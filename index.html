<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">

  <!-- SEO Meta Tags -->
  <title>MindLoop CostOS - Restaurant Intelligence Platform</title>
  <meta name="description"
    content="Plataforma de inteligencia para restaurantes. Gestiona costes, recetas, inventario y an√°lisis financiero de tu negocio gastron√≥mico.">
  <meta name="keywords" content="restaurante, gesti√≥n, costes, recetas, inventario, food cost, hosteler√≠a, MindLoop">
  <meta name="author" content="MindLoop IA">
  <meta name="robots" content="index, follow">

  <!-- Open Graph / Social Media -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="MindLoop CostOS - Restaurant Intelligence">
  <meta property="og:description"
    content="Plataforma de inteligencia para restaurantes. Gesti√≥n de costes, recetas e inventario.">
  <meta property="og:url" content="https://klaker79.github.io/lacaletacost/">

  <!-- PWA / Mobile -->
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MindLoop CostOS">

  <!-- Favicon -->
  <link rel="icon" href="https://em-content.zobj.net/source/apple/391/pot-of-food_1f372.png" type="image/png">
  <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/391/pot-of-food_1f372.png">

  <!-- Preconnect para performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <!-- Scripts externos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-size: 200% 200%;
      animation: gradient 15s ease infinite;
      min-height: 100vh;
    }

    @keyframes gradient {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 15px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .header:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    /* Animaciones globales premium */
    .kpi-card {
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
    }

    .kpi-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .dashboard-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .dashboard-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }

    /* Tabs con animaci√≥n */
    .tab {
      position: relative;
      overflow: hidden;
    }

    .tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: all 0.3s ease;
      transform: translateX(-50%);
      border-radius: 3px 3px 0 0;
    }

    .tab:hover::after {
      width: 80%;
    }

    .tab.active::after {
      width: 100%;
      background: #c35a3f;
    }

    /* Botones con pulse effect */
    .btn-primary {
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-primary:hover::before {
      width: 300px;
      height: 300px;
    }

    /* Smooth scroll */
    html {
      scroll-behavior: smooth;
    }

    /* Focus states para accesibilidad */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    .logo-circle {
      width: 50px;
      height: 50px;
      border: 2px solid #c35a3f;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #c35a3f;
    }

    .header-title {
      flex: 1;
    }

    .header-title h1 {
      color: #c35a3f;
      font-size: 24px;
      font-weight: 700;
    }

    .header-title p {
      color: #666;
      font-size: 14px;
    }

    .tabs {
      background: white;
      border-radius: 10px 10px 0 0;
      display: flex;
      gap: 5px;
      padding: 10px 10px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
    }

    .tab:hover {
      background: #f5f5f5;
    }

    .tab.active {
      background: white;
      color: #c35a3f;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
    }

    .main-card {
      background: white;
      border-radius: 0 10px 10px 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      min-height: 500px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      min-height: 600px;
      padding: 20px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .top-bar h2 {
      font-size: 28px;
      color: #333;
    }

    .top-bar p {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #c35a3f;
      color: white;
    }

    .btn-primary:hover {
      background: #a84a33;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
    }

    /* === BUSCADOR MEJORADO === */
    .search-box {
      position: relative;
      max-width: 400px;
      margin: 20px 0;
    }

    .search-box input {
      width: 100%;
      padding: 14px 20px 14px 48px;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      color: #1E293B;
      background: white;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .search-box input:focus {
      outline: none;
      border-color: #FF6B35;
      box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1), 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .search-box input::placeholder {
      color: #94A3B8;
      font-weight: 400;
    }

    .search-box::before {
      content: "üîç";
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      pointer-events: none;
      opacity: 0.6;
    }

    .form-card {
      background: #fff5f2;
      border: 2px solid #c35a3f;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .form-card h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .ingredientes-receta {
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .ingredientes-receta h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }

    .ingrediente-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .ingrediente-item select,
    .ingrediente-item input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .ingrediente-item button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .selector-ingredientes {
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .selector-ingredientes h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }

    .ingredientes-disponibles {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #f9f9f9;
    }

    .ingrediente-checkbox {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .ingrediente-checkbox:hover {
      background: #f0f0f0;
    }

    .ingrediente-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
    }

    .ingrediente-checkbox label {
      cursor: pointer;
      flex: 1;
      margin: 0;
    }

    .coste-calculado {
      background: #f0fdf4;
      border: 2px solid #10b981;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .coste-calculado h4 {
      color: #059669;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .coste-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #d1fae5;
    }

    .coste-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 18px;
      color: #059669;
      padding-top: 15px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #c35a3f;
    }

    .stat-card.green {
      border-left-color: #10b981;
    }

    .stat-card.blue {
      border-left-color: #3b82f6;
    }

    .stat-card.orange {
      border-left-color: #f59e0b;
    }

    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }

    .stat-card .subtext {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chart-card h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 15px;
    }

    .chart-card canvas {
      max-height: 300px;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    table {
      width: 100%;
      min-width: 800px;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      background: #f8f8f8;
      border-bottom: 2px solid #e0e0e0;
    }

    th {
      padding: 12px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
    }

    td {
      padding: 15px 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    tbody tr:hover {
      background: #f9f9f9;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      transform: scale(1.1);
    }

    .icon-btn.edit {
      color: #c35a3f;
    }

    .icon-btn.delete {
      color: #dc2626;
    }

    .icon-btn.produce {
      color: #10b981;
    }

    .icon-btn.view {
      color: #3b82f6;
    }

    .icon-btn.receive {
      color: #10b981;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state .icon {
      font-size: 60px;
      margin-bottom: 15px;
    }

    .empty-state h3 {
      font-size: 20px;
      color: #666;
      margin-bottom: 10px;
    }

    .stock-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .stock-low {
      background: #fee;
      color: #c00;
    }

    .stock-ok {
      background: #efe;
      color: #060;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #d1fae5;
      color: #059669;
    }

    .badge-warning {
      background: #fef3c7;
      color: #d97706;
    }

    .badge-info {
      background: #dbeafe;
      color: #2563eb;
    }

    .badge-pending {
      background: #fef3c7;
      color: #d97706;
    }

    .badge-received {
      background: #d1fae5;
      color: #059669;
    }

    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }

    .summary strong {
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      line-height: 1;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h3 {
      font-size: 22px;
      color: #333;
      margin-bottom: 20px;
    }

    .ingredientes-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .ingredientes-list .badge {
      background: #f0f0f0;
      color: #333;
      padding: 6px 12px;
    }

    .total-pedido {
      background: #f0fdf4;
      border: 2px solid #10b981;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: right;
    }

    .total-pedido strong {
      font-size: 24px;
      color: #059669;
    }

    /* Estilos para Inventario */
    .tab-badge {
      background: #ef4444;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 6px;
      font-weight: bold;
    }

    .stock-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .stock-ok {
      background: #10b981;
    }

    .stock-bajo {
      background: #f59e0b;
    }

    .stock-critico {
      background: #ef4444;
    }

    .stock-actions {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .stock-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    .stock-btn:hover {
      background: #e5e7eb;
    }

    .stock-value {
      min-width: 60px;
      text-align: center;
      font-weight: bold;
    }

    /* === MEJORAS PROFESIONALES MINDLOOP === */
    .header {
      background: linear-gradient(135deg, #4F46E5 0%, #9333EA 100%);
      padding: 12px 32px;
      box-shadow: 0 4px 20px rgba(79, 70, 229, 0.15);
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header img {
      height: 60px;
      border-radius: 50%;
      background: white;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .header h1 {
      margin: 0;
      background: linear-gradient(135deg, #FF6B35 0%, #F59E0B 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 48px;
      font-weight: 800;
      letter-spacing: -1px;
    }

    /* KPI Dashboard Cards */
    .kpi-dashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin: 24px 0;
      padding: 0 32px;
    }

    .kpi-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .kpi-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .kpi-label {
      font-size: 13px;
      color: #64748B;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 36px;
      font-weight: 800;
      color: #1E293B;
      margin-bottom: 8px;
      line-height: 1;
    }

    .kpi-trend {
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-trend.positive {
      color: #10B981;
    }

    .kpi-trend.negative {
      color: #EF4444;
    }

    .kpi-trend.warning {
      color: #F59E0B;
    }

    .header p {
      margin: 8px 0 0 0;
      color: rgba(255, 255, 255, 0.9);
      font-size: 18px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    /* KPI Dashboard Cards */
    .kpi-dashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin: 24px 0;
      padding: 0 32px;
    }

    .kpi-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .kpi-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .kpi-label {
      font-size: 13px;
      color: #64748B;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 36px;
      font-weight: 800;
      color: #1E293B;
      margin-bottom: 8px;
      line-height: 1;
    }

    .kpi-trend {
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-trend.positive {
      color: #10B981;
    }

    .kpi-trend.negative {
      color: #EF4444;
    }

    .kpi-trend.warning {
      color: #F59E0B;
    }

    /* Chart Container */
    .chart-container {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 24px;
    }

    .chart-header {
      margin-bottom: 24px;
    }

    .chart-header h3 {
      font-size: 20px;
      font-weight: 700;
      color: #1E293B;
      margin: 0 0 8px 0;
    }

    .chart-header p {
      font-size: 14px;
      color: #64748B;
      margin: 0;
    }

    #revenueChart {
      max-height: 350px;
    }

    .logo-mindloop {
      display: none;
    }

    .header-title h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .tabs {
      gap: 8px;
      padding: 16px 0;
    }

    .tab {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .tab:hover {
      background: rgba(255, 107, 53, 0.1);
      transform: translateY(-2px);
    }

    .tab.active {
      background: linear-gradient(135deg, #FF6B35, #F59E0B);
      color: white;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .main-card {
      border-radius: 16px;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
    }

    .btn-primary {
      background: linear-gradient(135deg, #FF6B35, #F59E0B);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.35);
    }

    table {
      border-spacing: 0 8px;
    }

    /* === TABLAS MEJORADAS === */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
    }

    table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    table thead th {
      background: linear-gradient(180deg, #F8FAFC 0%, #F1F5F9 100%);
      color: #64748B;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      padding: 16px 20px;
      text-align: left;
      border-bottom: 2px solid #E2E8F0;
      white-space: nowrap;
    }

    table thead th:first-child {
      border-top-left-radius: 12px;
    }

    table thead th:last-child {
      border-top-right-radius: 12px;
    }

    table tbody tr {
      background: white;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-bottom: 1px solid #F1F5F9;
    }

    table tbody tr:hover {
      background: linear-gradient(90deg, #FFF7ED 0%, #FFFFFF 100%);
      transform: translateX(4px);
      box-shadow: -4px 0 0 0 #FF6B35, 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    table tbody tr:last-child {
      border-bottom: none;
    }

    table tbody td {
      padding: 18px 20px;
      color: #1E293B;
      font-size: 14px;
      vertical-align: middle;
    }

    table tbody td:first-child {
      font-weight: 600;
    }

    /* Actions buttons */
    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .icon-btn {
      background: transparent;
      border: 1px solid #E2E8F0;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .icon-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .icon-btn.edit:hover {
      background: #FFF7ED;
      border-color: #F59E0B;
    }

    .icon-btn.delete:hover {
      background: #FEF2F2;
      border-color: #EF4444;
    }

    .icon-btn.view:hover {
      background: #EFF6FF;
      border-color: #3B82F6;
    }

    table tbody tr {
      background: white;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-bottom: 1px solid #F1F5F9;
    }

    table tbody tr:hover {
      background: linear-gradient(90deg, #FFF7ED 0%, #FFFFFF 100%);
      transform: translateX(4px);
      box-shadow: -4px 0 0 0 #FF6B35, 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    table tbody tr:last-child {
      border-bottom: none;
    }

    table tbody td {
      padding: 18px 20px;
      color: #1E293B;
      font-size: 14px;
      vertical-align: middle;
    }

    table tbody td:first-child {
      font-weight: 600;
    }

    /* Actions buttons */
    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .icon-btn {
      background: transparent;
      border: 1px solid #E2E8F0;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .icon-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .icon-btn.edit:hover {
      background: #FFF7ED;
      border-color: #F59E0B;
    }

    .icon-btn.delete:hover {
      background: #FEF2F2;
      border-color: #EF4444;
    }

    .icon-btn.view:hover {
      background: #EFF6FF;
      border-color: #3B82F6;
    }

    background: #EFF6FF;
    border-color: #3B82F6;
    }

    /* === ANIMACIONES DE ENTRADA === */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* Header animation */
    .header {
      animation: fadeIn 0.6s ease-out;
    }

    /* KPI cards staggered animation */
    .kpi-card {
      animation: fadeInUp 0.6s ease-out;
    }

    .kpi-card:nth-child(1) {
      animation-delay: 0.1s;
    }

    .kpi-card:nth-child(2) {
      animation-delay: 0.2s;
    }

    .kpi-card:nth-child(3) {
      animation-delay: 0.3s;
    }

    .kpi-card:nth-child(4) {
      animation-delay: 0.4s;
    }

    /* Tabs animation */
    .tabs {
      animation: fadeIn 0.6s ease-out 0.5s backwards;
    }

    /* Main card animation */
    .main-card {
      animation: fadeInUp 0.6s ease-out 0.6s backwards;
    }

    /* Table rows animation */
    table tbody tr {
      animation: fadeIn 0.4s ease-out backwards;
    }

    table tbody tr:nth-child(1) {
      animation-delay: 0.05s;
    }

    table tbody tr:nth-child(2) {
      animation-delay: 0.1s;
    }

    table tbody tr:nth-child(3) {
      animation-delay: 0.15s;
    }

    table tbody tr:nth-child(4) {
      animation-delay: 0.2s;
    }

    table tbody tr:nth-child(5) {
      animation-delay: 0.25s;
    }

    table tbody tr:nth-child(6) {
      animation-delay: 0.3s;
    }

    table tbody tr:nth-child(7) {
      animation-delay: 0.35s;
    }

    table tbody tr:nth-child(8) {
      animation-delay: 0.4s;
    }

    table tbody tr:nth-child(9) {
      animation-delay: 0.45s;
    }

    table tbody tr:nth-child(10) {
      animation-delay: 0.5s;
    }

    /* Buttons animation */
    .btn-primary {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary:active {
      transform: scale(0.95);
    }

    /* === TOAST NOTIFICATIONS === */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
    }

    .toast {
      background: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
      border-left: 4px solid #10B981;
    }

    .toast.success {
      border-left-color: #10B981;
    }

    .toast.error {
      border-left-color: #EF4444;
    }

    .toast.warning {
      border-left-color: #F59E0B;
    }

    .toast.info {
      border-left-color: #3B82F6;
    }

    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      color: #1E293B;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* === LOADING SPINNER === */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #FF6B35;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Login Screen */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 48px 40px;
      border-radius: 24px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.3);
      width: 100%;
      max-width: 420px;
      animation: loginSlideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes loginSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-header h1 {
      color: #1a1a2e;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .login-header p {
      color: #666;
      font-size: 14px;
    }

    .login-form .form-group {
      margin-bottom: 20px;
    }

    .login-form label {
      display: block;
      margin-bottom: 6px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }

    .login-form input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }

    .login-form input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .login-error {
      color: #e74c3c;
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
    }

    .login-footer {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 14px;
    }

    .login-footer a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    /* Empty States Profesionales */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      animation: fadeInUp 0.6s ease-out;
    }

    .empty-state-icon {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
      animation: float 3s ease-in-out infinite;
    }

    .empty-state h3 {
      color: #1a1a2e;
      font-size: 24px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .empty-state p {
      color: #7d7d8e;
      font-size: 16px;
      margin-bottom: 25px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.5;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }
  </style>
  </style>
</head>

<body>
  <!-- Pantalla de Login -->
  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>üçΩÔ∏è MindLoop CostOS</h1>
        <p>Restaurant Intelligence Platform</p>
      </div>
      <form id="login-form" class="login-form">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="tu@email.com" required>
        </div>
        <div class="form-group">
          <label for="login-password">Contrase√±a</label>
          <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="login-btn">Iniciar Sesi√≥n</button>
        <p id="login-error" class="login-error"></p>
      </form>
      <div class="login-footer">
        <p>¬øNo tienes cuenta? <a href="#" onclick="mostrarRegistro()">Registrar restaurante</a></p>
      </div>
    </div>
  </div>

  <div class="container" id="app-container" style="display: none;">
    <div class="header" style="justify-content: space-between;">
      <div style="display: flex; align-items: center; flex: 1;">
        <img src="logosincirculo-removebg-preview.png" alt="MindLoopIA"
          style="height: 120px; width: auto; margin-right: 20px; background: transparent; padding: 0; box-shadow: none;">
        <div>
          <h1 style="margin: 0;">MindLoop CostOS</h1>
          <p style="margin: 0;">Restaurant Intelligence Platform</p>
        </div>
      </div>
      <div style="display: flex; align-items: center; gap: 15px;">
        <span id="user-restaurant" style="color: #666; font-size: 14px;"></span>
        <button onclick="logout()"
          style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px;">Cerrar
          Sesi√≥n</button>
      </div>
    </div>

    <!-- KPI Dashboard -->
    <div class="kpi-dashboard">
      <div class="kpi-card">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi-label">Ingresos totales</div>
        <div class="kpi-value" id="kpi-ingresos">0‚Ç¨</div>
        <div class="kpi-trend positive">
          <span>‚Üó</span> <span id="kpi-ingresos-trend">+0%</span> este mes
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">üìã</div>
        <div class="kpi-label">Pedidos activos</div>
        <div class="kpi-value" id="kpi-pedidos">0</div>
        <div class="kpi-trend positive">
          <span>‚Üó</span> <span id="kpi-pedidos-trend">+0%</span> vs anterior
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">‚ö†Ô∏è</div>
        <div class="kpi-label">Stock bajo</div>
        <div class="kpi-value" id="kpi-stock">0</div>
        <div class="kpi-trend warning">
          <span>‚ö°</span> <span id="kpi-stock-msg">Requieren atenci√≥n</span>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">üìä</div>
        <div class="kpi-label">Margen promedio</div>
        <div class="kpi-value" id="kpi-margen">0%</div>
        <div class="kpi-trend positive">
          <span>‚Üó</span> <span id="kpi-margen-trend">+0%</span> objetivo
        </div>
      </div>
    </div>
    <!-- Dashboard Expandido -->
    <div id="dashboard-expandido" class="dashboard-expandido"
      style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 0 32px 24px 32px;">

      <!-- Alertas de Stock -->
      <div class="dashboard-card"
        style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #1E293B; display: flex; align-items: center; gap: 8px;">
          üö® Alertas de Stock
        </h3>
        <div id="alertas-stock-lista" style="max-height: 150px; overflow-y: auto; font-size: 14px;">
          <p style="color: #64748B; margin: 0;">Cargando...</p>
        </div>
      </div>

      <!-- Resumen del D√≠a -->
      <div class="dashboard-card"
        style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #1E293B; display: flex; align-items: center; gap: 8px;">
          üìä Resumen de Hoy
        </h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div style="text-align: center; padding: 12px; background: #F0FDF4; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: 700; color: #10B981;" id="ventas-hoy">0</div>
            <div style="font-size: 12px; color: #64748B;">Ventas</div>
          </div>
          <div style="text-align: center; padding: 12px; background: #EFF6FF; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: 700; color: #3B82F6;" id="ingresos-hoy">0‚Ç¨</div>
            <div style="font-size: 12px; color: #64748B;">Ingresos</div>
          </div>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: #FFF7ED; border-radius: 8px; text-align: center;">
          <div style="font-size: 12px; color: #64748B;">Plato estrella hoy</div>
          <div style="font-size: 14px; font-weight: 600; color: #F59E0B;" id="plato-estrella-hoy">-</div>
        </div>
      </div>

      <!-- Accesos R√°pidos -->
      <div class="dashboard-card"
        style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #1E293B; display: flex; align-items: center; gap: 8px;">
          ‚ö° Acciones R√°pidas
        </h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="window.cambiarTab('ventas'); document.getElementById('venta-receta').focus();"
            style="padding: 12px; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
            üí∞ Nueva Venta
          </button>
          <button
            onclick="window.cambiarTab('pedidos'); window.mostrarFormularioPedido && window.mostrarFormularioPedido();"
            style="padding: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
            üì¶ Nuevo Pedido
          </button>
          <button onclick="window.cambiarTab('inventario');"
            style="padding: 12px; background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
            üîç Ver Inventario
          </button>
        </div>
      </div>

    </div>
    <div class="tabs">
      <button id="tab-btn-ingredientes" class="tab active" onclick="window.cambiarTab('ingredientes')">üì¶
        Ingredientes</button>
      <button id="tab-btn-recetas" class="tab" onclick="window.cambiarTab('recetas')">üë®‚Äçüç≥ Recetas</button>
      <button id="tab-btn-proveedores" class="tab" onclick="window.cambiarTab('proveedores')">üöö Proveedores</button>
      <button id="tab-btn-pedidos" class="tab" onclick="window.cambiarTab('pedidos')">üìã Pedidos</button>
      <button id="tab-btn-analisis" class="tab" onclick="window.cambiarTab('analisis')">üìä An√°lisis</button>
      <button id="tab-btn-inventario" class="tab" onclick="window.cambiarTab('inventario')">üì¶ Inventario<span
          id="badge-inventario" class="tab-badge" style="display:none;">0</span></button>
      <button id="tab-btn-ventas" class="tab" onclick="window.cambiarTab('ventas')">üí∞ Ventas</button>
      <button id="tab-btn-balance" class="tab" onclick="window.cambiarTab('balance')">üíµ Finanzas</button>
      <button id="tab-btn-diario" class="tab" onclick="window.cambiarTab('diario')">üìà Diario</button>
      <button id="tab-btn-configuracion" class="tab" onclick="window.cambiarTab('configuracion')">‚öôÔ∏è
        Configuraci√≥n</button>
    </div>

    <div class="main-card">



      <!-- TAB: INGREDIENTES (c√≥digo anterior simplificado por brevedad) -->
      <div id="tab-ingredientes" class="tab-content active">
        <div class="top-bar">
          <div>
            <h2>Ingredientes</h2>
            <p>Gestiona todos los ingredientes de tu restaurante</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="window.mostrarFormularioIngrediente()">‚ûï A√±adir
              Ingrediente</button>
            <button class="btn btn-secondary" onclick="window.mostrarModalImportarIngredientes()">üì§ Importar
              Excel</button>
            <button class="btn btn-secondary" onclick="exportarIngredientes()">üì• Exportar Excel</button>
          </div>
        </div>
        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <input type="text" id="busqueda-ingredientes" placeholder="Buscar..."
            oninput="window.renderizarIngredientes()">
        </div>
        <div id="formulario-ingrediente" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-ingrediente">Nuevo Ingrediente</span>
            <button class="close-btn" onclick="window.cerrarFormularioIngrediente()">√ó</button>
          </h3>
          <form onsubmit="window.guardarIngrediente(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="ing-nombre" required>
              </div>
              <div class="form-group">
                <label>Proveedor</label>
                <select id="ing-proveedor-select">
                  <option value="">Sin proveedor</option>
                </select>
              </div>
              <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="ing-precio" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label>Unidad</label>
                <select id="ing-unidad">
                  <option value="kg">kg</option>
                  <option value="g">g</option>
                  <option value="l">L</option>
                  <option value="ml">ml</option>
                  <option value="unidad">Unidades</option>
                </select>
              </div>
              <div class="form-group">
                <label>Familia</label>
                <select id="ing-familia">
                  <option value="alimento">Alimento</option>
                  <option value="bebida">Bebida</option>
                </select>
              </div>
              <div class="form-group">
                <label>Stock actual</label>
                <input type="number" id="ing-stockActual" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label>Stock m√≠nimo</label>
                <input type="number" id="ing-stockMinimo" step="0.01" min="0">
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary"
                onclick="window.cerrarFormularioIngrediente()">Cancelar</button>
              <button type="submit" class="btn btn-primary"><span id="btn-text-ingrediente">A√±adir</span></button>
            </div>
          </form>
        </div>
        <div id="tabla-ingredientes"></div>
        <div id="resumen-ingredientes" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: RECETAS (simplificado) -->
      <div id="tab-recetas" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>Recetas</h2>
            <p>Crea recetas y calcula costes</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="window.mostrarFormularioReceta()">‚ûï Nueva Receta</button>
            <button class="btn btn-secondary" onclick="window.mostrarModalImportarRecetas()">üì§ Importar Excel</button>
            <button class="btn btn-secondary" onclick="exportarRecetas()">üì• Exportar Excel</button>
          </div>
        </div>
        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <input type="text" id="busqueda-recetas" placeholder="Buscar..." oninput="window.renderizarRecetas()">
        </div>
        <div id="formulario-receta" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-receta">Nueva Receta</span>
            <button class="close-btn" onclick="window.cerrarFormularioReceta()">√ó</button>
          </h3>
          <form onsubmit="window.guardarReceta(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="rec-nombre" required>
              </div>
              <div class="form-group">
                <label>C√≥digo TPV</label>
                <input type="text" id="rec-codigo" placeholder="Ej: 101">
              </div>
              <div class="form-group">
                <label>Categor√≠a</label>
                <select id="rec-categoria">
                  <option value="entrante">Entrante</option>
                  <option value="principal">Principal</option>
                  <option value="postre">Postre</option>
                  <option value="bebida">Bebida</option>
                </select>
              </div>
              <div class="form-group">
                <label>Precio venta (‚Ç¨)</label>
                <input type="number" id="rec-precio_venta" step="0.01" min="0" oninput="window.calcularCosteReceta()">
              </div>
              <div class="form-group">
                <label>Porciones</label>
                <input type="number" id="rec-porciones" min="1" value="1">
              </div>
            </div>
            <div class="ingredientes-receta">
              <h4>Ingredientes</h4>
              <div id="lista-ingredientes-receta"></div>
              <button type="button" class="btn btn-secondary btn-small" onclick="window.agregarIngredienteReceta()">+
                A√±adir</button>
            </div>
            <div id="coste-calculado-form" class="coste-calculado" style="display: none;"></div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary"
                onclick="window.cerrarFormularioReceta()">Cancelar</button>
              <button type="submit" class="btn btn-primary"><span id="btn-text-receta">Guardar</span></button>
            </div>
          </form>
        </div>
        <div id="tabla-recetas"></div>
        <div id="resumen-recetas" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: PROVEEDORES (simplificado) -->
      <div id="tab-proveedores" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>Proveedores</h2>
            <p>Gestiona tus proveedores</p>
          </div>
          <button class="btn btn-primary" onclick="window.mostrarFormularioProveedor()">+ A√±adir Proveedor</button>
        </div>
        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <input type="text" id="busqueda-proveedores" placeholder="Buscar..." oninput="window.renderizarProveedores()">
        </div>
        <div id="formulario-proveedor" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-proveedor">Nuevo Proveedor</span>
            <button class="close-btn" onclick="window.cerrarFormularioProveedor()">√ó</button>
          </h3>
          <form onsubmit="window.guardarProveedor(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="prov-nombre" required>
              </div>
              <div class="form-group">
                <label>Contacto</label>
                <input type="text" id="prov-contacto">
              </div>
              <div class="form-group">
                <label>Tel√©fono</label>
                <input type="tel" id="prov-telefono">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="prov-email">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Direcci√≥n</label>
                <textarea id="prov-direccion"></textarea>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Notas</label>
                <textarea id="prov-notas"></textarea>
              </div>
            </div>
            <div class="selector-ingredientes">
              <h4>Ingredientes que suministra</h4>
              <div class="search-box" style="margin-bottom: 10px;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <circle cx="11" cy="11" r="8" />
                  <path d="m21 21-4.35-4.35" />
                </svg>
                <input type="text" id="buscar-ingredientes-proveedor" placeholder="Buscar..."
                  oninput="window.filtrarIngredientesProveedor()">
              </div>
              <div class="ingredientes-disponibles" id="lista-ingredientes-proveedor"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary"
                onclick="window.cerrarFormularioProveedor()">Cancelar</button>
              <button type="submit" class="btn btn-primary"><span id="btn-text-proveedor">A√±adir</span></button>
            </div>
          </form>
        </div>
        <div id="tabla-proveedores"></div>
        <div id="resumen-proveedores" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: PEDIDOS -->
      <div id="tab-pedidos" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>Pedidos a Proveedores</h2>
            <p>Gestiona tus pedidos y actualiza stock autom√°ticamente</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="window.mostrarFormularioPedido()">+ Nuevo Pedido</button>
            <button class="btn btn-secondary" onclick="window.mostrarModalImportarPedidos()">üì§ Importar
              Pedidos</button>
          </div>
        </div>

        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <input type="text" id="busqueda-pedidos" placeholder="Buscar pedidos..." oninput="window.renderizarPedidos()">
        </div>

        <div id="formulario-pedido" class="form-card" style="display: none;">
          <h3>
            <span>Nuevo Pedido</span>
            <button class="close-btn" onclick="window.cerrarFormularioPedido()">√ó</button>
          </h3>
          <form onsubmit="window.guardarPedido(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Proveedor *</label>
                <select id="ped-proveedor" required onchange="window.cargarIngredientesPedido()">
                  <option value="">Seleccionar proveedor...</option>
                </select>
              </div>
              <div class="form-group">
                <label>Fecha del pedido</label>
                <input type="date" id="ped-fecha" required>
              </div>
            </div>

            <div class="ingredientes-receta" id="container-ingredientes-pedido" style="display:none;">
              <h4>Ingredientes del pedido</h4>
              <div id="lista-ingredientes-pedido"></div>
              <button type="button" class="btn btn-secondary btn-small" onclick="window.agregarIngredientePedido()">+
                A√±adir ingrediente</button>
            </div>

            <div id="total-pedido-form" style="display:none;" class="total-pedido">
              Total: <strong id="total-pedido-value">0.00 ‚Ç¨</strong>
            </div>

            <div class="form-actions" style="margin-top: 20px;">
              <button type="button" class="btn btn-secondary"
                onclick="window.cerrarFormularioPedido()">Cancelar</button>
              <button type="submit" class="btn btn-primary">Crear Pedido</button>
            </div>
          </form>
        </div>

        <div id="tabla-pedidos"></div>
        <div id="resumen-pedidos" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: AN√ÅLISIS -->
      <div id="tab-analisis" class="tab-content">
        <div class="chart-container">
          <div class="chart-header">
            <h3>üìä Ingresos vs Gastos</h3>
            <p>Evoluci√≥n financiera de los √∫ltimos 7 d√≠as</p>
          </div>
          <canvas id="revenueChart"></canvas>
        </div>

        <div id="analisis-vacio" class="empty-state">
          <div class="icon">üìä</div>
          <h3>A√∫n no hay datos</h3>
          <p>A√±ade ingredientes y recetas</p>
        </div>

        <div id="analisis-contenido" style="display: none;">
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Total Recetas</h3>
              <div class="value" id="stat-total-recetas">0</div>
            </div>
            <div class="stat-card green">
              <h3>Margen Promedio</h3>
              <div class="value" id="stat-margen-promedio">0%</div>
            </div>
            <div class="stat-card blue">
              <h3>Coste Promedio</h3>
              <div class="value" id="stat-coste-promedio">0 ‚Ç¨</div>
            </div>
            <div class="stat-card orange">
              <h3>Total Ingredientes</h3>
              <div class="value" id="stat-total-ingredientes">0</div>
            </div>
          </div>
          <div class="charts-grid">
            <div class="chart-card">
              <h3>Rentabilidad por Plato</h3>
              <canvas id="chart-rentabilidad"></canvas>
            </div>
            <div class="chart-card">
              <h3>Ingredientes M√°s Caros</h3>
              <canvas id="chart-ingredientes"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Ranking de Rentabilidad</h3>
            <div id="tabla-rentabilidad"></div>
          </div>

          <!-- Matriz BCG -->
          <div class="chart-card" id="bcg-matrix-container" style="margin-top: 20px;">
            <h3>üèÜ Ingenier√≠a de Men√∫ (Matriz BCG)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <!-- Estrellas -->
              <div style="background: #ecfdf5; padding: 15px; border-radius: 8px; border: 1px solid #10b981;">
                <h4 style="color: #047857; margin: 0 0 10px 0;">‚≠ê Estrellas (Alta Rentabilidad, Alta Popularidad)</h4>
                <div id="lista-estrella" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
              </div>
              <!-- Puzzles -->
              <div style="background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #3b82f6;">
                <h4 style="color: #1d4ed8; margin: 0 0 10px 0;">‚ùì Puzzles (Alta Rentabilidad, Baja Popularidad)</h4>
                <div id="lista-puzzle" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
              </div>
              <!-- Caballos -->
              <div style="background: #fff7ed; padding: 15px; border-radius: 8px; border: 1px solid #f97316;">
                <h4 style="color: #c2410c; margin: 0 0 10px 0;">üêé Caballos (Baja Rentabilidad, Alta Popularidad)</h4>
                <div id="lista-caballo" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
              </div>
              <!-- Perros -->
              <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #ef4444;">
                <h4 style="color: #b91c1c; margin: 0 0 10px 0;">üê∂ Perros (Baja Rentabilidad, Baja Popularidad)</h4>
                <div id="lista-perro" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
              </div>
            </div>
            <style>
              .bcg-item {
                background: white;
                padding: 6px 10px;
                border-radius: 20px;
                font-size: 12px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(0, 0, 0, 0.05);
              }
            </style>
          </div>
        </div>
      </div>

      <!-- TAB: INVENTARIO -->
      <div id="tab-inventario" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>üì¶ Inventario</h2>
            <p>Control de stock de ingredientes</p>
          </div>
        </div>

        <div style="margin-bottom: 15px;">
          <button class="btn btn-secondary" onclick="window.mostrarModalInventarioMasivo()">üìä ACTUALIZAR INVENTARIO
            MASIVO</button>
          <button class="btn btn-primary" onclick="window.guardarCambiosStock()">üíæ Guardar Stock</button>
        </div>

        <div id="resumen-inventario" style="display: none; gap: 20px;"></div>


        <div class="card">
          <div style="margin-bottom: 20px;">
            <input type="text" id="busqueda-inventario" placeholder="üîç Buscar ingrediente..."
              style="width: 100%; max-width: 400px;">
          </div>

          <div id="tabla-inventario"></div>
        </div>
      </div>
      <!-- TAB: VENTAS -->
      <div id="tab-ventas" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>üí∞ Ventas</h2>
            <p>Registro diario de ventas</p>
          </div>
          <button class="btn btn-secondary" onclick="window.mostrarModalImportarVentas()">üì§ Importar Ventas
            TPV</button>
        </div>

        <div class="card">
          <h3>Registrar Venta</h3>
          <form id="form-venta">
            <label>Plato:</label>
            <select id="venta-receta" required></select>

            <label>Cantidad:</label>
            <input type="number" id="venta-cantidad" min="1" value="1" required>

            <button type="submit" class="btn btn-success">Registrar Venta</button>
          </form>
        </div>
        <div class="card" style="margin-bottom: 20px;">
          <h3>üìÖ Filtrar por Fecha</h3>
          <div style="display: flex; gap: 15px; align-items: end;">
            <div class="form-group" style="flex: 1;">
              <label>Desde:</label>
              <input type="date" id="ventas-fecha-desde" class="form-control">
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Hasta:</label>
              <input type="date" id="ventas-fecha-hasta" class="form-control">
            </div>
            <button class="btn btn-primary" onclick="window.renderizarVentas()">üîç Filtrar</button>
            <button class="btn btn-secondary"
              onclick="document.getElementById('ventas-fecha-desde').value=''; document.getElementById('ventas-fecha-hasta').value=''; window.renderizarVentas();">üîÑ
              Limpiar</button>
          </div>
        </div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">üìä Hist√≥rico de Ventas</h3>
            <button class="btn btn-secondary" onclick="exportarVentas()">üì• Exportar Excel</button>
          </div>
          <div id="tabla-ventas"></div>
        </div>
      </div>

      <!-- TAB: DIARIO (Tracking de Costes/Ventas por D√≠a) -->
      <div id="tab-diario" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>üìà Control Diario</h2>
            <p>Tracking de compras y ventas por d√≠a - Vista tipo Excel</p>
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="diario-mes" class="form-control"
              style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
              <option value="1">Enero</option>
              <option value="2">Febrero</option>
              <option value="3">Marzo</option>
              <option value="4">Abril</option>
              <option value="5">Mayo</option>
              <option value="6">Junio</option>
              <option value="7">Julio</option>
              <option value="8">Agosto</option>
              <option value="9">Septiembre</option>
              <option value="10">Octubre</option>
              <option value="11">Noviembre</option>
              <option value="12">Diciembre</option>
            </select>
            <select id="diario-ano" class="form-control"
              style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
            <button class="btn btn-primary" onclick="window.cargarResumenMensual()">üîÑ Cargar</button>
            <button class="btn btn-secondary" onclick="window.exportarDiarioExcel()">üì• Exportar Excel</button>
          </div>
        </div>

        <!-- Selector de Vista -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button id="btn-vista-compras" class="btn btn-primary" onclick="window.cambiarVistaDiario('compras')">üõí
            Compras (Costes)</button>
          <button id="btn-vista-ventas" class="btn btn-secondary" onclick="window.cambiarVistaDiario('ventas')">üí∞
            Ventas (Ingresos)</button>
          <button id="btn-vista-combinada" class="btn btn-secondary" onclick="window.cambiarVistaDiario('combinada')">üìä
            P&L Diario</button>
        </div>

        <!-- Resumen R√°pido -->
        <div class="stats-grid" id="diario-resumen">
          <div class="stat-card">
            <h3>Total Compras Mes</h3>
            <div class="value" id="diario-total-compras">0.00 ‚Ç¨</div>
          </div>
          <div class="stat-card green">
            <h3>Total Ventas Mes</h3>
            <div class="value" id="diario-total-ventas">0.00 ‚Ç¨</div>
          </div>
          <div class="stat-card blue">
            <h3>Beneficio Bruto</h3>
            <div class="value" id="diario-beneficio">0.00 ‚Ç¨</div>
          </div>
          <div class="stat-card orange">
            <h3>Food Cost</h3>
            <div class="value" id="diario-food-cost">0.0%</div>
          </div>

          <!-- Vista Compras -->
          <div id="vista-compras" class="diario-vista" style="display: block;">
            <h3 style="margin-bottom: 15px;">üõí Precio de Compra por Ingrediente / D√≠a</h3>
            <div id="tabla-compras-diarias" style="overflow-x: auto; width: 100%; max-width: 100%;">
              <p class="empty-state">Selecciona un mes y haz clic en "Cargar" para ver los datos</p>
            </div>
          </div>

          <!-- Vista Ventas -->
          <div id="vista-ventas" class="diario-vista" style="display: none;">
            <h3 style="margin-bottom: 15px;">üí∞ Ventas por Receta / D√≠a</h3>
            <div id="tabla-ventas-diarias" style="overflow-x: auto; width: 100%; max-width: 100%;">
              <p class="empty-state">Selecciona un mes y haz clic en "Cargar" para ver los datos</p>
            </div>
          </div>

          <!-- Vista Combinada (P&L) -->
          <div id="vista-combinada" class="diario-vista" style="display: none;">
            <h3 style="margin-bottom: 15px;">üìä Cuenta de Resultados Diaria</h3>
            <div id="tabla-pl-diario" style="overflow-x: auto; width: 100%; max-width: 100%;">
              <p class="empty-state">Selecciona un mes y haz clic en "Cargar" para ver los datos</p>
            </div>
          </div>
        </div>

        <!-- TAB: CONFIGURACI√ìN -->
        <div id="tab-configuracion" class="tab-content">
          <div class="top-bar">
            <div>
              <h2>‚öôÔ∏è Configuraci√≥n & Equipo</h2>
              <p>Gestiona los accesos y datos de tu negocio</p>
            </div>
            <button class="btn btn-secondary" onclick="window.abrirManualFormulas()">üìò Descargar/Imprimir
              Dossier</button>
          </div>

          <div class="dashboard-grid" style="grid-template-columns: 1fr; gap: 24px;">

            <!-- Tarjeta: Gesti√≥n de Equipo -->
            <div class="card"
              style="background:white; padding:20px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.08);">
              <div class="card-header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>üë• Mi Equipo</h3>
                <button class="btn btn-primary" onclick="window.mostrarModalInvitar()">+ Invitar Usuario</button>
              </div>
              <div class="table-container">
                <table style="width:100%; border-collapse:collapse;">
                  <thead>
                    <tr style="border-bottom:2px solid #eee;">
                      <th style="text-align:left; padding:10px;">Nombre</th>
                      <th style="text-align:left; padding:10px;">Email</th>
                      <th style="text-align:left; padding:10px;">Rol</th>
                      <th style="text-align:left; padding:10px;">Fecha Alta</th>
                      <th style="text-align:right; padding:10px;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="lista-equipo-body">
                    <!-- Se llena con JS -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Placeholder Datos Restaurante -->
            <div class="card"
              style="background:white; padding:20px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.08);">
              <h3>üè¢ Datos del Restaurante</h3>
              <div style="margin-top:10px; color:#666;">
                <p><strong>Nombre:</strong> <span id="config-restaurante-nombre">Cargando...</span></p>
                <p style="font-size:0.9em; margin-top:5px;">ID Restaurante: <span id="config-restaurante-id">...</span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- MODAL INVITAR EQUIPO -->
        <div id="modal-invitar-equipo" class="modal">
          <div class="modal-content" style="max-width:500px">
            <span class="close"
              onclick="document.getElementById('modal-invitar-equipo').classList.remove('active')">&times;</span>
            <h2>Invitar Nuevo Usuario</h2>
            <div style="margin-top:20px;">
              <div class="form-group" style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Nombre Completo</label>
                <input type="text" id="team-nombre" class="form-control" placeholder="Ej. Juan Cocinero"
                  style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
              </div>
              <div class="form-group" style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Email Corporativo</label>
                <input type="email" id="team-email" class="form-control" placeholder="juan@lacaleta.com"
                  style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
              </div>
              <div class="form-group" style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Contrase√±a Inicial</label>
                <input type="password" id="team-password" class="form-control" placeholder="******"
                  style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
              </div>
              <div class="form-group" style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Rol</label>
                <select id="team-rol" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                  <option value="usuario">Usuario (Est√°ndar)</option>
                  <option value="admin">Administrador (Acceso Total)</option>
                </select>
              </div>
              <button class="btn btn-primary" style="width:100%" onclick="window.invitarUsuarioEquipo()">Enviar
                Invitaci√≥n</button>
            </div>
          </div>
        </div>
        <div id="tab-balance" class="tab-content">
          <div class="top-bar">
            <div>
              <h2>üíµ Cuenta de Resultados (P&L)</h2>
              <p>Visi√≥n unificada de la rentabilidad real de tu negocio</p>
            </div>
            <div style="text-align: right;">
              <div id="pl-badge-estado"
                style="display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; background: #e2e8f0; color: #64748b;">
                Calculando...
              </div>
            </div>
          </div>

          <div
            style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; align-items: start; min-width: 800px; width: 100%;">

            <!-- COLUMNA IZQUIERDA: CASCADA P&L -->
            <div style="display: flex; flex-direction: column; gap: 15px;">

              <!-- 1. INGRESOS (VENTAS) -->
              <div
                style="background: white; border-radius: 12px; padding: 20px; border-left: 5px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="margin: 0; font-size: 16px; color: #1e293b;">(+) INGRESOS POR VENTAS</h3>
                  <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Facturaci√≥n total del periodo</p>
                </div>
                <div style="text-align: right;">
                  <div id="pl-ingresos" style="font-size: 24px; font-weight: 700; color: #10b981;">0.00 ‚Ç¨</div>
                </div>
              </div>

              <!-- 2. COSTE DE PRODUCTO (COGS) -->
              <div
                style="background: white; border-radius: 12px; padding: 20px; border-left: 5px solid #ef4444; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="margin: 0; font-size: 16px; color: #1e293b;">(-) COSTE DE PRODUCTO (Food Cost)</h3>
                  <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Coste de ingredientes de lo vendido</p>
                </div>
                <div style="text-align: right;">
                  <div id="pl-cogs" style="font-size: 24px; font-weight: 700; color: #ef4444;">0.00 ‚Ç¨</div>
                  <div id="pl-cogs-pct" style="font-size: 12px; color: #94a3b8;">0% sobre ventas</div>
                </div>
              </div>

              <!-- RESULTADO INTERMEDIO: MARGEN BRUTO -->
              <div
                style="background: #f8fafc; border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px dashed #cbd5e1;">
                <span style="font-weight: 600; color: #475569;">(=) MARGEN BRUTO</span>
                <span id="pl-margen-bruto" style="font-weight: 700; color: #334155; font-size: 18px;">0.00 ‚Ç¨</span>
              </div>

              <!-- 3. GASTOS OPERATIVOS (OPEX) - EDITABLES -->
              <div
                style="background: white; border-radius: 12px; padding: 25px; border-left: 5px solid #f59e0b; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <div>
                    <h3 style="margin: 0; font-size: 16px; color: #1e293b;">(-) GASTOS OPERATIVOS FIJOS</h3>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Costes estructurales (Editables)</p>
                  </div>
                  <div style="text-align: right;">
                    <div id="pl-opex-total" style="font-size: 24px; font-weight: 700; color: #f59e0b;">0.00 ‚Ç¨</div>
                  </div>
                </div>

                <!-- Inputs Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div class="form-group" style="margin: 0;">
                    <label style="font-size: 12px; color: #64748b;">Alquiler Local</label>
                    <div style="position: relative;">
                      <input type="number" id="pl-input-alquiler" class="pl-input" placeholder="0.00" min="0"
                        step="0.01"
                        oninput="window.guardarGastoFinanzas('Alquiler', 'p1-input-alquiler'); window.calcularPL();">
                      <span
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8;">‚Ç¨</span>
                    </div>
                  </div>
                  <div class="form-group" style="margin: 0;">
                    <label style="font-size: 12px; color: #64748b;">Personal (N√≥minas)</label>
                    <div style="position: relative;">
                      <input type="number" id="pl-input-personal" class="pl-input" placeholder="0.00" min="0"
                        step="0.01"
                        oninput="window.guardarGastoFinanzas('Personal', 'p1-input-personal'); window.calcularPL();">
                      <span
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8;">‚Ç¨</span>
                    </div>
                  </div>
                  <div class="form-group" style="margin: 0;">
                    <label style="font-size: 12px; color: #64748b;">Suministros</label>
                    <div style="position: relative;">
                      <input type="number" id="pl-input-suministros" class="pl-input" placeholder="0.00" min="0"
                        step="0.01"
                        oninput="window.guardarGastoFinanzas('Suministros', 'p1-input-suministros'); window.calcularPL();">
                      <span
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8;">‚Ç¨</span>
                    </div>
                  </div>
                  <div class="form-group" style="margin: 0;">
                    <label style="font-size: 12px; color: #64748b;">Otros Gastos</label>
                    <div style="position: relative;">
                      <input type="number" id="pl-input-otros" class="pl-input" placeholder="0.00" min="0" step="0.01"
                        oninput="window.guardarGastoFinanzas('Otros', 'p1-input-otros'); window.calcularPL();">
                      <span
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8;">‚Ç¨</span>
                    </div>
                  </div>
                </div>
                <style>
                  .pl-input {
                    width: 100%;
                    padding: 8px 12px;
                    border: 1px solid #e2e8f0;
                    border-radius: 6px;
                    font-weight: 600;
                    color: #1e293b;
                    transition: all 0.2s;
                  }

                  .pl-input:focus {
                    border-color: #f59e0b;
                    outline: none;
                    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
                  }
                </style>
              </div>

              <!-- 4. BENEFICIO NETO -->
              <div id="pl-card-neto"
                style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 16px; padding: 30px; box-shadow: 0 10px 25px rgba(30, 41, 59, 0.2); color: white; display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <div>
                  <h3 style="margin: 0; font-size: 18px; color: #e2e8f0;">(=) BENEFICIO NETO (EBITDA)</h3>
                  <p style="margin: 5px 0 0 0; font-size: 14px; color: #94a3b8;">Resultado final antes de impuestos</p>
                </div>
                <div style="text-align: right;">
                  <div id="pl-neto" style="font-size: 36px; font-weight: 800; line-height: 1;">0.00 ‚Ç¨</div>
                  <div id="pl-neto-pct" style="font-size: 14px; color: #cbd5e1; margin-top: 5px;">0% Rentabilidad</div>
                </div>
              </div>

            </div>

            <!-- COLUMNA DERECHA: AN√ÅLISIS VIABILIDAD -->
            <div style="display: flex; flex-direction: column; gap: 20px;">

              <!-- Card Break Even -->
              <div
                style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                <h3
                  style="margin: 0 0 20px 0; font-size: 16px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                  üéØ An√°lisis de Punto de Equilibrio
                </h3>

                <div style="text-align: center; margin-bottom: 25px;">
                  <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">Facturaci√≥n
                    Necesaria</div>
                  <div id="pl-breakeven" style="font-size: 32px; font-weight: 800; color: #334155;">0.00 ‚Ç¨</div>
                  <div style="font-size: 13px; color: #94a3b8;">para cubrir todos los costes</div>
                </div>

                <!-- Term√≥metro Visual -->
                <div
                  style="position: relative; height: 200px; width: 40px; margin: 0 auto; background: #f1f5f9; border-radius: 20px; overflow: hidden;">
                  <!-- Zona P√©rdidas -->
                  <div
                    style="position: absolute; bottom: 0; left: 0; right: 0; height: 50%; background: rgba(239, 68, 68, 0.2); border-top: 1px dashed #ef4444;">
                  </div>
                  <!-- Zona Ganancias -->
                  <div
                    style="position: absolute; top: 0; left: 0; right: 0; height: 50%; background: rgba(16, 185, 129, 0.2);">
                  </div>

                  <!-- Nivel Actual -->
                  <div id="pl-termometro-fill"
                    style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, #3b82f6, #6366f1); transition: height 1s cubic-bezier(0.4, 0, 0.2, 1); height: 0%;">
                  </div>

                  <!-- L√≠nea de Equilibrio -->
                  <div
                    style="position: absolute; bottom: 50%; left: -10px; right: -10px; height: 2px; background: #1e293b; z-index: 10;">
                  </div>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; font-weight: 600; color: #1e293b;">
                  Nivel de Ventas
                </div>

                <div
                  style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 10px; font-size: 13px; color: #475569; line-height: 1.5; text-align: center;">
                  <span id="pl-mensaje-analisis">Calculando viabilidad...</span>
                </div>
              </div>

              <!-- Card KPIs Adicionales -->
              <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                  <div style="font-size: 12px; color: #64748b;">Margen Bruto Promedio</div>
                  <div id="pl-kpi-margen" style="font-size: 20px; font-weight: 700; color: #1e293b;">0%</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                  <div style="font-size: 12px; color: #64748b;">Ventas Diarias Promedio</div>
                  <div id="pl-kpi-ventas-diarias" style="font-size: 20px; font-weight: 700; color: #1e293b;">0.00 ‚Ç¨
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Modales (simplificados) -->
      <div id="modal-producir" class="modal">
        <div class="modal-content">
          <h3>Producir platos</h3>
          <p style="margin-bottom: 20px;">¬øCu√°ntas unidades de <strong id="modal-plato-nombre"></strong>?</p>
          <div class="form-group">
            <label>Cantidad</label>
            <input type="number" id="modal-cantidad" min="1" value="1" style="width:100%;padding:10px;"
              oninput="window.actualizarDetalleDescuento()">
          </div>
          <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 6px;">
            <strong>‚ö†Ô∏è Descuento de stock:</strong>
            <div id="modal-descuento-detalle" style="margin-top: 10px;"></div>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="window.cerrarModalProducir()">Cancelar</button>
            <button class="btn btn-success" onclick="window.confirmarProduccion()">Confirmar</button>
          </div>
        </div>
      </div>

      <div id="modal-ver-proveedor" class="modal">
        <div class="modal-content">
          <h3 id="modal-proveedor-titulo"></h3>
          <div id="modal-proveedor-contenido"></div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="window.cerrarModalVerProveedor()">Cerrar</button>
          </div>
        </div>
      </div>

      <!-- Modal ver detalles pedido -->
      <div id="modal-ver-pedido" class="modal">
        <div class="modal-content" style="max-width: 800px;">
          <h3>Detalles del Pedido</h3>
          <div id="modal-ver-pedido-contenido"></div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="window.cerrarModalVerPedido()">Cerrar</button>
            <button class="btn btn-primary" onclick="window.descargarPedidoPDF()" id="btn-descargar-pdf">
              üìÑ Descargar PDF
            </button>
          </div>
        </div>
      </div>

      <!-- Modal recibir pedido -->
      <div id="modal-recibir-pedido" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <h3>Recibir Pedido</h3>
          <p style="margin-bottom: 20px; color: #666;">
            Verifica las cantidades y precios recibidos. Puedes ajustar los valores si hay diferencias.
          </p>

          <div style="background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>Proveedor:</strong> <span id="modal-rec-proveedor"></span><br>
            <strong>Fecha pedido:</strong> <span id="modal-rec-fecha"></span><br>
            <strong>Total original:</strong> <span id="modal-rec-total-original"></span>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">Ingredientes del pedido:</h4>
            <table style="font-size: 13px;">
              <thead>
                <tr>
                  <th>Ingrediente</th>
                  <th>Pedido</th>
                  <th>Recibido</th>
                  <th>Precio Ped.</th>
                  <th>Precio Real</th>
                  <th>Subtotal</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="modal-rec-items"></tbody>
            </table>
          </div>

          <div
            style="background: #f0fdf4; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
              <div>
                <strong style="color: #666;">Total Original:</strong><br>
                <span style="font-size: 20px; font-weight: bold; color: #333;" id="modal-rec-resumen-original">0.00
                  ‚Ç¨</span>
              </div>
              <div>
                <strong style="color: #666;">Total Recibido:</strong><br>
                <span style="font-size: 20px; font-weight: bold; color: #059669;" id="modal-rec-resumen-recibido">0.00
                  ‚Ç¨</span>
              </div>
              <div>
                <strong style="color: #666;">Varianza:</strong><br>
                <span style="font-size: 20px; font-weight: bold;" id="modal-rec-resumen-varianza">0.00 ‚Ç¨</span>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="window.cerrarModalRecibirPedido()">Cancelar</button>
            <button class="btn btn-success" onclick="window.confirmarRecepcionPedido()">Confirmar Recepci√≥n</button>
          </div>
        </div>
      </div>

      <!-- API Client robusto que maneja errores y previene TypeErrors -->
      <script src="api.js"></script>

      <script>
        // C√≥digo JavaScript completo (por brevedad, incluyo versi√≥n funcional comprimida)
        // El c√≥digo completo est√° disponible en el archivo descargable


        (function () {
          window.ingredientes = [];
          window.recetas = [];
          window.proveedores = [];
          window.pedidos = [];
          let editandoIngredienteId = null;
          let editandoRecetaId = null;
          let editandoProveedorId = null;
          let recetaProduciendo = null;
          let chartRentabilidad = null;
          let chartIngredientes = null;

          // === UTILIDADES ===
          window.showToast = function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };

            toast.innerHTML = `
          <div class="toast-icon">${icons[type]}</div>
          <div class="toast-message">${message}</div>
        `;

            container.appendChild(toast);
            setTimeout(() => {
              toast.style.animation = 'slideIn 0.3s ease reverse';
              setTimeout(() => toast.remove(), 300);
            }, 3000);
          }

          function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
          }

          function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
          }
          // === EXPORT A EXCEL ===
          function exportarAExcel(datos, nombreArchivo, columnas) {
            // Preparar datos para Excel
            const datosExcel = datos.map(item => {
              const fila = {};
              columnas.forEach(col => {
                fila[col.header] = col.key ? item[col.key] : col.value(item);
              });
              return fila;
            });

            // Crear libro y hoja
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datosExcel);

            // Ajustar ancho de columnas
            ws['!cols'] = columnas.map(() => ({ wch: 20 }));

            XLSX.utils.book_append_sheet(wb, ws, "Datos");

            // Descargar
            XLSX.writeFile(wb, `${nombreArchivo}_${new Date().toISOString().split('T')[0]}.xlsx`);

            showToast('Excel descargado correctamente', 'success');
          }
          // === EXPORTACIONES ESTANDARIZADAS (Formato TPV) ===
          function exportarIngredientes() {
            const columnas = [
              { header: 'ID', key: 'id' },
              { header: 'C√≥digo', value: (ing) => `ING-${String(ing.id).padStart(4, '0')}` },
              { header: 'Nombre', key: 'nombre' },
              { header: 'Categor√≠a', value: (ing) => ing.familia || ing.categoria || 'alimento' },
              {
                header: 'Proveedor', value: (ing) => {
                  const prov = window.proveedores.find(p => p.id === ing.proveedor_id);
                  return prov ? prov.nombre : 'Sin proveedor';
                }
              },
              { header: 'Precio Unitario (‚Ç¨)', value: (ing) => parseFloat(ing.precio || 0).toFixed(2) },
              { header: 'Unidad', key: 'unidad' },
              { header: 'Stock Actual', value: (ing) => parseFloat(ing.stock_actual || ing.stockActual || 0).toFixed(2) },
              { header: 'Stock M√≠nimo', value: (ing) => parseFloat(ing.stock_minimo || ing.stockMinimo || 0).toFixed(2) },
              { header: 'Fecha Actualizaci√≥n', value: () => new Date().toLocaleDateString('es-ES') }
            ];
            exportarAExcel(window.ingredientes, 'Ingredientes_LaCaleta', columnas);
          }

          function exportarRecetas() {
            const columnas = [
              { header: 'ID', key: 'id' },
              { header: 'C√≥digo', value: (rec) => rec.codigo || `REC-${String(rec.id).padStart(4, '0')}` },
              { header: 'Nombre', key: 'nombre' },
              { header: 'Categor√≠a', key: 'categoria' },
              { header: 'Precio Venta (‚Ç¨)', value: (rec) => parseFloat(rec.precio_venta || 0).toFixed(2) },
              {
                header: 'Coste (‚Ç¨)', value: (rec) => {
                  return (rec.ingredientes || []).reduce((sum, item) => {
                    const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
                    return sum + (ing ? parseFloat(ing.precio) * parseFloat(item.cantidad) : 0);
                  }, 0).toFixed(2);
                }
              },
              {
                header: 'Margen (‚Ç¨)', value: (rec) => {
                  const coste = (rec.ingredientes || []).reduce((sum, item) => {
                    const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
                    return sum + (ing ? parseFloat(ing.precio) * parseFloat(item.cantidad) : 0);
                  }, 0);
                  return (parseFloat(rec.precio_venta || 0) - coste).toFixed(2);
                }
              },
              {
                header: 'Margen (%)', value: (rec) => {
                  const coste = (rec.ingredientes || []).reduce((sum, item) => {
                    const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
                    return sum + (ing ? parseFloat(ing.precio) * parseFloat(item.cantidad) : 0);
                  }, 0);
                  const margen = rec.precio_venta > 0 ? ((parseFloat(rec.precio_venta) - coste) / parseFloat(rec.precio_venta) * 100) : 0;
                  return margen.toFixed(1) + '%';
                }
              },
              { header: 'Porciones', key: 'porciones' },
              { header: 'N¬∫ Ingredientes', value: (rec) => (rec.ingredientes || []).length }
            ];
            exportarAExcel(window.recetas, 'Recetas_LaCaleta', columnas);
          }

          function exportarVentas() {
            const columnas = [
              { header: 'ID', key: 'id' },
              { header: 'Fecha', value: (v) => new Date(v.fecha).toLocaleDateString('es-ES') },
              { header: 'Hora', value: (v) => new Date(v.fecha).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) },
              {
                header: 'C√≥digo Receta', value: (v) => {
                  const rec = window.recetas.find(r => r.id === v.receta_id);
                  return rec?.codigo || `REC-${String(v.receta_id).padStart(4, '0')}`;
                }
              },
              { header: 'Descripci√≥n', value: (v) => v.receta_nombre || (window.recetas.find(r => r.id === v.receta_id)?.nombre || 'Desconocida') },
              { header: 'Cantidad', key: 'cantidad' },
              { header: 'Precio Unitario (‚Ç¨)', value: (v) => parseFloat(v.precio_unitario || 0).toFixed(2) },
              { header: 'Total (‚Ç¨)', value: (v) => parseFloat(v.total || 0).toFixed(2) }
            ];
            api.getSales().then(ventas => exportarAExcel(ventas, 'Ventas_LaCaleta', columnas));
          }

          // Exportar Pedidos (nueva funci√≥n)
          function exportarPedidos() {
            const columnas = [
              { header: 'ID', key: 'id' },
              { header: 'Fecha Pedido', value: (p) => new Date(p.fecha).toLocaleDateString('es-ES') },
              {
                header: 'Proveedor', value: (p) => {
                  const prov = window.proveedores.find(pr => pr.id === p.proveedor_id);
                  return prov ? prov.nombre : 'Sin proveedor';
                }
              },
              { header: 'Estado', key: 'estado' },
              { header: 'N¬∫ Ingredientes', value: (p) => (p.ingredientes || []).length },
              { header: 'Total (‚Ç¨)', value: (p) => parseFloat(p.total || 0).toFixed(2) },
              { header: 'Total Recibido (‚Ç¨)', value: (p) => parseFloat(p.total_recibido || 0).toFixed(2) },
              { header: 'Fecha Recepci√≥n', value: (p) => p.fecha_recepcion ? new Date(p.fecha_recepcion).toLocaleDateString('es-ES') : '-' }
            ];
            exportarAExcel(window.pedidos, 'Pedidos_LaCaleta', columnas);
          }

          // Exponer funciones globalmente
          window.exportarIngredientes = exportarIngredientes;
          window.exportarRecetas = exportarRecetas;
          window.exportarVentas = exportarVentas;
          window.exportarPedidos = exportarPedidos;
          // === ACTUALIZAR KPIs ===
          window.actualizarKPIs = function () {
            // 1. INGRESOS TOTALES (suma de ventas)
            api.getSales().then(ventas => {
              const ingresos = ventas.reduce((sum, v) => sum + parseFloat(v.total), 0);
              document.getElementById('kpi-ingresos').textContent = ingresos.toFixed(0) + '‚Ç¨';
            }).catch(() => {
              document.getElementById('kpi-ingresos').textContent = '0‚Ç¨';
            });

            // 2. PEDIDOS ACTIVOS
            const pedidosActivos = window.pedidos.filter(p => p.estado === 'pendiente').length;
            document.getElementById('kpi-pedidos').textContent = pedidosActivos;

            // 3. STOCK BAJO
            const stockBajo = window.ingredientes.filter(ing => {
              const stockActual = parseFloat(ing.stock_actual) || 0;
              const stockMinimo = parseFloat(ing.stock_minimo) || 0;
              return stockMinimo > 0 && stockActual <= stockMinimo;
            }).length;
            document.getElementById('kpi-stock').textContent = stockBajo;
            document.getElementById('kpi-stock-msg').textContent =
              stockBajo > 0 ? 'Requieren atenci√≥n' : 'Todo OK';

            // 4. MARGEN PROMEDIO
            if (window.recetas.length > 0) {
              let totalMargen = 0;
              window.recetas.forEach(rec => {
                const coste = rec.ingredientes.reduce((sum, item) => {
                  const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
                  return sum + (ing ? parseFloat(ing.precio) * item.cantidad : 0);
                }, 0);
                const precioVenta = parseFloat(rec.precio_venta) || 0;
                const margen = precioVenta > 0 ? ((precioVenta - coste) / precioVenta) * 100 : 0;
                totalMargen += margen;
              });
              const margenPromedio = (totalMargen / window.recetas.length).toFixed(0);
              document.getElementById('kpi-margen').textContent = margenPromedio + '%';
            } else {
              document.getElementById('kpi-margen').textContent = '0%';
            }
          };

          // === GR√ÅFICO INGRESOS VS GASTOS ===
          async function renderRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (!ctx || typeof Chart === 'undefined') return;

            // Obtener datos reales de los √∫ltimos 7 d√≠as
            const labels = [];
            const ingresos = [];
            const costos = [];

            for (let i = 6; i >= 0; i--) {
              const fecha = new Date();
              fecha.setDate(fecha.getDate() - i);
              const fechaStr = fecha.toISOString().split('T')[0];
              const diaSemana = fecha.toLocaleDateString('es-ES', { weekday: 'short' });
              labels.push(diaSemana.charAt(0).toUpperCase() + diaSemana.slice(1));

              // Filtrar ventas de ese d√≠a
              try {
                const ventas = await api.getSales();
                const ventasDia = ventas.filter(v => v.fecha.split('T')[0] === fechaStr);
                const ingresoDia = ventasDia.reduce((sum, v) => sum + parseFloat(v.total), 0);
                ingresos.push(ingresoDia);

                // Calcular costos de ese d√≠a (basado en ingredientes de recetas vendidas)
                let costoDia = 0;
                for (const venta of ventasDia) {
                  const receta = window.recetas.find(r => r.id === venta.receta_id);
                  if (receta && receta.ingredientes) {
                    for (const item of receta.ingredientes) {
                      const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
                      if (ing) {
                        costoDia += parseFloat(ing.precio) * item.cantidad * venta.cantidad;
                      }
                    }
                  }
                }
                costos.push(costoDia);
              } catch (e) {
                ingresos.push(0);
                costos.push(0);
              }
            }

            // Destruir gr√°fico anterior si existe
            if (window.revenueChartInstance) {
              window.revenueChartInstance.destroy();
            }

            window.revenueChartInstance = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Ingresos',
                  data: ingresos,
                  borderColor: '#10B981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  fill: true,
                  tension: 0.4,
                  borderWidth: 3
                }, {
                  label: 'Costos',
                  data: costos,
                  borderColor: '#EF4444',
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  fill: true,
                  tension: 0.4,
                  borderWidth: 3
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    position: 'top',
                    labels: { usePointStyle: true, padding: 20, font: { size: 14, weight: '600' } }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: { callback: value => value + '‚Ç¨', font: { size: 12 } }
                  },
                  x: { grid: { display: false }, ticks: { font: { size: 12 } } }
                }
              }
            });
          }
          // === VENTAS ===
          window.renderizarVentas = async function () {
            const select = document.getElementById('venta-receta');
            select.innerHTML = '<option value="">Selecciona un plato...</option>';
            window.recetas.forEach(r => {
              select.innerHTML += `<option value="${r.id}">${r.nombre} - ${r.precio_venta}‚Ç¨</option>`;
            });

            // Obtener rango de fechas
            const fechaDesde = document.getElementById('ventas-fecha-desde')?.value;
            const fechaHasta = document.getElementById('ventas-fecha-hasta')?.value;

            try {
              const ventas = await api.getSales();

              // Filtrar por fechas si hay filtros
              let ventasFiltradas = ventas;
              if (fechaDesde) {
                ventasFiltradas = ventasFiltradas.filter(v => v.fecha >= fechaDesde);
              }
              if (fechaHasta) {
                ventasFiltradas = ventasFiltradas.filter(v => v.fecha <= fechaHasta + 'T23:59:59');
              }

              // Agrupar por d√≠a
              const ventasPorDia = {};
              ventasFiltradas.forEach(v => {
                const dia = v.fecha.split('T')[0];
                if (!ventasPorDia[dia]) ventasPorDia[dia] = [];
                ventasPorDia[dia].push(v);
              });

              let html = '<table><thead><tr><th>Fecha</th><th>Hora</th><th>Plato</th><th>Cantidad</th><th>Total</th><th>Acciones</th></tr></thead><tbody>';
              let totalGeneral = 0;

              Object.keys(ventasPorDia).sort().reverse().forEach(dia => {
                // Header de fecha
                html += `<tr style="background:#F8FAFC;"><td colspan="5" style="padding:12px 16px;font-weight:700;color:#1E293B;border-top:2px solid #E2E8F0;">${new Date(dia).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</td></tr>`;

                // Ventas de ese d√≠a
                ventasPorDia[dia].forEach(v => {
                  const hora = new Date(v.fecha).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                  const fecha = new Date(v.fecha).toLocaleDateString('es-ES');
                  html += `<tr><td style="padding:8px 16px 8px 32px;color:#64748B;">${fecha}</td><td style="padding:8px 16px;color:#64748B;">${hora}</td><td style="padding:8px 16px;color:#1E293B;">${v.receta_nombre}</td><td style="padding:8px 16px;text-align:center;color:#64748B;">${v.cantidad}</td><td style="padding:8px 16px;text-align:right;"><strong style="color:#1E293B;">${parseFloat(v.total).toFixed(2)}‚Ç¨</strong></td><td style="padding:8px 16px;text-align:center;"><button class="icon-btn delete" onclick="window.eliminarVenta(${v.id})" title="Eliminar">üóëÔ∏è</button></td></tr>`;
                  totalGeneral += parseFloat(v.total);
                });
              });

              html += `<tr style="background:#10b981;color:white;font-weight:700;font-size:16px;"><td colspan="4">TOTAL</td><td>${totalGeneral.toFixed(2)}‚Ç¨</td></tr>`;
              html += '</tbody></table>';

              document.getElementById('tabla-ventas').innerHTML = html;
            } catch (error) {
              document.getElementById('tabla-ventas').innerHTML = '<p style="color:#ef4444;">Error cargando ventas</p>';
            }
          };
          window.eliminarVenta = async function (id) {
            if (!confirm('¬øEliminar esta venta? El stock NO se restaurar√° autom√°ticamente.')) return;

            try {
              await api.deleteSale(id);
              await cargarDatos();
              renderizarVentas();
              renderizarIngredientes();
              renderizarInventario();
              window.actualizarKPIs();
              window.actualizarDashboardExpandido();
              showToast('Venta eliminada', 'success');
            } catch (error) {
              console.error('Error:', error);
              showToast('Error eliminando venta', 'error');
            }
          };
          // === BALANCE ===
          // === P&L UNIFICADO (Cuenta de Resultados) ===
          window.renderizarBalance = async function () {
            try {
              // 1. Cargar gastos fijos desde la BD (fuente de verdad)
              try {
                const gastosFijos = await window.API.getGastosFijos();
                if (gastosFijos && gastosFijos.length > 0) {
                  // Mapear gastos fijos a los inputs
                  gastosFijos.forEach(gasto => {
                    const concepto = gasto.concepto.toLowerCase();
                    const monto = parseFloat(gasto.monto_mensual) || 0;
                    if (concepto.includes('alquiler')) {
                      const el = document.getElementById('pl-input-alquiler');
                      if (el) el.value = monto;
                    } else if (concepto.includes('personal')) {
                      const el = document.getElementById('pl-input-personal');
                      if (el) el.value = monto;
                    } else if (concepto.includes('suministro')) {
                      const el = document.getElementById('pl-input-suministros');
                      if (el) el.value = monto;
                    } else if (concepto.includes('otros')) {
                      const el = document.getElementById('pl-input-otros');
                      if (el) el.value = monto;
                    }
                  });
                }
              } catch (error) {
                console.warn('Using localStorage for gastos fijos:', error.message);
                // Fallback a localStorage si falla la BD
                const savedOpex = JSON.parse(localStorage.getItem('opex_inputs') || '{}');
                const alquilerEl = document.getElementById('pl-input-alquiler');
                const personalEl = document.getElementById('pl-input-personal');
                const suministrosEl = document.getElementById('pl-input-suministros');
                const otrosEl = document.getElementById('pl-input-otros');
                if (alquilerEl && savedOpex.alquiler) alquilerEl.value = savedOpex.alquiler;
                if (personalEl && savedOpex.personal) personalEl.value = savedOpex.personal;
                if (suministrosEl && savedOpex.suministros) suministrosEl.value = savedOpex.suministros;
                if (otrosEl && savedOpex.otros) otrosEl.value = savedOpex.otros;
              }

              // 2. Obtener Datos Reales (Ventas y Costes)
              const ventas = await api.getSales();

              // Filtrar ventas del mes actual
              const ahora = new Date();
              const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1).toISOString().split('T')[0];
              const ventasMes = ventas.filter(v => v.fecha >= inicioMes);

              const ingresos = ventasMes.reduce((sum, v) => sum + parseFloat(v.total), 0);

              // Calcular COGS (Coste de lo vendido)
              let cogs = 0;
              ventasMes.forEach(venta => {
                const receta = window.recetas.find(r => r.id === venta.receta_id);
                if (receta && receta.ingredientes) {
                  const costeReceta = receta.ingredientes.reduce((sum, item) => {
                    const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
                    return sum + (ing ? parseFloat(ing.precio) * item.cantidad : 0);
                  }, 0);
                  cogs += costeReceta * venta.cantidad;
                }
              });

              // 3. Actualizar UI (Parte Superior)
              document.getElementById('pl-ingresos').textContent = ingresos.toFixed(2) + ' ‚Ç¨';
              document.getElementById('pl-cogs').textContent = cogs.toFixed(2) + ' ‚Ç¨';

              const cogsPct = ingresos > 0 ? (cogs / ingresos) * 100 : 0;
              document.getElementById('pl-cogs-pct').textContent = cogsPct.toFixed(1) + '% sobre ventas';

              const margenBruto = ingresos - cogs;
              document.getElementById('pl-margen-bruto').textContent = margenBruto.toFixed(2) + ' ‚Ç¨';

              // KPIs Adicionales
              const margenPct = ingresos > 0 ? (margenBruto / ingresos) * 100 : 0;
              document.getElementById('pl-kpi-margen').textContent = margenPct.toFixed(1) + '%';

              // Ventas diarias promedio (del mes)
              const diaDelMes = ahora.getDate();
              const ventasDiarias = ingresos / diaDelMes;
              document.getElementById('pl-kpi-ventas-diarias').textContent = ventasDiarias.toFixed(2) + ' ‚Ç¨';

              // 4. Calcular Resto (OPEX y Neto)
              window.calcularPL();

            } catch (error) {
              console.error('Error renderizando P&L:', error);
              showToast('Error cargando datos financieros', 'error');
            }
          };

          window.calcularPL = function () {
            // Validar que los elementos existan antes de acceder
            const ingresosEl = document.getElementById('pl-ingresos');
            const cogsEl = document.getElementById('pl-cogs');
            const alquilerEl = document.getElementById('pl-input-alquiler');
            const personalEl = document.getElementById('pl-input-personal');
            const suministrosEl = document.getElementById('pl-input-suministros');
            const otrosEl = document.getElementById('pl-input-otros');

            if (!ingresosEl || !cogsEl || !alquilerEl || !personalEl || !suministrosEl || !otrosEl) {
              console.warn('Inputs de P&L no cargados a√∫n');
              return;
            }

            // 1. Leer Valores
            const ingresosStr = ingresosEl.textContent.replace(' ‚Ç¨', '').replace(',', '.');
            const cogsStr = cogsEl.textContent.replace(' ‚Ç¨', '').replace(',', '.');

            const ingresos = parseFloat(ingresosStr) || 0;
            const cogs = parseFloat(cogsStr) || 0;
            const margenBruto = ingresos - cogs;

            // Leer Inputs OPEX
            const alquiler = parseFloat(alquilerEl.value) || 0;
            const personal = parseFloat(personalEl.value) || 0;
            const suministros = parseFloat(suministrosEl.value) || 0;
            const otros = parseFloat(otrosEl.value) || 0;

            // Guardar en LocalStorage
            localStorage.setItem('opex_inputs', JSON.stringify({ alquiler, personal, suministros, otros }));

            const opexTotal = alquiler + personal + suministros + otros;
            document.getElementById('pl-opex-total').textContent = opexTotal.toFixed(2) + ' ‚Ç¨';

            // 2. Calcular Neto
            const beneficioNeto = margenBruto - opexTotal;
            const netoEl = document.getElementById('pl-neto');

            netoEl.textContent = beneficioNeto.toFixed(2) + ' ‚Ç¨';
            netoEl.style.color = beneficioNeto >= 0 ? '#10b981' : '#ef4444'; // Verde o Rojo

            const rentabilidad = ingresos > 0 ? (beneficioNeto / ingresos) * 100 : 0;
            document.getElementById('pl-neto-pct').textContent = rentabilidad.toFixed(1) + '% Rentabilidad';

            // 3. An√°lisis Break-Even (Punto de Equilibrio)
            // BEP = Costes Fijos / (Margen Contribuci√≥n %)
            // Margen Contribuci√≥n % = (Ventas - Costes Variables) / Ventas
            let margenContribucionPct = 0.70; // Default 70% si no hay ventas
            if (ingresos > 0) {
              margenContribucionPct = margenBruto / ingresos;
            }

            // Evitar divisi√≥n por cero o m√°rgenes negativos locos
            if (margenContribucionPct <= 0) margenContribucionPct = 0.1;

            const breakEven = opexTotal / margenContribucionPct;
            document.getElementById('pl-breakeven').textContent = breakEven.toFixed(2) + ' ‚Ç¨';

            // 4. Actualizar Term√≥metro y Estado
            const estadoBadge = document.getElementById('pl-badge-estado');
            const termometroFill = document.getElementById('pl-termometro-fill');
            const mensajeAnalisis = document.getElementById('pl-mensaje-analisis');

            // Porcentaje de cumplimiento del Break Even
            // Si BreakEven es 1000 y Ingresos son 500 -> 50% (Zona P√©rdidas)
            // Si BreakEven es 1000 y Ingresos son 1000 -> 100% (Equilibrio)
            // Si BreakEven es 1000 y Ingresos son 1500 -> 150% (Beneficios)

            let porcentajeCumplimiento = 0;
            if (breakEven > 0) {
              porcentajeCumplimiento = (ingresos / breakEven) * 100;
            } else if (opexTotal === 0) {
              porcentajeCumplimiento = 100; // Si no hay gastos, todo es beneficio
            }

            // Mapear porcentaje a altura del term√≥metro (0-100%)
            // Queremos que el 100% (Equilibrio) est√© en la mitad (50%)
            // 0% cumplimiento -> 0% altura
            // 100% cumplimiento -> 50% altura
            // 200% cumplimiento -> 100% altura
            let alturaTermometro = porcentajeCumplimiento / 2;
            if (alturaTermometro > 100) alturaTermometro = 100;

            termometroFill.style.height = `${alturaTermometro}%`;

            // Colores y Mensajes
            if (ingresos < breakEven) {
              // P√âRDIDAS
              estadoBadge.textContent = 'EN P√âRDIDAS';
              estadoBadge.style.background = '#fee2e2';
              estadoBadge.style.color = '#991b1b';

              const falta = breakEven - ingresos;
              mensajeAnalisis.innerHTML = `Te faltan <strong>${falta.toFixed(0)}‚Ç¨</strong> para cubrir gastos.<br>Est√°s al <strong>${porcentajeCumplimiento.toFixed(0)}%</strong> del objetivo.`;
            } else {
              // BENEFICIOS
              estadoBadge.textContent = 'EN BENEFICIOS';
              estadoBadge.style.background = '#d1fae5';
              estadoBadge.style.color = '#065f46';

              const sobra = ingresos - breakEven;
              mensajeAnalisis.innerHTML = `¬°Enhorabuena! Cubres gastos y generas <strong>${beneficioNeto.toFixed(0)}‚Ç¨</strong> de beneficio.<br>Superas el equilibrio por <strong>${sobra.toFixed(0)}‚Ç¨</strong>.`;
            }
          };


          // ========== AUTENTICACI√ìN ==========
          const API_AUTH_URL = 'https://lacaleta-api.mindloop.cloud/api/auth';

          function checkAuth() {
            const token = localStorage.getItem('token');
            if (token) {
              document.getElementById('login-screen').style.display = 'none';
              document.getElementById('app-container').style.display = 'block';
              return true;
            }
            return false;
          }

          document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            try {
              const res = await fetch(API_AUTH_URL + '/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
              });

              const data = await res.json();

              if (!res.ok) {
                errorEl.textContent = data.error || 'Error al iniciar sesi√≥n';
                return;
              }

              localStorage.setItem('token', data.token);
              localStorage.setItem('user', JSON.stringify(data.user));

              document.getElementById('login-screen').style.display = 'none';
              document.getElementById('app-container').style.display = 'block';

              init();
            } catch (err) {
              errorEl.textContent = 'Error de conexi√≥n';
            }
          });

          window.logout = function () {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            location.reload();
          };


          // ========== GESTI√ìN DE EQUIPO (Team Management) ==========
          window.renderizarEquipo = async function () {
            const tbody = document.getElementById('lista-equipo-body');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Cargando equipo...</td></tr>';

            try {
              const users = await api.getTeam();

              // Update restaurant info
              const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
              document.getElementById('config-restaurante-nombre').textContent = currentUser.restaurante || 'Mi Restaurante';
              document.getElementById('config-restaurante-id').textContent = currentUser.restauranteId || '...';

              if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No hay usuarios en el equipo</td></tr>';
                return;
              }

              let html = '';
              users.forEach(user => {
                const fechaAlta = new Date(user.fecha_registro).toLocaleDateString('es-ES');
                const isMe = user.id === currentUser.id;
                const roleBadge = user.rol === 'admin'
                  ? '<span style="background:#FEF3C7; color:#D97706; padding:2px 8px; border-radius:12px; font-size:12px; font-weight:600;">Admin</span>'
                  : '<span style="background:#E0F2FE; color:#0284C7; padding:2px 8px; border-radius:12px; font-size:12px; font-weight:600;">Usuario</span>';

                html += `
            <tr style="border-bottom:1px solid #f0f0f0;">
              <td style="padding:12px;"><strong>${user.nombre}</strong> ${isMe ? '(T√∫)' : ''}</td>
              <td style="padding:12px; color:#666;">${user.email}</td>
              <td style="padding:12px;">${roleBadge}</td>
              <td style="padding:12px; color:#999;">${fechaAlta}</td>
              <td style="padding:12px; text-align:right;">
                ${!isMe && currentUser.rol === 'admin' ?
                    `<button onclick="window.eliminarUsuarioEquipo(${user.id})" class="icon-btn delete" title="Eliminar acceso">üóëÔ∏è</button>`
                    : ''}
              </td>
            </tr>
          `;
              });
              tbody.innerHTML = html;

            } catch (error) {
              console.error('Error renderizando equipo:', error);
              tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red; padding:20px;">Error: ${error.message}</td></tr>`;
            }
          };

          window.mostrarModalInvitar = function () {
            document.getElementById('modal-invitar-equipo').classList.add('active');
          };

          window.invitarUsuarioEquipo = async function () {
            const nombre = document.getElementById('team-nombre').value;
            const email = document.getElementById('team-email').value;
            const password = document.getElementById('team-password').value;
            const rol = document.getElementById('team-rol').value;

            if (!nombre || !email || !password) {
              showToast('Completa todos los campos', 'warning');
              return;
            }

            showLoading();
            try {
              await api.inviteUser(nombre, email, password, rol);
              hideLoading();
              showToast('Invitaci√≥n enviada y usuario creado', 'success');
              document.getElementById('modal-invitar-equipo').classList.remove('active');

              // Limpiar form
              document.getElementById('team-nombre').value = '';
              document.getElementById('team-email').value = '';
              document.getElementById('team-password').value = '';

              // Recargar lista
              renderizarEquipo();
            } catch (error) {
              hideLoading();
              showToast(error.message, 'error');
            }
          };

          window.eliminarUsuarioEquipo = async function (id) {
            if (!confirm('¬øEst√°s seguro de eliminar el acceso a este usuario?')) return;

            showLoading();
            try {
              await api.deleteUser(id);
              hideLoading();
              showToast('Usuario eliminado del equipo', 'success');
              renderizarEquipo();
            } catch (error) {
              hideLoading();
              showToast(error.message, 'error');
            }
          };

          // ========== SIMULADOR FINANCIERO ==========
          window.actualizarSimulador = function () {
            const alquiler = parseInt(document.getElementById('input-alquiler').value) || 0;
            const personal = parseInt(document.getElementById('input-personal').value) || 0;
            const suministros = parseInt(document.getElementById('input-suministros').value) || 0;

            // Actualizar etiquetas
            document.getElementById('label-alquiler').textContent = alquiler.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('label-personal').textContent = personal.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('label-suministros').textContent = suministros.toLocaleString('es-ES') + ' ‚Ç¨';


            // Obtener Margen Bruto (Ingresos - Coste Recetas)
            // Usamos el valor calculado previamente en renderizarBalance
            const margenBrutoElem = document.getElementById('balance-ganancia');
            let margenBruto = 0;

            if (margenBrutoElem) {
              // El valor en balance-ganancia viene de .toFixed(2) + '‚Ç¨' -> "2172.01‚Ç¨"
              // OJO: Si se cambia el locale, esto podr√≠a variar. Asumimos formato standard JS (punto decimal)
              // Si fuera locale string (con puntos de mil), habr√≠a que limpiar puntos y cambiar coma por punto.
              // Para seguridad, limpiamos todo excepto d√≠gitos, punto y menos.
              const text = margenBrutoElem.textContent;
              // Si contiene "‚Ç¨", lo quitamos.
              // Si el formato es "2.172,01" (ES) vs "2172.01" (US/JS)
              // renderizarBalance usa .toFixed(2) -> "2172.01" (US format)
              const cleanText = text.replace('‚Ç¨', '').trim();
              margenBruto = parseFloat(cleanText);

              if (isNaN(margenBruto)) margenBruto = 0;
            }

            const costosFijos = alquiler + personal + suministros;
            const neto = margenBruto - costosFijos;

            // Actualizar UI Simulador
            document.getElementById('sim-margen-bruto').textContent = margenBruto.toLocaleString('es-ES', { minimumFractionDigits: 2 }) + ' ‚Ç¨';
            document.getElementById('sim-costos-fijos').textContent = costosFijos.toLocaleString('es-ES', { minimumFractionDigits: 2 }) + ' ‚Ç¨';

            const netoElem = document.getElementById('sim-resultado-neto');
            netoElem.textContent = neto.toLocaleString('es-ES', { minimumFractionDigits: 2 }) + ' ‚Ç¨';

            // Color Din√°mico y Barra Progreso
            const progressBar = document.getElementById('sim-progreso-fill');
            const analytics = document.getElementById('sim-analytics');

            let porcentajeCubierto = 0;
            if (costosFijos > 0) {
              porcentajeCubierto = (margenBruto / costosFijos) * 100;
            } else {
              porcentajeCubierto = 100; // Si no hay costos, cubrimos "todo"
            }

            // Limitamos visualmente al 100% para la barra interna (aunque conceptualmente puede pasar)
            const widthPct = Math.min(Math.max(porcentajeCubierto, 0), 100);
            progressBar.style.width = widthPct + '%';

            if (neto >= 0) {
              netoElem.style.color = '#10b981'; // Verde
              progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #34d399 100%)';
              analytics.innerHTML = '<span>üöÄ</span> ¬°Beneficio! Cubres el <strong>' + porcentajeCubierto.toFixed(0) + '%</strong> de tus costes fijos.';
              analytics.style.color = '#059669';
            } else {
              netoElem.style.color = '#ef4444'; // Rojo
              progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #f87171 100%)';
              analytics.innerHTML = '<span>üöë</span> P√©rdidas. Solo cubres el <strong>' + porcentajeCubierto.toFixed(0) + '%</strong> de tus costos fijos.';
              analytics.style.color = '#dc2626';
            }

            // Break-Even Display
            // Punto Equilibrio (Ingresos) = Costos Fijos / %Margen
            // Primero calculamos el % de Margen real
            const ingresosElem = document.getElementById('balance-ingresos');
            let ingresos = 0;
            if (ingresosElem) {
              // Mismo fix de parsing
              const textIng = ingresosElem.textContent.replace('‚Ç¨', '').trim();
              ingresos = parseFloat(textIng) || 0;
            }

            let breakEven = 0;
            if (ingresos > 0) {
              const margenPorcentaje = margenBruto / ingresos;
              if (margenPorcentaje > 0) {
                breakEven = costosFijos / margenPorcentaje;
              }
            }
            document.getElementById('break-even-display').textContent = breakEven.toLocaleString('es-ES', { minimumFractionDigits: 2 }) + ' ‚Ç¨';

            // Barra de Progreso (Visualizaci√≥n simple: % de cubrimiento de costos fijos)
            const progresoFill = document.getElementById('sim-progreso-fill');
            let porcentajeCobertura = 0;
            if (costosFijos > 0) {
              porcentajeCobertura = (margenBruto / costosFijos) * 100;
            } else if (margenBruto > 0) {
              porcentajeCobertura = 100;
            }

            if (porcentajeCobertura > 100) porcentajeCobertura = 100;
            progresoFill.style.width = porcentajeCobertura + '%';

            // Actualizar tambi√©n la Card de Beneficio Neto superior
            document.getElementById('balance-neto').textContent = neto.toLocaleString('es-ES', { minimumFractionDigits: 2 }) + ' ‚Ç¨';

            if (neto >= 0) {
              document.getElementById('balance-mensaje-neto').textContent = 'P√©rdida Real';
              document.getElementById('balance-mensaje-neto').style.color = '#ffccc7';
            }
          };

          // ========== MANUAL DOBLE (Printable) ==========
          window.abrirManualFormulas = function () {
            const ventana = window.open('', '_blank');
            const html = `
            <!DOCTYPE html>
            <html lang="es">
            <head>
              <meta charset="UTF-8">
              <base href="${window.location.href}">
              <title>Dossier T√©cnico - MindLoop CostOS</title>
              <style>
                body { font-family: 'Segoe UI', system-ui, sans-serif; line-height: 1.6; max-width: 800px; margin: 40px auto; color: #333; }
                h1 { border-bottom: 2px solid #6366f1; padding-bottom: 10px; color: #1e293b; margin-top: 10px; }
                .logo-header { text-align: center; margin-bottom: 20px; }
                .logo-header img { max-height: 80px; }
                h2 { margin-top: 30px; color: #334155; border-left: 4px solid #6366f1; padding-left: 10px; }
                h3 { color: #64748b; margin-top: 20px; }
                .formula { background: #f1f5f9; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 1.1em; border: 1px solid #e2e8f0; margin: 10px 0; }
                .example { background: #ecfdf5; padding: 15px; border-radius: 8px; font-size: 0.9em; border: 1px solid #a7f3d0; margin-top: 10px; color: #065f46; }
                @media print { body { max-width: 100%; margin: 20px; } .no-print { display: none; } }
              </style>
            </head>
            <body>
              <div class="no-print" style="margin-bottom: 30px; padding: 20px; background: #EEF2FF; border-radius: 8px; border: 1px solid #C7D2FE;">
                 <p style="margin-top:0;"><strong>üí° Para guardar como PDF:</strong></p>
                 <ol style="margin-bottom:15px;">
                   <li>Haz clic en el bot√≥n <strong>"Imprimir"</strong> de abajo.</li>
                   <li>En "Destino" o "Impresora", selecciona <strong>"Guardar como PDF"</strong>.</li>
                   <li>Haz clic en "Guardar".</li>
                 </ol>
                 <button onclick="window.print()" style="padding:10px 20px; background:#6366f1; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">üñ®Ô∏è Imprimir / Guardar PDF</button>
              </div>

              <div class="logo-header">
                <img src="logo.png" onerror="this.style.display='none'">
              </div>

              <h1>üìò Dossier T√©cnico: F√≥rmulas y C√°lculos</h1>
              <p>Documento generado autom√°ticamente por <strong>MindLoop CostOS</strong> para transparencia del cliente.</p>

              <h2>1. ü•ò Gesti√≥n de Recetas (Costing)</h2>
              <h3>Coste de Receta (Food Cost)</h3>
              <p>Suma del coste individual de cada ingrediente seg√∫n su porci√≥n.</p>
              <div class="formula">Coste Receta = Œ£ (Cantidad Ingrediente √ó Precio Unitario)</div>

              <h3>Margen de Beneficio (‚Ç¨) y (%)</h3>
              <p>Ganancia bruta tras descontar el coste de la materia prima.</p>
              <div class="formula">
                Margen (‚Ç¨) = PVP - Coste Receta<br>
                Margen (%) = (Margen ‚Ç¨ / PVP) √ó 100
              </div>

              <h2>2. üì¶ Inventario y Stock</h2>
              <h3>Stock Virtual (Te√≥rico)</h3>
              <div class="formula">Stock Virtual = Stock Anterior + Compras - Ventas (Recetas)</div>

              <h3>Diferencia (Mermas)</h3>
              <div class="formula">Diferencia = Stock Real (Conteo F√≠sico) - Stock Virtual</div>

              <h2>3. ‚öñÔ∏è Simulador Financiero</h2>
              <h3>Resultado Neto Estimado</h3>
              <div class="formula">Resultado Neto = Margen Bruto Real - Costos Fijos (Alquiler + Personal + Suministros)</div>

              <h3>Punto de Equilibrio (Break-Even) üåü</h3>
              <p>Facturaci√≥n necesaria para cubrir todos los gastos (Beneficio 0‚Ç¨).</p>
              <div class="formula">Punto Equilibrio (‚Ç¨) = Costos Fijos / % Margen Bruto Real</div>
              <div class="example">
                <strong>Ejemplo:</strong> Costos Fijos 6.000‚Ç¨ / Margen 0.70 (70%) = <strong>8.571‚Ç¨</strong> de facturaci√≥n necesaria.
              </div>

              <h2>5. ‚ùì Preguntas Frecuentes (FAQ)</h2>
              
              <h3>¬øC√≥mo "adivina" el futuro el Simulador?</h3>
              <p>El sistema no adivina, utiliza tus datos actuales para proyectar:</p>
              <ul>
                <li><strong>1. Analiza tu "Mix":</strong> Revisa qu√© est√°s vendiendo hoy (si vendes m√°s platos de alto margen o de bajo margen).</li>
                <li><strong>2. Proyecta:</strong> Asume que seguir√°s vendiendo con esa misma rentabilidad el resto del mes.</li>
                <li><strong>3. Calcula:</strong> Cruza tus gastos fijos con ese margen promedio real.</li>
              </ul>
              <p><em>Si tu margen cambia ma√±ana (porque vendes platos m√°s rentables), el Punto de Equilibrio bajar√° autom√°ticamente.</em></p>

              <h2>6. üìä Ingenier√≠a de Men√∫ (Matriz BCG)</h2>
              <p>Clasificaci√≥n autom√°tica de platos:</p>
              <ul>
                <li><strong>‚≠ê Estrellas:</strong> Alta Rentabilidad + Alta Popularidad</li>
                <li><strong>üêé Caballos:</strong> Baja Rentabilidad + Alta Popularidad</li>
                <li><strong>‚ùì Puzzles:</strong> Alta Rentabilidad + Baja Popularidad</li>
                <li><strong>üê∂ Perros:</strong> Baja Rentabilidad + Baja Popularidad</li>
              </ul>
              
              <footer style="margin-top: 50px; text-align: center; font-size: 12px; color: #999; border-top: 1px solid #eee; padding-top: 20px;">
                Generado por MindLoop CostOS - ${new Date().toLocaleDateString('es-ES')}
              </footer>
            </body>
            </html>
          `;
            ventana.document.write(html);
            ventana.document.close();
          };

          async function init() {
            // Mostrar nombre del restaurante
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.restaurante) {
              document.getElementById('user-restaurant').textContent = 'üçΩÔ∏è ' + user.restaurante;
            }

            await cargarDatos();
            renderizarIngredientes();
            renderizarRecetas();
            renderizarProveedores();
            renderizarPedidos();
            renderizarInventario();
            renderizarVentas();
            renderizarBalance();
            actualizarKPIs();
            window.actualizarDashboardExpandido();
            document.getElementById('form-venta').addEventListener('submit', async (e) => {
              e.preventDefault();
              const recetaId = document.getElementById('venta-receta').value;
              const cantidad = parseInt(document.getElementById('venta-cantidad').value);

              // Validaciones
              if (!recetaId) {
                showToast('Selecciona un plato', 'error');
                return;
              }
              if (!cantidad || cantidad <= 0) {
                showToast('La cantidad debe ser mayor que 0', 'error');
                return;
              }

              try {
                await api.createSale({ recetaId, cantidad });
                await cargarDatos();
                renderizarVentas();
                renderizarInventario();
                renderizarIngredientes();
                window.actualizarKPIs();
                e.target.reset();
                showToast('Venta registrada correctamente', 'success');
              } catch (error) {
                alert('Error: ' + error.message);
              }
            });

            // Configurar fecha de hoy por defecto
            const hoy = new Date().toISOString().split('T')[0];
            if (document.getElementById('ped-fecha')) {
              document.getElementById('ped-fecha').value = hoy;
            }
          }
          // API helper para balance
          const API_BASE = 'https://lacaleta-api.mindloop.cloud/api';

          function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
              'Content-Type': 'application/json',
              'Authorization': token ? 'Bearer ' + token : ''
            };
          }

          window.api = {
            // --- Team Management ---
            getTeam: async () => {
              const res = await fetch(API_BASE + '/team', { headers: getAuthHeaders() });
              if (!res.ok) throw new Error('Error cargando equipo');
              return await res.json();
            },
            inviteUser: async (nombre, email, password, rol) => {
              const res = await fetch(API_BASE + '/team/invite', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ nombre, email, password, rol })
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || 'Error invitando usuario');
              return data;
            },
            deleteUser: async (id) => {
              const res = await fetch(API_BASE + `/team/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || 'Error eliminando usuario');
              return data;
            },
            async getIngredientes() {
              const res = await fetch(API_BASE + '/ingredients', {
                headers: getAuthHeaders()
              });
              return await res.json();
            },

            async createIngrediente(ingrediente) {
              const res = await fetch(API_BASE + '/ingredients', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(ingrediente)
              });
              if (!res.ok) throw new Error('Error creando ingrediente');
              return await res.json();
            },

            async updateIngrediente(id, ingrediente) {
              const res = await fetch(API_BASE + `/ingredients/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(ingrediente)
              });
              if (!res.ok) throw new Error('Error actualizando ingrediente');
              return await res.json();
            },

            async deleteIngrediente(id) {
              const res = await fetch(API_BASE + `/ingredients/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
              });
              if (!res.ok) throw new Error('Error eliminando ingrediente');
              return await res.json();
            },

            async getRecetas() {
              const res = await fetch(API_BASE + '/recipes', {
                headers: getAuthHeaders()
              });
              return await res.json();
            },

            async createReceta(receta) {
              const res = await fetch(API_BASE + '/recipes', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(receta)
              });
              if (!res.ok) throw new Error('Error creando receta');
              return await res.json();
            },

            async updateReceta(id, receta) {
              const res = await fetch(API_BASE + `/recipes/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(receta)
              });
              if (!res.ok) throw new Error('Error actualizando receta');
              return await res.json();
            },

            async deleteReceta(id) {
              const res = await fetch(API_BASE + `/recipes/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
              });
              if (!res.ok) throw new Error('Error eliminando receta');
              return await res.json();
            },

            async getProveedores() {
              const res = await fetch(API_BASE + '/suppliers', {
                headers: getAuthHeaders()
              });
              return await res.json();
            },

            async createProveedor(proveedor) {
              const res = await fetch(API_BASE + '/suppliers', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(proveedor)
              });
              if (!res.ok) throw new Error('Error creando proveedor');
              return await res.json();
            },

            async updateProveedor(id, proveedor) {
              const res = await fetch(API_BASE + `/suppliers/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(proveedor)
              });
              if (!res.ok) throw new Error('Error actualizando proveedor');
              return await res.json();
            },

            async deleteProveedor(id) {
              const res = await fetch(API_BASE + `/suppliers/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
              });
              if (!res.ok) throw new Error('Error eliminando proveedor');
              return await res.json();
            },

            async getPedidos() {
              const res = await fetch(API_BASE + '/orders', {
                headers: getAuthHeaders()
              });
              return await res.json();
            },

            async createPedido(pedido) {
              const res = await fetch(API_BASE + '/orders', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(pedido)
              });
              if (!res.ok) throw new Error('Error creando pedido');
              return await res.json();
            },

            async updatePedido(id, pedido) {
              const res = await fetch(API_BASE + `/orders/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(pedido)
              });
              if (!res.ok) throw new Error('Error actualizando pedido');
              return await res.json();
            },

            async deletePedido(id) {
              const res = await fetch(API_BASE + `/orders/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
              });
              if (!res.ok) throw new Error('Error eliminando pedido');
              return await res.json();
            },

            async getSales(fecha = null) {
              const url = fecha
                ? API_BASE + `/sales?fecha=${fecha}`
                : API_BASE + '/sales';
              const res = await fetch(url, {
                headers: getAuthHeaders()
              });
              if (!res.ok) throw new Error('Error al cargar ventas');
              return await res.json();
            },

            async createSale(saleData) {
              const res = await fetch(API_BASE + '/sales', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(saleData)
              });
              if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.error || 'Error al registrar venta');
              }
              return await res.json();
            },

            async deleteSale(id) {
              const res = await fetch(API_BASE + `/sales/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
              });
              if (!res.ok) throw new Error('Error al eliminar venta');
              return await res.json();
            },

            // INVENTARIO AVANZADO
            async getInventoryComplete() {
              const res = await fetch(API_BASE + '/inventory/complete', {
                headers: getAuthHeaders()
              });
              if (!res.ok) throw new Error('Error cargando inventario');
              return await res.json();
            },

            async updateStockReal(id, stock_real) {
              const res = await fetch(API_BASE + `/inventory/${id}/stock-real`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ stock_real })
              });
              if (!res.ok) throw new Error('Error actualizando stock real');
              return await res.json();
            },

            async bulkUpdateStockReal(stocks) {
              const res = await fetch(API_BASE + '/inventory/bulk-update-stock', {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ stocks })
              });
              if (!res.ok) throw new Error('Error en actualizaci√≥n masiva');
              return await res.json();
            },

            async consolidateStock(adjustments, snapshots = [], finalStock = []) {
              const res = await fetch(API_BASE + '/inventory/consolidate', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ adjustments, snapshots, finalStock })
              });
              if (!res.ok) throw new Error('Error en consolidaci√≥n de stock');
              return await res.json();
            },

            async getMenuEngineering() {
              const res = await fetch(API_BASE + '/analysis/menu-engineering', {
                headers: getAuthHeaders()
              });
              if (!res.ok) throw new Error('Error al obtener ingenier√≠a de men√∫');
              return await res.json();
            },

            // GASTOS FIJOS (Fixed Expenses) - LocalStorage based
            async getGastosFijos() {
              try {
                const stored = localStorage.getItem('gastos_fijos');
                return stored ? JSON.parse(stored) : [];
              } catch (error) {
                console.warn('Error loading gastos fijos from localStorage:', error);
                return [];
              }
            },

            async createGastoFijo(concepto, monto_mensual) {
              try {
                const gastos = await this.getGastosFijos();
                const newGasto = {
                  id: Date.now(),
                  concepto,
                  monto_mensual: parseFloat(monto_mensual)
                };
                gastos.push(newGasto);
                localStorage.setItem('gastos_fijos', JSON.stringify(gastos));
                return newGasto;
              } catch (error) {
                throw new Error('Error creando gasto fijo: ' + error.message);
              }
            },

            async updateGastoFijo(id, concepto, monto_mensual) {
              try {
                const gastos = await this.getGastosFijos();
                const index = gastos.findIndex(g => g.id === id);
                if (index === -1) throw new Error('Gasto no encontrado');
                gastos[index] = { id, concepto, monto_mensual: parseFloat(monto_mensual) };
                localStorage.setItem('gastos_fijos', JSON.stringify(gastos));
                return gastos[index];
              } catch (error) {
                throw new Error('Error actualizando gasto fijo: ' + error.message);
              }
            },

            async deleteGastoFijo(id) {
              try {
                const gastos = await this.getGastosFijos();
                const filtered = gastos.filter(g => g.id !== id);
                localStorage.setItem('gastos_fijos', JSON.stringify(filtered));
                return { success: true };
              } catch (error) {
                throw new Error('Error eliminando gasto fijo: ' + error.message);
              }
            }
          };

          // Crear alias en may√∫sculas para compatibilidad
          window.API = window.api;

          async function cargarDatos() {
            try {
              window.ingredientes = await api.getIngredientes();
              window.recetas = await api.getRecetas();
              window.proveedores = await api.getProveedores();
              window.pedidos = await api.getPedidos();
            } catch (error) {
              console.error('Error cargando datos:', error);
              showToast('Error conectando con la API', 'error');
            }
          }
          window.cambiarTab = function (tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tabBtn = document.getElementById('tab-btn-' + tab);
            const tabContent = document.getElementById('tab-' + tab);
            if (tabBtn) tabBtn.classList.add('active');
            if (tabContent) tabContent.classList.add('active');

            if (tab === 'analisis') {
              window.renderizarAnalisis();
              // Llama al an√°lisis avanzado si est√° disponible
              api.getMenuEngineering().then(data => window.renderMenuEngineeringUI(data)).catch(e => console.log('Error bcg', e));
            }
            if (tab === 'pedidos') renderizarPedidos();
            if (tab === 'inventario') window.renderizarInventario();
            if (tab === 'ventas') window.renderizarVentas();
            if (tab === 'balance') window.renderizarBalance();
            if (tab === 'configuracion') window.renderizarEquipo();

          };

          // ========== INGREDIENTES (c√≥digo completo pero resumido visualmente) ==========
          window.mostrarFormularioIngrediente = function () {
            actualizarSelectProveedores();
            document.getElementById('formulario-ingrediente').style.display = 'block';
            document.getElementById('ing-nombre').focus();
          };

          window.cerrarFormularioIngrediente = function () {
            document.getElementById('formulario-ingrediente').style.display = 'none';
            document.querySelector('#formulario-ingrediente form').reset();
            editandoIngredienteId = null;
            document.getElementById('form-title-ingrediente').textContent = 'Nuevo Ingrediente';
            document.getElementById('btn-text-ingrediente').textContent = 'A√±adir';
          };

          function actualizarSelectProveedores() {
            const select = document.getElementById('ing-proveedor-select');
            select.innerHTML = '<option value="">Sin proveedor</option>';
            proveedores.forEach(prov => {
              select.innerHTML += `<option value="${prov.id}">${prov.nombre}</option>`;
            });
          }

          window.guardarIngrediente = async function (event) {
            event.preventDefault();

            const ingrediente = {
              nombre: document.getElementById('ing-nombre').value,
              proveedorId: document.getElementById('ing-proveedor-select').value || null,
              precio: parseFloat(document.getElementById('ing-precio').value) || 0,
              unidad: document.getElementById('ing-unidad').value,
              familia: document.getElementById('ing-familia').value || 'alimento',
              stockActual: parseFloat(document.getElementById('ing-stockActual').value) || 0,
              stockMinimo: parseFloat(document.getElementById('ing-stockMinimo').value) || 0
            };

            // Validaciones
            if (!ingrediente.nombre || ingrediente.nombre.trim() === '') {
              showToast('El nombre es obligatorio', 'error');
              return;
            }
            if (ingrediente.precio < 0) {
              showToast('El precio no puede ser negativo', 'error');
              return;
            }
            if (ingrediente.stockActual < 0) {
              showToast('El stock no puede ser negativo', 'error');
              return;
            }
            if (ingrediente.stockMinimo < 0) {
              showToast('El stock m√≠nimo no puede ser negativo', 'error');
              return;
            }

            showLoading();

            try {
              let ingredienteId;
              if (editandoIngredienteId !== null) {
                await api.updateIngrediente(editandoIngredienteId, ingrediente);
                ingredienteId = editandoIngredienteId;
              } else {
                const nuevoIng = await api.createIngrediente(ingrediente);
                ingredienteId = nuevoIng.id;
              }

              // Si se seleccion√≥ un proveedor, a√±adir ingrediente a su lista
              if (ingrediente.proveedorId) {
                const proveedor = proveedores.find(p => p.id === parseInt(ingrediente.proveedorId));
                if (proveedor) {
                  const ingredientesDelProveedor = proveedor.ingredientes || [];
                  if (!ingredientesDelProveedor.includes(ingredienteId)) {
                    ingredientesDelProveedor.push(ingredienteId);
                    await api.updateProveedor(proveedor.id, {
                      ...proveedor,
                      ingredientes: ingredientesDelProveedor
                    });
                  }
                }
              }
              await cargarDatos();
              renderizarIngredientes();
              renderizarInventario();
              window.actualizarKPIs();
              window.actualizarDashboardExpandido();
              hideLoading();
              showToast(editandoIngredienteId ? 'Ingrediente actualizado' : 'Ingrediente creado', 'success');
              window.cerrarFormularioIngrediente();
            } catch (error) {
              hideLoading();
              console.error('Error:', error);
              showToast('Error guardando ingrediente: ' + error.message, 'error');
            }
          };
          window.editarIngrediente = function (id) {
            const ing = ingredientes.find(i => i.id === id);
            if (!ing) return;

            actualizarSelectProveedores();
            document.getElementById('ing-nombre').value = ing.nombre;
            document.getElementById('ing-proveedor-select').value = ing.proveedorId || '';
            document.getElementById('ing-precio').value = ing.precio || '';
            document.getElementById('ing-unidad').value = ing.unidad;
            document.getElementById('ing-familia').value = ing.familia || 'alimento';
            document.getElementById('ing-stockActual').value = ing.stockActual || '';
            document.getElementById('ing-stockMinimo').value = ing.stockMinimo || '';

            editandoIngredienteId = id;
            document.getElementById('form-title-ingrediente').textContent = 'Editar Ingrediente';
            document.getElementById('btn-text-ingrediente').textContent = 'Guardar';
            window.mostrarFormularioIngrediente();
          };

          window.eliminarIngrediente = async function (id) {
            const ing = ingredientes.find(i => i.id === id);
            if (!ing) return;

            const confirmado = await window.confirmarEliminacion({
              titulo: 'Eliminar Ingrediente',
              tipo: 'el ingrediente',
              nombre: ing.nombre || 'Sin nombre'
            });

            if (confirmado) {
              try {
                await api.deleteIngrediente(id);
                ingredientes = ingredientes.filter(i => i.id !== id);
                window.renderizarIngredientes();
                showToast(`‚úÖ Ingrediente "${ing.nombre}" eliminado correctamente`, 'success');
              } catch (error) {
                showToast('‚ùå Error al eliminar ingrediente', 'error');
              }
            }
          };


          function getNombreProveedor(proveedorId) {
            if (!proveedorId) return '-';
            const prov = proveedores.find(p => p.id == proveedorId);
            return prov ? prov.nombre : '-';
          }

          window.renderizarIngredientes = function () {
            const busqueda = document.getElementById('busqueda-ingredientes').value.toLowerCase();
            const filtrados = ingredientes.filter(ing => {
              const nombreProv = getNombreProveedor(ing.proveedorId).toLowerCase();
              return ing.nombre.toLowerCase().includes(busqueda) || nombreProv.includes(busqueda);
            });

            const container = document.getElementById('tabla-ingredientes');

            if (filtrados.length === 0) {
              container.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">ü•ï</div>
      <h3>${busqueda ? '¬°No encontramos nada!' : '¬°No hay ingredientes a√∫n!'}</h3>
      <p>${busqueda ? 'Intenta con otra b√∫squeda o a√±ade tu primer ingrediente' : 'A√±ade tu primer ingrediente para empezar a gestionar tu inventario'}</p>
    </div>
  `;
              document.getElementById('resumen-ingredientes').style.display = 'none';
              return;
            } else {
              let html = '<table><thead><tr>';
              html += '<th>Ingrediente</th><th>Familia</th><th>Proveedor</th><th>Precio</th><th>Stock</th><th>Stock M√≠nimo</th><th>Acciones</th>';
              html += '</tr></thead><tbody>';

              filtrados.forEach(ing => {
                const stockActual = parseFloat(ing.stock_actual) || 0;
                const stockMinimo = parseFloat(ing.stock_minimo) || 0;
                const stockBajo = stockMinimo > 0 && stockActual <= stockMinimo;

                html += '<tr>';
                html += `<td><strong style="cursor: pointer;" onclick="window.editarIngrediente(${ing.id})">${ing.nombre}</strong></td>`;
                html += `<td><span class="badge ${ing.familia === 'bebida' ? 'badge-info' : 'badge-success'}">${ing.familia || 'alimento'}</span></td>`;
                html += `<td>${getNombreProveedor(ing.proveedor_id)}</td>`;
                html += `<td>${ing.precio ? parseFloat(ing.precio).toFixed(2) + ' ‚Ç¨/' + ing.unidad + ' -' : ''}</td>`;
                html += `<td>`;
                if (ing.stock_actual) {
                  html += `<span class="stock-badge ${stockBajo ? 'stock-low' : 'stock-ok'}">${ing.stock_actual} ${ing.unidad}</span>`;
                  if (stockBajo && ing.stock_minimo) html += ` ‚ö†Ô∏è`;
                } else {
                  html += '-';
                }
                html += `</td>`;
                html += '<td>' + parseFloat(ing.stock_minimo) + ' ' + ing.unidad + '-' + '</td>';
                html += '<td><button class="icon-btn edit" onclick="window.editarIngrediente(' + ing.id + ')">‚úèÔ∏è</button> <button class="icon-btn delete" onclick="window.eliminarIngrediente(' + ing.id + ')">üóëÔ∏è</button></td>';
                html += '</tr>';
              });

              html += '</tbody></table>';
              container.innerHTML = html;

              document.getElementById('resumen-ingredientes').innerHTML = `
            <div>Total: <strong>${ingredientes.length}</strong></div>
            <div>Mostrando: <strong>${filtrados.length}</strong></div>
          `;
              document.getElementById('resumen-ingredientes').style.display = 'flex';
            }
          };

          // ========== RECETAS (resumido) ==========
          window.mostrarFormularioReceta = function () {
            if (ingredientes.length === 0) {
              showToast('Primero a√±ade ingredientes', 'warning');
              window.cambiarTab('ingredientes');
              window.mostrarFormularioIngrediente();
              return;
            }
            document.getElementById('formulario-receta').style.display = 'block';
            window.agregarIngredienteReceta();
            document.getElementById('rec-nombre').focus();
          };

          window.cerrarFormularioReceta = function () {
            document.getElementById('formulario-receta').style.display = 'none';
            document.querySelector('#formulario-receta form').reset();
            document.getElementById('lista-ingredientes-receta').innerHTML = '';
            document.getElementById('coste-calculado-form').style.display = 'none';
            editandoRecetaId = null;
            // Limpiar campos del formulario
            document.getElementById('rec-nombre').value = '';
            document.getElementById('rec-codigo').value = ''; // Reset c√≥digo
            document.getElementById('rec-categoria').value = 'entrante';
            document.getElementById('rec-precio_venta').value = '';
            document.getElementById('rec-porciones').value = '1';
            document.getElementById('lista-ingredientes-receta').innerHTML = '';
            document.getElementById('form-title-receta').textContent = 'Nueva Receta';
            document.getElementById('btn-text-receta').textContent = 'Guardar';
          };

          // Agregar fila de ingrediente en formulario de receta
          window.agregarIngredienteReceta = function () {
            const lista = document.getElementById('lista-ingredientes-receta');
            const item = document.createElement('div');
            item.className = 'ingrediente-item';
            item.style.cssText = 'display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;';

            let optionsHtml = '<option value="">Selecciona ingrediente...</option>';
            window.ingredientes.forEach(ing => {
              optionsHtml += `<option value="${ing.id}">${ing.nombre} (${parseFloat(ing.precio || 0).toFixed(2)}‚Ç¨/${ing.unidad})</option>`;
            });

            item.innerHTML = `
            <select style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px;" onchange="window.calcularCosteReceta()">
              ${optionsHtml}
            </select>
            <input type="number" step="0.01" min="0" placeholder="Cantidad" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;" onchange="window.calcularCosteReceta()">
            <button type="button" onclick="this.parentElement.remove(); window.calcularCosteReceta();" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">‚úï</button>
          `;

            lista.appendChild(item);
          };

          // Calcular coste de receta desde ingredientes seleccionados
          window.calcularCosteReceta = function () {
            const items = document.querySelectorAll('#lista-ingredientes-receta .ingrediente-item');
            let costeTotal = 0;

            items.forEach(item => {
              const select = item.querySelector('select');
              const input = item.querySelector('input');
              if (select.value && input.value) {
                const ing = window.ingredientes.find(i => i.id === parseInt(select.value));
                if (ing) {
                  costeTotal += parseFloat(ing.precio || 0) * parseFloat(input.value || 0);
                }
              }
            });

            const costeDiv = document.getElementById('coste-calculado-form');
            if (costeDiv) {
              costeDiv.style.display = costeTotal > 0 ? 'block' : 'none';
              const costeSpan = document.getElementById('coste-receta-valor');
              if (costeSpan) costeSpan.textContent = costeTotal.toFixed(2) + '‚Ç¨';

              const precioVenta = parseFloat(document.getElementById('rec-precio_venta')?.value || 0);
              const margenSpan = document.getElementById('margen-receta-valor');
              if (margenSpan && precioVenta > 0) {
                const margen = ((precioVenta - costeTotal) / precioVenta * 100);
                margenSpan.textContent = margen.toFixed(1) + '%';
                margenSpan.style.color = margen >= 60 ? '#10b981' : margen >= 40 ? '#f59e0b' : '#ef4444';
              }
            }

            return costeTotal;
          };

          window.guardarReceta = async function (event) {
            event.preventDefault();

            const items = document.querySelectorAll('#lista-ingredientes-receta .ingrediente-item');
            const ingredientesReceta = [];

            items.forEach(item => {
              const select = item.querySelector('select');
              const input = item.querySelector('input');
              if (select.value && input.value) {
                ingredientesReceta.push({
                  ingredienteId: parseInt(select.value),
                  cantidad: parseFloat(input.value)
                });
              }
            });

            if (ingredientesReceta.length === 0) {
              showToast('A√±ade ingredientes a la receta', 'warning');
              return;
            }

            const receta = {
              nombre: document.getElementById('rec-nombre').value,
              codigo: document.getElementById('rec-codigo').value, // Guardar c√≥digo
              categoria: document.getElementById('rec-categoria').value,
              precio_venta: parseFloat(document.getElementById('rec-precio_venta').value) || 0,
              porciones: parseInt(document.getElementById('rec-porciones').value) || 1,
              ingredientes: ingredientesReceta
            };

            showLoading();

            try {
              if (editandoRecetaId !== null) {
                await api.updateReceta(editandoRecetaId, receta);
              } else {
                await api.createReceta(receta);
              }
              await cargarDatos();
              renderizarRecetas();
              hideLoading();
              showToast(editandoRecetaId ? 'Receta actualizada' : 'Receta creada', 'success');
              window.cerrarFormularioReceta();
            } catch (error) {
              hideLoading();
              console.error('Error:', error);
              showToast('Error guardando receta: ' + error.message, 'error');
            }
          };

          window.editarReceta = function (id) {
            const rec = recetas.find(r => r.id === id);
            if (!rec) return;

            document.getElementById('rec-nombre').value = rec.nombre;
            document.getElementById('rec-codigo').value = rec.codigo || ''; // Cargar c√≥digo
            document.getElementById('rec-categoria').value = rec.categoria;
            document.getElementById('rec-precio_venta').value = rec.precio_venta;
            document.getElementById('rec-porciones').value = rec.porciones;

            document.getElementById('lista-ingredientes-receta').innerHTML = '';
            rec.ingredientes.forEach(item => {
              window.agregarIngredienteReceta();
              const lastItem = document.querySelector('#lista-ingredientes-receta .ingrediente-item:last-child');
              lastItem.querySelector('select').value = item.ingredienteId;
              lastItem.querySelector('input').value = item.cantidad;
            });

            window.calcularCosteReceta();
            editandoRecetaId = id;
            document.getElementById('form-title-receta').textContent = 'Editar';
            document.getElementById('btn-text-receta').textContent = 'Guardar';
            window.mostrarFormularioReceta();
          };

          // ... (eliminarReceta y calcularCosteRecetaCompleto sin cambios)

          window.renderizarRecetas = function () {
            const busqueda = document.getElementById('busqueda-recetas').value.toLowerCase();
            const filtradas = recetas.filter(r =>
              r.nombre.toLowerCase().includes(busqueda) ||
              (r.codigo && r.codigo.toString().includes(busqueda)) // Buscar por c√≥digo
            );

            const container = document.getElementById('tabla-recetas');

            if (filtradas.length === 0) {
              container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üë®‚Äçüç≥</div>
              <h3>${busqueda ? 'No encontradas' : 'A√∫n no hay recetas'}</h3>
            </div>
          `;
              document.getElementById('resumen-recetas').style.display = 'none';
            } else {
              let html = '<table><thead><tr>';
              html += '<th>C√≥d.</th><th>Plato</th><th>Categor√≠a</th><th>Coste</th><th>Precio</th><th>Margen</th><th>Acciones</th>';
              html += '</tr></thead><tbody>';

              filtradas.forEach(rec => {
                const coste = calcularCosteRecetaCompleto(rec);
                const margen = rec.precio_venta - coste;
                const pct = rec.precio_venta > 0 ? ((margen / rec.precio_venta) * 100).toFixed(0) : 0;

                html += '<tr>';
                html += `<td><span style="color:#666;font-size:12px;">${rec.codigo || '-'}</span></td>`;
                html += `<td><strong>${rec.nombre}</strong></td>`;
                html += `<td><span class="badge badge-success">${rec.categoria}</span></td>`;
                html += `<td>${coste.toFixed(2)} ‚Ç¨</td>`;
                html += `<td>${rec.precio_venta ? parseFloat(rec.precio_venta).toFixed(2) : '0.00'} ‚Ç¨</td>`;
                html += `<td><span class="badge ${margen > 0 ? 'badge-success' : 'badge-warning'}">${margen.toFixed(2)} ‚Ç¨ (${pct}%)</span></td>`;
                html += `<td><div class="actions">`;
                html += `<button class="icon-btn produce" onclick="window.abrirModalProducir(${rec.id})">‚¨áÔ∏è</button>`;
                html += `<button class="icon-btn edit" onclick="window.editarReceta(${rec.id})">‚úèÔ∏è</button>`;
                html += `<button class="icon-btn delete" onclick="window.eliminarReceta(${rec.id})">üóëÔ∏è</button>`;
                html += '</div></td>';
                html += '</tr>';
              });


              html += '</tbody></table>';
              container.innerHTML = html;

              document.getElementById('resumen-recetas').innerHTML = `
            <div>Total: <strong>${recetas.length}</strong></div>
            <div>Mostrando: <strong>${filtradas.length}</strong></div>
          `;
              document.getElementById('resumen-recetas').style.display = 'flex';
            }
          };

          // ========== PRODUCCI√ìN ==========
          window.abrirModalProducir = function (id) {
            recetaProduciendo = id;
            const rec = recetas.find(r => r.id === id);
            document.getElementById('modal-plato-nombre').textContent = rec.nombre;
            document.getElementById('modal-cantidad').value = 1;
            window.actualizarDetalleDescuento();
            document.getElementById('modal-producir').classList.add('active');
          };

          window.cerrarModalProducir = function () {
            document.getElementById('modal-producir').classList.remove('active');
            recetaProduciendo = null;
          };

          window.actualizarDetalleDescuento = function () {
            if (recetaProduciendo === null) return;
            const cant = parseInt(document.getElementById('modal-cantidad').value) || 1;
            const rec = recetas.find(r => r.id === recetaProduciendo);
            let html = '<ul style="margin:0;padding-left:20px;">';
            rec.ingredientes.forEach(item => {
              const ing = ingredientes.find(i => i.id === item.ingredienteId);
              if (ing) html += `<li>${ing.nombre}: -${item.cantidad * cant} ${ing.unidad}</li>`;
            });
            html += '</ul>';
            document.getElementById('modal-descuento-detalle').innerHTML = html;
          };

          window.confirmarProduccion = async function () {
            if (recetaProduciendo === null) return;
            const cant = parseInt(document.getElementById('modal-cantidad').value) || 1;
            const rec = recetas.find(r => r.id === recetaProduciendo);

            let falta = false;
            let msg = 'Stock insuficiente:\n';
            rec.ingredientes.forEach(item => {
              const ing = ingredientes.find(i => i.id === item.ingredienteId);
              if (ing) {
                const necesario = item.cantidad * cant;
                if (ing.stockActual < necesario) {
                  falta = true;
                  msg += `- ${ing.nombre}: necesitas ${necesario}, tienes ${ing.stockActual}\n`;
                }
              }
            });

            if (falta) {
              alert(msg);
              return;
            }

            showLoading();

            try {
              for (const item of rec.ingredientes) {
                const ing = ingredientes.find(i => i.id === item.ingredienteId);
                if (ing) {
                  const nuevoStock = Math.max(0, ing.stockActual - (item.cantidad * cant));
                  await api.updateIngrediente(ing.id, {
                    ...ing,
                    stockActual: nuevoStock
                  });
                }
              }

              await cargarDatos();
              renderizarIngredientes();
              hideLoading();
              window.cerrarModalProducir();
              showToast(`Producidas ${cant} unidades de ${rec.nombre}`, 'success');
            } catch (error) {
              hideLoading();
              console.error('Error:', error);
              showToast('Error actualizando stock: ' + error.message, 'error');
            }
          };

          // ========== PROVEEDORES (resumido) ==========
          window.mostrarFormularioProveedor = function () {
            document.getElementById('formulario-proveedor').style.display = 'block';
            cargarIngredientesProveedor();
            document.getElementById('prov-nombre').focus();
          };

          window.cerrarFormularioProveedor = function () {
            document.getElementById('formulario-proveedor').style.display = 'none';
            document.querySelector('#formulario-proveedor form').reset();
            editandoProveedorId = null;
            document.getElementById('form-title-proveedor').textContent = 'Nuevo Proveedor';
            document.getElementById('btn-text-proveedor').textContent = 'A√±adir';
          };

          function cargarIngredientesProveedor(seleccionados = []) {
            const container = document.getElementById('lista-ingredientes-proveedor');
            if (ingredientes.length === 0) {
              container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">Primero a√±ade ingredientes</p>';
              return;
            }

            const busqueda = document.getElementById('buscar-ingredientes-proveedor').value.toLowerCase();
            const filtrados = ingredientes.filter(ing => ing.nombre.toLowerCase().includes(busqueda));

            let html = '';
            filtrados.forEach(ing => {
              const checked = seleccionados.includes(ing.id) ? 'checked' : '';
              html += `
            <div class="ingrediente-checkbox">
              <input type="checkbox" id="check-ing-${ing.id}" value="${ing.id}" ${checked}>
              <label for="check-ing-${ing.id}">${ing.nombre}</label>
            </div>
          `;
            });

            container.innerHTML = html || '<p style="color:#999;padding:10px;">Sin resultados</p>';
          }

          window.filtrarIngredientesProveedor = function () {
            const checks = document.querySelectorAll('#lista-ingredientes-proveedor input[type="checkbox"]:checked');
            const seleccionados = Array.from(checks).map(c => parseInt(c.value));
            cargarIngredientesProveedor(seleccionados);
          };

          window.guardarProveedor = async function (event) {
            event.preventDefault();

            const checks = document.querySelectorAll('#lista-ingredientes-proveedor input[type="checkbox"]:checked');
            const ingredientesIds = Array.from(checks).map(c => parseInt(c.value));

            const proveedor = {
              nombre: document.getElementById('prov-nombre').value,
              contacto: document.getElementById('prov-contacto').value,
              telefono: document.getElementById('prov-telefono').value,
              email: document.getElementById('prov-email').value,
              direccion: document.getElementById('prov-direccion').value,
              notas: document.getElementById('prov-notas').value,
              ingredientes: ingredientesIds
            };

            showLoading();

            try {
              if (editandoProveedorId !== null) {
                await api.updateProveedor(editandoProveedorId, proveedor);
              } else {
                await api.createProveedor(proveedor);
              }
              await cargarDatos();
              renderizarProveedores();
              hideLoading();
              showToast(editandoProveedorId ? 'Proveedor actualizado' : 'Proveedor creado', 'success');
              window.cerrarFormularioProveedor();
            } catch (error) {
              hideLoading();
              console.error('Error:', error);
              showToast('Error guardando proveedor: ' + error.message, 'error');
            }
          };

          window.editarProveedor = function (id) {
            const prov = proveedores.find(p => p.id === id);
            if (!prov) return;

            document.getElementById('prov-nombre').value = prov.nombre;
            document.getElementById('prov-contacto').value = prov.contacto || '';
            document.getElementById('prov-telefono').value = prov.telefono || '';
            document.getElementById('prov-email').value = prov.email || '';
            document.getElementById('prov-direccion').value = prov.direccion || '';
            document.getElementById('prov-notas').value = prov.notas || '';

            cargarIngredientesProveedor(prov.ingredientes || []);

            editandoProveedorId = id;
            document.getElementById('form-title-proveedor').textContent = 'Editar';
            document.getElementById('btn-text-proveedor').textContent = 'Guardar';
            window.mostrarFormularioProveedor();
          };

          window.eliminarProveedor = async function (id) {
            const prov = proveedores.find(p => p.id === id);
            if (!prov) return;

            const confirmado = await window.confirmarEliminacion({
              titulo: 'Eliminar Proveedor',
              tipo: 'el proveedor',
              nombre: prov.nombre || 'Sin nombre'
            });

            if (confirmado) {
              showLoading();
              try {
                await api.deleteProveedor(id);
                proveedores = proveedores.filter(p => p.id !== id);
                window.renderizarProveedores();
                await cargarDatos();
                renderizarProveedores();
                renderizarIngredientes();
                hideLoading();
                showToast('‚úÖ Proveedor eliminado correctamente', 'success');
              } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showToast('‚ùå Error eliminando proveedor: ' + error.message, 'error');
              }
            }
          };

          window.verProveedorDetalles = function (id) {
            const prov = proveedores.find(p => p.id === id);
            if (!prov) return;

            document.getElementById('modal-proveedor-titulo').textContent = prov.nombre;

            let html = '<div style="margin-bottom:20px;">';
            if (prov.contacto) html += `<p><strong>Contacto:</strong> ${prov.contacto}</p>`;
            if (prov.telefono) html += `<p><strong>Tel√©fono:</strong> ${prov.telefono}</p>`;
            if (prov.email) html += `<p><strong>Email:</strong> ${prov.email}</p>`;
            if (prov.direccion) html += `<p><strong>Direcci√≥n:</strong> ${prov.direccion}</p>`;
            if (prov.notas) html += `<p><strong>Notas:</strong> ${prov.notas}</p>`;
            html += '</div>';

            html += '<h4 style="margin-top:20px;margin-bottom:10px;">Ingredientes:</h4>';
            if (prov.ingredientes && prov.ingredientes.length > 0) {
              html += '<div class="ingredientes-list">';
              prov.ingredientes.forEach(ingId => {
                const ing = ingredientes.find(i => i.id === ingId);
                if (ing) html += `<span class="badge">${ing.nombre}</span>`;
              });
              html += '</div>';
            } else {
              html += '<p style="color:#999;">Sin ingredientes</p>';
            }

            document.getElementById('modal-proveedor-contenido').innerHTML = html;
            document.getElementById('modal-ver-proveedor').classList.add('active');
          };

          window.cerrarModalVerProveedor = function () {
            document.getElementById('modal-ver-proveedor').classList.remove('active');
          };

          window.renderizarProveedores = function () {
            const busqueda = document.getElementById('busqueda-proveedores').value.toLowerCase();
            const filtrados = proveedores.filter(p => p.nombre.toLowerCase().includes(busqueda));

            const container = document.getElementById('tabla-proveedores');

            if (filtrados.length === 0) {
              container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üöö</div>
              <h3>${busqueda ? 'No encontrados' : 'A√∫n no hay proveedores'}</h3>
            </div>
          `;
              document.getElementById('resumen-proveedores').style.display = 'none';
            } else {
              let html = '<table><thead><tr>';
              html += '<th>Proveedor</th><th>Contacto</th><th>Tel√©fono</th><th>Ingredientes</th><th>Acciones</th>';
              html += '</tr></thead><tbody>';

              filtrados.forEach(prov => {
                const numIng = prov.ingredientes ? prov.ingredientes.length : 0;

                html += '<tr>';
                html += `<td><strong>${prov.nombre}</strong></td>`;
                html += `<td>${prov.contacto || '-'}</td>`;
                html += `<td>${prov.telefono || '-'}</td>`;
                html += `<td><span class="badge badge-info">${numIng}</span></td>`;
                html += `<td><div class="actions">`;
                html += `<button class="icon-btn view" onclick="window.verProveedorDetalles(${prov.id})">üëÅÔ∏è</button>`;
                html += `<button class="icon-btn edit" onclick="window.editarProveedor(${prov.id})">‚úèÔ∏è</button>`;
                html += `<button class="icon-btn delete" onclick="window.eliminarProveedor(${prov.id})">üóëÔ∏è</button>`;
                html += '</div></td>';
                html += '</tr>';
              });

              html += '</tbody></table>';
              container.innerHTML = html;

              document.getElementById('resumen-proveedores').innerHTML = `
            <div>Total: <strong>${proveedores.length}</strong></div>
            <div>Mostrando: <strong>${filtrados.length}</strong></div>
          `;
              document.getElementById('resumen-proveedores').style.display = 'flex';
            }
          };

          // ========== PEDIDOS ==========
          window.mostrarFormularioPedido = function () {
            if (proveedores.length === 0) {
              showToast('Primero a√±ade proveedores', 'warning');
              window.cambiarTab('proveedores');
              return;
            }

            // Cargar select de proveedores
            const select = document.getElementById('ped-proveedor');
            select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
            proveedores.forEach(prov => {
              select.innerHTML += `<option value="${prov.id}">${prov.nombre}</option>`;
            });

            document.getElementById('formulario-pedido').style.display = 'block';
            document.getElementById('ped-proveedor').focus();
          };

          window.cerrarFormularioPedido = function () {
            document.getElementById('formulario-pedido').style.display = 'none';
            document.querySelector('#formulario-pedido form').reset();
            document.getElementById('container-ingredientes-pedido').style.display = 'none';
            document.getElementById('lista-ingredientes-pedido').innerHTML = '';
            document.getElementById('total-pedido-form').style.display = 'none';
          };

          window.cargarIngredientesPedido = function () {
            const proveedorId = parseInt(document.getElementById('ped-proveedor').value);
            if (!proveedorId) {
              document.getElementById('container-ingredientes-pedido').style.display = 'none';
              return;
            }

            const proveedor = proveedores.find(p => p.id === proveedorId);
            if (!proveedor || !proveedor.ingredientes || proveedor.ingredientes.length === 0) {
              document.getElementById('container-ingredientes-pedido').style.display = 'none';
              showToast('Este proveedor no tiene ingredientes asignados', 'warning');
              return;
            }

            document.getElementById('container-ingredientes-pedido').style.display = 'block';
            document.getElementById('lista-ingredientes-pedido').innerHTML = '';
            window.agregarIngredientePedido();
          };

          window.agregarIngredientePedido = function () {
            const proveedorId = parseInt(document.getElementById('ped-proveedor').value);
            if (!proveedorId) return;

            const proveedor = proveedores.find(p => p.id === proveedorId);
            const ingredientesProveedor = ingredientes.filter(ing =>
              proveedor.ingredientes.includes(ing.id)
            );

            const container = document.getElementById('lista-ingredientes-pedido');
            const div = document.createElement('div');
            div.className = 'ingrediente-item';

            let opciones = '<option value="">Seleccionar...</option>';
            ingredientesProveedor.forEach(ing => {
              opciones += `<option value="${ing.id}">${ing.nombre} (${parseFloat(ing.precio || 0).toFixed(2)}‚Ç¨/${ing.unidad})</option>`;
            });

            div.innerHTML = `
          <select onchange="window.calcularTotalPedido()">${opciones}</select>
          <input type="number" placeholder="Cantidad" step="0.01" min="0" oninput="window.calcularTotalPedido()">
          <span style="font-size: 12px; color: #666;"></span>
          <button type="button" onclick="this.parentElement.remove(); window.calcularTotalPedido()">√ó</button>
        `;

            container.appendChild(div);
          };

          window.calcularTotalPedido = function () {
            const items = document.querySelectorAll('#lista-ingredientes-pedido .ingrediente-item');
            let total = 0;
            let hayDatos = false;

            items.forEach(item => {
              const select = item.querySelector('select');
              const input = item.querySelector('input');
              const span = item.querySelector('span');

              if (select.value && input.value) {
                hayDatos = true;
                const ing = ingredientes.find(i => i.id == select.value);
                const cantidad = parseFloat(input.value);
                const subtotal = ing.precio * cantidad;
                total += subtotal;
                span.textContent = `${subtotal.toFixed(2)} ‚Ç¨`;
              } else {
                span.textContent = '';
              }
            });

            if (hayDatos) {
              document.getElementById('total-pedido-form').style.display = 'block';
              document.getElementById('total-pedido-value').textContent = total.toFixed(2) + ' ‚Ç¨';
            } else {
              document.getElementById('total-pedido-form').style.display = 'none';
            }
          };

          window.guardarPedido = async function (event) {
            event.preventDefault();

            const proveedorId = parseInt(document.getElementById('ped-proveedor').value);
            const fecha = document.getElementById('ped-fecha').value;

            const items = document.querySelectorAll('#lista-ingredientes-pedido .ingrediente-item');
            const ingredientesPedido = [];
            let total = 0;

            items.forEach(item => {
              const select = item.querySelector('select');
              const input = item.querySelector('input');
              if (select.value && input.value) {
                const ing = ingredientes.find(i => i.id == select.value);
                const cantidad = parseFloat(input.value);
                const subtotal = ing.precio * cantidad;
                total += subtotal;

                ingredientesPedido.push({
                  ingredienteId: ing.id,
                  cantidad: cantidad,
                  precioUnitario: ing.precio,
                  subtotal: subtotal
                });
              }
            });

            if (ingredientesPedido.length === 0) {
              showToast('A√±ade ingredientes al pedido', 'warning');
              return;
            }

            // Validaciones adicionales
            if (!proveedorId) {
              showToast('Selecciona un proveedor', 'error');
              return;
            }
            if (!fecha) {
              showToast('Selecciona una fecha', 'error');
              return;
            }

            // Validar cantidades positivas
            const cantidadInvalida = ingredientesPedido.find(i => i.cantidad <= 0);
            if (cantidadInvalida) {
              showToast('Las cantidades deben ser mayores que 0', 'error');
              return;
            }

            const pedido = {
              proveedorId: proveedorId,
              fecha: fecha,
              ingredientes: ingredientesPedido,
              total: total,
              estado: 'pendiente'
            };

            showLoading();

            try {
              await api.createPedido(pedido);
              await cargarDatos();
              renderizarPedidos();
              window.cerrarFormularioPedido();
              hideLoading();
              showToast('Pedido creado correctamente', 'success');
            } catch (error) {
              hideLoading();
              console.error('Error:', error);
              showToast('Error creando pedido: ' + error.message, 'error');
            }
          };

          let pedidoRecibiendoId = null;

          window.marcarPedidoRecibido = function (id) {
            pedidoRecibiendoId = id;
            const pedido = pedidos.find(p => p.id === id);
            const prov = proveedores.find(p => p.id === pedido.proveedorId);

            // Llenar informaci√≥n del pedido
            document.getElementById('modal-rec-proveedor').textContent = prov ? prov.nombre : 'Desconocido';
            document.getElementById('modal-rec-fecha').textContent = new Date(pedido.fecha).toLocaleDateString('es-ES');
            document.getElementById('modal-rec-total-original').textContent = parseFloat(pedido.total || 0).toFixed(2) + ' ‚Ç¨';

            // Crear copia de items para edici√≥n
            if (!pedido.itemsRecepcion) {
              pedido.itemsRecepcion = pedido.ingredientes.map(item => ({
                ...item,
                cantidadRecibida: item.cantidad,
                precioReal: item.precioUnitario,
                estado: 'consolidado'
              }));
            }

            renderItemsRecepcion();
            document.getElementById('modal-recibir-pedido').classList.add('active');
          };

          function renderItemsRecepcion() {
            const pedido = pedidos.find(p => p.id === pedidoRecibiendoId);
            const tbody = document.getElementById('modal-rec-items');

            let html = '';
            let totalOriginal = 0;
            let totalRecibido = 0;

            pedido.itemsRecepcion.forEach((item, idx) => {
              const ing = ingredientes.find(i => i.id === item.ingredienteId);
              if (!ing) return;

              const subtotalOriginal = item.cantidad * item.precioUnitario;
              const subtotalRecibido = item.cantidadRecibida * item.precioReal;
              totalOriginal += subtotalOriginal;

              if (item.estado !== 'no-entregado') {
                totalRecibido += subtotalRecibido;
              }

              const varianzaCant = item.cantidadRecibida - item.cantidad;
              const varianzaPrecio = item.precioReal - item.precioUnitario;

              html += '<tr>';
              html += `<td><strong>${ing.nombre}</strong></td>`;
              html += `<td>${item.cantidad} ${ing.unidad}</td>`;
              html += `<td>`;
              if (item.estado === 'no-entregado') {
                html += '<span style="color:#999;">No entregado</span>';
              } else {
                html += `<input type="number" value="${item.cantidadRecibida}" step="0.01" min="0" 
              style="width:80px;padding:5px;border:1px solid #ddd;border-radius:4px;"
              onchange="window.actualizarItemRecepcion(${idx}, 'cantidad', this.value)"> ${ing.unidad}`;
                if (Math.abs(varianzaCant) > 0.01) {
                  html += `<br><small style="color:${varianzaCant > 0 ? '#10b981' : '#ef4444'};">${varianzaCant > 0 ? '+' : ''}${varianzaCant.toFixed(2)}</small>`;
                }
              }
              html += `</td>`;
              html += `<td>${parseFloat(item.precioUnitario || 0).toFixed(2)} ‚Ç¨</td>`;
              html += `<td>`;
              if (item.estado === 'no-entregado') {
                html += '<span style="color:#999;">-</span>';
              } else {
                html += `<input type="number" value="${item.precioReal}" step="0.01" min="0" 
              style="width:80px;padding:5px;border:1px solid #ddd;border-radius:4px;"
              onchange="window.actualizarItemRecepcion(${idx}, 'precio', this.value)"> ‚Ç¨`;
                if (Math.abs(varianzaPrecio) > 0.01) {
                  html += `<br><small style="color:${varianzaPrecio > 0 ? '#ef4444' : '#10b981'};">${varianzaPrecio > 0 ? '+' : ''}${varianzaPrecio.toFixed(2)} ‚Ç¨</small>`;
                }
              }
              html += `</td>`;
              html += `<td><strong>${item.estado === 'no-entregado' ? '0.00' : subtotalRecibido.toFixed(2)} ‚Ç¨</strong></td>`;
              html += `<td>`;
              html += `<select onchange="window.cambiarEstadoItem(${idx}, this.value)" style="padding:5px;border:1px solid #ddd;border-radius:4px;">`;
              html += `<option value="consolidado" ${item.estado === 'consolidado' ? 'selected' : ''}>‚úÖ OK</option>`;
              html += `<option value="varianza" ${item.estado === 'varianza' ? 'selected' : ''}>‚ö†Ô∏è Varianza</option>`;
              html += `<option value="no-entregado" ${item.estado === 'no-entregado' ? 'selected' : ''}>‚ùå No entregado</option>`;
              html += `</select>`;
              html += `</td>`;
              html += '</tr>';
            });

            tbody.innerHTML = html;

            // Actualizar resumen
            const varianza = totalRecibido - totalOriginal;
            document.getElementById('modal-rec-resumen-original').textContent = totalOriginal.toFixed(2) + ' ‚Ç¨';
            document.getElementById('modal-rec-resumen-recibido').textContent = totalRecibido.toFixed(2) + ' ‚Ç¨';

            const varianzaEl = document.getElementById('modal-rec-resumen-varianza');
            varianzaEl.textContent = (varianza >= 0 ? '+' : '') + varianza.toFixed(2) + ' ‚Ç¨';
            varianzaEl.style.color = varianza > 0 ? '#ef4444' : varianza < 0 ? '#10b981' : '#666';
          }

          window.actualizarItemRecepcion = function (idx, tipo, valor) {
            const pedido = pedidos.find(p => p.id === pedidoRecibiendoId);
            const item = pedido.itemsRecepcion[idx];

            if (tipo === 'cantidad') {
              item.cantidadRecibida = parseFloat(valor) || 0;
              if (Math.abs(item.cantidadRecibida - item.cantidad) > 0.01) {
                item.estado = 'varianza';
              } else if (item.estado === 'varianza') {
                item.estado = 'consolidado';
              }
            } else if (tipo === 'precio') {
              item.precioReal = parseFloat(valor) || 0;
              if (Math.abs(item.precioReal - item.precioUnitario) > 0.01) {
                item.estado = 'varianza';
              } else if (item.estado === 'varianza') {
                item.estado = 'consolidado';
              }
            }

            renderItemsRecepcion();
          };

          window.cambiarEstadoItem = function (idx, estado) {
            const pedido = pedidos.find(p => p.id === pedidoRecibiendoId);
            pedido.itemsRecepcion[idx].estado = estado;
            renderItemsRecepcion();
          };

          window.cerrarModalRecibirPedido = function () {
            document.getElementById('modal-recibir-pedido').classList.remove('active');
            pedidoRecibiendoId = null;
          };

          window.confirmarRecepcionPedido = async function () {
            if (!confirm('¬øConfirmar recepci√≥n del pedido? Esto actualizar√° el stock con las cantidades recibidas.')) return;

            const pedido = pedidos.find(p => p.id === pedidoRecibiendoId);

            // Actualizar stock con cantidades reales recibidas
            let totalRecibido = 0;

            showLoading();

            try {
              const items = pedido.itemsRecepcion || pedido.ingredientes;
              for (const item of items) {
                if (item.estado !== 'no-entregado') {
                  const ing = ingredientes.find(i => i.id === item.ingredienteId);
                  if (ing) {
                    await api.updateIngrediente(ing.id, {
                      ...ing,
                      stock_actual: parseFloat(ing.stock_actual || 0) + parseFloat(item.cantidadRecibida || item.cantidad || 0)
                    });
                  }
                  totalRecibido += item.cantidadRecibida * item.precioReal;
                }
              }

              // Actualizar pedido
              await api.updatePedido(pedidoRecibiendoId, {
                ...pedido,
                estado: 'recibido',
                totalRecibido: totalRecibido,
                ingredientes: pedido.itemsRecepcion.map(item => ({
                  ...item,
                  precioReal: item.precioReal || item.precioUnitario
                }))
              });

              await cargarDatos();
              renderizarPedidos();
              renderizarIngredientes();
              renderizarInventario();
              window.actualizarKPIs();
              window.actualizarDashboardExpandido();
              window.cerrarModalRecibirPedido();
              hideLoading();
              showToast('Pedido recibido y stock actualizado correctamente', 'success');
            } catch (error) {
              hideLoading();
              console.error('Error:', error);
              showToast('Error confirmando recepci√≥n: ' + error.message, 'error');
            }
          };

          window.eliminarPedido = async function (id) {
            if (confirm('¬øEliminar este pedido?')) {
              showLoading();

              try {
                await api.deletePedido(id);
                await cargarDatos();
                renderizarPedidos();
                hideLoading();
                showToast('Pedido eliminado', 'success');
              } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showToast('Error eliminando pedido: ' + error.message, 'error');
              }
            }
          };

          let pedidoViendoId = null;

          window.verDetallesPedido = function (pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) {
              showToast('Pedido no encontrado', 'error');
              return;
            }

            const prov = proveedores.find(p => p.id === pedido.proveedor_id);

            let html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div>
              <strong style="color:#666;">Proveedor:</strong><br>
              ${prov ? prov.nombre : 'Desconocido'}
            </div>
            <div>
              <strong style="color:#666;">Fecha:</strong><br>
              ${new Date(pedido.fecha).toLocaleDateString('es-ES')}
            </div>
          </div>
          
          <div style="margin-bottom: 30px;">
            <strong style="color:#666;">Estado:</strong><br>
            <span class="badge ${pedido.estado === 'recibido' ? 'badge-received' : 'badge-pending'}">
              ${pedido.estado === 'recibido' ? 'Recibido' : 'Pendiente'}
            </span>
          </div>
          
          <h4 style="margin: 30px 0 15px 0; color: #1E293B;">Ingredientes del pedido:</h4>
          
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="background: #F8FAFC; border-bottom: 2px solid #E2E8F0;">
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #64748B;">Ingrediente</th>
                <th style="padding: 12px; text-align: center; font-weight: 600; color: #64748B;">Cantidad</th>
                <th style="padding: 12px; text-align: right; font-weight: 600; color: #64748B;">Precio Unit.</th>
                <th style="padding: 12px; text-align: right; font-weight: 600; color: #64748B;">Subtotal</th>
              </tr>
            </thead>
            <tbody>
        `;

            let total = 0;

            if (pedido.ingredientes && pedido.ingredientes.length > 0) {
              pedido.ingredientes.forEach(item => {
                const ing = ingredientes.find(i => i.id === item.ingredienteId);
                const nombreIng = ing ? ing.nombre : 'Ingrediente eliminado (ID: ' + item.ingredienteId + ')';
                const unidadIng = ing ? ing.unidad : 'ud';

                const cantidad = item.cantidad || 0;
                const precio = item.precioReal || item.precioUnitario || ing.precio || 0;
                const subtotal = cantidad * precio;
                total += subtotal;

                html += `
              <tr style="border-bottom: 1px solid #F1F5F9;">
                <td style="padding: 12px;">
                 <strong style="color: ${ing ? '#1E293B' : '#EF4444'}">${nombreIng}</strong>
                </td>
                <td style="padding: 12px; text-align: center; color: #64748B;">
                  ${cantidad.toFixed(2)} ${unidadIng}
                </td>
                <td style="padding: 12px; text-align: right; color: #64748B;">
                 ${parseFloat(precio || 0).toFixed(2)} ‚Ç¨
                </td>
                <td style="padding: 12px; text-align: right;">
                  <strong style="color: #1E293B;">${subtotal.toFixed(2)} ‚Ç¨</strong>
                </td>
              </tr>
            `;
              });
            } else {
              html += `
            <tr>
              <td colspan="4" style="padding: 40px; text-align: center; color: #94A3B8;">
                No hay ingredientes en este pedido
              </td>
            </tr>
          `;
            }

            html += `
            </tbody>
          </table>
          
          <div style="margin-top: 30px; padding: 20px; background: #F0FDF4; border: 2px solid #10B981; border-radius: 12px; text-align: right;">
            <strong style="color: #666; font-size: 16px;">Total del Pedido:</strong><br>
            <span style="font-size: 32px; font-weight: bold; color: #059669;">${total.toFixed(2)} ‚Ç¨</span>
          </div>
        `;

            document.getElementById('modal-ver-pedido-contenido').innerHTML = html;
            document.getElementById('modal-ver-pedido').classList.add('active');
            pedidoViendoId = pedidoId;
          };

          window.cerrarModalVerPedido = function () {
            document.getElementById('modal-ver-pedido').classList.remove('active');
            pedidoViendoId = null;
          };

          // Funci√≥n auxiliar para calcular coste completo de receta
          window.calcularCosteRecetaCompleto = function (receta) {
            if (!receta || !receta.ingredientes) return 0;
            return receta.ingredientes.reduce((total, item) => {
              const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
              const precio = ing ? parseFloat(ing.precio) : 0;
              return total + (precio * item.cantidad);
            }, 0);
          };

          window.descargarPedidoPDF = function () {
            if (pedidoViendoId === null) return;

            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            const pedido = pedidos.find(p => p.id === pedidoViendoId);
            const prov = proveedores.find(p => p.id === pedido.proveedorId);

            // Crear HTML para imprimir
            let htmlPrint = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pedido - La Caleta 102</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #c35a3f; padding-bottom: 20px; }
    .header h1 { color: #c35a3f; margin: 0; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; background: #f8f8f8; padding: 20px; border-radius: 5px; }
    .info-item { margin-bottom: 10px; }
    .info-item strong { display: block; color: #666; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th { background: #f8f8f8; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-size: 12px; color: #666; }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    .total-box { background: #f0fdf4; border: 2px solid #10b981; padding: 20px; border-radius: 5px; text-align: right; }
    .total-box strong { font-size: 24px; color: #059669; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .badge-received { background: #d1fae5; color: #059669; }
    .badge-pending { background: #fef3c7; color: #d97706; }
    .varianza { font-size: 11px; }
    .varianza.pos { color: #10b981; }
    .varianza.neg { color: #ef4444; }
    @media print {
      body { padding: 20px; }
      button { display: none; }
    }
    /* === RESPONSIVE MOBILE === */
@media (max-width: 768px) {
  /* Container */
  .container { padding: 12px; }
  
  /* Header */
  .header {
    padding: 8px 32px;
    flex-direction: column;
    text-align: center;
    gap: 12px;
  }
  
  .header h1 { font-size: 32px; }
  .header p { font-size: 14px; }
  
  /* KPI Dashboard */
  .kpi-dashboard {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    padding: 0 12px;
    margin: 16px 0;
  }
  
  .kpi-card {
    padding: 16px;
  }
  
  .kpi-icon { font-size: 24px; margin-bottom: 8px; }
  .kpi-label { font-size: 11px; }
  .kpi-value { font-size: 28px; }
  .kpi-trend { font-size: 12px; }
  
  /* Tabs */
  .tabs {
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    padding: 12px 12px 0;
    gap: 8px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  
  .tabs::-webkit-scrollbar { display: none; }
  
  .tab {
    padding: 10px 16px;
    font-size: 13px;
    display: inline-block;
  }
  
  /* Main Card */
  .main-card {
    padding: 16px;
    border-radius: 16px 16px 0 0;
  }
  
  /* Top Bar */
  .top-bar {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 20px;
  }
  
  .top-bar h2 { font-size: 22px; }
  .top-bar p { font-size: 13px; }
  
  /* Buttons */
  .btn {
    width: 100%;
    justify-content: center;
    padding: 14px 20px;
    font-size: 14px;
  }
  
  .btn-small {
    width: auto;
    padding: 10px 16px;
  }
  
  /* Search Box */
  .search-box {
    max-width: 100%;
    margin: 16px 0;
  }
  
  /* Form Grid */
  .form-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .form-card {
    padding: 16px;
  }
  
  /* Tables */
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }
  
  table thead th {
    padding: 12px 16px;
    font-size: 10px;
  }
  
  table tbody td {
    padding: 12px 16px;
    font-size: 13px;
  }
  
  /* Actions */
  .actions {
    gap: 6px;
  }
  
  .icon-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  /* Stats Grid */
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  /* Charts Grid */
  .charts-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  /* Balance Cards */
  [id^="tab-balance"] > div[style*="grid"] {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }
  
  /* Balance Cards Gradient */
  [id="tab-balance"] > div:nth-child(2) > div {
    padding: 24px !important;
  }
  
  [id="tab-balance"] > div:nth-child(2) > div > div:first-child {
    font-size: 100px !important;
  }
  
  [id="tab-balance"] > div:nth-child(2) > div [id^="balance-"] {
    font-size: 36px !important;
  }
  
  /* Modals */
  .modal-content {
    width: 95%;
    padding: 20px;
    max-height: 90vh;
  }
  
  /* Ingrediente Item */
  .ingrediente-item {
    grid-template-columns: 1fr;
    gap: 8px;
  }
  
  .ingrediente-item select,
  .ingrediente-item input {
    width: 100%;
  }
  
  /* Toast Container */
  .toast-container {
    top: 60px;
    right: 12px;
    left: 12px;
    max-width: none;
  }
  
  .toast {
    padding: 12px 16px;
  }
  
  /* Summary */
  .summary {
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
  }
}

@media (max-width: 480px) {
  /* Extra peque√±o */
  .kpi-dashboard {
    grid-template-columns: 1fr;
  }
  
  .header h1 { font-size: 28px; }
  
  .kpi-value { font-size: 32px; }
}
  </style>
</head>
<body>
  <div class="header">
    <img src="logo.png" onerror="this.style.display='none'">
    <h1>${currentUser.restaurante || 'Mi Restaurante'}</h1>
    <p>Pedido a Proveedor</p>
  </div>

  <div class="info-grid">
    <div class="info-item">
      <strong>Proveedor</strong>
      ${prov ? prov.nombre : 'Desconocido'}
    </div>
    <div class="info-item">
      <strong>Fecha del Pedido</strong>
      ${new Date(pedido.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}
    </div>
    <div class="info-item">
      <strong>Estado</strong>
      <span class="badge ${pedido.estado === 'recibido' ? 'badge-received' : 'badge-pending'}">
        ${pedido.estado === 'recibido' ? 'Recibido' : 'Pendiente'}
      </span>
    </div>
    ${pedido.estado === 'recibido' && pedido.fechaRecepcion ? `
    <div class="info-item">
      <strong>Fecha de Recepci√≥n</strong>
      ${new Date(pedido.fechaRecepcion).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}
    </div>
    ` : ''}
  </div>

  <h3>Detalle del Pedido</h3>
  <table>
    <thead>
      <tr>
        <th>Ingrediente</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Subtotal</th>
        ${pedido.estado === 'recibido' ? '<th>Estado</th>' : ''}
      </tr>
    </thead>
    <tbody>`;

            const items = pedido.ingredientes;
            let totalFinal = 0;

            items.forEach(item => {
              const ing = ingredientes.find(i => i.id === item.ingredienteId);
              if (!ing) return;

              const esRecibido = pedido.estado === 'recibido' && item.cantidadRecibida !== undefined;
              const cantidad = esRecibido ? item.cantidadRecibida : item.cantidad;
              const precio = esRecibido && item.precioReal ? item.precioReal : item.precioUnitario;
              const subtotal = cantidad * precio;

              if (item.estado !== 'no-entregado') {
                totalFinal += subtotal;
              }

              htmlPrint += '<tr>';
              htmlPrint += `<td>${ing.nombre}</td>`;
              htmlPrint += `<td>${cantidad} ${ing.unidad}`;

              if (esRecibido && item.cantidad && Math.abs(cantidad - item.cantidad) > 0.01) {
                const diff = cantidad - item.cantidad;
                htmlPrint += `<br><span class="varianza ${diff > 0 ? 'pos' : 'neg'}">(${diff > 0 ? '+' : ''}${diff.toFixed(2)})</span>`;
              }

              htmlPrint += `</td>`;
              htmlPrint += `<td>${parseFloat(precio || 0).toFixed(2)} ‚Ç¨/${ing.unidad}`;

              if (esRecibido && item.precioUnitario && Math.abs(precio - item.precioUnitario) > 0.01) {
                const diff = precio - item.precioUnitario;
                htmlPrint += `<br><span class="varianza ${diff > 0 ? 'neg' : 'pos'}">(${diff > 0 ? '+' : ''}${diff.toFixed(2)} ‚Ç¨)</span>`;
              }

              htmlPrint += `</td>`;
              htmlPrint += `<td>${item.estado === 'no-entregado' ? '0.00' : subtotal.toFixed(2)} ‚Ç¨</td>`;

              if (esRecibido) {
                let estadoText = '';
                if (item.estado === 'consolidado') estadoText = '‚úÖ OK';
                else if (item.estado === 'varianza') estadoText = '‚ö†Ô∏è Varianza';
                else if (item.estado === 'no-entregado') estadoText = '‚ùå No entregado';
                htmlPrint += `<td>${estadoText}</td>`;
              }

              htmlPrint += '</tr>';
            });

            htmlPrint += '</tbody></table>';

            if (pedido.estado === 'recibido' && pedido.totalRecibido !== undefined) {
              const varianza = pedido.totalRecibido - pedido.total;
              htmlPrint += `
  <div class="total-box">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
      <div>
        <strong style="color:#666;font-size:14px;">Total Original</strong><br>
        <span style="font-size:20px;">${pedido.total.toFixed(2)} ‚Ç¨</span>
      </div>
      <div>
        <strong style="color:#059669;font-size:14px;">Total Recibido</strong><br>
        <strong>${pedido.totalRecibido.toFixed(2)} ‚Ç¨</strong>
      </div>
      <div>
        <strong style="color:#666;font-size:14px;">Varianza</strong><br>
        <span style="font-size:20px;color:${varianza >= 0 ? '#ef4444' : '#10b981'};">${varianza >= 0 ? '+' : ''}${varianza.toFixed(2)} ‚Ç¨</span>
      </div>
    </div>
  </div>`;
            } else {
              htmlPrint += `
  <div class="total-box">
   <strong>Total del Pedido: ${parseFloat(pedido.total).toFixed(2)} ‚Ç¨</strong>
  </div>`;
            }

            htmlPrint += `
  <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 11px; color: #999; text-align: center;">
    Generado el ${new Date().toLocaleDateString('es-ES')} - ${currentUser.restaurante || 'MindLoop Dashboard'}
  </div>
</body>
</html>`;

            // Abrir en nueva ventana para imprimir/guardar PDF
            const ventana = window.open('', '_blank');
            ventana.document.write(htmlPrint);
            ventana.document.close();

            // Esperar a que se cargue y abrir di√°logo de impresi√≥n
            setTimeout(() => {
              ventana.print();
            }, 250);
          };

          window.renderizarPedidos = function () {
            const busqueda = document.getElementById('busqueda-pedidos').value.toLowerCase();
            const filtrados = pedidos.filter(ped => {
              const prov = proveedores.find(p => p.id === ped.proveedorId);
              const nombreProv = prov ? prov.nombre.toLowerCase() : '';
              return nombreProv.includes(busqueda) || ped.estado.includes(busqueda);
            });

            const container = document.getElementById('tabla-pedidos');

            if (filtrados.length === 0) {
              container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìã</div>
              <h3>${busqueda ? 'No encontrados' : 'A√∫n no hay pedidos'}</h3>
              <p>${busqueda ? 'Otra b√∫squeda' : 'Crea tu primer pedido'}</p>
            </div>
          `;
              document.getElementById('resumen-pedidos').style.display = 'none';
            } else {
              let html = '<table><thead><tr>';
              html += '<th>Fecha</th><th>Proveedor</th><th>Items</th><th>Total</th><th>Estado</th><th>Acciones</th>';
              html += '</tr></thead><tbody>';

              filtrados.forEach(ped => {
                const prov = proveedores.find(p => p.id === (ped.proveedor_id || ped.proveedorId));
                const nombreProv = prov ? prov.nombre : 'Desconocido';

                html += '<tr>';
                html += `<td>${new Date(ped.fecha).toLocaleDateString('es-ES')}</td>`;
                html += `<td><strong>${nombreProv}</strong></td>`;
                html += `<td>${ped.ingredientes.length} ingredientes</td>`;
                html += `<td><strong>${parseFloat(ped.total).toFixed(2)} ‚Ç¨</strong></td>`;
                html += `<td><span class="badge ${ped.estado === 'recibido' ? 'badge-received' : 'badge-pending'}">${ped.estado === 'recibido' ? 'Recibido' : 'Pendiente'}</span></td>`;
                html += `<td><div class="actions">`;
                html += `<button class="icon-btn view" onclick="window.verDetallesPedido(${ped.id})" title="Ver detalles">üëÅÔ∏è</button>`;
                if (ped.estado === 'pendiente') {
                  html += `<button class="icon-btn receive" onclick="window.marcarPedidoRecibido(${ped.id})" title="Recibir pedido">üì•</button>`;
                }
                html += `<button class="icon-btn delete" onclick="window.eliminarPedido(${ped.id})" title="Eliminar">üóëÔ∏è</button>`;
                html += '</div></td>';
                html += '</tr>';
              });

              html += '</tbody></table>';
              container.innerHTML = html;

              const totalPendientes = pedidos.filter(p => p.estado === 'pendiente').length;
              const totalRecibidos = pedidos.filter(p => p.estado === 'recibido').length;

              document.getElementById('resumen-pedidos').innerHTML = `
            <div>Total: <strong>${pedidos.length}</strong></div>
            <div>Pendientes: <strong>${totalPendientes}</strong></div>
            <div>Recibidos: <strong>${totalRecibidos}</strong></div>
          `;
              document.getElementById('resumen-pedidos').style.display = 'flex';
            }
          }

          // ========== AN√ÅLISIS (resumido) ==========
          window.renderizarAnalisis = async function () {
            if (recetas.length === 0 || ingredientes.length === 0) {
              document.getElementById('analisis-vacio').style.display = 'block';
              document.getElementById('analisis-contenido').style.display = 'none';
              return;
            }

            document.getElementById('analisis-vacio').style.display = 'none';
            document.getElementById('analisis-contenido').style.display = 'block';

            let totalMargen = 0;
            let totalCoste = 0;
            const datosRecetas = recetas.map(rec => {
              const coste = calcularCosteRecetaCompleto(rec);
              const margen = rec.precio_venta - coste;
              const margenPct = rec.precio_venta > 0 ? (margen / rec.precio_venta) * 100 : 0;
              totalMargen += margenPct;
              totalCoste += coste;
              return { ...rec, coste, margen, margenPct };
            });

            try {
              const menuAnalysis = await api.getMenuEngineering(); // Nueva llamada a la API

              let totalMargen = 0;
              let totalCoste = 0;
              const datosRecetas = recetas.map(rec => {
                const coste = calcularCosteRecetaCompleto(rec);
                const margen = rec.precio_venta - coste;
                const margenPct = rec.precio_venta > 0 ? (margen / rec.precio_venta) * 100 : 0;
                totalMargen += margenPct;
                totalCoste += coste;
                return { ...rec, coste, margen, margenPct };
              });

              const margenPromedio = (totalMargen / recetas.length).toFixed(1);
              const costePromedio = (totalCoste / recetas.length).toFixed(2);

              document.getElementById('stat-total-recetas').textContent = menuAnalysis.length;
              document.getElementById('stat-margen-promedio').textContent = margenPromedio + '%';
              document.getElementById('stat-coste-promedio').textContent = costePromedio + ' ‚Ç¨';
              document.getElementById('stat-total-ingredientes').textContent = ingredientes.length;

              // Renderizar Gr√°ficos existentes
              renderRevenueChart();
              renderChartRentabilidad(datosRecetas);
              renderChartIngredientes();
              renderTablaRentabilidad(datosRecetas);

              // RENDERIZAR INGENIER√çA DE MEN√ö (Matriz BCG)
              renderMenuEngineeringUI(menuAnalysis);

            } catch (error) {
              console.error('Error renderizando an√°lisis:', error);
            }
          };

          window.renderMenuEngineeringUI = function (data) {
            const container = document.getElementById('bcg-matrix-container');
            if (!container) return;

            // Limpiar contenedores
            const containers = {
              'estrella': document.getElementById('lista-estrella'),
              'caballo': document.getElementById('lista-caballo'),
              'puzzle': document.getElementById('lista-puzzle'),
              'perro': document.getElementById('lista-perro')
            };

            Object.values(containers).forEach(c => c.innerHTML = '');

            const consejos = {
              'estrella': '‚≠ê <strong>Consejo:</strong> Estos son tus platos estrella - generan buenos m√°rgenes y se venden mucho. Estrategia: Mant√©n la calidad constante, dest√°calos en el men√∫ principal, considera subirlos ligeramente de precio (tienen demanda), capacita al equipo para recomendarlos, y usa fotos atractivas en redes sociales para aprovechar su popularidad.',
              'caballo': 'üê¥ <strong>Consejo:</strong> Se venden mucho pero ganan poco - peligro de trabajar sin beneficio. Estrategia urgente: Renegocia con proveedores para reducir coste, optimiza las porciones sin afectar percepci√≥n de calidad, sube el precio gradualmente (5-10%), o redise√±a la receta con ingredientes m√°s econ√≥micos manteniendo el sabor. Son candidatos a retirar si no mejora la rentabilidad.',
              'puzzle': '‚ùì <strong>Consejo:</strong> Platos rentables pero poco vendidos - tienen potencial sin explotar. Estrategia: Mejora la visibilidad (posici√≥n destacada en carta, descripci√≥n m√°s apetecible, foto profesional), forma al personal para recomendarlos activamente, crea combos con platos populares, o considera cambiar el nombre para hacerlo m√°s atractivo. Si tras estos cambios no mejoran, eval√∫a retirarlos.',
              'perro': 'üêï <strong>Consejo:</strong> No se venden y no ganan - est√°n ocupando espacio valioso en tu carta. Acci√≥n recomendada: Ret√≠ralos del men√∫ cuanto antes. Est√°n consumiendo inventario, tiempo de cocina y espacio en carta sin aportar valor. Libera recursos para potenciar tus Estrellas o mejorar tus Puzzles. Si tienen valor sentimental, considera ofrecerlos solo como especial del d√≠a ocasional.'
            };

            // A√±adir consejos DENTRO del contenedor limpio, al principio
            containers['estrella'].innerHTML = `<div style="font-size: 11px; margin-bottom: 8px; color: #065f46; width:100%;">${consejos['estrella']}</div>`;
            containers['caballo'].innerHTML = `<div style="font-size: 11px; margin-bottom: 8px; color: #9a3412; width:100%;">${consejos['caballo']}</div>`;
            containers['puzzle'].innerHTML = `<div style="font-size: 11px; margin-bottom: 8px; color: #1e40af; width:100%;">${consejos['puzzle']}</div>`;
            containers['perro'].innerHTML = `<div style="font-size: 11px; margin-bottom: 8px; color: #991b1b; width:100%;">${consejos['perro']}</div>`;

            data.forEach(item => {
              const el = document.createElement('div');
              el.className = 'bcg-item';
              el.innerHTML = `<strong>${item.nombre}</strong><br><span style="font-size:11px">Mg: ${item.margen.toFixed(2)}‚Ç¨ | Ventas: ${item.popularidad}</span>`;

              if (containers[item.clasificacion]) {
                containers[item.clasificacion].appendChild(el);
              }
            });
          }

          function renderChartRentabilidad(datos) {
            const ctx = document.getElementById('chart-rentabilidad');
            if (!ctx) return;

            const ordenados = [...datos].sort((a, b) => b.margenPct - a.margenPct).slice(0, 10);

            if (chartRentabilidad) chartRentabilidad.destroy();

            chartRentabilidad = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ordenados.map(r => r.nombre),
                datasets: [{
                  label: 'Margen (%)',
                  data: ordenados.map(r => r.margenPct.toFixed(1)),
                  backgroundColor: ordenados.map(r => r.margenPct > 50 ? '#10b981' : r.margenPct > 30 ? '#f59e0b' : '#ef4444')
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return value + '%';
                      }
                    }
                  }
                }
              }
            });
          }

          function renderChartIngredientes() {
            const ctx = document.getElementById('chart-ingredientes');
            if (!ctx) return;

            const ordenados = [...ingredientes]
              .filter(ing => ing.precio > 0)
              .sort((a, b) => b.precio - a.precio)
              .slice(0, 10);

            if (chartIngredientes) chartIngredientes.destroy();

            chartIngredientes = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ordenados.map(i => i.nombre),
                datasets: [{
                  data: ordenados.map(i => i.precio),
                  backgroundColor: [
                    '#c35a3f', '#d47157', '#10b981', '#3b82f6', '#f59e0b',
                    '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
                  ]
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    position: 'right',
                    labels: {
                      font: {
                        size: 11
                      }
                    }
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        return context.label + ': ' + context.parsed.toFixed(2) + ' ‚Ç¨';
                      }
                    }
                  }
                }
              }
            });
          }

          function renderTablaRentabilidad(datos) {
            const ordenados = [...datos].sort((a, b) => b.margenPct - a.margenPct);

            let html = '<table><thead><tr>';
            html += '<th>#</th><th>Plato</th><th>Coste</th><th>Precio</th><th>Margen ‚Ç¨</th><th>Margen %</th>';
            html += '</tr></thead><tbody>';

            ordenados.forEach((rec, idx) => {
              html += '<tr>';
              html += `<td><strong>#${idx + 1}</strong></td>`;
              html += `<td>${rec.nombre}</td>`;
              html += `<td>${parseFloat(rec.coste || 0).toFixed(2)} ‚Ç¨</td>`;
              html += `<td>${parseFloat(rec.precio_venta || 0).toFixed(2)} ‚Ç¨</td>`;
              html += `<td>${parseFloat(rec.margen || 0).toFixed(2)} ‚Ç¨</td>`;
              html += `<td><span class="badge ${rec.margenPct > 50 ? 'badge-success' : rec.margenPct > 30 ? 'badge-warning' : 'badge-warning'}">${parseFloat(rec.margenPct || 0).toFixed(1)}%</span></td>`;
              html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('tabla-rentabilidad').innerHTML = html;
          }

          // ========== INVENTARIO ==========
          window.renderizarInventario = async function () {
            try {
              const inventario = await api.getInventoryComplete();
              const busqueda = document.getElementById('busqueda-inventario').value.toLowerCase();
              const filtrados = inventario.filter(ing =>
                ing.nombre.toLowerCase().includes(busqueda)
              );

              const container = document.getElementById('tabla-inventario');

              // Calcular alertas
              let stockBajo = 0;
              let stockCritico = 0;

              window.ingredientes.forEach(ing => {
                const stockActual = parseFloat(ing.stock_actual) || 0;
                const stockMinimo = parseFloat(ing.stock_minimo) || 0;
                // Solo contar si tiene m√≠nimo configurado
                if (stockActual <= 0) {
                  stockCritico++;
                } else if (stockMinimo > 0 && stockActual <= stockMinimo) {
                  stockBajo++;
                }
              });

              // Actualizar badge
              const totalAlertas = stockBajo + stockCritico;
              const badge = document.getElementById('badge-inventario');
              if (totalAlertas > 0) {
                badge.textContent = totalAlertas;
                badge.style.display = 'inline-block';
              } else {
                badge.style.display = 'none';
              }

              // Actualizar resumen
              const resumen = document.getElementById('resumen-inventario');
              if (stockBajo > 0 || stockCritico > 0) {
                resumen.innerHTML = `
            <div style="color: #f59e0b;">‚ö†Ô∏è Stock bajo: <strong>${stockBajo}</strong></div>
            <div style="color: #ef4444;">üî¥ Stock cr√≠tico: <strong>${stockCritico}</strong></div>
          `;
                resumen.style.display = 'flex';
              } else {
                resumen.style.display = 'none';
              }

              if (filtrados.length === 0) {
                container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üì¶</div>
              <h3>No hay ingredientes</h3>
              <p>A√±ade ingredientes para gestionar el inventario</p>
            </div>
          `;
                return;
              }

              let html = '<table><thead><tr>';
              html += '<th>Estado</th><th>Ingrediente</th><th>Stock Virtual</th><th>Stock Real</th><th>Diferencia</th><th>Precio Medio</th><th>Valor Stock</th><th>Unidad</th>';
              html += '</tr></thead><tbody>';

              filtrados.forEach(ing => {
                let estadoClass = 'stock-ok';
                let estadoIcon = 'üü¢';

                const stockActual = parseFloat(ing.stock_virtual) || 0;
                const stockMinimo = parseFloat(ing.stock_minimo) || 0;

                if (stockActual <= 0) {
                  estadoClass = 'stock-critico';
                  estadoIcon = 'üî¥';
                } else if (stockMinimo > 0 && stockActual <= stockMinimo) {
                  estadoClass = 'stock-bajo';
                  estadoIcon = 'üü°';
                }

                const precioMedio = parseFloat(ing.precio_medio || 0);
                const valorStock = parseFloat(ing.valor_stock || 0);
                const diferencia = parseFloat(ing.diferencia || 0);
                const stockReal = ing.stock_real !== null ? parseFloat(ing.stock_real).toFixed(2) : '';

                html += '<tr>';
                html += `<td><span class="stock-indicator ${estadoClass}"></span>${estadoIcon}</td>`;
                html += `<td><strong>${ing.nombre}</strong></td>`;
                html += `<td><span class="stock-value">${parseFloat(ing.stock_virtual || 0).toFixed(2)}</span></td>`;

                // Input con evento ONINPUT para c√°lculo din√°mico
                // Input con evento ONINPUT para c√°lculo din√°mico
                html += `<td><input type="number" step="0.01" value="${stockReal}" placeholder="Sin datos" 
                        class="input-stock-real" 
                        data-id="${ing.id}" 
                        data-stock-virtual="${ing.stock_virtual || 0}" 
                        data-precio="${precioMedio}"
                        oninput="window.updateDifferenceCell(this)"
                        style="width:80px;padding:5px;border:1px solid #ddd;border-radius:4px;"></td>`;

                // Celda de Diferencia con ID √∫nico para actualizar
                let diffDisplay = '-';
                let diffColor = '#666';

                // Si viene calculado de backend (porque hab√≠a stock_real guardado)
                if (ing.diferencia !== null && ing.diferencia !== undefined) {
                  const d = parseFloat(ing.diferencia);
                  diffDisplay = d.toFixed(2);
                  if (d < 0) diffColor = '#ef4444'; // Negativo (Falta) -> Rojo
                  else if (d > 0) diffColor = '#10b981'; // Positivo (Sobra) -> Verde
                }

                html += `<td id="diff-cell-${ing.id}" style="color:${diffColor}; font-weight:bold;">${diffDisplay}</td>`;

                html += `<td>${precioMedio.toFixed(2)}‚Ç¨/${ing.unidad}</td>`;

                // Valor Stock: Por defecto usa Virtual. Si hay Real guardado, usa Real.
                const cantidadParaValor = (stockReal !== '' && stockReal !== null) ? parseFloat(stockReal) : parseFloat(ing.stock_virtual || 0);
                const valorStockDisplay = (cantidadParaValor * precioMedio).toFixed(2);

                html += `<td id="val-cell-${ing.id}"><strong>${valorStockDisplay}‚Ç¨</strong></td>`;
                html += `<td>${ing.unidad}</td>`;
                html += '</tr>';
              });

              container.innerHTML = html;
            } catch (error) {
              console.error('Error:', error);
              document.getElementById('tabla-inventario').innerHTML = '<p style="color:#ef4444;">Error cargando inventario</p>';
            }
          };

          window.updateDifferenceCell = function (input) {
            const id = input.dataset.id;
            const virtual = parseFloat(input.dataset.stockVirtual) || 0;
            const val = input.value;
            const cellDiff = document.getElementById(`diff-cell-${id}`);
            const cellVal = document.getElementById(`val-cell-${id}`);

            // Precio Medio (lo extraemos de la celda vecina o mejor, lo pasamos por data attribute.
            // Hack r√°pido: obtenemos valor de la celda de precio (indice 5, pero variable)
            // Mejor: Agregamos data-precio al input
            const precio = parseFloat(input.dataset.precio || 0);

            if (val === '' || val === null) {
              cellDiff.textContent = '-';
              cellDiff.style.color = '#666';
              // Si borra, volvemos a mostrar valor VIRTUAL
              cellVal.innerHTML = `<strong>${(virtual * precio).toFixed(2)}‚Ç¨</strong>`;
              return;
            }

            const real = parseFloat(val);
            const diff = real - virtual;

            cellDiff.textContent = diff.toFixed(2);
            if (diff < 0) cellDiff.style.color = '#ef4444';
            else if (diff > 0) cellDiff.style.color = '#10b981';
            else cellDiff.style.color = '#666';

            // Actualizar Valor Stock (REAL * Precio)
            cellVal.innerHTML = `<strong>${(real * precio).toFixed(2)}‚Ç¨</strong>`;
          };

          // Funci√≥n global para actualizar stock real
          // Funci√≥n para guardar stock masivo
          // Funci√≥n para guardar stock masivo con l√≥gica de mermas
          window.guardarCambiosStock = async function () {
            const inputs = document.querySelectorAll('.input-stock-real');
            const adjustments = [];
            const mermas = [];

            inputs.forEach(input => {
              const val = input.value;
              if (val !== '' && val !== null) {
                const nuevoReal = parseFloat(val);
                const dataId = parseInt(input.dataset.id);
                const stockVirtual = parseFloat(input.dataset.stockVirtual || 0);

                // Solo nos importa si hay cambios (aunque la l√≥gica pide ajustar si es positivo, 
                // asumimos que si el usuario escribe algo es porque quiere fijarlo)
                // Pero podemos optimizar enviando solo lo que difiere o todo lo escrito.
                // El usuario dijo "Update Stock" button allow users to edit multiple...
                // Enviamos todo lo que tenga valor expl√≠cito en el input.

                const item = {
                  id: dataId,
                  stock_real: nuevoReal
                };
                adjustments.push(item);

                // Detectar mermas (Real < Ficticio)
                // Nota: Javascript floats pueden ser tricky, usamos una peque√±a tolerancia o simple comparaci√≥n
                if (nuevoReal < stockVirtual) {
                  const nombreIng = window.ingredientes.find(i => i.id === dataId)?.nombre || 'Ingrediente ' + dataId;
                  mermas.push({ id: dataId, nombre: nombreIng, diferencia: (stockVirtual - nuevoReal).toFixed(2) });
                }
              }
            });

            if (adjustments.length === 0) {
              showToast('No hay datos para guardar', 'info');
              return;
            }

            // L√≥gica de confirmaci√≥n
            if (mermas.length > 0) {
              // Abrir modal de gesti√≥n de mermas
              window.mostrarModalConfirmarMermas(adjustments, mermas);
              return;
            }

            let mensajeConfirmacion = `¬øActualizar stock de ${adjustments.length} ingredientes?`;
            mensajeConfirmacion += `\n\nEl stock ficticio se ajustar√° autom√°ticamente al stock real ingresado.`;

            if (!confirm(mensajeConfirmacion)) return;

            try {
              showLoading();
              // Usamos el endpoint de consolidaci√≥n que actualiza AMBOS (read y actual)
              await api.consolidateStock(adjustments);
              await window.renderizarInventario();
              hideLoading();
              showToast('Inventario consolidado correctamente', 'success');
            } catch (error) {
              hideLoading();
              showToast('Error: ' + error.message, 'error');
            }
          };

          // Variables para el modal de mermas (Snapshot y Ajustes)
          let currentSnapshots = [];
          let currentAdjustmentsMap = {}; // Map ingId -> Array of reasons

          window.mostrarModalConfirmarMermas = function (snapshotsData) {
            currentSnapshots = snapshotsData;
            currentAdjustmentsMap = {};

            // Inicializar ajustes vac√≠os
            currentSnapshots.forEach(snap => {
              const diff = snap.stock_real - snap.stock_virtual;
              // Si falta stock (diff negativa), proponemos una fila inicial por defecto
              if (diff < 0) {
                currentAdjustmentsMap[snap.id] = [{
                  id: Date.now() + Math.random(),
                  cantidad: Math.abs(diff), // Sugerimos todo como una causa inicial
                  motivo: 'Caduco',
                  notas: ''
                }];
              } else {
                // Si sobra stock (diff positiva), tambi√©n se debe justificar
                currentAdjustmentsMap[snap.id] = [{
                  id: Date.now() + Math.random(),
                  cantidad: diff,
                  motivo: 'Error de Inventario', // Default positivo
                  notas: ''
                }];
              }
            });

            window.renderTablaSplits();
            document.getElementById('modal-confirmar-mermas').classList.add('active');
          };

          window.renderTablaSplits = function () {
            const tbody = document.getElementById('tabla-mermas-body');
            tbody.innerHTML = '';

            let totalValid = true;

            currentSnapshots.forEach(snap => {
              const ing = ingredientes.find(i => i.id === snap.id);
              const nombre = ing ? ing.nombre : 'Unknown';
              const diffTotal = snap.stock_real - snap.stock_virtual;
              const isNegative = diffTotal < 0;
              const sign = isNegative ? '-' : '+';
              const color = isNegative ? '#ef4444' : '#10b981';

              // Calcular cu√°nto llevamos asignado
              const asignado = currentAdjustmentsMap[snap.id].reduce((sum, adj) => sum + parseFloat(adj.cantidad || 0), 0);
              // La suma de ajustes (siempre positivos en input) debe igualar el valor absoluto de la diferencia
              const target = Math.abs(diffTotal);
              const restante = target - asignado;
              const isMatch = Math.abs(restante) < 0.01;

              if (!isMatch) totalValid = false;

              // Fila Cabecera Ingrediente
              const trHeader = document.createElement('tr');
              trHeader.style.background = '#f1f5f9';
              trHeader.innerHTML = `
                    <td colspan="4" style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong>${nombre}</strong>
                            <span>Diff: <strong style="color:${color}">${sign}${Math.abs(diffTotal).toFixed(2)} ${ing.unidad}</strong></span>
                        </div>
                         <div style="font-size:12px; color: ${isMatch ? '#059669' : '#dc2626'}; margin-top:4px;">
                            ${isMatch ? '‚úì Cuadrado' : `‚ö†Ô∏è Faltan por asignar: ${restante.toFixed(2)} ${ing.unidad}`}
                        </div>
                    </td>
                `;
              tbody.appendChild(trHeader);

              // Filas de Ajustes (Splits)
              currentAdjustmentsMap[snap.id].forEach((adj, idx) => {
                const trAdj = document.createElement('tr');
                trAdj.innerHTML = `
                        <td style="padding-left: 20px;">
                            <span style="color:#aaa; font-size:12px;">‚Ü≥ Ajuste ${idx + 1}</span>
                        </td>
                         <td style="padding: 5px;">
                            <input type="number" step="0.01" value="${(adj.cantidad || 0)}" 
                                onchange="window.updateSplitAmount(${snap.id}, ${adj.id}, this.value)"
                                style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"> 
                            <span style="font-size:11px">${ing.unidad}</span>
                        </td>
                        <td style="padding: 5px;">
                            <select onchange="window.updateSplitReason(${snap.id}, ${adj.id}, this.value)"
                                style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="Caduco" ${adj.motivo === 'Caduco' ? 'selected' : ''}>Caduco</option>
                                <option value="Invitacion" ${adj.motivo === 'Invitacion' ? 'selected' : ''}>Invitaci√≥n</option>
                                <option value="Accidente" ${adj.motivo === 'Accidente' ? 'selected' : ''}>Accidente</option>
                                <option value="Error Cocina" ${adj.motivo === 'Error Cocina' ? 'selected' : ''}>Error Cocina</option>
                                <option value="Error Inventario" ${adj.motivo === 'Error Inventario' ? 'selected' : ''}>Error Conteo</option>
                                <option value="Robo" ${adj.motivo === 'Robo' ? 'selected' : ''}>Robo / Desconocido</option>
                                <option value="Otros" ${adj.motivo === 'Otros' ? 'selected' : ''}>Otros</option>
                            </select>
                        </td>
                        <td style="padding: 5px; display: flex; gap: 5px;">
                            <input type="text" value="${adj.notas}" placeholder="Nota..."
                                onchange="window.updateSplitNote(${snap.id}, ${adj.id}, this.value)"
                                style="flex:1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="window.removeSplit(${snap.id}, ${adj.id})" style="background:none; border:none; cursor:pointer;">‚ùå</button>
                        </td>
                    `;
                tbody.appendChild(trAdj);
              });

              // Bot√≥n a√±adir split
              const trAdd = document.createElement('tr');
              trAdd.innerHTML = `
                    <td colspan="4" style="text-align:right; padding:5px; border-bottom: 2px solid #e2e8f0;">
                        <button onclick="window.addSplit(${snap.id})" style="font-size:12px; color:#3b82f6; background:none; border:none; cursor:pointer; font-weight:600;">+ Dividir diferencia</button>
                    </td>
                 `;
              tbody.appendChild(trAdd);
            });

            const btn = document.getElementById('btn-confirmar-split');
            const alertBox = document.getElementById('mermas-alert-box');

            if (totalValid) {
              btn.disabled = false;
              btn.style.opacity = 1;
              alertBox.style.display = 'none';
            } else {
              btn.disabled = true;
              btn.style.opacity = 0.5;
              alertBox.textContent = '‚ö†Ô∏è Debes asignar la cantidad exacta total para todos los ingredientes antes de confirmar.';
              alertBox.style.display = 'block';
            }
          };

          window.updateSplitAmount = (ingId, adjId, val) => {
            const adj = currentAdjustmentsMap[ingId].find(a => a.id === adjId);
            // Si val es vac√≠o o inv√°lido, usamos 0
            if (adj) adj.cantidad = parseFloat(val) || 0;
            window.renderTablaSplits();
          };

          window.updateSplitReason = (ingId, adjId, val) => {
            const adj = currentAdjustmentsMap[ingId].find(a => a.id === adjId);
            if (adj) adj.motivo = val;
          };

          window.updateSplitNote = (ingId, adjId, val) => {
            const adj = currentAdjustmentsMap[ingId].find(a => a.id === adjId);
            if (adj) adj.notas = val;
          };

          window.addSplit = (ingId) => {
            currentAdjustmentsMap[ingId].push({
              id: Date.now(),
              cantidad: 0,
              motivo: 'Caduco',
              notas: ''
            });
            window.renderTablaSplits();
          };

          window.removeSplit = (ingId, adjId) => {
            currentAdjustmentsMap[ingId] = currentAdjustmentsMap[ingId].filter(a => a.id !== adjId);
            window.renderTablaSplits();
          };

          window.confirmarMermasFinal = async function () {
            // Flatten de todos los ajustes para enviar
            const finalAdjustments = [];

            Object.keys(currentAdjustmentsMap).forEach(ingIdStr => {
              const ingId = parseInt(ingIdStr);
              currentAdjustmentsMap[ingId].forEach(adj => {
                // Importante: Si la diferencia original era NEGATIVA, los ajustes son SALIDAS (negativos).
                // Si era POSITIVA, son ENTRADAS (positivos).
                // La UI muestra valores absolutos para simplificar, aqu√≠ aplicamos el signo.
                const snap = currentSnapshots.find(s => s.id === ingId);
                const isNegative = (snap.stock_real - snap.stock_virtual) < 0;

                finalAdjustments.push({
                  ingrediente_id: ingId,
                  cantidad: isNegative ? -Math.abs(adj.cantidad) : Math.abs(adj.cantidad),
                  motivo: adj.motivo,
                  notas: adj.notas
                });
              });
            });

            // Preparar payload para consolidate (Snapshots + Splits)
            // FinalStock is just the target state for updating the master table
            const finalStock = currentSnapshots.map(s => ({
              id: s.id,
              stock_real: s.stock_real
            }));

            try {
              document.getElementById('modal-confirmar-mermas').classList.remove('active');
              showLoading();

              await api.consolidateStock(finalAdjustments, currentSnapshots, finalStock);

              await window.renderizarInventario();
              hideLoading();
              showToast('Ajustes de inventario registrados correctamente', 'success');
            } catch (error) {
              hideLoading();
              showToast('Error: ' + error.message, 'error');
            }
          };

          // MODIFICACION EN CLAVE: guardarCambiosStock (Nueva L√≥gica)
          window.guardarCambiosStock = async function () {
            const inputs = document.querySelectorAll('.input-stock-real');
            const changes = [];

            inputs.forEach(input => {
              const id = parseInt(input.dataset.id);
              // Validaci√≥n anti-NaN: Si dataset.stockVirtual falla, asumimos 0
              const virtual = parseFloat(input.dataset.stockVirtual) || 0;
              const real = parseFloat(input.value);

              // Solo procesamos si hay cambio real
              if (!isNaN(real) && Math.abs(real - virtual) > 0.001) {
                changes.push({
                  id: id,
                  stock_virtual: virtual,
                  stock_real: real
                });
              }
            });

            if (changes.length === 0) {
              showToast('No hay cambios en el stock para registrar', 'info');
              return;
            }

            // ABRIMOS DIRECTAMENTE EL CHECKER (Modal Split)
            window.mostrarModalConfirmarMermas(changes);
          };


          // Event listener para b√∫squeda de inventario
          document.getElementById('busqueda-inventario').addEventListener('input', window.renderizarInventario);

          // Dashboard expandido - actualizar datos
          window.actualizarDashboardExpandido = async function () {
            try {
              // Verificar que los elementos existan antes de continuar
              const ventasHoyEl = document.getElementById('ventas-hoy');
              const ingresosHoyEl = document.getElementById('ingresos-hoy');
              const platoEstrellaEl = document.getElementById('plato-estrella-hoy');
              const alertasListaEl = document.getElementById('alertas-stock-lista');

              if (!ventasHoyEl || !ingresosHoyEl || !platoEstrellaEl || !alertasListaEl) {
                console.warn('Dashboard elements not loaded yet');
                return;
              }

              const ventas = await api.getSales();
              const hoy = new Date().toISOString().split('T')[0];
              const ventasHoy = ventas.filter(v => v.fecha.split('T')[0] === hoy);

              ventasHoyEl.textContent = ventasHoy.length;
              const ingresosHoy = ventasHoy.reduce((sum, v) => sum + parseFloat(v.total), 0);
              ingresosHoyEl.textContent = ingresosHoy.toFixed(2) + '‚Ç¨';

              const platosHoy = {};
              ventasHoy.forEach(v => {
                platosHoy[v.receta_nombre] = (platosHoy[v.receta_nombre] || 0) + v.cantidad;
              });
              const platoEstrella = Object.entries(platosHoy).sort((a, b) => b[1] - a[1])[0];
              platoEstrellaEl.textContent = platoEstrella ? platoEstrella[0] + ' (' + platoEstrella[1] + ')' : 'Sin ventas';

              const alertas = window.ingredientes.filter(ing => {
                const stockActual = parseFloat(ing.stock_actual) || 0;
                const stockMinimo = parseFloat(ing.stock_minimo) || 0;
                return stockMinimo > 0 && stockActual <= stockMinimo;
              });

              if (alertas.length === 0) {
                alertasListaEl.innerHTML = '<p style="color: #10B981; margin: 0;">‚úÖ Todo el stock OK</p>';
              } else {
                alertasListaEl.innerHTML = alertas.map(ing =>
                  '<div style="padding: 8px; margin-bottom: 6px; background: #FEF2F2; border-radius: 6px; border-left: 3px solid #EF4444;"><strong>' + ing.nombre + '</strong>: ' + parseFloat(ing.stock_actual).toFixed(1) + ' ' + ing.unidad + '</div>'
                ).join('');
              }
            } catch (e) {
              console.error('Error dashboard:', e);
            }
          };

          // Verificar autenticaci√≥n al cargar
          if (checkAuth()) {
            init();
          }
        })();

      </script>
      <!-- Toast Container -->
      <div class="toast-container" id="toast-container"></div>

      <!-- Loading Overlay -->
      <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
      </div>

      <!-- Modal: Confirmar Mermas Avanzado -->
      <div id="modal-confirmar-mermas" class="modal">
        <div class="modal-content" style="max-width: 800px;">
          <span class="close"
            onclick="document.getElementById('modal-confirmar-mermas').classList.remove('active')">&times;</span>
          <h2 style="color: #ef4444; display: flex; align-items: center; gap: 10px;">‚ö†Ô∏è Confirmar Mermas/P√©rdidas</h2>
          <p style="color: #64748b; margin-bottom: 20px;">Se han detectado diferencias negativas en el inventario. Por
            favor, especifica el motivo de cada p√©rdida para el control de costes.</p>

          <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="background: #f8fafc; position: sticky; top: 0;">
                <tr>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Ingrediente</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Diferencia</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Motivo</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Notas</th>
                </tr>
              </thead>
              <tbody id="tabla-mermas-body">
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>

          <div id="mermas-alert-box"
            style="display:none; margin-top: 10px; padding: 10px; background: #fee2e2; color: #b91c1c; border-radius: 6px; font-size: 13px;">
          </div>

          <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn btn-secondary"
              onclick="document.getElementById('modal-confirmar-mermas').classList.remove('active')">Cancelar</button>
            <button class="btn btn-primary" id="btn-confirmar-split" style="background: #ef4444;"
              onclick="window.confirmarMermasFinal()">Confirmar Ajustes</button>
          </div>
        </div>
      </div>
      <!-- Modal: Actualizar Inventario Masivo -->
      <div id="modal-inventario-masivo" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <span class="close"
            onclick="document.getElementById('modal-inventario-masivo').classList.remove('active')">&times;</span>
          <h2>üìä Actualizar Inventario Masivo</h2>

          <div style="margin: 20px 0;">
            <p style="color: #64748b; margin-bottom: 15px;">
              Sube un archivo Excel (.xlsx) o CSV con las columnas: <strong>Ingrediente</strong> y <strong>Stock
                Real</strong>
            </p>

            <div style="text-align: right; margin-bottom: 10px;">
              <button class="btn btn-secondary btn-small" onclick="window.descargarPlantillaStock()">üì• Descargar
                Plantilla</button>
            </div>

            <div
              style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc;">
              <input type="file" id="file-inventario-masivo" accept=".xlsx,.csv" style="display: none;"
                onchange="window.procesarArchivoInventario(this)">
              <label for="file-inventario-masivo" style="cursor: pointer;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                <div style="font-size: 16px; color: #475569; font-weight: 500;">Haz clic para seleccionar archivo</div>
                <div style="font-size: 14px; color: #94a3b8; margin-top: 5px;">Excel (.xlsx) o CSV</div>
              </label>
            </div>
          </div>

          <div id="preview-inventario-masivo" style="display: none; margin-top: 20px;">
            <h3>Vista Previa de Cambios</h3>
            <div id="preview-table-container"
              style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;"></div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
              <button class="btn btn-secondary" onclick="window.cancelarInventarioMasivo()">Cancelar</button>
              <button class="btn btn-primary" onclick="window.confirmarInventarioMasivo()" id="btn-confirmar-masivo">‚úì
                Confirmar Actualizaci√≥n</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Importar Ingredientes -->
      <div id="modal-importar-ingredientes" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <span class="close"
            onclick="document.getElementById('modal-importar-ingredientes').classList.remove('active')">&times;</span>
          <h2>üì§ Importar Ingredientes desde Excel</h2>

          <div style="margin: 20px 0;">
            <p style="color: #64748b; margin-bottom: 15px;">
              Sube un archivo Excel (.xlsx) o CSV con las columnas: <strong>Nombre</strong>, <strong>Precio</strong>,
              <strong>Unidad</strong>, <strong>Stock Actual</strong>, <strong>Stock M√≠nimo</strong>
            </p>

            <div
              style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc;">
              <input type="file" id="file-importar-ingredientes" accept=".xlsx,.csv" style="display: none;"
                onchange="window.procesarArchivoIngredientes(this)">
              <label for="file-importar-ingredientes" style="cursor: pointer;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                <div style="font-size: 16px; color: #475569; font-weight: 500;">Haz clic para seleccionar archivo</div>
                <div style="font-size: 14px; color: #94a3b8; margin-top: 5px;">Excel (.xlsx) o CSV</div>
              </label>
            </div>
          </div>

          <div id="preview-importar-ingredientes" style="display: none; margin-top: 20px;">
            <h3>Vista Previa de Ingredientes</h3>
            <div id="preview-ingredientes-container"
              style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;"></div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
              <button class="btn btn-secondary" onclick="window.cancelarImportarIngredientes()">Cancelar</button>
              <button class="btn btn-primary" onclick="window.confirmarImportarIngredientes()"
                id="btn-confirmar-importar-ingredientes">‚úì Importar Ingredientes</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Importar Recetas -->
      <div id="modal-importar-recetas" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <span class="close"
            onclick="document.getElementById('modal-importar-recetas').classList.remove('active')">&times;</span>
          <h2>üì§ Importar Recetas desde Excel</h2>

          <div style="margin: 20px 0;">
            <p style="color: #64748b; margin-bottom: 15px;">
              Sube un archivo Excel (.xlsx) o CSV con las columnas: <strong>Nombre</strong>, <strong>Categor√≠a</strong>,
              <strong>Precio Venta</strong>, <strong>Porciones</strong>
            </p>

            <div
              style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc;">
              <input type="file" id="file-importar-recetas" accept=".xlsx,.csv" style="display: none;"
                onchange="window.procesarArchivoRecetas(this)">
              <label for="file-importar-recetas" style="cursor: pointer;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                <div style="font-size: 16px; color: #475569; font-weight: 500;">Haz clic para seleccionar archivo</div>
                <div style="font-size: 14px; color: #94a3b8; margin-top: 5px;">Excel (.xlsx) o CSV</div>
              </label>
            </div>
          </div>

          <div id="preview-importar-recetas" style="display: none; margin-top: 20px;">
            <h3>Vista Previa de Recetas</h3>
            <div id="preview-recetas-container"
              style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;"></div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
              <button class="btn btn-secondary" onclick="window.cancelarImportarRecetas()">Cancelar</button>
              <button class="btn btn-primary" onclick="window.confirmarImportarRecetas()"
                id="btn-confirmar-importar-recetas">‚úì Importar Recetas</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Importar Ventas TPV -->
      <div id="modal-importar-ventas" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <span class="close"
            onclick="document.getElementById('modal-importar-ventas').classList.remove('active')">&times;</span>
          <h2>üì§ Importar Ventas TPV</h2>

          <div style="margin: 20px 0;">
            <p style="color: #64748b; margin-bottom: 15px;">
              Sube un archivo Excel (.xlsx) o CSV con las columnas: <strong>C√≥digo</strong> (opcional),
              <strong>Nombre</strong>, <strong>Cantidad</strong>, <strong>Total</strong>
            </p>

            <div
              style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc;">
              <input type="file" id="file-importar-ventas" accept=".xlsx,.csv" style="display: none;"
                onchange="window.procesarArchivoVentas(this)">
              <label for="file-importar-ventas" style="cursor: pointer;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                <div style="font-size: 16px; color: #475569; font-weight: 500;">Haz clic para seleccionar archivo</div>
                <div style="font-size: 14px; color: #94a3b8; margin-top: 5px;">Excel (.xlsx) o CSV</div>
              </label>
            </div>
          </div>

          <div id="preview-importar-ventas" style="display: none; margin-top: 20px;">
            <h3>Vista Previa de Ventas</h3>
            <div id="preview-ventas-container"
              style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;"></div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
              <button class="btn btn-secondary" onclick="window.cancelarImportarVentas()">Cancelar</button>
              <button class="btn btn-primary" onclick="window.confirmarImportarVentas()"
                id="btn-confirmar-importar-ventas">‚úì Importar Ventas</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Importar Pedidos (Compras) -->
      <div id="modal-importar-pedidos" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <span class="close"
            onclick="document.getElementById('modal-importar-pedidos').classList.remove('active')">&times;</span>
          <h2>üì§ Importar Pedidos (Compras)</h2>

          <div style="margin: 20px 0;">
            <p style="color: #64748b; margin-bottom: 15px;">
              Sube un archivo Excel (.xlsx) o CSV con las columnas: <strong>Fecha</strong>, <strong>Proveedor</strong>,
              <strong>Ingrediente</strong>, <strong>Cantidad</strong>, <strong>Precio</strong>, <strong>Total</strong>
            </p>

            <div
              style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc;">
              <input type="file" id="file-importar-pedidos" accept=".xlsx,.csv" style="display: none;"
                onchange="window.procesarArchivoPedidos(this)">
              <label for="file-importar-pedidos" style="cursor: pointer;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                <div style="font-size: 16px; color: #475569; font-weight: 500;">Haz clic para seleccionar archivo</div>
                <div style="font-size: 14px; color: #94a3b8; margin-top: 5px;">Excel (.xlsx) o CSV</div>
              </label>
            </div>
          </div>

          <div id="preview-importar-pedidos" style="display: none; margin-top: 20px;">
            <h3>Vista Previa de Pedidos</h3>
            <div id="preview-pedidos-container"
              style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;"></div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
              <button class="btn btn-secondary" onclick="window.cancelarImportarPedidos()">Cancelar</button>
              <button class="btn btn-primary" onclick="window.confirmarImportarPedidos()"
                id="btn-confirmar-importar-pedidos">‚úì Importar Pedidos</button>
            </div>
          </div>
        </div>
      </div>
      </script>
    </div>
    <script>

      // ========== INVENTARIO MASIVO ==========

      let datosInventarioMasivo = [];

      window.mostrarModalInventarioMasivo = function () {
        document.getElementById('modal-inventario-masivo').classList.add('active');
        document.getElementById('preview-inventario-masivo').style.display = 'none';
        document.getElementById('file-inventario-masivo').value = '';
      };

      window.procesarArchivoInventario = async function (input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading-overlay').classList.add('active');

        try {
          const data = await leerArchivoInventario(file);
          datosInventarioMasivo = await validarDatosInventario(data);
          mostrarPreviewInventario(datosInventarioMasivo);
        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          showToast('Error procesando archivo: ' + error.message, 'error');
        }
      };

      async function leerArchivoInventario(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

              // Validar que tenga al menos 2 columnas
              if (rows.length < 2) {
                reject(new Error('El archivo debe tener al menos 2 filas (encabezado + datos)'));
                return;
              }

              // Parsear datos
              const result = [];
              for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row[0] && row[1] !== undefined && row[1] !== null && row[1] !== '') {
                  result.push({
                    ingrediente: String(row[0]).trim(),
                    stockReal: parseFloat(row[1])
                  });
                }
              }

              if (result.length === 0) {
                reject(new Error('No se encontraron datos v√°lidos en el archivo'));
                return;
              }

              resolve(result);
            } catch (error) {
              reject(new Error('Error leyendo el archivo: ' + error.message));
            }
          };

          reader.onerror = () => reject(new Error('Error leyendo el archivo'));
          reader.readAsArrayBuffer(file);
        });
      }

      async function validarDatosInventario(data) {
        const ingredientesActuales = window.ingredientes || await api.getIngredientes();

        return data.map(item => {
          const ing = ingredientesActuales.find(i =>
            i.nombre.toLowerCase() === item.ingrediente.toLowerCase()
          );

          return {
            ...item,
            ingredienteId: ing ? ing.id : null,
            // Guardamos el Virtual para comparar p√©rdidas
            stockVirtual: ing ? (parseFloat(ing.stock_actual || ing.stock_virtual || 0)) : 0,
            // stockActual aqui se refiere al que mostramos como ref en la tabla de preview (sistema)
            stockActual: ing ? (parseFloat(ing.stock_actual || ing.stock_virtual || 0)) : null,
            valido: !!ing && !isNaN(item.stockReal) && item.stockReal >= 0,
            error: !ing ? 'Ingrediente no encontrado' :
              isNaN(item.stockReal) ? 'Stock inv√°lido' :
                item.stockReal < 0 ? 'Stock no puede ser negativo' : null
          };
        });
      }

      window.descargarPlantillaStock = function () {
        if (!window.ingredientes || window.ingredientes.length === 0) {
          showToast('No hay ingredientes para descargar', 'warning');
          return;
        }

        const datos = window.ingredientes.map(ing => ({
          'Ingrediente': ing.nombre,
          'Stock Real': '' // Dejar vac√≠o para que lo rellenen, o poner ing.stock_real si quisieran editar
        }));

        const ws = XLSX.utils.json_to_sheet(datos);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Plantilla Stock");

        // Ajustar ancho
        ws['!cols'] = [{ wch: 30 }, { wch: 15 }];

        XLSX.writeFile(wb, `Plantilla_Inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
      };

      function mostrarPreviewInventario(datos) {
        document.getElementById('loading-overlay').classList.remove('active');

        const validos = datos.filter(d => d.valido).length;
        const invalidos = datos.filter(d => !d.valido).length;

        let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                    <strong>Resumen:</strong> 
                    <span style="color: #10b981; margin-left: 10px;">‚úì ${validos} v√°lidos</span>
                    ${invalidos > 0 ? `<span style="color: #ef4444; margin-left: 10px;">‚úó ${invalidos} con errores</span>` : ''}
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f1f5f9;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Estado</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Ingrediente</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e2e8f0;">Stock Actual</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e2e8f0;">Stock Nuevo</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Observaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        datos.forEach(item => {
          const bgColor = item.valido ? '#f0fdf4' : '#fef2f2';
          const icon = item.valido ? '‚úì' : '‚úó';
          const iconColor = item.valido ? '#10b981' : '#ef4444';

          html += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                            <span style="color: ${iconColor}; font-size: 18px;">${icon}</span>
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${item.ingrediente}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">
                            ${item.stockActual !== null ? item.stockActual : '-'}
                        </td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0; font-weight: 600;">
                            ${item.stockReal}
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; color: ${item.valido ? '#10b981' : '#ef4444'};">
                            ${item.error || 'OK'}
                        </td>
                    </tr>
                `;
        });

        html += `
                    </tbody>
                </table>
            `;

        document.getElementById('preview-table-container').innerHTML = html;
        document.getElementById('preview-inventario-masivo').style.display = 'block';

        // Solo deshabilitar si NO hay datos v√°lidos, no si hay algunos errores
        const hayValidos = datosInventarioMasivo.some(d => d.valido);
        const btnConfirmar = document.getElementById('btn-confirmar-masivo');
        btnConfirmar.disabled = !hayValidos;
        if (!hayValidos) {
          btnConfirmar.style.opacity = '0.5';
          btnConfirmar.style.cursor = 'not-allowed';
        } else {
          btnConfirmar.style.opacity = '1';
          btnConfirmar.style.cursor = 'pointer';
        }
      }

      window.confirmarInventarioMasivo = async function () {
        const datosValidos = datosInventarioMasivo.filter(d => d.valido);

        if (datosValidos.length === 0) {
          window.showToast('No hay datos v√°lidos para actualizar', 'error');
          return;
        }

        // Preparar datos para consolidaci√≥n
        const adjustments = datosValidos.map(d => ({
          id: d.ingredienteId,
          stock_real: d.stockReal
        }));

        const mermas = [];
        datosValidos.forEach(d => {
          if (d.stockReal < d.stockVirtual) {
            mermas.push({
              nombre: d.ingrediente,
              diferencia: (d.stockVirtual - d.stockReal).toFixed(2)
            });
          }
        });

        let mensaje = `¬øConfirmar actualizaci√≥n de ${datosValidos.length} ingredientes?`;
        if (mermas.length > 0) {
          mensaje += `\n\n‚ö†Ô∏è SE DETECTARON ${mermas.length} MERMAS (Stock Real < Sistema).\nSe registrar√°n como p√©rdidas.`;
        } else {
          mensaje += `\n\nEl stock del sistema se ajustar√° al stock real importado.`;
        }

        if (!confirm(mensaje)) {
          return;
        }

        document.getElementById('loading-overlay').classList.add('active');

        try {
          // Usar consolidaci√≥n
          await window.api.consolidateStock(adjustments);

          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast(`‚úì ${datosValidos.length} ingredientes actualizados y consolidados`, 'success');

          document.getElementById('modal-inventario-masivo').classList.remove('active');
          await window.renderizarInventario();

        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error actualizando inventario: ' + error.message, 'error');
        }
      };

      window.cancelarInventarioMasivo = function () {
        document.getElementById('modal-inventario-masivo').classList.remove('active');
        datosInventarioMasivo = [];
      };

      // ========== IMPORTAR INGREDIENTES ==========
      let datosImportarIngredientes = [];

      window.mostrarModalImportarIngredientes = function () {
        document.getElementById('modal-importar-ingredientes').classList.add('active');
        document.getElementById('preview-importar-ingredientes').style.display = 'none';
        document.getElementById('file-importar-ingredientes').value = '';
        datosImportarIngredientes = [];
      };

      window.procesarArchivoIngredientes = async function (input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading-overlay').classList.add('active');

        try {
          const data = await leerArchivoGenerico(file);
          datosImportarIngredientes = validarDatosIngredientes(data);
          mostrarPreviewIngredientes(datosImportarIngredientes);
          document.getElementById('loading-overlay').classList.remove('active');
        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error procesando archivo: ' + error.message, 'error');
        }
      };

      async function leerArchivoGenerico(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
              resolve(jsonData);
            } catch (err) {
              reject(new Error('Error leyendo archivo Excel'));
            }
          };

          reader.onerror = () => reject(new Error('Error leyendo archivo'));
          reader.readAsArrayBuffer(file);
        });
      }

      function validarDatosIngredientes(data) {
        return data.map(row => {
          const nombre = row['Nombre'] || row['nombre'] || row['NOMBRE'] || '';
          const precio = parseFloat(row['Precio'] || row['precio'] || row['PRECIO'] || 0);
          const unidad = row['Unidad'] || row['unidad'] || row['UNIDAD'] || 'kg';
          const stockActual = parseFloat(row['Stock Actual'] || row['stock_actual'] || row['Stock'] || 0);
          const stockMinimo = parseFloat(row['Stock M√≠nimo'] || row['stock_minimo'] || row['Stock Minimo'] || 0);

          const valido = nombre.trim().length > 0;
          return {
            nombre: nombre.trim(),
            precio: isNaN(precio) ? 0 : precio,
            unidad: unidad,
            stockActual: isNaN(stockActual) ? 0 : stockActual,
            stockMinimo: isNaN(stockMinimo) ? 0 : stockMinimo,
            valido: valido,
            error: valido ? null : 'Nombre requerido'
          };
        });
      }

      function mostrarPreviewIngredientes(datos) {
        const validos = datos.filter(d => d.valido).length;
        const invalidos = datos.filter(d => !d.valido).length;

        let html = `
        <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
          <strong>Resumen:</strong> 
          <span style="color: #10b981;">‚úì ${validos} v√°lidos</span>
          ${invalidos > 0 ? `<span style="color: #ef4444; margin-left: 10px;">‚úó ${invalidos} con errores</span>` : ''}
        </div>
        <table style="width: 100%; font-size: 13px;">
          <thead>
            <tr style="background: #f1f5f9;">
              <th style="padding: 10px; text-align: left;">Estado</th>
              <th style="padding: 10px; text-align: left;">Nombre</th>
              <th style="padding: 10px; text-align: right;">Precio</th>
              <th style="padding: 10px; text-align: center;">Unidad</th>
              <th style="padding: 10px; text-align: right;">Stock</th>
              <th style="padding: 10px; text-align: left;">Observaci√≥n</th>
            </tr>
          </thead>
          <tbody>`;

        datos.forEach(item => {
          const icon = item.valido ? '‚úì' : '‚úó';
          const bgColor = item.valido ? '#f0fdf4' : '#fef2f2';
          const iconColor = item.valido ? '#10b981' : '#ef4444';

          html += `
          <tr style="background: ${bgColor};">
            <td style="padding: 10px;"><span style="color: ${iconColor};">${icon}</span></td>
            <td style="padding: 10px;">${item.nombre || '-'}</td>
            <td style="padding: 10px; text-align: right;">${item.precio.toFixed(2)}‚Ç¨</td>
            <td style="padding: 10px; text-align: center;">${item.unidad}</td>
            <td style="padding: 10px; text-align: right;">${item.stockActual}</td>
            <td style="padding: 10px; color: ${item.valido ? '#10b981' : '#ef4444'};">${item.error || 'OK'}</td>
          </tr>`;
        });

        html += '</tbody></table>';

        document.getElementById('preview-ingredientes-container').innerHTML = html;
        document.getElementById('preview-importar-ingredientes').style.display = 'block';

        const hayValidos = datos.some(d => d.valido);
        const btn = document.getElementById('btn-confirmar-importar-ingredientes');
        btn.disabled = !hayValidos;
        btn.style.opacity = hayValidos ? '1' : '0.5';
      }

      window.confirmarImportarIngredientes = async function () {
        const datosValidos = datosImportarIngredientes.filter(d => d.valido);

        if (datosValidos.length === 0) {
          window.showToast('No hay ingredientes v√°lidos para importar', 'error');
          return;
        }

        if (!confirm(`¬øImportar ${datosValidos.length} ingredientes?`)) {
          return;
        }

        document.getElementById('loading-overlay').classList.add('active');

        try {
          let importados = 0;
          for (const ing of datosValidos) {
            await window.api.createIngrediente({
              nombre: ing.nombre,
              precio: ing.precio,
              unidad: ing.unidad,
              stockActual: ing.stockActual,
              stockMinimo: ing.stockMinimo
            });
            importados++;
          }

          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast(`‚úì ${importados} ingredientes importados correctamente`, 'success');
          document.getElementById('modal-importar-ingredientes').classList.remove('active');
          await window.renderizarIngredientes();

        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error importando: ' + error.message, 'error');
        }
      };

      window.cancelarImportarIngredientes = function () {
        document.getElementById('modal-importar-ingredientes').classList.remove('active');
        datosImportarIngredientes = [];
      };

      // ========== IMPORTAR RECETAS ==========
      let datosImportarRecetas = [];

      window.mostrarModalImportarRecetas = function () {
        document.getElementById('modal-importar-recetas').classList.add('active');
        document.getElementById('preview-importar-recetas').style.display = 'none';
        document.getElementById('file-importar-recetas').value = '';
        datosImportarRecetas = [];
      };

      window.procesarArchivoRecetas = async function (input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading-overlay').classList.add('active');

        try {
          const data = await leerArchivoGenerico(file);
          datosImportarRecetas = validarDatosRecetas(data);
          mostrarPreviewRecetas(datosImportarRecetas);
          document.getElementById('loading-overlay').classList.remove('active');
        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error procesando archivo: ' + error.message, 'error');
        }
      };

      function validarDatosRecetas(data) {
        return data.map(row => {
          const nombre = row['Nombre'] || row['nombre'] || row['NOMBRE'] || '';
          const categoria = row['Categor√≠a'] || row['categoria'] || row['Categoria'] || 'principal';
          const precioVenta = parseFloat(row['Precio Venta'] || row['precio_venta'] || row['Precio'] || 0);
          const porciones = parseInt(row['Porciones'] || row['porciones'] || 1);

          const valido = nombre.trim().length > 0;
          return {
            nombre: nombre.trim(),
            categoria: categoria,
            precioVenta: isNaN(precioVenta) ? 0 : precioVenta,
            porciones: isNaN(porciones) || porciones < 1 ? 1 : porciones,
            ingredientes: [],
            valido: valido,
            error: valido ? null : 'Nombre requerido'
          };
        });
      }

      function mostrarPreviewRecetas(datos) {
        const validos = datos.filter(d => d.valido).length;
        const invalidos = datos.filter(d => !d.valido).length;

        let html = `
        <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
          <strong>Resumen:</strong> 
          <span style="color: #10b981;">‚úì ${validos} v√°lidos</span>
          ${invalidos > 0 ? `<span style="color: #ef4444; margin-left: 10px;">‚úó ${invalidos} con errores</span>` : ''}
        </div>
        <table style="width: 100%; font-size: 13px;">
          <thead>
            <tr style="background: #f1f5f9;">
              <th style="padding: 10px; text-align: left;">Estado</th>
              <th style="padding: 10px; text-align: left;">Nombre</th>
              <th style="padding: 10px; text-align: center;">Categor√≠a</th>
              <th style="padding: 10px; text-align: right;">Precio Venta</th>
              <th style="padding: 10px; text-align: center;">Porciones</th>
              <th style="padding: 10px; text-align: left;">Observaci√≥n</th>
            </tr>
          </thead>
          <tbody>`;

        datos.forEach(item => {
          const icon = item.valido ? '‚úì' : '‚úó';
          const bgColor = item.valido ? '#f0fdf4' : '#fef2f2';
          const iconColor = item.valido ? '#10b981' : '#ef4444';

          html += `
          <tr style="background: ${bgColor};">
            <td style="padding: 10px;"><span style="color: ${iconColor};">${icon}</span></td>
            <td style="padding: 10px;">${item.nombre || '-'}</td>
            <td style="padding: 10px; text-align: center;">${item.categoria}</td>
            <td style="padding: 10px; text-align: right;">${item.precioVenta.toFixed(2)}‚Ç¨</td>
            <td style="padding: 10px; text-align: center;">${item.porciones}</td>
            <td style="padding: 10px; color: ${item.valido ? '#10b981' : '#ef4444'};">${item.error || 'OK'}</td>
          </tr>`;
        });

        html += '</tbody></table>';

        document.getElementById('preview-recetas-container').innerHTML = html;
        document.getElementById('preview-importar-recetas').style.display = 'block';

        const hayValidos = datos.some(d => d.valido);
        const btn = document.getElementById('btn-confirmar-importar-recetas');
        btn.disabled = !hayValidos;
        btn.style.opacity = hayValidos ? '1' : '0.5';
      }



      window.confirmarImportarRecetas = async function () {
        const datosValidos = datosImportarRecetas.filter(d => d.valido);

        if (datosValidos.length === 0) {
          window.showToast('No hay recetas v√°lidas para importar', 'error');
          return;
        }

        if (!confirm(`¬øImportar ${datosValidos.length} recetas?`)) {
          return;
        }

        document.getElementById('loading-overlay').classList.add('active');

        try {
          let importados = 0;
          for (const rec of datosValidos) {
            await window.api.createReceta({
              nombre: rec.nombre,
              categoria: rec.categoria,
              precio_venta: rec.precioVenta,
              porciones: rec.porciones,
              ingredientes: []
            });
            importados++;
          }

          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast(`‚úì ${importados} recetas importadas correctamente`, 'success');
          document.getElementById('modal-importar-recetas').classList.remove('active');
          await window.renderizarRecetas();

        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error importando: ' + error.message, 'error');
        }
      };

      window.cancelarImportarRecetas = function () {
        document.getElementById('modal-importar-recetas').classList.remove('active');
        datosImportarRecetas = [];
      };


      // ========== IMPORTAR VENTAS TPV ==========
      let datosImportarVentas = [];

      window.mostrarModalImportarVentas = function () {
        document.getElementById('modal-importar-ventas').classList.add('active');
        document.getElementById('preview-importar-ventas').style.display = 'none';
        document.getElementById('file-importar-ventas').value = '';
        datosImportarVentas = [];
      };

      window.procesarArchivoVentas = async function (input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading-overlay').classList.add('active');

        try {
          const data = await leerArchivoGenerico(file);
          datosImportarVentas = validarDatosVentas(data);
          mostrarPreviewVentas(datosImportarVentas);
          document.getElementById('loading-overlay').classList.remove('active');
        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error procesando archivo: ' + error.message, 'error');
        }
      };

      function validarDatosVentas(data) {
        return data.map(row => {
          // Mapeo flexible de columnas
          const codigo = row['C√≥digo'] || row['codigo'] || row['Codigo'] || row['CODIGO'] || '';
          const nombre = row['Nombre'] || row['nombre'] || row['NOMBRE'] || row['Articulo'] || row['Art√≠culo'] || '';
          const cantidad = parseFloat(row['Cantidad'] || row['cantidad'] || row['CANTIDAD'] || row['Unidades'] || 0);
          const total = parseFloat(row['Total'] || row['total'] || row['TOTAL'] || row['Importe'] || 0);

          // Intentar vincular con receta existente
          let recetaEncontrada = null;

          // 1. Buscar por c√≥digo exacto si existe
          if (codigo) {
            recetaEncontrada = window.recetas.find(r => r.codigo && String(r.codigo) === String(codigo));
          }

          // 2. Si no, buscar por nombre (exacto o aproximado)
          if (!recetaEncontrada && nombre) {
            const nombreNorm = nombre.toLowerCase().trim();
            recetaEncontrada = window.recetas.find(r => r.nombre.toLowerCase().trim() === nombreNorm);
          }

          const valido = cantidad > 0 && (recetaEncontrada || nombre.length > 0);

          return {
            codigo: codigo,
            nombre: nombre,
            cantidad: isNaN(cantidad) ? 0 : cantidad,
            total: isNaN(total) ? 0 : total,
            recetaId: recetaEncontrada ? recetaEncontrada.id : null,
            recetaNombre: recetaEncontrada ? recetaEncontrada.nombre : null,
            valido: valido,
            error: !valido ? 'Cantidad inv√°lida' : (!recetaEncontrada ? '‚ö†Ô∏è No vinculado (se registrar√° como gen√©rico)' : null)
          };
        });
      }

      function mostrarPreviewVentas(datos) {
        const validos = datos.filter(d => d.valido).length;
        const vinculados = datos.filter(d => d.recetaId).length;
        const noVinculados = validos - vinculados;

        let html = `
        <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
          <strong>Resumen:</strong> 
          <span style="color: #10b981;">‚úì ${validos} registros v√°lidos</span>
          <span style="color: #3b82f6; margin-left: 10px;">üîó ${vinculados} vinculados a recetas</span>
          ${noVinculados > 0 ? `<span style="color: #f59e0b; margin-left: 10px;">‚ö†Ô∏è ${noVinculados} sin vincular (solo financiero)</span>` : ''}
        </div>
        <table style="width: 100%; font-size: 13px;">
          <thead>
            <tr style="background: #f1f5f9;">
              <th style="padding: 10px; text-align: left;">Estado</th>
              <th style="padding: 10px; text-align: left;">TPV (C√≥d/Nombre)</th>
              <th style="padding: 10px; text-align: left;">Receta Vinculada</th>
              <th style="padding: 10px; text-align: right;">Cant.</th>
              <th style="padding: 10px; text-align: right;">Total</th>
            </tr>
          </thead>
          <tbody>`;

        datos.forEach(item => {
          const icon = item.valido ? '‚úì' : '‚úó';
          const bgColor = item.valido ? (item.recetaId ? '#f0fdf4' : '#fffbeb') : '#fef2f2';
          const iconColor = item.valido ? '#10b981' : '#ef4444';

          html += `
          <tr style="background: ${bgColor};">
            <td style="padding: 10px;"><span style="color: ${iconColor};">${icon}</span></td>
            <td style="padding: 10px;">
              ${item.codigo ? `<span style="font-family:monospace; background:#eee; padding:2px 4px; border-radius:4px;">${item.codigo}</span> ` : ''}
              ${item.nombre}
            </td>
            <td style="padding: 10px;">
              ${item.recetaId ? `<strong>${item.recetaNombre}</strong>` : '<span style="color:#999; font-style:italic;">No encontrado</span>'}
            </td>
            <td style="padding: 10px; text-align: right;">${item.cantidad}</td>
            <td style="padding: 10px; text-align: right;">${item.total.toFixed(2)}‚Ç¨</td>
          </tr>`;
        });

        html += '</tbody></table>';

        document.getElementById('preview-ventas-container').innerHTML = html;
        document.getElementById('preview-importar-ventas').style.display = 'block';

        const hayValidos = datos.some(d => d.valido);
        const btn = document.getElementById('btn-confirmar-importar-ventas');
        btn.disabled = !hayValidos;
        btn.style.opacity = hayValidos ? '1' : '0.5';
      }

      window.confirmarImportarVentas = async function () {
        const datosValidos = datosImportarVentas.filter(d => d.valido);

        if (datosValidos.length === 0) {
          window.showToast('No hay ventas v√°lidas para importar', 'error');
          return;
        }

        if (!confirm(`¬øImportar ${datosValidos.length} registros de venta?\nSe actualizar√° el stock de los art√≠culos vinculados.`)) {
          return;
        }

        document.getElementById('loading-overlay').classList.add('active');

        try {
          let importados = 0;
          const fechaHoy = new Date().toISOString();

          // Procesar en lotes o uno a uno (por ahora uno a uno para simplicidad, idealmente batch en backend)
          // Nota: La API actual de createSale espera un solo objeto.
          // Podr√≠amos crear un endpoint batch, pero usaremos el existente en bucle por ahora.

          for (const venta of datosValidos) {
            // Si est√° vinculado, registramos venta normal (descuenta stock)
            if (venta.recetaId) {
              await window.api.createSale({
                recetaId: venta.recetaId,
                cantidad: venta.cantidad,
                total: venta.total, // Opcional si el backend lo recalcula, pero √∫til si el precio TPV var√≠a
                fecha: fechaHoy
              });
            } else {
              // Si NO est√° vinculado, solo registramos financieramente (TODO: Backend support for generic sales)
              // Por ahora, para no perder el dato financiero, podr√≠amos asignarlo a una receta "Varios" o similar,
              // o simplemente ignorar el descuento de stock pero sumar al total.
              // Como el backend actual requiere recetaId, saltaremos los no vinculados o crearemos una receta dummy.
              // ESTRATEGIA: Crear venta con recetaId nulo si el backend lo permite, o loguear error.
              // Revisando server.js: receta_id es INTEGER NOT NULL.
              // Soluci√≥n temporal: Solo importar vinculados.
              console.warn('Venta no vinculada omitida de stock (se requiere receta):', venta.nombre);
              continue;
            }
            importados++;
          }

          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast(`‚úì ${importados} ventas importadas correctamente`, 'success');
          document.getElementById('modal-importar-ventas').classList.remove('active');

          // Actualizar UI
          await window.renderizarVentas();
          window.actualizarKPIs();
          window.actualizarDashboardExpandido();

        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error importando ventas: ' + error.message, 'error');
        }
      };

      window.cancelarImportarVentas = function () {
        document.getElementById('modal-importar-ventas').classList.remove('active');
        datosImportarVentas = [];
      };


      // ========== IMPORTAR PEDIDOS (COMPRAS) ==========
      let datosImportarPedidos = [];

      window.mostrarModalImportarPedidos = function () {
        document.getElementById('modal-importar-pedidos').classList.add('active');
        document.getElementById('preview-importar-pedidos').style.display = 'none';
        document.getElementById('file-importar-pedidos').value = '';
        datosImportarPedidos = [];
      };

      window.procesarArchivoPedidos = async function (input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading-overlay').classList.add('active');

        try {
          const data = await leerArchivoGenerico(file);
          datosImportarPedidos = validarDatosPedidos(data);
          mostrarPreviewPedidos(datosImportarPedidos);
          document.getElementById('loading-overlay').classList.remove('active');
        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error procesando archivo: ' + error.message, 'error');
        }
      };

      function validarDatosPedidos(data) {
        return data.map(row => {
          // Mapeo flexible de columnas
          const fecha = row['Fecha'] || row['fecha'] || row['FECHA'] || new Date().toISOString().split('T')[0];
          const proveedor = row['Proveedor'] || row['proveedor'] || row['PROVEEDOR'] || 'Varios';
          const ingredienteNombre = row['Ingrediente'] || row['ingrediente'] || row['INGREDIENTE'] || row['Articulo'] || row['Concepto'] || '';
          const cantidad = parseFloat(row['Cantidad'] || row['cantidad'] || row['CANTIDAD'] || row['Unidades'] || 0);
          const precio = parseFloat(row['Precio'] || row['precio'] || row['PRECIO'] || row['Precio Unitario'] || 0);
          const total = parseFloat(row['Total'] || row['total'] || row['TOTAL'] || row['Importe'] || 0);

          // Intentar vincular con ingrediente existente
          let ingredienteEncontrado = null;
          if (ingredienteNombre) {
            const nombreNorm = ingredienteNombre.toLowerCase().trim();
            ingredienteEncontrado = window.ingredientes.find(i => i.nombre.toLowerCase().trim() === nombreNorm);
          }

          const valido = cantidad > 0 && ingredienteNombre.length > 0;

          return {
            fecha: fecha,
            proveedor: proveedor,
            ingredienteNombre: ingredienteNombre,
            cantidad: isNaN(cantidad) ? 0 : cantidad,
            precio: isNaN(precio) ? 0 : precio,
            total: isNaN(total) ? 0 : total,
            ingredienteId: ingredienteEncontrado ? ingredienteEncontrado.id : null,
            ingredienteUnidad: ingredienteEncontrado ? ingredienteEncontrado.unidad : 'unidad',
            valido: valido,
            error: !valido ? 'Datos incompletos' : (!ingredienteEncontrado ? '‚ö†Ô∏è Nuevo ingrediente (se crear√°)' : null)
          };
        });
      }

      function mostrarPreviewPedidos(datos) {
        const validos = datos.filter(d => d.valido).length;
        const vinculados = datos.filter(d => d.ingredienteId).length;
        const nuevos = validos - vinculados;

        let html = `
        <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
          <strong>Resumen:</strong> 
          <span style="color: #10b981;">‚úì ${validos} registros v√°lidos</span>
          <span style="color: #3b82f6; margin-left: 10px;">üîó ${vinculados} vinculados</span>
          ${nuevos > 0 ? `<span style="color: #f59e0b; margin-left: 10px;">‚ú® ${nuevos} nuevos ingredientes</span>` : ''}
        </div>
        <table style="width: 100%; font-size: 13px;">
          <thead>
            <tr style="background: #f1f5f9;">
              <th style="padding: 10px; text-align: left;">Estado</th>
              <th style="padding: 10px; text-align: left;">Fecha</th>
              <th style="padding: 10px; text-align: left;">Proveedor</th>
              <th style="padding: 10px; text-align: left;">Ingrediente</th>
              <th style="padding: 10px; text-align: right;">Cant.</th>
              <th style="padding: 10px; text-align: right;">Total</th>
            </tr>
          </thead>
          <tbody>`;

        datos.forEach(item => {
          const icon = item.valido ? '‚úì' : '‚úó';
          const bgColor = item.valido ? (item.ingredienteId ? '#f0fdf4' : '#fffbeb') : '#fef2f2';
          const iconColor = item.valido ? '#10b981' : '#ef4444';

          html += `
          <tr style="background: ${bgColor};">
            <td style="padding: 10px;"><span style="color: ${iconColor};">${icon}</span></td>
            <td style="padding: 10px;">${item.fecha}</td>
            <td style="padding: 10px;">${item.proveedor}</td>
            <td style="padding: 10px;">
              ${item.ingredienteNombre}
              ${!item.ingredienteId ? '<br><span style="font-size:11px; color:#f59e0b;">(Se crear√° nuevo)</span>' : ''}
            </td>
            <td style="padding: 10px; text-align: right;">${item.cantidad} ${item.ingredienteUnidad}</td>
            <td style="padding: 10px; text-align: right;">${item.total.toFixed(2)}‚Ç¨</td>
          </tr>`;
        });

        html += '</tbody></table>';

        document.getElementById('preview-pedidos-container').innerHTML = html;
        document.getElementById('preview-importar-pedidos').style.display = 'block';

        const hayValidos = datos.some(d => d.valido);
        const btn = document.getElementById('btn-confirmar-importar-pedidos');
        btn.disabled = !hayValidos;
        btn.style.opacity = hayValidos ? '1' : '0.5';
      }

      window.confirmarImportarPedidos = async function () {
        const datosValidos = datosImportarPedidos.filter(d => d.valido);

        if (datosValidos.length === 0) {
          window.showToast('No hay pedidos v√°lidos para importar', 'error');
          return;
        }

        if (!confirm(`¬øImportar ${datosValidos.length} pedidos?\nSe actualizar√° el stock y se crear√°n los ingredientes nuevos.`)) {
          return;
        }

        document.getElementById('loading-overlay').classList.add('active');

        try {
          let importados = 0;

          for (const pedido of datosValidos) {
            let ingId = pedido.ingredienteId;

            // 1. Si no existe ingrediente, crearlo
            if (!ingId) {
              // Buscar proveedor ID o crear (simplificado: asignamos string por ahora o null)
              // Para simplificar, creamos el ingrediente con datos b√°sicos
              const nuevoIng = await window.api.createIngrediente({
                nombre: pedido.ingredienteNombre,
                precio: pedido.total / pedido.cantidad, // Precio unitario calculado
                unidad: 'unidad', // Default, usuario deber√° corregir
                stockActual: 0,
                stockMinimo: 0,
                familia: 'alimento' // Default
              });
              ingId = nuevoIng.id;
            }

            // 2. Crear el pedido (que actualiza stock en backend si est√° configurado, 
            // pero la API actual de createOrder es compleja (cabecera + lineas).
            // SIMPLIFICACION: Usaremos una l√≥gica directa de actualizaci√≥n de stock + registro de gasto?
            // No, lo correcto es crear un pedido.
            // Pero createOrder espera { proveedorId, fecha, items: [{ingredienteId, cantidad, precio}] }
            // Aqu√≠ tenemos una lista plana. Agruparemos por proveedor y fecha?
            // Para MVP: Importaci√≥n l√≠nea a l√≠nea creando 1 pedido por l√≠nea es ineficiente pero seguro.
            // MEJOR: Agrupar por (Fecha, Proveedor).

            // Por ahora, para no complicar, asumiremos que el backend tiene un endpoint 'registrarCompra' o similar?
            // No. Usaremos la API existente.
            // Vamos a actualizar el stock directamente y registrar el gasto como "Otros Gastos" o crear un pedido dummy?
            // Lo ideal es crear el pedido real.

            // ESTRATEGIA: Crear un pedido por cada l√≠nea (simple) o agrupar.
            // Vamos a crear un pedido por l√≠nea para asegurar trazabilidad individual.

            // Buscar ID proveedor
            let provId = null;
            const prov = window.proveedores.find(p => p.nombre.toLowerCase() === pedido.proveedor.toLowerCase());
            if (prov) {
              provId = prov.id;
            } else {
              // Crear proveedor si no existe
              const nuevoProv = await window.api.createProveedor({
                nombre: pedido.proveedor,
                contacto: '',
                telefono: '',
                email: '',
                direccion: '',
                notas: 'Importado autom√°ticamente'
              });
              provId = nuevoProv.id;
              // Recargar proveedores localmente
              window.proveedores.push(nuevoProv);
            }

            await window.api.createPedido({
              proveedorId: provId,
              fecha: pedido.fecha,
              estado: 'recibido', // Importante: ya est√° recibido
              ingredientes: [{
                ingredienteId: ingId,
                cantidad: pedido.cantidad,
                precio: pedido.precio > 0 ? pedido.precio : (pedido.total / pedido.cantidad)
              }],
              total: pedido.total
            });

            importados++;
          }

          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast(`‚úì ${importados} pedidos importados correctamente`, 'success');
          document.getElementById('modal-importar-pedidos').classList.remove('active');

          // Actualizar UI
          await window.renderizarIngredientes(); // Stock actualizado
          await window.renderizarPedidos();
          await window.renderizarBalance(); // P&L actualizado

        } catch (error) {
          document.getElementById('loading-overlay').classList.remove('active');
          window.showToast('Error importando pedidos: ' + error.message, 'error');
        }
      };

      window.cancelarImportarPedidos = function () {
        document.getElementById('modal-importar-pedidos').classList.remove('active');
        datosImportarPedidos = [];
      };

      // ========== M√ìDULO DIARIO: Tracking de Costes/Ventas por D√≠a ==========

      let datosResumenMensual = null;

      // Inicializar mes actual en los selectores
      (function initDiario() {
        const mesSelect = document.getElementById('diario-mes');
        const anoSelect = document.getElementById('diario-ano');
        if (mesSelect) {
          mesSelect.value = (new Date().getMonth() + 1).toString();
        }
        if (anoSelect) {
          anoSelect.value = new Date().getFullYear().toString();
        }
      })();

      // Cargar resumen mensual desde la API
      window.cargarResumenMensual = async function () {
        const mes = document.getElementById('diario-mes').value;
        const ano = document.getElementById('diario-ano').value;
        const token = localStorage.getItem('token');

        if (!token) {
          window.showToast('Sesi√≥n expirada', 'error');
          return;
        }

        try {
          window.showToast('Cargando datos...', 'info');

          const response = await fetch(`https://lacaleta-api.mindloop.cloud/api/monthly/summary?mes=${mes}&ano=${ano}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!response.ok) throw new Error('Error cargando datos');

          datosResumenMensual = await response.json();

          // Actualizar KPIs
          document.getElementById('diario-total-compras').textContent =
            (datosResumenMensual.compras?.total || 0).toFixed(2) + ' ‚Ç¨';
          document.getElementById('diario-total-ventas').textContent =
            (datosResumenMensual.ventas?.totalIngresos || 0).toFixed(2) + ' ‚Ç¨';
          document.getElementById('diario-beneficio').textContent =
            (datosResumenMensual.ventas?.beneficioBruto || 0).toFixed(2) + ' ‚Ç¨';
          document.getElementById('diario-food-cost').textContent =
            (datosResumenMensual.resumen?.foodCost || 0) + '%';

          // Renderizar tablas
          renderizarTablaComprasDiarias();
          renderizarTablaVentasDiarias();
          renderizarTablaPLDiario();

          window.showToast('Datos cargados', 'success');
        } catch (error) {
          console.error('Error cargando resumen mensual:', error);
          window.showToast('Error cargando datos', 'error');
        }
      };

      // Cambiar entre vistas (Compras, Ventas, P&L)
      window.cambiarVistaDiario = function (vista) {
        // Ocultar todas las vistas
        document.querySelectorAll('.diario-vista').forEach(el => el.style.display = 'none');

        // Resetear botones
        document.getElementById('btn-vista-compras').className = 'btn btn-secondary';
        document.getElementById('btn-vista-ventas').className = 'btn btn-secondary';
        document.getElementById('btn-vista-combinada').className = 'btn btn-secondary';

        // Mostrar vista seleccionada
        if (vista === 'compras') {
          document.getElementById('vista-compras').style.display = 'block';
          document.getElementById('btn-vista-compras').className = 'btn btn-primary';
        } else if (vista === 'ventas') {
          document.getElementById('vista-ventas').style.display = 'block';
          document.getElementById('btn-vista-ventas').className = 'btn btn-primary';
        } else if (vista === 'combinada') {
          document.getElementById('vista-combinada').style.display = 'block';
          document.getElementById('btn-vista-combinada').className = 'btn btn-primary';
        }
      };

      // Renderizar tabla de compras diarias (tipo Excel)
      function renderizarTablaComprasDiarias() {
        const container = document.getElementById('tabla-compras-diarias');
        if (!datosResumenMensual || !datosResumenMensual.dias?.length) {
          container.innerHTML = '<p class="empty-state">No hay datos de compras para este mes</p>';
          return;
        }

        const dias = datosResumenMensual.dias;
        const ingredientes = datosResumenMensual.compras?.ingredientes || {};

        let html = '<table style="min-width: 100%; border-collapse: collapse;">';

        // Header con d√≠as
        html += '<thead><tr><th style="position: sticky; left: 0; background: #f8f8f8; z-index: 1;">Ingrediente</th>';
        dias.forEach(dia => {
          const fecha = new Date(dia);
          html += `<th style="min-width: 80px; text-align: center;">${fecha.getDate()}/${fecha.getMonth() + 1}</th>`;
        });
        html += '<th style="background: #e8f5e9; font-weight: bold;">TOTAL</th></tr></thead>';

        // Filas de ingredientes
        html += '<tbody>';
        for (const [nombre, data] of Object.entries(ingredientes)) {
          html += `<tr><td style="position: sticky; left: 0; background: white; font-weight: 500;">${nombre}</td>`;
          dias.forEach(dia => {
            const diaData = data.dias[dia];
            if (diaData) {
              html += `<td style="text-align: center; background: #fff3e0;">${diaData.precio.toFixed(2)}‚Ç¨<br><small style="color:#666;">${diaData.cantidad}</small></td>`;
            } else {
              html += '<td style="text-align: center; color: #ccc;">-</td>';
            }
          });
          html += `<td style="text-align: center; background: #e8f5e9; font-weight: bold;">${data.total.toFixed(2)}‚Ç¨</td>`;
          html += '</tr>';
        }
        html += '</tbody></table>';

        container.innerHTML = html;
      }

      // Renderizar tabla de ventas diarias (tipo Excel)
      function renderizarTablaVentasDiarias() {
        const container = document.getElementById('tabla-ventas-diarias');
        if (!datosResumenMensual || !datosResumenMensual.dias?.length) {
          container.innerHTML = '<p class="empty-state">No hay datos de ventas para este mes</p>';
          return;
        }

        const dias = datosResumenMensual.dias;
        const recetas = datosResumenMensual.ventas?.recetas || {};

        let html = '<table style="min-width: 100%; border-collapse: collapse;">';

        // Header con d√≠as
        html += '<thead><tr><th style="position: sticky; left: 0; background: #f8f8f8; z-index: 1;">Receta</th>';
        dias.forEach(dia => {
          const fecha = new Date(dia);
          html += `<th style="min-width: 100px; text-align: center;">${fecha.getDate()}/${fecha.getMonth() + 1}</th>`;
        });
        html += '<th style="background: #e8f5e9; font-weight: bold;">TOTAL</th></tr></thead>';

        // Filas de recetas
        html += '<tbody>';
        for (const [nombre, data] of Object.entries(recetas)) {
          html += `<tr><td style="position: sticky; left: 0; background: white; font-weight: 500;">${nombre}</td>`;
          dias.forEach(dia => {
            const diaData = data.dias[dia];
            if (diaData) {
              html += `<td style="text-align: center;">
              <div style="color: #2e7d32; font-weight: 500;">${diaData.ingresos.toFixed(2)}‚Ç¨</div>
              <small style="color:#666;">${diaData.vendidas} uds</small>
            </td>`;
            } else {
              html += '<td style="text-align: center; color: #ccc;">-</td>';
            }
          });
          html += `<td style="text-align: center; background: #e8f5e9;">
          <div style="font-weight: bold;">${data.totalIngresos.toFixed(2)}‚Ç¨</div>
          <small>${data.totalVendidas} uds</small>
        </td>`;
          html += '</tr>';
        }
        html += '</tbody></table>';

        container.innerHTML = html;
      }

      // Renderizar P&L diario
      function renderizarTablaPLDiario() {
        const container = document.getElementById('tabla-pl-diario');
        if (!datosResumenMensual || !datosResumenMensual.dias?.length) {
          container.innerHTML = '<p class="empty-state">No hay datos para este mes</p>';
          return;
        }

        const dias = datosResumenMensual.dias;
        const recetas = datosResumenMensual.ventas?.recetas || {};

        // Calcular totales por d√≠a
        const totalesPorDia = {};
        dias.forEach(dia => {
          totalesPorDia[dia] = { ingresos: 0, costes: 0, beneficio: 0 };
        });

        for (const [nombre, data] of Object.entries(recetas)) {
          for (const [dia, diaData] of Object.entries(data.dias)) {
            if (totalesPorDia[dia]) {
              totalesPorDia[dia].ingresos += diaData.ingresos;
              totalesPorDia[dia].costes += diaData.coste;
              totalesPorDia[dia].beneficio += diaData.beneficio;
            }
          }
        }

        let html = '<table style="min-width: 100%; border-collapse: collapse;">';

        // Header
        html += '<thead><tr><th style="position: sticky; left: 0; background: #f8f8f8;">Concepto</th>';
        dias.forEach(dia => {
          const fecha = new Date(dia);
          html += `<th style="min-width: 90px; text-align: center;">${fecha.getDate()}/${fecha.getMonth() + 1}</th>`;
        });
        html += '<th style="background: #1565c0; color: white;">TOTAL MES</th></tr></thead>';

        // Fila Ingresos
        let totalIngresos = 0, totalCostes = 0, totalBeneficio = 0;
        html += '<tbody>';
        html += '<tr style="background: #e8f5e9;"><td style="position: sticky; left: 0; background: #e8f5e9; font-weight: bold;">üìà INGRESOS</td>';
        dias.forEach(dia => {
          const val = totalesPorDia[dia].ingresos;
          totalIngresos += val;
          html += `<td style="text-align: center; font-weight: 500; color: #2e7d32;">${val.toFixed(2)}‚Ç¨</td>`;
        });
        html += `<td style="text-align: center; background: #1565c0; color: white; font-weight: bold;">${totalIngresos.toFixed(2)}‚Ç¨</td></tr>`;

        // Fila Costes
        html += '<tr style="background: #ffebee;"><td style="position: sticky; left: 0; background: #ffebee; font-weight: bold;">üìâ COSTES</td>';
        dias.forEach(dia => {
          const val = totalesPorDia[dia].costes;
          totalCostes += val;
          html += `<td style="text-align: center; color: #c62828;">${val.toFixed(2)}‚Ç¨</td>`;
        });
        html += `<td style="text-align: center; background: #1565c0; color: white; font-weight: bold;">${totalCostes.toFixed(2)}‚Ç¨</td></tr>`;

        // Obtener gastos fijos mensuales
        const opexData = JSON.parse(localStorage.getItem('opex_inputs') || '{"alquiler":0,"personal":0,"suministros":0,"otros":0}');
        const gastosFijosMes = parseFloat(opexData.alquiler || 0) + parseFloat(opexData.personal || 0) + parseFloat(opexData.suministros || 0) + parseFloat(opexData.otros || 0);

        // Calcular gastos fijos por d√≠a (d√≠as del mes calendario, no solo d√≠as con datos)
        const mesSeleccionado = parseInt(document.getElementById('diario-mes').value);
        const anoSeleccionado = parseInt(document.getElementById('diario-ano').value);
        const diasEnMes = new Date(anoSeleccionado, mesSeleccionado, 0).getDate();
        const gastosFijosDia = diasEnMes > 0 ? (gastosFijosMes / diasEnMes) : 0;

        // Fila Beneficio BRUTO (antes de gastos fijos)
        html += '<tr style="background: #fff3e0;"><td style="position: sticky; left: 0; background: #fff3e0; font-weight: bold;">üí∞ BENEFICIO BRUTO</td>';
        dias.forEach(dia => {
          const val = totalesPorDia[dia].beneficio;
          totalBeneficio += val;
          const color = val >= 0 ? '#f57c00' : '#c62828';
          html += `<td style="text-align: center; font-weight: bold; color: ${color};">${val.toFixed(2)}‚Ç¨</td>`;
        });
        html += `<td style="text-align: center; background: #1565c0; color: white; font-weight: bold;">${totalBeneficio.toFixed(2)}‚Ç¨</td></tr>`;

        // Fila Gastos Fijos Diarios
        html += '<tr style="background: #fce4ec;"><td style="position: sticky; left: 0; background: #fce4ec; font-weight: bold;">üè¢ GASTOS FIJOS/D√çA</td>';
        const totalGastosFijos = gastosFijosDia * dias.length;
        dias.forEach(() => {
          html += `<td style="text-align: center; color: #c62828;">${gastosFijosDia.toFixed(2)}‚Ç¨</td>`;
        });
        html += `<td style="text-align: center; background: #1565c0; color: white; font-weight: bold;">${totalGastosFijos.toFixed(2)}‚Ç¨</td></tr>`;

        // Fila Beneficio NETO (despu√©s de gastos fijos)
        html += '<tr style="background: #e3f2fd; border-top: 3px solid #1565c0;"><td style="position: sticky; left: 0; background: #e3f2fd; font-weight: bold; font-size: 16px;">‚úÖ BENEFICIO NETO</td>';
        let totalBeneficioNeto = 0;
        dias.forEach(dia => {
          const beneficioNeto = totalesPorDia[dia].beneficio - gastosFijosDia;
          totalBeneficioNeto += beneficioNeto;
          const color = beneficioNeto >= 0 ? '#1565c0' : '#c62828';
          html += `<td style="text-align: center; font-weight: bold; font-size: 15px; color: ${color};">${beneficioNeto.toFixed(2)}‚Ç¨</td>`;
        });
        html += `<td style="text-align: center; background: #1565c0; color: white; font-weight: bold; font-size: 16px;">${totalBeneficioNeto.toFixed(2)}‚Ç¨</td></tr>`;

        html += '</tbody></table>';

        container.innerHTML = html;
      }

      // Exportar a Excel
      window.exportarDiarioExcel = function () {
        if (!datosResumenMensual) {
          window.showToast('Primero carga los datos', 'warning');
          return;
        }

        // Crear workbook con los datos
        const wb = XLSX.utils.book_new();

        // Hoja de compras
        const comprasData = [];
        comprasData.push(['Ingrediente', ...datosResumenMensual.dias, 'TOTAL']);
        for (const [nombre, data] of Object.entries(datosResumenMensual.compras?.ingredientes || {})) {
          const fila = [nombre];
          datosResumenMensual.dias.forEach(dia => {
            fila.push(data.dias[dia]?.precio || '');
          });
          fila.push(data.total);
          comprasData.push(fila);
        }
        const wsCompras = XLSX.utils.aoa_to_sheet(comprasData);
        XLSX.utils.book_append_sheet(wb, wsCompras, 'Compras');

        // Hoja de ventas
        const ventasData = [];
        ventasData.push(['Receta', ...datosResumenMensual.dias, 'TOTAL']);
        for (const [nombre, data] of Object.entries(datosResumenMensual.ventas?.recetas || {})) {
          const fila = [nombre];
          datosResumenMensual.dias.forEach(dia => {
            fila.push(data.dias[dia]?.ingresos || '');
          });
          fila.push(data.totalIngresos);
          ventasData.push(fila);
        }
        const wsVentas = XLSX.utils.aoa_to_sheet(ventasData);
        XLSX.utils.book_append_sheet(wb, wsVentas, 'Ventas');

        // Descargar
        const mes = document.getElementById('diario-mes').value;
        const ano = document.getElementById('diario-ano').value;
        XLSX.writeFile(wb, `Control_Diario_${ano}-${mes.padStart(2, '0')}.xlsx`);

        window.showToast('Excel exportado', 'success');
      };

    </script>
    <!-- MODAL DE CONFIRMACI√ìN PROFESIONAL -->
    <div id="modal-confirmacion" class="modal-overlay-custom" style="display: none;">
      <div class="modal-confirmacion-container">
        <div class="modal-confirmacion-content">
          <div class="modal-header-danger">
            <span class="modal-danger-icon">‚ö†Ô∏è</span>
            <h3 id="confirm-titulo">Confirmar Eliminaci√≥n</h3>
          </div>
          <div class="modal-confirmacion-body">
            <p id="confirm-mensaje"></p>
          </div>
          <div class="modal-confirmacion-footer">
            <button class="btn-modal-cancel" onclick="window.cerrarConfirmacion()">
              <span>‚úñ</span> Cancelar
            </button>
            <button class="btn-modal-danger" id="btn-confirmar-eliminar">
              <span>üóëÔ∏è</span> Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
    <style>
      <!-- Modal Gasto Fijo 
      -->
    <div id="modal-gasto-fijo" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarFormularioGastoFijo()">&times;</span>
        <h2 id="titulo-modal-gasto">A√±adir Gasto Fijo</h2>

        <form id="form-gasto-fijo" onsubmit="guardarGastoFijo(event)">
          <input type="hidden" id="gasto-id">

          <div class="form-group">
            <label for="gasto-concepto">Concepto *</label>
            <input type="text" id="gasto-concepto" required placeholder="ej: Alquiler, N√≥minas, Luz...">
          </div>

          <div class="form-group">
            <label for="gasto-monto">Monto Mensual (‚Ç¨) *</label>
            <input type="number" id="gasto-monto" step="0.01" min="0" required placeholder="0.00">
          </div>

          <div style="display:flex;gap:10px;margin-top:20px">
            <button type="submit" class="btn-primary">Guardar</button>
            <button type="button" class="btn-secondary" onclick="cerrarFormularioGastoFijo()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
    .modal-overlay-custom {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    animation: fadeInModal 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes fadeInModal {
    from { opacity: 0; backdrop-filter: blur(0); }
    to { opacity: 1; backdrop-filter: blur(8px); }
    }
    .modal-confirmacion-container {
    animation: slideUpBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes slideUpBounce {
    0% { transform: translateY(100px) scale(0.8); opacity: 0; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal-confirmacion-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
    max-width: 520px;
    width: 92%;
    overflow: hidden;
    }
    .modal-header-danger {
    background: linear-gradient(145deg, #ff4444 0%, #cc0000 100%);
    color: white;
    padding: 28px 32px;
    display: flex;
    align-items: center;
    gap: 16px;
    }
    .modal-danger-icon {
    font-size: 2.5rem;
    animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
    }
    .modal-header-danger h3 {
    margin: 0;
    font-size: 1.35rem;
    font-weight: 700;
    }
    .modal-confirmacion-body {
    padding: 32px;
    font-size: 1.05rem;
    line-height: 1.6;
    color: #2c3e50;
    }
    .modal-confirmacion-body strong {
    color: #ff4444;
    font-weight: 700;
    }
    .modal-confirmacion-footer {
    padding: 20px 32px 28px;
    border-top: 1px solid #ecf0f1;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: #f8f9fa;
    }
    .btn-modal-cancel, .btn-modal-danger {
    padding: 12px 28px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .btn-modal-cancel {
    background: white;
    color: #495057;
    border: 2px solid #dee2e6;
    }
    .btn-modal-cancel:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .btn-modal-danger {
    background: linear-gradient(145deg, #ff4444 0%, #cc0000 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
    }
    .btn-modal-danger:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(255, 68, 68, 0.4);
    }
    </style>
    <script>
      window.confirmarEliminacion = function (config) {
        return new Promise((resolve) => {
          const modal = document.getElementById('modal-confirmacion');
          const titulo = document.getElementById('confirm-titulo');
          const mensaje = document.getElementById('confirm-mensaje');
          const btnConfirmar = document.getElementById('btn-confirmar-eliminar');

          titulo.textContent = config.titulo || 'Confirmar Eliminaci√≥n';
          mensaje.innerHTML = `
      ¬øEst√°s seguro de eliminar <strong>${config.tipo || 'este elemento'}</strong>?
      <br><br>
      <strong style="font-size: 1.15rem;">"${config.nombre}"</strong>
      <br><br>
      <span style="font-size: 0.95rem; color: #6c757d;">Esta acci√≥n no se puede deshacer.</span>
    `;

          modal.style.display = 'flex';

          function handleConfirm() {
            modal.style.display = 'none';
            btnConfirmar.removeEventListener('click', handleConfirm);
            resolve(true);
          }

          window.cerrarConfirmacion = function () {
            modal.style.display = 'none';
            btnConfirmar.removeEventListener('click', handleConfirm);
            resolve(false);
          };

          modal.onclick = function (e) {
            if (e.target === modal) window.cerrarConfirmacion();
          };

          btnConfirmar.addEventListener('click', handleConfirm);
        });
      };


      // ==================== GASTOS FIJOS ====================
      let gastosFijos = [];

      async function cargarGastosFijos() {
        try {
          gastosFijos = await window.API.getGastosFijos();
          renderizarGastosFijos();
          actualizarTotalesGastosFijos();
        } catch (error) {
          console.error('Error cargando gastos fijos:', error);
        }
      }

      function renderizarGastosFijos() {
        const tbody = document.getElementById('tabla-gastos-fijos');
        if (!tbody) return;

        if (gastosFijos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#999"><div style="font-size:48px">üí∞</div><div>A√∫n no hay gastos fijos</div></td></tr>';
          return;
        }

        tbody.innerHTML = gastosFijos.map(g => {
          const costeDiario = (parseFloat(g.monto_mensual) / 30).toFixed(2);
          return `<tr>
            <td><strong>${g.concepto}</strong></td>
            <td>${parseFloat(g.monto_mensual).toFixed(2)}‚Ç¨</td>
            <td>${costeDiario}‚Ç¨</td>
            <td>
                <button class="btn-icon" onclick="editarGastoFijo(${g.id})">‚úèÔ∏è</button>
                <button class="btn-icon" onclick="confirmarEliminarGastoFijo(${g.id}, '${g.concepto}')">üóëÔ∏è</button>
            </td>
        </tr>`;
        }).join('');
      }

      function actualizarTotalesGastosFijos() {
        const totalMensual = gastosFijos.reduce((sum, g) => sum + parseFloat(g.monto_mensual || 0), 0);
        const totalDiario = totalMensual / 30;

        const elemMensual = document.getElementById('total-mensual-gastos');
        const elemDiario = document.getElementById('total-diario-gastos');
        if (elemMensual) elemMensual.textContent = totalMensual.toFixed(2) + '‚Ç¨';
        if (elemDiario) elemDiario.textContent = totalDiario.toFixed(2) + '‚Ç¨';
      }

      function abrirFormularioGastoFijo(id = null) {
        const modal = document.getElementById('modal-gasto-fijo');
        const titulo = document.getElementById('titulo-modal-gasto');
        const form = document.getElementById('form-gasto-fijo');

        form.reset();

        if (id) {
          titulo.textContent = 'Editar Gasto Fijo';
          const gasto = gastosFijos.find(g => g.id === id);
          if (gasto) {
            document.getElementById('gasto-id').value = gasto.id;
            document.getElementById('gasto-concepto').value = gasto.concepto;
            document.getElementById('gasto-monto').value = parseFloat(gasto.monto_mensual);
          }
        } else {
          titulo.textContent = 'A√±adir Gasto Fijo';
          document.getElementById('gasto-id').value = '';
        }

        modal.style.display = 'block';
      }

      function cerrarFormularioGastoFijo() {
        document.getElementById('modal-gasto-fijo').style.display = 'none';
      }

      async function guardarGastoFijo(event) {
        event.preventDefault();

        const id = document.getElementById('gasto-id').value;
        const concepto = document.getElementById('gasto-concepto').value;
        const monto = parseFloat(document.getElementById('gasto-monto').value);

        try {
          if (id) {
            await window.API.updateGastoFijo(id, concepto, monto);
            showToast('‚úÖ Gasto fijo actualizado', 'success');
          } else {
            await window.API.createGastoFijo(concepto, monto);
            showToast('‚úÖ Gasto fijo creado', 'success');
          }

          cerrarFormularioGastoFijo();
          await cargarGastosFijos();
        } catch (error) {
          showToast('‚ùå Error guardando gasto', 'error');
        }
      }

      function editarGastoFijo(id) {
        abrirFormularioGastoFijo(id);
      }

      async function confirmarEliminarGastoFijo(id, concepto) {
        const confirmado = await window.confirmarEliminacion({
          titulo: 'Eliminar Gasto Fijo',
          tipo: 'el gasto fijo',
          nombre: concepto
        });

        if (confirmado) {
          try {
            await window.API.deleteGastoFijo(id);
            gastosFijos = gastosFijos.filter(g => g.id !== id);
            renderizarGastosFijos();
            actualizarTotalesGastosFijos();
            showToast(`‚úÖ Gasto "${concepto}" eliminado`, 'success');
          } catch (error) {
            showToast('‚ùå Error eliminando', 'error');
          }
        }
      }

      window.cargarGastosFijos = cargarGastosFijos;


      // Actualizar beneficio real con gastos fijos en Diario
      async function actualizarBeneficioRealDiario() {
        try {
          const totales = await window.API.getTotalGastosFijos();
          const gastosDiario = totales.total_diario || 0;

          const elemGastos = document.getElementById('diario-gastos-fijos');
          if (elemGastos) elemGastos.textContent = gastosDiario.toFixed(2) + ' ‚Ç¨';

          const beneficioBrutoMensual = parseFloat(document.getElementById('diario-beneficio')?.textContent || '0');
          const beneficioBrutoDiario = beneficioBrutoMensual / 30;
          const beneficioReal = beneficioBrutoDiario - gastosDiario;

          const elemBeneficio = document.getElementById('diario-beneficio-real');
          const cardBeneficio = document.getElementById('card-beneficio-real');

          if (elemBeneficio) elemBeneficio.textContent = beneficioReal.toFixed(2) + ' ‚Ç¨';
          if (cardBeneficio) {
            cardBeneficio.className = beneficioReal < 0 ? 'stat-card red' : 'stat-card green';
          }
        } catch (error) {
          console.error('Error:', error);
        }
      }

      setInterval(actualizarBeneficioRealDiario, 2000);


      // ============ FINANZAS: Guardar/Cargar Gastos Fijos desde BD ============
      window.guardarGastoFinanzas = async function (concepto, inputId) {
        const elem = document.getElementById(inputId);
        if (!elem) return;

        const monto = parseFloat(elem.value) || 0;

        try {
          const gastos = await window.API.getGastosFijos();
          const existe = gastos.find(g => g.concepto === concepto);

          if (existe) {
            await window.API.updateGastoFijo(existe.id, concepto, monto);
          } else {
            await window.API.createGastoFijo(concepto, monto);
          }
        } catch (error) {
          console.error('Error guardando gasto:', error);
        }
      };


    </script>
</body>

</html>
