<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>La Caleta 102 - Dashboard de Costes</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #c35a3f 0%, #d47157 100%);
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .logo-circle {
      width: 50px;
      height: 50px;
      border: 2px solid #c35a3f;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #c35a3f;
    }
    .header-title { flex: 1; }
    .header-title h1 { color: #c35a3f; font-size: 24px; font-weight: 700; }
    .header-title p { color: #666; font-size: 14px; }
    
    .tabs {
      background: white;
      border-radius: 10px 10px 0 0;
      display: flex;
      gap: 5px;
      padding: 10px 10px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
    }
    .tab:hover { background: #f5f5f5; }
    .tab.active {
      background: white;
      color: #c35a3f;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    
    .main-card {
      background: white;
      border-radius: 0 10px 10px 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .top-bar h2 { font-size: 28px; color: #333; }
    .top-bar p { color: #666; font-size: 14px; margin-top: 5px; }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    .btn-primary { background: #c35a3f; color: white; }
    .btn-primary:hover { background: #a84a33; }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-small { padding: 8px 16px; font-size: 13px; }
    
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    .search-box input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
    }
    .search-box svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }
    
    .form-card {
      background: #fff5f2;
      border: 2px solid #c35a3f;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
    }
    .form-card h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 5px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .ingredientes-receta {
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .ingredientes-receta h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    .ingrediente-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .ingrediente-item select,
    .ingrediente-item input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    .ingrediente-item button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    
    /* Selector de ingredientes para proveedor */
    .selector-ingredientes {
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .selector-ingredientes h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    .ingredientes-disponibles {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #f9f9f9;
    }
    .ingrediente-checkbox {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .ingrediente-checkbox:hover {
      background: #f0f0f0;
    }
    .ingrediente-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
    }
    .ingrediente-checkbox label {
      cursor: pointer;
      flex: 1;
      margin: 0;
    }
    
    .coste-calculado {
      background: #f0fdf4;
      border: 2px solid #10b981;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .coste-calculado h4 {
      color: #059669;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .coste-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #d1fae5;
    }
    .coste-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 18px;
      color: #059669;
      padding-top: 15px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: #f8f8f8;
      border-bottom: 2px solid #e0e0e0;
    }
    th {
      padding: 12px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
    }
    td {
      padding: 15px 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    tbody tr:hover {
      background: #f9f9f9;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      transition: all 0.2s;
    }
    .icon-btn:hover { transform: scale(1.1); }
    .icon-btn.edit { color: #c35a3f; }
    .icon-btn.delete { color: #dc2626; }
    .icon-btn.produce { color: #10b981; }
    .icon-btn.view { color: #3b82f6; }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .empty-state .icon { font-size: 60px; margin-bottom: 15px; }
    .empty-state h3 { font-size: 20px; color: #666; margin-bottom: 10px; }
    
    .stock-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .stock-low { background: #fee; color: #c00; }
    .stock-ok { background: #efe; color: #060; }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-success { background: #d1fae5; color: #059669; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-info { background: #dbeafe; color: #2563eb; }
    
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }
    .summary strong { color: #333; }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      line-height: 1;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h3 {
      font-size: 22px;
      color: #333;
      margin-bottom: 20px;
    }
    
    .ingredientes-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .ingredientes-list .badge {
      background: #f0f0f0;
      color: #333;
      padding: 6px 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-circle">LC</div>
      <div class="header-title">
        <h1>La Caleta 102</h1>
        <p>Dashboard de Costes</p>
      </div>
    </div>

    <div class="tabs">
      <button id="tab-btn-ingredientes" class="tab active" onclick="window.cambiarTab('ingredientes')">üì¶ Ingredientes</button>
      <button id="tab-btn-recetas" class="tab" onclick="window.cambiarTab('recetas')">üë®‚Äçüç≥ Recetas</button>
      <button id="tab-btn-proveedores" class="tab" onclick="window.cambiarTab('proveedores')">üöö Proveedores</button>
    </div>

    <div class="main-card">
      
      <!-- TAB: INGREDIENTES -->
      <div id="tab-ingredientes" class="tab-content active">
        <div class="top-bar">
          <div>
            <h2>Ingredientes</h2>
            <p>Gestiona todos los ingredientes de tu restaurante</p>
          </div>
          <button class="btn btn-primary" onclick="window.mostrarFormularioIngrediente()">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            A√±adir Ingrediente
          </button>
        </div>

        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="busqueda-ingredientes" placeholder="Buscar ingredientes o proveedores..." oninput="window.renderizarIngredientes()">
        </div>

        <div id="formulario-ingrediente" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-ingrediente">Nuevo Ingrediente</span>
            <button class="close-btn" onclick="window.cerrarFormularioIngrediente()">√ó</button>
          </h3>
          <form onsubmit="window.guardarIngrediente(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre del ingrediente *</label>
                <input type="text" id="ing-nombre" required placeholder="Ej: Tomate">
              </div>
              <div class="form-group">
                <label>Proveedor</label>
                <select id="ing-proveedor-select">
                  <option value="">Sin proveedor</option>
                </select>
              </div>
              <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="ing-precio" step="0.01" min="0" placeholder="0.00">
              </div>
              <div class="form-group">
                <label>Unidad de medida</label>
                <select id="ing-unidad">
                  <option value="kg">Kilogramos (kg)</option>
                  <option value="g">Gramos (g)</option>
                  <option value="l">Litros (L)</option>
                  <option value="ml">Mililitros (ml)</option>
                  <option value="unidad">Unidades</option>
                </select>
              </div>
              <div class="form-group">
                <label>Stock actual</label>
                <input type="number" id="ing-stockActual" step="0.01" min="0" placeholder="0">
              </div>
              <div class="form-group">
                <label>Stock m√≠nimo</label>
                <input type="number" id="ing-stockMinimo" step="0.01" min="0" placeholder="0">
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="window.cerrarFormularioIngrediente()">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <span id="btn-text-ingrediente">A√±adir Ingrediente</span>
              </button>
            </div>
          </form>
        </div>

        <div id="tabla-ingredientes"></div>
        <div id="resumen-ingredientes" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: RECETAS -->
      <div id="tab-recetas" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>Recetas</h2>
            <p>Crea recetas y calcula el coste de tus platos</p>
          </div>
          <button class="btn btn-primary" onclick="window.mostrarFormularioReceta()">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Nueva Receta
          </button>
        </div>

        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="busqueda-recetas" placeholder="Buscar recetas..." oninput="window.renderizarRecetas()">
        </div>

        <div id="formulario-receta" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-receta">Nueva Receta</span>
            <button class="close-btn" onclick="window.cerrarFormularioReceta()">√ó</button>
          </h3>
          <form onsubmit="window.guardarReceta(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre del plato *</label>
                <input type="text" id="rec-nombre" required placeholder="Ej: Ensalada C√©sar">
              </div>
              <div class="form-group">
                <label>Categor√≠a</label>
                <select id="rec-categoria">
                  <option value="entrante">Entrante</option>
                  <option value="principal">Principal</option>
                  <option value="postre">Postre</option>
                  <option value="bebida">Bebida</option>
                  <option value="otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label>Precio de venta (‚Ç¨)</label>
                <input type="number" id="rec-precioVenta" step="0.01" min="0" placeholder="0.00" oninput="window.calcularCosteReceta()">
              </div>
              <div class="form-group">
                <label>Porciones</label>
                <input type="number" id="rec-porciones" min="1" value="1" placeholder="1">
              </div>
            </div>

            <div class="ingredientes-receta">
              <h4>Ingredientes de la receta</h4>
              <div id="lista-ingredientes-receta"></div>
              <button type="button" class="btn btn-secondary btn-small" onclick="window.agregarIngredienteReceta()">+ A√±adir ingrediente</button>
            </div>

            <div id="coste-calculado-form" class="coste-calculado" style="display: none;"></div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="window.cerrarFormularioReceta()">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <span id="btn-text-receta">Guardar Receta</span>
              </button>
            </div>
          </form>
        </div>

        <div id="tabla-recetas"></div>
        <div id="resumen-recetas" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: PROVEEDORES -->
      <div id="tab-proveedores" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>Proveedores</h2>
            <p>Gestiona tus proveedores y sus productos</p>
          </div>
          <button class="btn btn-primary" onclick="window.mostrarFormularioProveedor()">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            A√±adir Proveedor
          </button>
        </div>

        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="busqueda-proveedores" placeholder="Buscar proveedores..." oninput="window.renderizarProveedores()">
        </div>

        <div id="formulario-proveedor" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-proveedor">Nuevo Proveedor</span>
            <button class="close-btn" onclick="window.cerrarFormularioProveedor()">√ó</button>
          </h3>
          <form onsubmit="window.guardarProveedor(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre del proveedor *</label>
                <input type="text" id="prov-nombre" required placeholder="Ej: Mercabarna">
              </div>
              <div class="form-group">
                <label>Persona de contacto</label>
                <input type="text" id="prov-contacto" placeholder="Ej: Juan Garc√≠a">
              </div>
              <div class="form-group">
                <label>Tel√©fono</label>
                <input type="tel" id="prov-telefono" placeholder="Ej: 934 123 456">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="prov-email" placeholder="Ej: contacto@proveedor.com">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Direcci√≥n</label>
                <textarea id="prov-direccion" placeholder="Ej: Calle Example 123, Barcelona"></textarea>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Notas</label>
                <textarea id="prov-notas" placeholder="Informaci√≥n adicional..."></textarea>
              </div>
            </div>

            <div class="selector-ingredientes">
              <h4>Ingredientes que suministra</h4>
              <div class="search-box" style="margin-bottom: 10px;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" id="buscar-ingredientes-proveedor" placeholder="Buscar ingredientes..." oninput="window.filtrarIngredientesProveedor()">
              </div>
              <div class="ingredientes-disponibles" id="lista-ingredientes-proveedor"></div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="window.cerrarFormularioProveedor()">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <span id="btn-text-proveedor">A√±adir Proveedor</span>
              </button>
            </div>
          </form>
        </div>

        <div id="tabla-proveedores"></div>
        <div id="resumen-proveedores" class="summary" style="display: none;"></div>
      </div>

    </div>
  </div>

  <!-- Modal producir platos -->
  <div id="modal-producir" class="modal">
    <div class="modal-content">
      <h3>Producir platos</h3>
      <p style="margin-bottom: 20px; color: #666;">¬øCu√°ntas unidades de <strong id="modal-plato-nombre"></strong> has preparado?</p>
      <div class="form-group">
        <label>Cantidad producida</label>
        <input type="number" id="modal-cantidad" min="1" value="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" oninput="window.actualizarDetalleDescuento()">
      </div>
      <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 6px; font-size: 14px;">
        <strong>‚ö†Ô∏è Esto descontar√° del stock:</strong>
        <div id="modal-descuento-detalle" style="margin-top: 10px;"></div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="window.cerrarModalProducir()">Cancelar</button>
        <button class="btn btn-success" onclick="window.confirmarProduccion()">Confirmar Producci√≥n</button>
      </div>
    </div>
  </div>

  <!-- Modal ver ingredientes del proveedor -->
  <div id="modal-ver-proveedor" class="modal">
    <div class="modal-content">
      <h3 id="modal-proveedor-titulo"></h3>
      <div id="modal-proveedor-contenido"></div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="window.cerrarModalVerProveedor()">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      let ingredientes = [];
      let recetas = [];
      let proveedores = [];
      let editandoIngredienteIndex = null;
      let editandoRecetaIndex = null;
      let editandoProveedorIndex = null;
      let recetaProduciendo = null;

      function init() {
        cargarDatos();
        renderizarIngredientes();
        renderizarRecetas();
        renderizarProveedores();
      }

      function cargarDatos() {
        const ingData = localStorage.getItem('lacaleta_ingredientes');
        const recData = localStorage.getItem('lacaleta_recetas');
        const provData = localStorage.getItem('lacaleta_proveedores');
        if (ingData) ingredientes = JSON.parse(ingData);
        if (recData) recetas = JSON.parse(recData);
        if (provData) proveedores = JSON.parse(provData);
      }

      function guardarDatos() {
        localStorage.setItem('lacaleta_ingredientes', JSON.stringify(ingredientes));
        localStorage.setItem('lacaleta_recetas', JSON.stringify(recetas));
        localStorage.setItem('lacaleta_proveedores', JSON.stringify(proveedores));
      }

      // ==================== TABS ====================
      window.cambiarTab = function(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        document.getElementById('tab-btn-' + tab).classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
      };

      // ==================== INGREDIENTES ====================
      window.mostrarFormularioIngrediente = function() {
        actualizarSelectProveedores();
        document.getElementById('formulario-ingrediente').style.display = 'block';
        document.getElementById('ing-nombre').focus();
      };

      window.cerrarFormularioIngrediente = function() {
        document.getElementById('formulario-ingrediente').style.display = 'none';
        document.querySelector('#formulario-ingrediente form').reset();
        editandoIngredienteIndex = null;
        document.getElementById('form-title-ingrediente').textContent = 'Nuevo Ingrediente';
        document.getElementById('btn-text-ingrediente').textContent = 'A√±adir Ingrediente';
      };

      function actualizarSelectProveedores() {
        const select = document.getElementById('ing-proveedor-select');
        select.innerHTML = '<option value="">Sin proveedor</option>';
        proveedores.forEach((prov, idx) => {
          select.innerHTML += `<option value="${prov.id}">${prov.nombre}</option>`;
        });
      }

      window.guardarIngrediente = function(event) {
        event.preventDefault();
        
        const proveedorId = document.getElementById('ing-proveedor-select').value;
        
        const ingrediente = {
          nombre: document.getElementById('ing-nombre').value,
          proveedorId: proveedorId || null,
          precio: parseFloat(document.getElementById('ing-precio').value) || 0,
          unidad: document.getElementById('ing-unidad').value,
          stockActual: parseFloat(document.getElementById('ing-stockActual').value) || 0,
          stockMinimo: parseFloat(document.getElementById('ing-stockMinimo').value) || 0,
          id: editandoIngredienteIndex !== null ? ingredientes[editandoIngredienteIndex].id : Date.now()
        };

        if (editandoIngredienteIndex !== null) {
          ingredientes[editandoIngredienteIndex] = ingrediente;
        } else {
          ingredientes.push(ingrediente);
        }

        guardarDatos();
        renderizarIngredientes();
        window.cerrarFormularioIngrediente();
      };

      window.editarIngrediente = function(index) {
        const ing = ingredientes[index];
        actualizarSelectProveedores();
        document.getElementById('ing-nombre').value = ing.nombre;
        document.getElementById('ing-proveedor-select').value = ing.proveedorId || '';
        document.getElementById('ing-precio').value = ing.precio || '';
        document.getElementById('ing-unidad').value = ing.unidad;
        document.getElementById('ing-stockActual').value = ing.stockActual || '';
        document.getElementById('ing-stockMinimo').value = ing.stockMinimo || '';
        
        editandoIngredienteIndex = index;
        document.getElementById('form-title-ingrediente').textContent = 'Editar Ingrediente';
        document.getElementById('btn-text-ingrediente').textContent = 'Guardar Cambios';
        window.mostrarFormularioIngrediente();
      };

      window.eliminarIngrediente = function(index) {
        if (confirm('¬øEst√°s seguro de eliminar este ingrediente?')) {
          ingredientes.splice(index, 1);
          guardarDatos();
          renderizarIngredientes();
        }
      };

      function getNombreProveedor(proveedorId) {
        if (!proveedorId) return '-';
        const prov = proveedores.find(p => p.id == proveedorId);
        return prov ? prov.nombre : '-';
      }

      window.renderizarIngredientes = function() {
        const busqueda = document.getElementById('busqueda-ingredientes').value.toLowerCase();
        const filtrados = ingredientes.filter(ing => {
          const nombreProv = getNombreProveedor(ing.proveedorId).toLowerCase();
          return ing.nombre.toLowerCase().includes(busqueda) || nombreProv.includes(busqueda);
        });

        const container = document.getElementById('tabla-ingredientes');
        
        if (filtrados.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üì¶</div>
              <h3>${busqueda ? 'No se encontraron ingredientes' : 'A√∫n no hay ingredientes'}</h3>
              <p>${busqueda ? 'Intenta con otra b√∫squeda' : 'A√±ade tu primer ingrediente para comenzar'}</p>
            </div>
          `;
          document.getElementById('resumen-ingredientes').style.display = 'none';
        } else {
          let html = '<table><thead><tr>';
          html += '<th>Ingrediente</th><th>Proveedor</th><th>Precio</th><th>Stock</th><th style="text-align: right;">Acciones</th>';
          html += '</tr></thead><tbody>';

          filtrados.forEach(ing => {
            const realIndex = ingredientes.indexOf(ing);
            const stockBajo = ing.stockActual <= ing.stockMinimo;
            
            html += '<tr>';
            html += `<td><strong>${ing.nombre}</strong></td>`;
            html += `<td>${getNombreProveedor(ing.proveedorId)}</td>`;
            html += `<td>${ing.precio ? ing.precio.toFixed(2) + ' ‚Ç¨/' + ing.unidad : '-'}</td>`;
            html += `<td>`;
            if (ing.stockActual) {
              html += `<span class="stock-badge ${stockBajo ? 'stock-low' : 'stock-ok'}">${ing.stockActual} ${ing.unidad}</span>`;
              if (stockBajo && ing.stockMinimo) html += ` ‚ö†Ô∏è`;
            } else {
              html += '-';
            }
            html += `</td>`;
            html += `<td><div class="actions">`;
            html += `<button class="icon-btn edit" onclick="window.editarIngrediente(${realIndex})" title="Editar">‚úèÔ∏è</button>`;
            html += `<button class="icon-btn delete" onclick="window.eliminarIngrediente(${realIndex})" title="Eliminar">üóëÔ∏è</button>`;
            html += '</div></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          container.innerHTML = html;

          document.getElementById('resumen-ingredientes').innerHTML = `
            <div>Total de ingredientes: <strong>${ingredientes.length}</strong></div>
            <div>Mostrando: <strong>${filtrados.length}</strong></div>
          `;
          document.getElementById('resumen-ingredientes').style.display = 'flex';
        }
      };

      // ==================== RECETAS (c√≥digo existente, simplificado) ====================
      window.mostrarFormularioReceta = function() {
        if (ingredientes.length === 0) {
          alert('Primero debes a√±adir ingredientes');
          window.cambiarTab('ingredientes');
          window.mostrarFormularioIngrediente();
          return;
        }
        document.getElementById('formulario-receta').style.display = 'block';
        window.agregarIngredienteReceta();
        document.getElementById('rec-nombre').focus();
      };

      window.cerrarFormularioReceta = function() {
        document.getElementById('formulario-receta').style.display = 'none';
        document.querySelector('#formulario-receta form').reset();
        document.getElementById('lista-ingredientes-receta').innerHTML = '';
        document.getElementById('coste-calculado-form').style.display = 'none';
        editandoRecetaIndex = null;
        document.getElementById('form-title-receta').textContent = 'Nueva Receta';
        document.getElementById('btn-text-receta').textContent = 'Guardar Receta';
      };

      window.agregarIngredienteReceta = function() {
        const container = document.getElementById('lista-ingredientes-receta');
        const div = document.createElement('div');
        div.className = 'ingrediente-item';
        
        let opciones = '<option value="">Seleccionar...</option>';
        ingredientes.forEach((ing, idx) => {
          opciones += `<option value="${idx}">${ing.nombre} (${ing.unidad})</option>`;
        });
        
        div.innerHTML = `
          <select onchange="window.calcularCosteReceta()">${opciones}</select>
          <input type="number" placeholder="Cantidad" step="0.01" min="0" oninput="window.calcularCosteReceta()">
          <span style="font-size: 12px; color: #666;"></span>
          <button type="button" onclick="this.parentElement.remove(); window.calcularCosteReceta()">Quitar</button>
        `;
        
        container.appendChild(div);
      };

      window.calcularCosteReceta = function() {
        const items = document.querySelectorAll('#lista-ingredientes-receta .ingrediente-item');
        let costeTotal = 0;
        let hayDatos = false;

        items.forEach(item => {
          const select = item.querySelector('select');
          const input = item.querySelector('input');
          const span = item.querySelector('span');
          
          if (select.value && input.value) {
            hayDatos = true;
            const ing = ingredientes[parseInt(select.value)];
            const cantidad = parseFloat(input.value);
            const coste = (ing.precio * cantidad).toFixed(2);
            costeTotal += parseFloat(coste);
            span.textContent = `${coste} ‚Ç¨`;
          } else {
            span.textContent = '';
          }
        });

        const precioVenta = parseFloat(document.getElementById('rec-precioVenta').value) || 0;
        const margen = precioVenta - costeTotal;
        const margenPct = precioVenta > 0 ? ((margen / precioVenta) * 100).toFixed(1) : 0;

        if (hayDatos) {
          document.getElementById('coste-calculado-form').style.display = 'block';
          document.getElementById('coste-calculado-form').innerHTML = `
            <h4>üí∞ C√°lculo de costes</h4>
            <div class="coste-row"><span>Coste de ingredientes:</span><strong>${costeTotal.toFixed(2)} ‚Ç¨</strong></div>
            <div class="coste-row"><span>Precio de venta:</span><strong>${precioVenta.toFixed(2)} ‚Ç¨</strong></div>
            <div class="coste-row"><span>Margen:</span><strong>${margen.toFixed(2)} ‚Ç¨ (${margenPct}%)</strong></div>
          `;
        } else {
          document.getElementById('coste-calculado-form').style.display = 'none';
        }
      };

      window.guardarReceta = function(event) {
        event.preventDefault();
        
        const items = document.querySelectorAll('#lista-ingredientes-receta .ingrediente-item');
        const ingredientesReceta = [];
        
        items.forEach(item => {
          const select = item.querySelector('select');
          const input = item.querySelector('input');
          if (select.value && input.value) {
            ingredientesReceta.push({
              ingredienteId: ingredientes[parseInt(select.value)].id,
              cantidad: parseFloat(input.value)
            });
          }
        });

        if (ingredientesReceta.length === 0) {
          alert('A√±ade al menos un ingrediente');
          return;
        }

        const receta = {
          nombre: document.getElementById('rec-nombre').value,
          categoria: document.getElementById('rec-categoria').value,
          precioVenta: parseFloat(document.getElementById('rec-precioVenta').value) || 0,
          porciones: parseInt(document.getElementById('rec-porciones').value) || 1,
          ingredientes: ingredientesReceta,
          id: editandoRecetaIndex !== null ? recetas[editandoRecetaIndex].id : Date.now()
        };

        if (editandoRecetaIndex !== null) {
          recetas[editandoRecetaIndex] = receta;
        } else {
          recetas.push(receta);
        }

        guardarDatos();
        renderizarRecetas();
        window.cerrarFormularioReceta();
      };

      window.editarReceta = function(index) {
        const rec = recetas[index];
        document.getElementById('rec-nombre').value = rec.nombre;
        document.getElementById('rec-categoria').value = rec.categoria;
        document.getElementById('rec-precioVenta').value = rec.precioVenta;
        document.getElementById('rec-porciones').value = rec.porciones;
        
        document.getElementById('lista-ingredientes-receta').innerHTML = '';
        rec.ingredientes.forEach(item => {
          window.agregarIngredienteReceta();
          const lastItem = document.querySelector('#lista-ingredientes-receta .ingrediente-item:last-child');
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          const ingIndex = ingredientes.indexOf(ing);
          lastItem.querySelector('select').value = ingIndex;
          lastItem.querySelector('input').value = item.cantidad;
        });
        
        window.calcularCosteReceta();
        editandoRecetaIndex = index;
        document.getElementById('form-title-receta').textContent = 'Editar Receta';
        document.getElementById('btn-text-receta').textContent = 'Guardar Cambios';
        window.mostrarFormularioReceta();
      };

      window.eliminarReceta = function(index) {
        if (confirm('¬øEliminar esta receta?')) {
          recetas.splice(index, 1);
          guardarDatos();
          renderizarRecetas();
        }
      };

      function calcularCosteRecetaCompleto(receta) {
        let total = 0;
        receta.ingredientes.forEach(item => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (ing) total += ing.precio * item.cantidad;
        });
        return total;
      }

      window.renderizarRecetas = function() {
        const busqueda = document.getElementById('busqueda-recetas').value.toLowerCase();
        const filtradas = recetas.filter(r => r.nombre.toLowerCase().includes(busqueda));

        const container = document.getElementById('tabla-recetas');
        
        if (filtradas.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üë®‚Äçüç≥</div>
              <h3>${busqueda ? 'No se encontraron recetas' : 'A√∫n no hay recetas'}</h3>
              <p>${busqueda ? 'Intenta otra b√∫squeda' : 'Crea tu primera receta'}</p>
            </div>
          `;
          document.getElementById('resumen-recetas').style.display = 'none';
        } else {
          let html = '<table><thead><tr>';
          html += '<th>Plato</th><th>Categor√≠a</th><th>Coste</th><th>Precio</th><th>Margen</th><th>Acciones</th>';
          html += '</tr></thead><tbody>';

          filtradas.forEach(rec => {
            const realIndex = recetas.indexOf(rec);
            const coste = calcularCosteRecetaCompleto(rec);
            const margen = rec.precioVenta - coste;
            const pct = rec.precioVenta > 0 ? ((margen/rec.precioVenta)*100).toFixed(0) : 0;
            
            html += '<tr>';
            html += `<td><strong>${rec.nombre}</strong></td>`;
            html += `<td><span class="badge badge-success">${rec.categoria}</span></td>`;
            html += `<td>${coste.toFixed(2)} ‚Ç¨</td>`;
            html += `<td>${rec.precioVenta.toFixed(2)} ‚Ç¨</td>`;
            html += `<td><span class="badge ${margen>0?'badge-success':'badge-warning'}">${margen.toFixed(2)} ‚Ç¨ (${pct}%)</span></td>`;
            html += `<td><div class="actions">`;
            html += `<button class="icon-btn produce" onclick="window.abrirModalProducir(${realIndex})" title="Producir">‚¨áÔ∏è</button>`;
            html += `<button class="icon-btn edit" onclick="window.editarReceta(${realIndex})" title="Editar">‚úèÔ∏è</button>`;
            html += `<button class="icon-btn delete" onclick="window.eliminarReceta(${realIndex})" title="Eliminar">üóëÔ∏è</button>`;
            html += '</div></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          container.innerHTML = html;

          document.getElementById('resumen-recetas').innerHTML = `
            <div>Total: <strong>${recetas.length}</strong></div>
            <div>Mostrando: <strong>${filtradas.length}</strong></div>
          `;
          document.getElementById('resumen-recetas').style.display = 'flex';
        }
      };

      // ==================== PRODUCCI√ìN ====================
      window.abrirModalProducir = function(index) {
        recetaProduciendo = index;
        const rec = recetas[index];
        document.getElementById('modal-plato-nombre').textContent = rec.nombre;
        document.getElementById('modal-cantidad').value = 1;
        window.actualizarDetalleDescuento();
        document.getElementById('modal-producir').classList.add('active');
      };

      window.cerrarModalProducir = function() {
        document.getElementById('modal-producir').classList.remove('active');
        recetaProduciendo = null;
      };

      window.actualizarDetalleDescuento = function() {
        if (recetaProduciendo === null) return;
        const cant = parseInt(document.getElementById('modal-cantidad').value) || 1;
        const rec = recetas[recetaProduciendo];
        let html = '<ul style="margin:0;padding-left:20px;">';
        rec.ingredientes.forEach(item => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (ing) {
            html += `<li>${ing.nombre}: -${item.cantidad*cant} ${ing.unidad}</li>`;
          }
        });
        html += '</ul>';
        document.getElementById('modal-descuento-detalle').innerHTML = html;
      };

      window.confirmarProduccion = function() {
        if (recetaProduciendo === null) return;
        const cant = parseInt(document.getElementById('modal-cantidad').value) || 1;
        const rec = recetas[recetaProduciendo];
        
        let falta = false;
        let msg = 'Stock insuficiente:\n';
        rec.ingredientes.forEach(item => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (ing) {
            const necesario = item.cantidad * cant;
            if (ing.stockActual < necesario) {
              falta = true;
              msg += `- ${ing.nombre}: necesitas ${necesario}, tienes ${ing.stockActual}\n`;
            }
          }
        });
        
        if (falta) {
          alert(msg);
          return;
        }
        
        rec.ingredientes.forEach(item => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (ing) {
            ing.stockActual -= item.cantidad * cant;
            ing.stockActual = Math.max(0, ing.stockActual);
          }
        });
        
        guardarDatos();
        renderizarIngredientes();
        window.cerrarModalProducir();
        alert(`‚úÖ Producidas ${cant} unidades de ${rec.nombre}`);
      };

      // ==================== PROVEEDORES ====================
      window.mostrarFormularioProveedor = function() {
        document.getElementById('formulario-proveedor').style.display = 'block';
        cargarIngredientesProveedor();
        document.getElementById('prov-nombre').focus();
      };

      window.cerrarFormularioProveedor = function() {
        document.getElementById('formulario-proveedor').style.display = 'none';
        document.querySelector('#formulario-proveedor form').reset();
        editandoProveedorIndex = null;
        document.getElementById('form-title-proveedor').textContent = 'Nuevo Proveedor';
        document.getElementById('btn-text-proveedor').textContent = 'A√±adir Proveedor';
      };

      function cargarIngredientesProveedor(ingredientesSeleccionados = []) {
        const container = document.getElementById('lista-ingredientes-proveedor');
        if (ingredientes.length === 0) {
          container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">Primero a√±ade ingredientes</p>';
          return;
        }

        const busqueda = document.getElementById('buscar-ingredientes-proveedor').value.toLowerCase();
        const filtrados = ingredientes.filter(ing => ing.nombre.toLowerCase().includes(busqueda));

        let html = '';
        filtrados.forEach(ing => {
          const checked = ingredientesSeleccionados.includes(ing.id) ? 'checked' : '';
          html += `
            <div class="ingrediente-checkbox">
              <input type="checkbox" id="check-ing-${ing.id}" value="${ing.id}" ${checked}>
              <label for="check-ing-${ing.id}">${ing.nombre} (${ing.unidad})</label>
            </div>
          `;
        });

        container.innerHTML = html || '<p style="color:#999;padding:10px;">No hay resultados</p>';
      }

      window.filtrarIngredientesProveedor = function() {
        const checks = document.querySelectorAll('#lista-ingredientes-proveedor input[type="checkbox"]:checked');
        const seleccionados = Array.from(checks).map(c => parseInt(c.value));
        cargarIngredientesProveedor(seleccionados);
      };

      window.guardarProveedor = function(event) {
        event.preventDefault();

        const checks = document.querySelectorAll('#lista-ingredientes-proveedor input[type="checkbox"]:checked');
        const ingredientesIds = Array.from(checks).map(c => parseInt(c.value));

        const proveedor = {
          nombre: document.getElementById('prov-nombre').value,
          contacto: document.getElementById('prov-contacto').value,
          telefono: document.getElementById('prov-telefono').value,
          email: document.getElementById('prov-email').value,
          direccion: document.getElementById('prov-direccion').value,
          notas: document.getElementById('prov-notas').value,
          ingredientes: ingredientesIds,
          id: editandoProveedorIndex !== null ? proveedores[editandoProveedorIndex].id : Date.now()
        };

        if (editandoProveedorIndex !== null) {
          proveedores[editandoProveedorIndex] = proveedor;
        } else {
          proveedores.push(proveedor);
        }

        guardarDatos();
        renderizarProveedores();
        window.cerrarFormularioProveedor();
      };

      window.editarProveedor = function(index) {
        const prov = proveedores[index];
        document.getElementById('prov-nombre').value = prov.nombre;
        document.getElementById('prov-contacto').value = prov.contacto || '';
        document.getElementById('prov-telefono').value = prov.telefono || '';
        document.getElementById('prov-email').value = prov.email || '';
        document.getElementById('prov-direccion').value = prov.direccion || '';
        document.getElementById('prov-notas').value = prov.notas || '';
        
        cargarIngredientesProveedor(prov.ingredientes || []);
        
        editandoProveedorIndex = index;
        document.getElementById('form-title-proveedor').textContent = 'Editar Proveedor';
        document.getElementById('btn-text-proveedor').textContent = 'Guardar Cambios';
        window.mostrarFormularioProveedor();
      };

      window.eliminarProveedor = function(index) {
        if (confirm('¬øEliminar este proveedor?')) {
          proveedores.splice(index, 1);
          guardarDatos();
          renderizarProveedores();
          renderizarIngredientes();
        }
      };

      window.verProveedorDetalles = function(index) {
        const prov = proveedores[index];
        document.getElementById('modal-proveedor-titulo').textContent = prov.nombre;
        
        let html = '<div style="margin-bottom:20px;">';
        if (prov.contacto) html += `<p><strong>Contacto:</strong> ${prov.contacto}</p>`;
        if (prov.telefono) html += `<p><strong>Tel√©fono:</strong> ${prov.telefono}</p>`;
        if (prov.email) html += `<p><strong>Email:</strong> ${prov.email}</p>`;
        if (prov.direccion) html += `<p><strong>Direcci√≥n:</strong> ${prov.direccion}</p>`;
        if (prov.notas) html += `<p><strong>Notas:</strong> ${prov.notas}</p>`;
        html += '</div>';

        html += '<h4 style="margin-top:20px;margin-bottom:10px;">Ingredientes que suministra:</h4>';
        if (prov.ingredientes && prov.ingredientes.length > 0) {
          html += '<div class="ingredientes-list">';
          prov.ingredientes.forEach(ingId => {
            const ing = ingredientes.find(i => i.id === ingId);
            if (ing) {
              html += `<span class="badge">${ing.nombre}</span>`;
            }
          });
          html += '</div>';
        } else {
          html += '<p style="color:#999;">No tiene ingredientes asignados</p>';
        }

        document.getElementById('modal-proveedor-contenido').innerHTML = html;
        document.getElementById('modal-ver-proveedor').classList.add('active');
      };

      window.cerrarModalVerProveedor = function() {
        document.getElementById('modal-ver-proveedor').classList.remove('active');
      };

      window.renderizarProveedores = function() {
        const busqueda = document.getElementById('busqueda-proveedores').value.toLowerCase();
        const filtrados = proveedores.filter(p => p.nombre.toLowerCase().includes(busqueda));

        const container = document.getElementById('tabla-proveedores');
        
        if (filtrados.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üöö</div>
              <h3>${busqueda ? 'No se encontraron proveedores' : 'A√∫n no hay proveedores'}</h3>
              <p>${busqueda ? 'Intenta otra b√∫squeda' : 'A√±ade tu primer proveedor'}</p>
            </div>
          `;
          document.getElementById('resumen-proveedores').style.display = 'none';
        } else {
          let html = '<table><thead><tr>';
          html += '<th>Proveedor</th><th>Contacto</th><th>Tel√©fono</th><th>Ingredientes</th><th>Acciones</th>';
          html += '</tr></thead><tbody>';

          filtrados.forEach(prov => {
            const realIndex = proveedores.indexOf(prov);
            const numIng = prov.ingredientes ? prov.ingredientes.length : 0;
            
            html += '<tr>';
            html += `<td><strong>${prov.nombre}</strong></td>`;
            html += `<td>${prov.contacto || '-'}</td>`;
            html += `<td>${prov.telefono || '-'}</td>`;
            html += `<td><span class="badge badge-info">${numIng} ingrediente${numIng!==1?'s':''}</span></td>`;
            html += `<td><div class="actions">`;
            html += `<button class="icon-btn view" onclick="window.verProveedorDetalles(${realIndex})" title="Ver detalles">üëÅÔ∏è</button>`;
            html += `<button class="icon-btn edit" onclick="window.editarProveedor(${realIndex})" title="Editar">‚úèÔ∏è</button>`;
            html += `<button class="icon-btn delete" onclick="window.eliminarProveedor(${realIndex})" title="Eliminar">üóëÔ∏è</button>`;
            html += '</div></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          container.innerHTML = html;

          document.getElementById('resumen-proveedores').innerHTML = `
            <div>Total: <strong>${proveedores.length}</strong></div>
            <div>Mostrando: <strong>${filtrados.length}</strong></div>
          `;
          document.getElementById('resumen-proveedores').style.display = 'flex';
        }
      };

      init();
    })();
  </script>
</body>
</html>
