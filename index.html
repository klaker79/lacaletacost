<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>MindLoop CostOS - Restaurant Intelligence Platform</title>
  <meta name="description" content="Plataforma de inteligencia para restaurantes con tracking diario autom√°tico.">
  <link rel="icon" href="https://em-content.zobj.net/source/apple/391/pot-of-food_1f372.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg-dark: #0D0D0D;
      --bg-card: #1A1A1A;
      --bg-elevated: #242424;
      --accent-orange: #FF6B35;
      --accent-gold: #FFB800;
      --accent-green: #00D26A;
      --accent-red: #FF4757;
      --accent-blue: #4F9EFF;
      --text-primary: #FFFFFF;
      --text-secondary: #A0A0A0;
      --text-muted: #666666;
      --border-subtle: rgba(255,255,255,0.08);
      --border-accent: rgba(255,107,53,0.3);
      --glow-orange: 0 0 40px rgba(255,107,53,0.15);
      --glow-green: 0 0 30px rgba(0,210,106,0.2);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1440px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ========== HEADER ========== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255,107,53,0.05) 100%);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent-orange), var(--accent-gold), var(--accent-orange));
      background-size: 200% 100%;
      animation: shimmer 3s ease infinite;
    }
    @keyframes shimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-logo {
      width: 52px;
      height: 52px;
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-gold));
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      box-shadow: var(--glow-orange);
    }
    .header-title h1 {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    .header-title p {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'Space Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-elevated);
      padding: 8px 16px;
      border-radius: 100px;
      border: 1px solid var(--border-subtle);
      font-size: 13px;
      font-weight: 500;
    }
    .user-badge .dot {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .btn-logout {
      background: transparent;
      border: 1px solid var(--accent-red);
      color: var(--accent-red);
      padding: 8px 16px;
      border-radius: 100px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-logout:hover {
      background: var(--accent-red);
      color: white;
    }

    /* ========== TABS ========== */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      padding: 6px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      margin-bottom: 20px;
      overflow-x: auto;
    }
    .tab {
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
    }
    .tab:hover { color: var(--text-primary); background: var(--bg-elevated); }
    .tab.active {
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-gold));
      color: var(--bg-dark);
      box-shadow: var(--glow-orange);
    }
    .tab-icon { font-size: 16px; }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      padding: 28px;
      min-height: calc(100vh - 200px);
    }
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========== PAGE HEADER ========== */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 28px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .page-header h2 {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .page-header p { color: var(--text-muted); font-size: 14px; margin-top: 4px; }

    /* ========== BUTTONS ========== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-gold));
      color: var(--bg-dark);
      box-shadow: var(--glow-orange);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255,107,53,0.3); }
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
    }
    .btn-secondary:hover { border-color: var(--accent-orange); }
    .btn-success { background: var(--accent-green); color: var(--bg-dark); }
    .btn-small { padding: 8px 16px; font-size: 12px; }

    /* ========== DATE SELECTOR ========== */
    .date-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-elevated);
      padding: 12px 20px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      margin-bottom: 24px;
    }
    .date-selector label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      font-family: 'Space Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .date-selector input[type="date"] {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
    }
    .date-selector input[type="date"]:focus {
      outline: none;
      border-color: var(--accent-orange);
      box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
    }
    .date-nav-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
    }
    .date-nav-btn:hover {
      background: var(--accent-orange);
      border-color: var(--accent-orange);
      color: var(--bg-dark);
    }

    /* ========== KPI CARDS ========== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    .kpi-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent-orange);
      box-shadow: var(--glow-orange);
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }
    .kpi-card.green::before { background: var(--accent-green); }
    .kpi-card.red::before { background: var(--accent-red); }
    .kpi-card.blue::before { background: var(--accent-blue); }
    .kpi-card.gold::before { background: var(--accent-gold); }
    .kpi-icon {
      font-size: 28px;
      margin-bottom: 12px;
    }
    .kpi-value {
      font-size: 28px;
      font-weight: 800;
      font-family: 'Space Mono', monospace;
      letter-spacing: -1px;
      margin-bottom: 4px;
    }
    .kpi-card.green .kpi-value { color: var(--accent-green); }
    .kpi-card.red .kpi-value { color: var(--accent-red); }
    .kpi-card.blue .kpi-value { color: var(--accent-blue); }
    .kpi-card.gold .kpi-value { color: var(--accent-gold); }
    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ========== OBJECTIVE METER ========== */
    .objective-meter {
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
    }
    .objective-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .objective-header h4 {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .objective-target {
      font-size: 13px;
      color: var(--text-muted);
    }
    .objective-target strong {
      color: var(--accent-gold);
      font-size: 18px;
      font-family: 'Space Mono', monospace;
    }
    .progress-bar-container {
      height: 24px;
      background: var(--bg-dark);
      border-radius: 100px;
      overflow: hidden;
      position: relative;
    }
    .progress-bar-fill {
      height: 100%;
      border-radius: 100px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
      animation: shine 2s infinite;
    }
    @keyframes shine {
      from { transform: translateX(-100%); }
      to { transform: translateX(100%); }
    }
    .progress-bar-fill.success { background: linear-gradient(90deg, #00D26A, #00FF88); }
    .progress-bar-fill.warning { background: linear-gradient(90deg, #FFB800, #FFD700); }
    .progress-bar-fill.danger { background: linear-gradient(90deg, #FF4757, #FF6B7A); }
    .progress-marker {
      position: absolute;
      top: -8px;
      bottom: -8px;
      width: 3px;
      background: var(--text-primary);
      border-radius: 2px;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    .objective-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .objective-stats strong { color: var(--text-primary); }

    /* ========== DASHBOARD GRID ========== */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    .dashboard-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
    }
    .dashboard-card.full-width { grid-column: 1 / -1; }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .card-header h3 {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ========== DATA TABLE ========== */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table thead th {
      text-align: left;
      padding: 12px 16px;
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      background: var(--bg-dark);
      border-bottom: 1px solid var(--border-subtle);
    }
    .data-table tbody tr {
      transition: all 0.15s;
    }
    .data-table tbody tr:hover {
      background: rgba(255,107,53,0.05);
    }
    .data-table tbody td {
      padding: 14px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .data-table .date-cell {
      font-family: 'Space Mono', monospace;
      font-weight: 700;
    }
    .data-table .amount-positive { color: var(--accent-green); font-weight: 700; font-family: 'Space Mono', monospace; }
    .data-table .amount-negative { color: var(--accent-red); font-weight: 700; font-family: 'Space Mono', monospace; }

    /* ========== STATUS BADGES ========== */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 700;
    }
    .status-badge.achieved { background: rgba(0,210,106,0.15); color: var(--accent-green); }
    .status-badge.partial { background: rgba(255,184,0,0.15); color: var(--accent-gold); }
    .status-badge.missed { background: rgba(255,71,87,0.15); color: var(--accent-red); }

    /* ========== CHART ========== */
    .chart-container { height: 250px; position: relative; }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: var(--text-muted);
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state h3 { font-size: 16px; color: var(--text-secondary); margin-bottom: 4px; }
    .empty-state p { font-size: 13px; }

    /* ========== GASTOS FORM ========== */
    .gastos-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    .gasto-input-group label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .gasto-input-group input {
      width: 100%;
      background: var(--bg-dark);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      font-family: 'Space Mono', monospace;
      font-size: 16px;
      font-weight: 700;
    }
    .gasto-input-group input:focus {
      outline: none;
      border-color: var(--accent-orange);
    }
    .gastos-total {
      margin-top: 16px;
      padding: 16px;
      background: var(--bg-dark);
      border-radius: var(--radius-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .gastos-total span { color: var(--text-muted); font-weight: 600; }
    .gastos-total strong {
      font-size: 24px;
      font-family: 'Space Mono', monospace;
      color: var(--accent-red);
    }

    /* ========== TOAST ========== */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      padding: 16px 20px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      animation: slideIn 0.3s ease;
      max-width: 360px;
    }
    .toast.success { border-left: 4px solid var(--accent-green); }
    .toast.error { border-left: 4px solid var(--accent-red); }
    .toast.warning { border-left: 4px solid var(--accent-gold); }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ========== LOADING ========== */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(13,13,13,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(10px);
    }
    .loading-overlay.active { display: flex; }
    .spinner {
      width: 56px;
      height: 56px;
      border: 4px solid var(--bg-elevated);
      border-top-color: var(--accent-orange);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========== LOGIN ========== */
    .login-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .login-bg {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: 
        radial-gradient(ellipse at 20% 80%, rgba(255,107,53,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(255,184,0,0.1) 0%, transparent 50%);
    }
    .login-container {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      padding: 48px 40px;
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .login-header { text-align: center; margin-bottom: 32px; }
    .login-logo {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-gold));
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      margin: 0 auto 20px;
      box-shadow: var(--glow-orange);
    }
    .login-header h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }
    .login-header p { color: var(--text-muted); font-size: 14px; }
    .login-form .form-group { margin-bottom: 20px; }
    .login-form label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 13px;
    }
    .login-form input {
      width: 100%;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 14px 18px;
      border-radius: var(--radius-md);
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s;
    }
    .login-form input:focus {
      outline: none;
      border-color: var(--accent-orange);
      box-shadow: 0 0 0 4px rgba(255,107,53,0.1);
    }
    .login-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-gold));
      color: var(--bg-dark);
      border: none;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      box-shadow: var(--glow-orange);
    }
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(255,107,53,0.4);
    }
    .login-error {
      color: var(--accent-red);
      text-align: center;
      margin-top: 16px;
      font-size: 13px;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 1024px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .dashboard-grid { grid-template-columns: 1fr; }
      .gastos-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .container { padding: 12px; }
      .header { flex-direction: column; gap: 16px; padding: 16px; }
      .header-right { width: 100%; justify-content: space-between; }
      .tabs { padding: 4px; gap: 2px; }
      .tab { padding: 10px 12px; font-size: 11px; min-width: auto; }
      .main-content { padding: 16px; }
      .kpi-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
      .kpi-card { padding: 16px; }
      .kpi-value { font-size: 22px; }
      .date-selector { flex-wrap: wrap; justify-content: center; }
      .gastos-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="login-screen">
    <div class="login-bg"></div>
    <div class="login-container">
      <div class="login-header">
        <div class="login-logo">üçΩÔ∏è</div>
        <h1>MindLoop CostOS</h1>
        <p>Restaurant Intelligence Platform</p>
      </div>
      <form id="login-form" class="login-form">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" placeholder="tu@email.com" required>
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="login-btn">Iniciar Sesi√≥n</button>
        <p id="login-error" class="login-error"></p>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="container" id="app-container" style="display: none;">
    <header class="header">
      <div class="header-left">
        <div class="header-logo">üçΩÔ∏è</div>
        <div class="header-title">
          <h1>MindLoop CostOS</h1>
          <p>Intelligence Platform v2.2</p>
        </div>
      </div>
      <div class="header-right">
        <div class="user-badge">
          <span class="dot"></span>
          <span id="user-restaurant">Restaurante</span>
        </div>
        <button onclick="logout()" class="btn-logout">Cerrar sesi√≥n</button>
      </div>
    </header>

    <nav class="tabs">
      <button id="tab-btn-diario" class="tab active" onclick="cambiarTab('diario')">
        <span class="tab-icon">üìÖ</span> Control Diario
      </button>
      <button id="tab-btn-finanzas" class="tab" onclick="cambiarTab('finanzas')">
        <span class="tab-icon">üíµ</span> P&L Mensual
      </button>
      <button id="tab-btn-ventas" class="tab" onclick="cambiarTab('ventas')">
        <span class="tab-icon">üí∞</span> Ventas
      </button>
      <button id="tab-btn-compras" class="tab" onclick="cambiarTab('compras')">
        <span class="tab-icon">üõí</span> Compras
      </button>
    </nav>

    <main class="main-content">
      <!-- TAB: CONTROL DIARIO -->
      <div id="tab-diario" class="tab-content active">
        <div class="page-header">
          <div>
            <h2>üìÖ Control Diario</h2>
            <p>Seguimiento autom√°tico de ventas, compras y objetivos</p>
          </div>
          <button class="btn btn-primary" onclick="forzarCierreDiario()">üîí Cerrar D√≠a</button>
        </div>

        <div class="date-selector">
          <button class="date-nav-btn" onclick="navegarDia(-1)">‚óÄ</button>
          <label>FECHA:</label>
          <input type="date" id="fecha-diario" onchange="cargarDatosDia()">
          <button class="date-nav-btn" onclick="navegarDia(1)">‚ñ∂</button>
          <button class="btn btn-secondary btn-small" onclick="irAHoy()">Hoy</button>
        </div>

        <div class="kpi-grid">
          <div class="kpi-card green">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-value" id="kpi-ventas-dia">0.00‚Ç¨</div>
            <div class="kpi-label">Ventas del D√≠a</div>
          </div>
          <div class="kpi-card red">
            <div class="kpi-icon">üõí</div>
            <div class="kpi-value" id="kpi-compras-dia">0.00‚Ç¨</div>
            <div class="kpi-label">Compras del D√≠a</div>
          </div>
          <div class="kpi-card blue">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-value" id="kpi-margen-dia">0.00‚Ç¨</div>
            <div class="kpi-label">Margen Bruto</div>
          </div>
          <div class="kpi-card gold">
            <div class="kpi-icon">üéØ</div>
            <div class="kpi-value" id="kpi-objetivo-dia">0%</div>
            <div class="kpi-label">% Objetivo</div>
          </div>
        </div>

        <div class="objective-meter">
          <div class="objective-header">
            <h4>üéØ Progreso hacia el Objetivo Diario</h4>
            <div class="objective-target">
              Necesitas facturar: <strong id="objetivo-diario-valor">0.00‚Ç¨</strong> /d√≠a
            </div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill success" id="objetivo-bar-fill" style="width: 0%"></div>
            <div class="progress-marker" id="objetivo-marker" style="left: 100%"></div>
          </div>
          <div class="objective-stats">
            <span>Facturado: <strong id="facturado-dia">0.00‚Ç¨</strong></span>
            <span id="objetivo-mensaje">Calculando...</span>
            <span>Objetivo: <strong id="objetivo-meta">0.00‚Ç¨</strong></span>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="card-header">
              <h3>üí∞ Ventas del D√≠a</h3>
            </div>
            <div id="detalle-ventas-dia" style="max-height: 220px; overflow-y: auto;">
              <div class="empty-state">
                <div class="icon">üìä</div>
                <p>Sin ventas registradas</p>
              </div>
            </div>
          </div>

          <div class="dashboard-card">
            <div class="card-header">
              <h3>üõí Compras del D√≠a</h3>
            </div>
            <div id="detalle-compras-dia" style="max-height: 220px; overflow-y: auto;">
              <div class="empty-state">
                <div class="icon">üì¶</div>
                <p>Sin compras registradas</p>
              </div>
            </div>
          </div>

          <div class="dashboard-card full-width">
            <div class="card-header">
              <h3>üìà √öltimos 7 D√≠as</h3>
            </div>
            <div class="chart-container">
              <canvas id="chart-7dias"></canvas>
            </div>
          </div>

          <div class="dashboard-card full-width">
            <div class="card-header">
              <h3>üìã Historial de Cierres</h3>
            </div>
            <div style="max-height: 350px; overflow-y: auto;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>D√≠a</th>
                    <th>Ventas</th>
                    <th>Compras</th>
                    <th>Margen</th>
                    <th>Food Cost</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody id="tabla-historial-diario">
                  <tr><td colspan="7" class="empty-state"><p>Cargando...</p></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: P&L MENSUAL -->
      <div id="tab-finanzas" class="tab-content">
        <div class="page-header">
          <div>
            <h2>üíµ P&L Mensual</h2>
            <p>Consolidado desde los cierres diarios</p>
          </div>
        </div>

        <div class="kpi-grid" style="margin-bottom: 24px;">
          <div class="kpi-card green">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-value" id="pl-total-ventas">0.00‚Ç¨</div>
            <div class="kpi-label">Ventas Mes</div>
          </div>
          <div class="kpi-card red">
            <div class="kpi-icon">üõí</div>
            <div class="kpi-value" id="pl-total-compras">0.00‚Ç¨</div>
            <div class="kpi-label">Compras Mes</div>
          </div>
          <div class="kpi-card blue">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-value" id="pl-margen">0.00‚Ç¨</div>
            <div class="kpi-label">Margen Bruto</div>
          </div>
          <div class="kpi-card gold">
            <div class="kpi-icon">üìâ</div>
            <div class="kpi-value" id="pl-food-cost">0%</div>
            <div class="kpi-label">Food Cost Medio</div>
          </div>
        </div>

        <div class="dashboard-card" style="margin-bottom: 24px;">
          <div class="card-header">
            <h3>üè¢ Gastos Operativos Fijos</h3>
            <button class="btn btn-primary btn-small" onclick="guardarGastosFijos()">üíæ Guardar</button>
          </div>
          <div class="gastos-grid">
            <div class="gasto-input-group">
              <label>Alquiler</label>
              <input type="number" id="gasto-alquiler" value="1000" oninput="recalcularTotalGastos()">
            </div>
            <div class="gasto-input-group">
              <label>Personal</label>
              <input type="number" id="gasto-personal" value="3000" oninput="recalcularTotalGastos()">
            </div>
            <div class="gasto-input-group">
              <label>Suministros</label>
              <input type="number" id="gasto-suministros" value="500" oninput="recalcularTotalGastos()">
            </div>
            <div class="gasto-input-group">
              <label>Otros</label>
              <input type="number" id="gasto-otros" value="300" oninput="recalcularTotalGastos()">
            </div>
          </div>
          <div class="gastos-total">
            <span>Total Gastos Fijos Mensuales:</span>
            <strong id="total-gastos-fijos">4,800.00‚Ç¨</strong>
          </div>
        </div>

        <div class="kpi-grid">
          <div class="kpi-card blue">
            <div class="kpi-icon">üéØ</div>
            <div class="kpi-value" id="pl-break-even">0.00‚Ç¨</div>
            <div class="kpi-label">Break-Even Mensual</div>
          </div>
          <div class="kpi-card green">
            <div class="kpi-icon">üíµ</div>
            <div class="kpi-value" id="pl-beneficio">0.00‚Ç¨</div>
            <div class="kpi-label">Beneficio Neto</div>
          </div>
          <div class="kpi-card gold">
            <div class="kpi-icon">üìà</div>
            <div class="kpi-value" id="pl-rentabilidad">0%</div>
            <div class="kpi-label">Rentabilidad</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-value" id="pl-dias-cumplidos">0/0</div>
            <div class="kpi-label">D√≠as Objetivo</div>
          </div>
        </div>
      </div>

      <!-- TAB: VENTAS -->
      <div id="tab-ventas" class="tab-content">
        <div class="page-header">
          <div>
            <h2>üí∞ Registro de Ventas</h2>
            <p>Las ventas actualizan autom√°ticamente el Control Diario</p>
          </div>
        </div>
        <div class="empty-state">
          <div class="icon">üí∞</div>
          <h3>M√≥dulo de Ventas</h3>
          <p>Registra ventas por receta para actualizar el tracking diario autom√°ticamente</p>
        </div>
      </div>

      <!-- TAB: COMPRAS -->
      <div id="tab-compras" class="tab-content">
        <div class="page-header">
          <div>
            <h2>üõí Registro de Compras</h2>
            <p>Las compras recibidas actualizan el Control Diario</p>
          </div>
        </div>
        <div class="empty-state">
          <div class="icon">üõí</div>
          <h3>M√≥dulo de Compras</h3>
          <p>Registra pedidos a proveedores para tracking de costes diarios</p>
        </div>
      </div>
    </main>
  </div>

  <!-- LOADING -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <!-- TOAST -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // ========== CONFIG ==========
    const API_BASE = 'https://lacaleta-api.mindloop.cloud/api';
    let authToken = localStorage.getItem('authToken');
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    let chart7Dias = null;

    // ========== UTILS ==========
    function showLoading() { document.getElementById('loading-overlay').classList.add('active'); }
    function hideLoading() { document.getElementById('loading-overlay').classList.remove('active'); }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
      toast.innerHTML = `<span style="font-size:18px">${icon}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value || 0);
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function getDayName(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('es-ES', { weekday: 'short' });
    }

    async function apiRequest(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json', ...options.headers };
      if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
        if (response.status === 401) { logout(); throw new Error('Sesi√≥n expirada'); }
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Error');
        return data;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // ========== AUTH ==========
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');

      showLoading();
      try {
        const data = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }).then(r => r.json());

        if (data.error) { errorEl.textContent = data.error; hideLoading(); return; }

        authToken = data.token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        document.getElementById('user-restaurant').textContent = currentUser.restaurante;

        await initApp();
        hideLoading();
        showToast(`Bienvenido, ${currentUser.nombre}`);
      } catch (error) {
        errorEl.textContent = 'Error de conexi√≥n';
        hideLoading();
      }
    });

    function logout() {
      authToken = null;
      currentUser = null;
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('app-container').style.display = 'none';
    }

    // ========== INIT ==========
    async function initApp() {
      document.getElementById('fecha-diario').value = new Date().toISOString().split('T')[0];
      await cargarConfigGastos();
      await cargarDatosDia();
      await cargarHistorialDiario();
      await cargarGrafico7Dias();
      await cargarPLMensual();
    }

    // ========== TABS ==========
    function cambiarTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`tab-btn-${tabId}`).classList.add('active');
      document.getElementById(`tab-${tabId}`).classList.add('active');
      if (tabId === 'finanzas') cargarPLMensual();
    }

    // ========== DATE NAV ==========
    function navegarDia(delta) {
      const input = document.getElementById('fecha-diario');
      const fecha = new Date(input.value);
      fecha.setDate(fecha.getDate() + delta);
      input.value = fecha.toISOString().split('T')[0];
      cargarDatosDia();
    }

    function irAHoy() {
      document.getElementById('fecha-diario').value = new Date().toISOString().split('T')[0];
      cargarDatosDia();
    }

    // ========== CONFIG GASTOS ==========
    async function cargarConfigGastos() {
      try {
        const config = await apiRequest('/config/gastos');
        if (config) {
          document.getElementById('gasto-alquiler').value = config.alquiler || 1000;
          document.getElementById('gasto-personal').value = config.personal || 3000;
          document.getElementById('gasto-suministros').value = config.suministros || 500;
          document.getElementById('gasto-otros').value = config.otros || 300;
          recalcularTotalGastos();
        }
      } catch (e) { console.log('Config gastos default'); }
    }

    async function guardarGastosFijos() {
      showLoading();
      try {
        await apiRequest('/config/gastos', {
          method: 'PUT',
          body: JSON.stringify({
            alquiler: parseFloat(document.getElementById('gasto-alquiler').value) || 0,
            personal: parseFloat(document.getElementById('gasto-personal').value) || 0,
            suministros: parseFloat(document.getElementById('gasto-suministros').value) || 0,
            otros: parseFloat(document.getElementById('gasto-otros').value) || 0
          })
        });
        showToast('Gastos guardados');
        await cargarDatosDia();
        await cargarPLMensual();
        hideLoading();
      } catch (e) { hideLoading(); showToast('Error guardando', 'error'); }
    }

    function recalcularTotalGastos() {
      const total = parseFloat(document.getElementById('gasto-alquiler').value || 0) +
                    parseFloat(document.getElementById('gasto-personal').value || 0) +
                    parseFloat(document.getElementById('gasto-suministros').value || 0) +
                    parseFloat(document.getElementById('gasto-otros').value || 0);
      document.getElementById('total-gastos-fijos').textContent = formatCurrency(total);
    }

    // ========== DAILY DATA ==========
    async function cargarDatosDia() {
      const fecha = document.getElementById('fecha-diario').value;
      if (!fecha) return;

      showLoading();
      try {
        const data = await apiRequest(`/daily/${fecha}`);

        document.getElementById('kpi-ventas-dia').textContent = formatCurrency(data.ventas_total);
        document.getElementById('kpi-compras-dia').textContent = formatCurrency(data.compras_total);
        document.getElementById('kpi-margen-dia').textContent = formatCurrency(data.margen_bruto);

        const pctObjetivo = data.objetivo_diario > 0 
          ? ((data.ventas_total / data.objetivo_diario) * 100).toFixed(0) : 0;
        document.getElementById('kpi-objetivo-dia').textContent = `${pctObjetivo}%`;

        actualizarMedidorObjetivo(data.ventas_total, data.objetivo_diario);
        await cargarDetalleVentasDia(fecha);
        await cargarDetalleComprasDia(fecha);
        hideLoading();
      } catch (error) {
        hideLoading();
        showToast('Error cargando datos', 'error');
      }
    }

    async function cargarDetalleVentasDia(fecha) {
      try {
        const ventas = await apiRequest(`/sales?fecha=${fecha}`);
        const container = document.getElementById('detalle-ventas-dia');

        if (!ventas || ventas.length === 0) {
          container.innerHTML = `<div class="empty-state"><div class="icon">üìä</div><p>Sin ventas</p></div>`;
          return;
        }

        let html = '';
        ventas.forEach(v => {
          html += `<div style="display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border-subtle);">
            <span style="font-weight:600">${v.receta_nombre || 'Venta'}</span>
            <span style="color:var(--accent-green);font-weight:700;font-family:'Space Mono',monospace">${formatCurrency(v.total)}</span>
          </div>`;
        });
        container.innerHTML = html;
      } catch (e) { console.error(e); }
    }

    async function cargarDetalleComprasDia(fecha) {
      try {
        const pedidos = await apiRequest('/orders');
        const container = document.getElementById('detalle-compras-dia');

        const pedidosDia = pedidos.filter(p => {
          const fechaPedido = p.fecha.split('T')[0];
          return fechaPedido === fecha && p.estado === 'recibido';
        });

        if (pedidosDia.length === 0) {
          container.innerHTML = `<div class="empty-state"><div class="icon">üì¶</div><p>Sin compras</p></div>`;
          return;
        }

        let html = '';
        pedidosDia.forEach(p => {
          html += `<div style="display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border-subtle);">
            <span style="font-weight:600">Pedido #${p.id}</span>
            <span style="color:var(--accent-red);font-weight:700;font-family:'Space Mono',monospace">${formatCurrency(p.total_recibido || p.total)}</span>
          </div>`;
        });
        container.innerHTML = html;
      } catch (e) { console.error(e); }
    }

    function actualizarMedidorObjetivo(ventas, objetivo) {
      const pct = objetivo > 0 ? Math.min((ventas / objetivo) * 100, 150) : 0;
      const bar = document.getElementById('objetivo-bar-fill');

      bar.style.width = `${Math.min(pct, 100)}%`;
      bar.className = 'progress-bar-fill';
      if (pct >= 100) bar.classList.add('success');
      else if (pct >= 70) bar.classList.add('warning');
      else bar.classList.add('danger');

      document.getElementById('facturado-dia').textContent = formatCurrency(ventas);
      document.getElementById('objetivo-diario-valor').textContent = formatCurrency(objetivo);
      document.getElementById('objetivo-meta').textContent = formatCurrency(objetivo);

      const msg = document.getElementById('objetivo-mensaje');
      if (pct >= 100) {
        msg.innerHTML = `<span style="color:var(--accent-green)">‚úÖ ¬°Objetivo superado!</span>`;
      } else {
        const falta = objetivo - ventas;
        msg.innerHTML = `<span style="color:var(--accent-gold)">Faltan ${formatCurrency(falta)}</span>`;
      }
    }

    // ========== HISTORIAL ==========
    async function cargarHistorialDiario() {
      try {
        const historial = await apiRequest('/daily?limit=30');
        const tbody = document.getElementById('tabla-historial-diario');

        if (!historial || historial.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--text-muted)">Sin registros</td></tr>';
          return;
        }

        tbody.innerHTML = historial.map(r => {
          const foodCost = r.food_cost_percent || 0;
          let statusClass = 'missed';
          let statusText = '‚ùå No alcanzado';
          if (r.objetivo_cumplido) { statusClass = 'achieved'; statusText = '‚úÖ Cumplido'; }
          else if (r.ventas_total >= r.objetivo_diario * 0.7) { statusClass = 'partial'; statusText = '‚ö†Ô∏è Parcial'; }

          return `<tr>
            <td class="date-cell">${formatDate(r.fecha)}</td>
            <td>${getDayName(r.fecha)}</td>
            <td class="amount-positive">${formatCurrency(r.ventas_total)}</td>
            <td class="amount-negative">${formatCurrency(r.compras_total)}</td>
            <td>${formatCurrency(r.margen_bruto)}</td>
            <td>${foodCost.toFixed(1)}%</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          </tr>`;
        }).join('');
      } catch (e) { console.error(e); }
    }

    // ========== CHART ==========
    async function cargarGrafico7Dias() {
      try {
        const datos = await apiRequest('/daily/chart/7');
        const ctx = document.getElementById('chart-7dias').getContext('2d');

        if (chart7Dias) chart7Dias.destroy();

        Chart.defaults.color = '#A0A0A0';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.08)';

        chart7Dias = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: datos.map(d => formatDate(d.fecha)),
            datasets: [
              {
                label: 'Ventas',
                data: datos.map(d => parseFloat(d.ventas_total) || 0),
                backgroundColor: 'rgba(0,210,106,0.7)',
                borderRadius: 4
              },
              {
                label: 'Compras',
                data: datos.map(d => parseFloat(d.compras_total) || 0),
                backgroundColor: 'rgba(255,71,87,0.7)',
                borderRadius: 4
              },
              {
                label: 'Margen',
                data: datos.map(d => parseFloat(d.margen_bruto) || 0),
                type: 'line',
                borderColor: '#4F9EFF',
                backgroundColor: 'rgba(79,158,255,0.1)',
                fill: true,
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { callback: v => formatCurrency(v) }
              },
              x: { grid: { display: false } }
            }
          }
        });
      } catch (e) { console.error(e); }
    }

    // ========== P&L ==========
    async function cargarPLMensual() {
      try {
        const mes = new Date().getMonth() + 1;
        const ano = new Date().getFullYear();
        const summary = await apiRequest(`/daily/summary/month?mes=${mes}&ano=${ano}`);

        document.getElementById('pl-total-ventas').textContent = formatCurrency(summary.total_ventas);
        document.getElementById('pl-total-compras').textContent = formatCurrency(summary.total_compras);
        document.getElementById('pl-margen').textContent = formatCurrency(summary.total_margen);
        document.getElementById('pl-food-cost').textContent = `${(summary.avg_food_cost || 0).toFixed(1)}%`;
        document.getElementById('pl-break-even').textContent = formatCurrency(summary.break_even_mensual);
        document.getElementById('pl-beneficio').textContent = formatCurrency(summary.beneficio_neto);
        document.getElementById('pl-rentabilidad').textContent = `${(summary.rentabilidad || 0).toFixed(1)}%`;
        document.getElementById('pl-dias-cumplidos').textContent = `${summary.dias_objetivo_cumplido}/${summary.dias_registrados}`;

        const beneficioEl = document.getElementById('pl-beneficio');
        beneficioEl.style.color = summary.beneficio_neto >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
      } catch (e) { console.error(e); }
    }

    // ========== CIERRE ==========
    async function forzarCierreDiario() {
      const fecha = document.getElementById('fecha-diario').value;
      if (!confirm(`¬øCerrar el d√≠a ${formatDate(fecha)}?`)) return;

      showLoading();
      try {
        await apiRequest(`/daily/${fecha}`, {
          method: 'POST',
          body: JSON.stringify({ cerrado: true })
        });
        showToast('D√≠a cerrado');
        await cargarHistorialDiario();
        await cargarGrafico7Dias();
        hideLoading();
      } catch (e) { hideLoading(); showToast('Error', 'error'); }
    }

    // ========== STARTUP ==========
    window.addEventListener('DOMContentLoaded', () => {
      if (authToken && currentUser) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        document.getElementById('user-restaurant').textContent = currentUser.restaurante;
        initApp();
      }
    });
  </script>
</body>
</html>
