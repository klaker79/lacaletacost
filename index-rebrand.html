<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MindLoop CostOS - Restaurant Intelligence</title>
  <link rel="icon" href="https://em-content.zobj.net/source/apple/391/pot-of-food_1f372.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
  font-family: 'Montserrat', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
  background-size: 200% 200%;
  animation: gradient 15s ease infinite;
  min-height: 100vh;
}

@keyframes gradient {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .logo-circle {
      width: 50px;
      height: 50px;
      border: 2px solid #c35a3f;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #c35a3f;
    }
    .header-title { flex: 1; }
    .header-title h1 { color: #c35a3f; font-size: 24px; font-weight: 700; }
    .header-title p { color: #666; font-size: 14px; }
    
    .tabs {
      background: white;
      border-radius: 10px 10px 0 0;
      display: flex;
      gap: 5px;
      padding: 10px 10px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
    }
    .tab:hover { background: #f5f5f5; }
    .tab.active {
      background: white;
      color: #c35a3f;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    
    .main-card {
      background: white;
      border-radius: 0 10px 10px 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 500px;
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .top-bar h2 { font-size: 28px; color: #333; }
    .top-bar p { color: #666; font-size: 14px; margin-top: 5px; }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    .btn-primary { background: #c35a3f; color: white; }
    .btn-primary:hover { background: #a84a33; }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-small { padding: 8px 16px; font-size: 13px; }
    
    /* === BUSCADOR MEJORADO === */
.search-box {
  position: relative;
  max-width: 400px;
  margin: 20px 0;
}

.search-box input {
  width: 100%;
  padding: 14px 20px 14px 48px;
  border: 2px solid #E2E8F0;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 500;
  color: #1E293B;
  background: white;
  transition: all 0.3s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.search-box input:focus {
  outline: none;
  border-color: #FF6B35;
  box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1), 0 4px 12px rgba(0, 0, 0, 0.08);
  transform: translateY(-1px);
}

.search-box input::placeholder {
  color: #94A3B8;
  font-weight: 400;
}

.search-box::before {
  content: "üîç";
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  pointer-events: none;
  opacity: 0.6;
}
    
    .form-card {
      background: #fff5f2;
      border: 2px solid #c35a3f;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
    }
    .form-card h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 5px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .ingredientes-receta {
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .ingredientes-receta h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    .ingrediente-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .ingrediente-item select,
    .ingrediente-item input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    .ingrediente-item button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .selector-ingredientes {
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .selector-ingredientes h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    .ingredientes-disponibles {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #f9f9f9;
    }
    .ingrediente-checkbox {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .ingrediente-checkbox:hover {
      background: #f0f0f0;
    }
    .ingrediente-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
    }
    .ingrediente-checkbox label {
      cursor: pointer;
      flex: 1;
      margin: 0;
    }
    
    .coste-calculado {
      background: #f0fdf4;
      border: 2px solid #10b981;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .coste-calculado h4 {
      color: #059669;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .coste-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #d1fae5;
    }
    .coste-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 18px;
      color: #059669;
      padding-top: 15px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #c35a3f;
    }
    .stat-card.green { border-left-color: #10b981; }
    .stat-card.blue { border-left-color: #3b82f6; }
    .stat-card.orange { border-left-color: #f59e0b; }
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 600;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }
    .stat-card .subtext {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chart-card h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 15px;
    }
    .chart-card canvas {
      max-height: 300px;
    }
    
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: #f8f8f8;
      border-bottom: 2px solid #e0e0e0;
    }
    th {
      padding: 12px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
    }
    td {
      padding: 15px 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    tbody tr:hover {
      background: #f9f9f9;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      transition: all 0.2s;
    }
    .icon-btn:hover { transform: scale(1.1); }
    .icon-btn.edit { color: #c35a3f; }
    .icon-btn.delete { color: #dc2626; }
    .icon-btn.produce { color: #10b981; }
    .icon-btn.view { color: #3b82f6; }
    .icon-btn.receive { color: #10b981; }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .empty-state .icon { font-size: 60px; margin-bottom: 15px; }
    .empty-state h3 { font-size: 20px; color: #666; margin-bottom: 10px; }
    
    .stock-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .stock-low { background: #fee; color: #c00; }
    .stock-ok { background: #efe; color: #060; }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-success { background: #d1fae5; color: #059669; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-info { background: #dbeafe; color: #2563eb; }
    .badge-pending { background: #fef3c7; color: #d97706; }
    .badge-received { background: #d1fae5; color: #059669; }
    
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }
    .summary strong { color: #333; }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      line-height: 1;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h3 {
      font-size: 22px;
      color: #333;
      margin-bottom: 20px;
    }
    
    .ingredientes-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .ingredientes-list .badge {
      background: #f0f0f0;
      color: #333;
      padding: 6px 12px;
    }

    .total-pedido {
      background: #f0fdf4;
      border: 2px solid #10b981;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: right;
    }
    .total-pedido strong {
      font-size: 24px;
      color: #059669;
    }

    /* Estilos para Inventario */
    .tab-badge {
      background: #ef4444;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 6px;
      font-weight: bold;
    }

    .stock-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .stock-ok { background: #10b981; }
    .stock-bajo { background: #f59e0b; }
    .stock-critico { background: #ef4444; }

    .stock-actions {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .stock-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    .stock-btn:hover {
      background: #e5e7eb;
    }

    .stock-value {
      min-width: 60px;
      text-align: center;
      font-weight: bold;
    }
    /* === MEJORAS PROFESIONALES MINDLOOP === */
.header { 
  background: linear-gradient(135deg, #4F46E5 0%, #9333EA 100%);
  padding: 12px 32px;
  box-shadow: 0 4px 20px rgba(79, 70, 229, 0.15);
  display: flex;
  align-items: center;
  gap: 20px;
}
    .header img {
  height: 60px;
  border-radius: 50%;
  background: white;
  padding: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.header h1 {
  margin: 0;
  background: linear-gradient(135deg, #FF6B35 0%, #F59E0B 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 48px;
  font-weight: 800;
  letter-spacing: -1px;
}
    /* KPI Dashboard Cards */
.kpi-dashboard {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin: 24px 0;
  padding: 0 32px;
}

.kpi-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  border: 1px solid rgba(0, 0, 0, 0.06);
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.kpi-icon {
  font-size: 32px;
  margin-bottom: 12px;
}

.kpi-label {
  font-size: 13px;
  color: #64748B;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 36px;
  font-weight: 800;
  color: #1E293B;
  margin-bottom: 8px;
  line-height: 1;
}

.kpi-trend {
  font-size: 14px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.kpi-trend.positive {
  color: #10B981;
}

.kpi-trend.negative {
  color: #EF4444;
}

.kpi-trend.warning {
  color: #F59E0B;
}

.header p {
  margin: 8px 0 0 0;
  color: rgba(255,255,255,0.9);
  font-size: 18px;
  font-weight: 500;
  letter-spacing: 0.5px;
}
    /* KPI Dashboard Cards */
.kpi-dashboard {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin: 24px 0;
  padding: 0 32px;
}

.kpi-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  border: 1px solid rgba(0, 0, 0, 0.06);
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.kpi-icon {
  font-size: 32px;
  margin-bottom: 12px;
}

.kpi-label {
  font-size: 13px;
  color: #64748B;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 36px;
  font-weight: 800;
  color: #1E293B;
  margin-bottom: 8px;
  line-height: 1;
}

.kpi-trend {
  font-size: 14px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.kpi-trend.positive {
  color: #10B981;
}

.kpi-trend.negative {
  color: #EF4444;
}

.kpi-trend.warning {
  color: #F59E0B;
}
    /* Chart Container */
.chart-container {
  background: white;
  border-radius: 16px;
  padding: 32px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  margin-bottom: 24px;
}

.chart-header {
  margin-bottom: 24px;
}

.chart-header h3 {
  font-size: 20px;
  font-weight: 700;
  color: #1E293B;
  margin: 0 0 8px 0;
}

.chart-header p {
  font-size: 14px;
  color: #64748B;
  margin: 0;
}

#revenueChart {
  max-height: 350px;
}

.logo-mindloop { display: none; }

.header-title h1 {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.tabs {
  gap: 8px;
  padding: 16px 0;
}

.tab {
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 500;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.tab:hover {
  background: rgba(255, 107, 53, 0.1);
  transform: translateY(-2px);
}

.tab.active {
  background: linear-gradient(135deg, #FF6B35, #F59E0B);
  color: white;
  box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
}

.main-card {
  border-radius: 16px;
  box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
}

.btn-primary {
  background: linear-gradient(135deg, #FF6B35, #F59E0B);
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
  transition: all 0.3s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 53, 0.35);
}

table {
  border-spacing: 0 8px;
}

/* === TABLAS MEJORADAS === */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 20px;
}

table thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

table thead th {
  background: linear-gradient(180deg, #F8FAFC 0%, #F1F5F9 100%);
  color: #64748B;
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  padding: 16px 20px;
  text-align: left;
  border-bottom: 2px solid #E2E8F0;
  white-space: nowrap;
}

table thead th:first-child {
  border-top-left-radius: 12px;
}

table thead th:last-child {
  border-top-right-radius: 12px;
}
    table tbody tr {
  background: white;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  border-bottom: 1px solid #F1F5F9;
}

table tbody tr:hover {
  background: linear-gradient(90deg, #FFF7ED 0%, #FFFFFF 100%);
  transform: translateX(4px);
  box-shadow: -4px 0 0 0 #FF6B35, 0 2px 8px rgba(0, 0, 0, 0.06);
}

table tbody tr:last-child {
  border-bottom: none;
}

table tbody td {
  padding: 18px 20px;
  color: #1E293B;
  font-size: 14px;
  vertical-align: middle;
}

table tbody td:first-child {
  font-weight: 600;
}

/* Actions buttons */
.actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.icon-btn {
  background: transparent;
  border: 1px solid #E2E8F0;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.icon-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.icon-btn.edit:hover {
  background: #FFF7ED;
  border-color: #F59E0B;
}

.icon-btn.delete:hover {
  background: #FEF2F2;
  border-color: #EF4444;
}

.icon-btn.view:hover {
  background: #EFF6FF;
  border-color: #3B82F6;
}

table tbody tr {
  background: white;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  border-bottom: 1px solid #F1F5F9;
}

table tbody tr:hover {
  background: linear-gradient(90deg, #FFF7ED 0%, #FFFFFF 100%);
  transform: translateX(4px);
  box-shadow: -4px 0 0 0 #FF6B35, 0 2px 8px rgba(0, 0, 0, 0.06);
}

table tbody tr:last-child {
  border-bottom: none;
}

table tbody td {
  padding: 18px 20px;
  color: #1E293B;
  font-size: 14px;
  vertical-align: middle;
}

table tbody td:first-child {
  font-weight: 600;
}

/* Actions buttons */
.actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.icon-btn {
  background: transparent;
  border: 1px solid #E2E8F0;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.icon-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.icon-btn.edit:hover {
  background: #FFF7ED;
  border-color: #F59E0B;
}

.icon-btn.delete:hover {
  background: #FEF2F2;
  border-color: #EF4444;
}

.icon-btn.view:hover {
  background: #EFF6FF;
  border-color: #3B82F6;
}
    background: #EFF6FF;
    border-color: #3B82F6;
  }

  /* === ANIMACIONES DE ENTRADA === */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Header animation */
  .header {
    animation: fadeIn 0.6s ease-out;
  }

  /* KPI cards staggered animation */
.kpi-card {
  animation: fadeInUp 0.6s ease-out;
}

  .kpi-card:nth-child(1) {
    animation-delay: 0.1s;
  }

  .kpi-card:nth-child(2) {
    animation-delay: 0.2s;
  }

  .kpi-card:nth-child(3) {
    animation-delay: 0.3s;
  }

  .kpi-card:nth-child(4) {
    animation-delay: 0.4s;
  }

  /* Tabs animation */
  .tabs {
    animation: fadeIn 0.6s ease-out 0.5s backwards;
  }

  /* Main card animation */
  .main-card {
    animation: fadeInUp 0.6s ease-out 0.6s backwards;
  }

  /* Table rows animation */
  table tbody tr {
    animation: fadeIn 0.4s ease-out backwards;
  }

  table tbody tr:nth-child(1) { animation-delay: 0.05s; }
  table tbody tr:nth-child(2) { animation-delay: 0.1s; }
  table tbody tr:nth-child(3) { animation-delay: 0.15s; }
  table tbody tr:nth-child(4) { animation-delay: 0.2s; }
  table tbody tr:nth-child(5) { animation-delay: 0.25s; }
  table tbody tr:nth-child(6) { animation-delay: 0.3s; }
  table tbody tr:nth-child(7) { animation-delay: 0.35s; }
  table tbody tr:nth-child(8) { animation-delay: 0.4s; }
  table tbody tr:nth-child(9) { animation-delay: 0.45s; }
  table tbody tr:nth-child(10) { animation-delay: 0.5s; }

  /* Buttons animation */
  .btn-primary {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .btn-primary:active {
    transform: scale(0.95);
  }
    /* === TOAST NOTIFICATIONS === */
  .toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
  }
  
  .toast {
    background: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    border-left: 4px solid #10B981;
  }
  
  .toast.success { border-left-color: #10B981; }
  .toast.error { border-left-color: #EF4444; }
  .toast.warning { border-left-color: #F59E0B; }
  .toast.info { border-left-color: #3B82F6; }
  
  .toast-icon {
    font-size: 24px;
    flex-shrink: 0;
  }
  
  .toast-message {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    color: #1E293B;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* === LOADING SPINNER === */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }
  
  .loading-overlay.active {
    display: flex;
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: #FF6B35;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Login Screen */
  .login-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .login-container {
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    width: 100%;
    max-width: 400px;
  }
  .login-header {
    text-align: center;
    margin-bottom: 30px;
  }
  .login-header h1 {
    color: #1a1a2e;
    font-size: 28px;
    margin-bottom: 8px;
  }
  .login-header p {
    color: #666;
    font-size: 14px;
  }
  .login-form .form-group {
    margin-bottom: 20px;
  }
  .login-form label {
    display: block;
    margin-bottom: 6px;
    color: #333;
    font-weight: 600;
    font-size: 14px;
  }
  .login-form input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }
  .login-form input:focus {
    outline: none;
    border-color: #667eea;
  }
  .login-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
  }
  .login-error {
    color: #e74c3c;
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
  }
  .login-footer {
    text-align: center;
    margin-top: 20px;
    color: #666;
    font-size: 14px;
  }
  .login-footer a {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
  }
    
/* === INVENTARIO AVANZADO === */
    .stock-real-input {
      width: 80px;
      padding: 4px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      text-align: center;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
    }

    .stock-real-input:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .dif-ok {
      color: #10b981;
      font-weight: 600;
    }

    .dif-positiva {
      color: #f59e0b;
      font-weight: 600;
    }

    .dif-negativa {
      color: #ef4444;
      font-weight: 600;
    }

    #tabla-ingredientes th {
      font-size: 11px;
      text-transform: uppercase;
      padding: 12px 8px;
      white-space: nowrap;
    }

    #tabla-ingredientes td {
      padding: 12px 8px;
      font-size: 14px;
    }
```

---

**A√±ade eso y luego haz commit con mensaje:**
```
feat: implementar inventario avanzado completo
  </style>
  </style>
</head>
<body>
  <!-- Pantalla de Login -->
  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>üçΩÔ∏è MindLoop CostOS</h1>
        <p>Restaurant Intelligence Platform</p>
      </div>
      <form id="login-form" class="login-form">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="tu@email.com" required>
        </div>
        <div class="form-group">
          <label for="login-password">Contrase√±a</label>
          <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="login-btn">Iniciar Sesi√≥n</button>
        <p id="login-error" class="login-error"></p>
      </form>
      <div class="login-footer">
        <p>¬øNo tienes cuenta? <a href="#" onclick="mostrarRegistro()">Registrar restaurante</a></p>
      </div>
    </div>
  </div>

  <div class="container" id="app-container" style="display: none;">
    <div class="header" style="justify-content: space-between;">
      <div style="display: flex; align-items: center; flex: 1;">
           <img src="logosincirculo-removebg-preview.png" alt="MindLoopIA" style="height: 120px; width: auto; margin-right: 20px; background: transparent; padding: 0; box-shadow: none;">
            <div>
                <h1 style="margin: 0;">MindLoop CostOS</h1>
                <p style="margin: 0;">Restaurant Intelligence Platform</p>
            </div>
        </div>
      <div style="display: flex; align-items: center; gap: 15px;">
        <span id="user-restaurant" style="color: #666; font-size: 14px;"></span>
        <button onclick="logout()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px;">Cerrar Sesi√≥n</button>
      </div>
    </div>

    <!-- KPI Dashboard -->
    <div class="kpi-dashboard">
      <div class="kpi-card">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi-label">Ingresos totales</div>
        <div class="kpi-value" id="kpi-ingresos">0‚Ç¨</div>
        <div class="kpi-trend positive">
          <span>‚Üó</span> <span id="kpi-ingresos-trend">+0%</span> este mes
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">üìã</div>
        <div class="kpi-label">Pedidos activos</div>
        <div class="kpi-value" id="kpi-pedidos">0</div>
        <div class="kpi-trend positive">
          <span>‚Üó</span> <span id="kpi-pedidos-trend">+0%</span> vs anterior
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">‚ö†Ô∏è</div>
        <div class="kpi-label">Stock bajo</div>
        <div class="kpi-value" id="kpi-stock">0</div>
        <div class="kpi-trend warning">
          <span>‚ö°</span> <span id="kpi-stock-msg">Requieren atenci√≥n</span>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">üìä</div>
        <div class="kpi-label">Margen promedio</div>
        <div class="kpi-value" id="kpi-margen">0%</div>
        <div class="kpi-trend positive">
          <span>‚Üó</span> <span id="kpi-margen-trend">+0%</span> objetivo
        </div>
      </div>
    </div>
    <!-- Dashboard Expandido -->
    <div id="dashboard-expandido" class="dashboard-expandido" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 0 32px 24px 32px;">
      
      <!-- Alertas de Stock -->
      <div class="dashboard-card" style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #1E293B; display: flex; align-items: center; gap: 8px;">
          üö® Alertas de Stock
        </h3>
        <div id="alertas-stock-lista" style="max-height: 150px; overflow-y: auto; font-size: 14px;">
          <p style="color: #64748B; margin: 0;">Cargando...</p>
        </div>
      </div>

      <!-- Resumen del D√≠a -->
      <div class="dashboard-card" style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #1E293B; display: flex; align-items: center; gap: 8px;">
          üìä Resumen de Hoy
        </h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div style="text-align: center; padding: 12px; background: #F0FDF4; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: 700; color: #10B981;" id="ventas-hoy">0</div>
            <div style="font-size: 12px; color: #64748B;">Ventas</div>
          </div>
          <div style="text-align: center; padding: 12px; background: #EFF6FF; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: 700; color: #3B82F6;" id="ingresos-hoy">0‚Ç¨</div>
            <div style="font-size: 12px; color: #64748B;">Ingresos</div>
          </div>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: #FFF7ED; border-radius: 8px; text-align: center;">
          <div style="font-size: 12px; color: #64748B;">Plato estrella hoy</div>
          <div style="font-size: 14px; font-weight: 600; color: #F59E0B;" id="plato-estrella-hoy">-</div>
        </div>
      </div>

      <!-- Accesos R√°pidos -->
      <div class="dashboard-card" style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #1E293B; display: flex; align-items: center; gap: 8px;">
          ‚ö° Acciones R√°pidas
        </h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="window.cambiarTab('ventas'); document.getElementById('venta-receta').focus();" style="padding: 12px; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
            üí∞ Nueva Venta
          </button>
          <button onclick="window.cambiarTab('pedidos'); window.mostrarFormularioPedido && window.mostrarFormularioPedido();" style="padding: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
            üì¶ Nuevo Pedido
          </button>
          <button onclick="window.cambiarTab('inventario');" style="padding: 12px; background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
            üîç Ver Inventario
          </button>
        </div>
      </div>

    </div>
    <div class="tabs">
      <button id="tab-btn-ingredientes" class="tab active" onclick="window.cambiarTab('ingredientes')">üì¶ Ingredientes</button>
      <button id="tab-btn-recetas" class="tab" onclick="window.cambiarTab('recetas')">üë®‚Äçüç≥ Recetas</button>
      <button id="tab-btn-proveedores" class="tab" onclick="window.cambiarTab('proveedores')">üöö Proveedores</button>
      <button id="tab-btn-pedidos" class="tab" onclick="window.cambiarTab('pedidos')">üìã Pedidos</button>
      <button id="tab-btn-analisis" class="tab" onclick="window.cambiarTab('analisis')">üìä An√°lisis</button>
      <button id="tab-btn-inventario" class="tab" onclick="window.cambiarTab('inventario')">üì¶ Inventario<span id="badge-inventario" class="tab-badge" style="display:none;">0</span></button>
      <button id="tab-btn-ventas" class="tab" onclick="window.cambiarTab('ventas')">üí∞ Ventas</button>
      <button id="tab-btn-balance" class="tab" onclick="window.cambiarTab('balance')">üíµ Balance</button>
    </div>

    <div class="main-card">
      
      <!-- TAB: INGREDIENTES (c√≥digo anterior simplificado por brevedad) -->
      <div id="tab-ingredientes" class="tab-content active">
        <div class="top-bar">
          <div>
            <h2>Ingredientes</h2>
            <p>Gestiona todos los ingredientes de tu restaurante</p>
          </div>
         <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="window.mostrarFormularioIngrediente()">‚ûï A√±adir Ingrediente</button>
        <button class="btn btn-secondary" onclick="exportarIngredientes()">üì• Exportar Excel</button>
      </div>
        </div>
        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="busqueda-ingredientes" placeholder="Buscar..." oninput="window.renderizarIngredientes()">
        </div>
        <div id="formulario-ingrediente" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-ingrediente">Nuevo Ingrediente</span>
            <button class="close-btn" onclick="window.cerrarFormularioIngrediente()">√ó</button>
          </h3>
          <form onsubmit="window.guardarIngrediente(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="ing-nombre" required>
              </div>
              <div class="form-group">
                <label>Proveedor</label>
                <select id="ing-proveedor-select"><option value="">Sin proveedor</option></select>
              </div>
              <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="ing-precio" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label>Unidad</label>
                <select id="ing-unidad">
                  <option value="kg">kg</option>
                  <option value="g">g</option>
                  <option value="l">L</option>
                  <option value="ml">ml</option>
                  <option value="unidad">Unidades</option>
                </select>
              </div>
              <div class="form-group">
                <label>Stock actual</label>
                <input type="number" id="ing-stockActual" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label>Stock m√≠nimo</label>
                <input type="number" id="ing-stockMinimo" step="0.01" min="0">
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="window.cerrarFormularioIngrediente()">Cancelar</button>
              <button type="submit" class="btn btn-primary"><span id="btn-text-ingrediente">A√±adir</span></button>
            </div>
          </form>
        </div>
        <div id="tabla-ingredientes"></div>
        <div id="resumen-ingredientes" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: RECETAS (simplificado) -->
      <div id="tab-recetas" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>Recetas</h2>
            <p>Crea recetas y calcula costes</p>
          </div>
         <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="window.mostrarFormularioReceta()">‚ûï Nueva Receta</button>
        <button class="btn btn-secondary" onclick="exportarRecetas()">üì• Exportar Excel</button>
      </div>
        </div>
        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="busqueda-recetas" placeholder="Buscar..." oninput="window.renderizarRecetas()">
        </div>
        <div id="formulario-receta" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-receta">Nueva Receta</span>
            <button class="close-btn" onclick="window.cerrarFormularioReceta()">√ó</button>
          </h3>
          <form onsubmit="window.guardarReceta(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="rec-nombre" required>
              </div>
              <div class="form-group">
                <label>Categor√≠a</label>
                <select id="rec-categoria">
                  <option value="entrante">Entrante</option>
                  <option value="principal">Principal</option>
                  <option value="postre">Postre</option>
                  <option value="bebida">Bebida</option>
                </select>
              </div>
              <div class="form-group">
                <label>Precio venta (‚Ç¨)</label>
                <input type="number" id="rec-precio_venta" step="0.01" min="0" oninput="window.calcularCosteReceta()">
              </div>
              <div class="form-group">
                <label>Porciones</label>
                <input type="number" id="rec-porciones" min="1" value="1">
              </div>
            </div>
            <div class="ingredientes-receta">
              <h4>Ingredientes</h4>
              <div id="lista-ingredientes-receta"></div>
              <button type="button" class="btn btn-secondary btn-small" onclick="window.agregarIngredienteReceta()">+ A√±adir</button>
            </div>
            <div id="coste-calculado-form" class="coste-calculado" style="display: none;"></div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="window.cerrarFormularioReceta()">Cancelar</button>
              <button type="submit" class="btn btn-primary"><span id="btn-text-receta">Guardar</span></button>
            </div>
          </form>
        </div>
        <div id="tabla-recetas"></div>
        <div id="resumen-recetas" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: PROVEEDORES (simplificado) -->
      <div id="tab-proveedores" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>Proveedores</h2>
            <p>Gestiona tus proveedores</p>
          </div>
          <button class="btn btn-primary" onclick="window.mostrarFormularioProveedor()">+ A√±adir Proveedor</button>
        </div>
        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="busqueda-proveedores" placeholder="Buscar..." oninput="window.renderizarProveedores()">
        </div>
        <div id="formulario-proveedor" class="form-card" style="display: none;">
          <h3>
            <span id="form-title-proveedor">Nuevo Proveedor</span>
            <button class="close-btn" onclick="window.cerrarFormularioProveedor()">√ó</button>
          </h3>
          <form onsubmit="window.guardarProveedor(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="prov-nombre" required>
              </div>
              <div class="form-group">
                <label>Contacto</label>
                <input type="text" id="prov-contacto">
              </div>
              <div class="form-group">
                <label>Tel√©fono</label>
                <input type="tel" id="prov-telefono">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="prov-email">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Direcci√≥n</label>
                <textarea id="prov-direccion"></textarea>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Notas</label>
                <textarea id="prov-notas"></textarea>
              </div>
            </div>
            <div class="selector-ingredientes">
              <h4>Ingredientes que suministra</h4>
              <div class="search-box" style="margin-bottom: 10px;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" id="buscar-ingredientes-proveedor" placeholder="Buscar..." oninput="window.filtrarIngredientesProveedor()">
              </div>
              <div class="ingredientes-disponibles" id="lista-ingredientes-proveedor"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="window.cerrarFormularioProveedor()">Cancelar</button>
              <button type="submit" class="btn btn-primary"><span id="btn-text-proveedor">A√±adir</span></button>
            </div>
          </form>
        </div>
        <div id="tabla-proveedores"></div>
        <div id="resumen-proveedores" class="summary" style="display: none;"></div>
      </div>

      <!-- TAB: PEDIDOS -->
      <div id="tab-pedidos" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>Pedidos a Proveedores</h2>
            <p>Gestiona tus pedidos y actualiza stock autom√°ticamente</p>
          </div>
          <button class="btn btn-primary" onclick="window.mostrarFormularioPedido()">+ Nuevo Pedido</button>
        </div>

        <div class="search-box">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="busqueda-pedidos" placeholder="Buscar pedidos..." oninput="window.renderizarPedidos()">
        </div>

        <div id="formulario-pedido" class="form-card" style="display: none;">
          <h3>
            <span>Nuevo Pedido</span>
            <button class="close-btn" onclick="window.cerrarFormularioPedido()">√ó</button>
          </h3>
          <form onsubmit="window.guardarPedido(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Proveedor *</label>
                <select id="ped-proveedor" required onchange="window.cargarIngredientesPedido()">
                  <option value="">Seleccionar proveedor...</option>
                </select>
              </div>
              <div class="form-group">
                <label>Fecha del pedido</label>
                <input type="date" id="ped-fecha" required>
              </div>
            </div>

            <div class="ingredientes-receta" id="container-ingredientes-pedido" style="display:none;">
              <h4>Ingredientes del pedido</h4>
              <div id="lista-ingredientes-pedido"></div>
              <button type="button" class="btn btn-secondary btn-small" onclick="window.agregarIngredientePedido()">+ A√±adir ingrediente</button>
            </div>

            <div id="total-pedido-form" style="display:none;" class="total-pedido">
              Total: <strong id="total-pedido-value">0.00 ‚Ç¨</strong>
            </div>

            <div class="form-actions" style="margin-top: 20px;">
              <button type="button" class="btn btn-secondary" onclick="window.cerrarFormularioPedido()">Cancelar</button>
              <button type="submit" class="btn btn-primary">Crear Pedido</button>
            </div>
          </form>
        </div>

        <div id="tabla-pedidos"></div>
        <div id="resumen-pedidos" class="summary" style="display: none;"></div>
      </div>

     <!-- TAB: AN√ÅLISIS -->
      <div id="tab-analisis" class="tab-content">
        <div class="chart-container">
          <div class="chart-header">
            <h3>üìä Ingresos vs Gastos</h3>
            <p>Evoluci√≥n financiera de los √∫ltimos 7 d√≠as</p>
          </div>
          <canvas id="revenueChart"></canvas>
        </div>
        
        <div id="analisis-vacio" class="empty-state">
          <div class="icon">üìä</div>
          <h3>A√∫n no hay datos</h3>
          <p>A√±ade ingredientes y recetas</p>
        </div>
        
        <div id="analisis-contenido" style="display: none;">
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Total Recetas</h3>
              <div class="value" id="stat-total-recetas">0</div>
            </div>
            <div class="stat-card green">
              <h3>Margen Promedio</h3>
              <div class="value" id="stat-margen-promedio">0%</div>
            </div>
            <div class="stat-card blue">
              <h3>Coste Promedio</h3>
              <div class="value" id="stat-coste-promedio">0 ‚Ç¨</div>
            </div>
            <div class="stat-card orange">
              <h3>Total Ingredientes</h3>
              <div class="value" id="stat-total-ingredientes">0</div>
            </div>
          </div>
          <div class="charts-grid">
            <div class="chart-card">
              <h3>Rentabilidad por Plato</h3>
              <canvas id="chart-rentabilidad"></canvas>
            </div>
            <div class="chart-card">
              <h3>Ingredientes M√°s Caros</h3>
              <canvas id="chart-ingredientes"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Ranking de Rentabilidad</h3>
            <div id="tabla-rentabilidad"></div>
          </div>
        </div>
      </div>

      <!-- TAB: INVENTARIO -->
      <div id="tab-inventario" class="tab-content">
        <div class="top-bar">
          <div>
            <h2>üì¶ Inventario</h2>
            <p>Control de stock de ingredientes</p>
          </div>
          <div id="resumen-inventario" style="display: none; gap: 20px;"></div>
        </div>

        <div class="card">
          <div style="margin-bottom: 20px;">
            <input type="text" id="busqueda-inventario" placeholder="üîç Buscar ingrediente..." style="width: 100%; max-width: 400px;">
          </div>

          <div id="tabla-inventario"></div>
        </div>
      </div>
      <!-- TAB: VENTAS -->
<div id="tab-ventas" class="tab-content">
  <div class="top-bar">
    <h2>üí∞ Ventas</h2>
    <p>Registro diario de ventas</p>
  </div>
  
  <div class="card">
    <h3>Registrar Venta</h3>
    <form id="form-venta">
      <label>Plato:</label>
      <select id="venta-receta" required></select>
      
      <label>Cantidad:</label>
      <input type="number" id="venta-cantidad" min="1" value="1" required>
      
      <button type="submit" class="btn btn-success">Registrar Venta</button>
    </form>
  </div>
  <div class="card" style="margin-bottom: 20px;">
    <h3>üìÖ Filtrar por Fecha</h3>
    <div style="display: flex; gap: 15px; align-items: end;">
      <div class="form-group" style="flex: 1;">
        <label>Desde:</label>
        <input type="date" id="ventas-fecha-desde" class="form-control">
      </div>
      <div class="form-group" style="flex: 1;">
        <label>Hasta:</label>
        <input type="date" id="ventas-fecha-hasta" class="form-control">
      </div>
      <button class="btn btn-primary" onclick="window.renderizarVentas()">üîç Filtrar</button>
      <button class="btn btn-secondary" onclick="document.getElementById('ventas-fecha-desde').value=''; document.getElementById('ventas-fecha-hasta').value=''; window.renderizarVentas();">üîÑ Limpiar</button>
    </div>
  </div>
  
  <div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 style="margin: 0;">üìä Hist√≥rico de Ventas</h3>
      <button class="btn btn-secondary" onclick="exportarVentas()">üì• Exportar Excel</button>
    </div>
    <div id="tabla-ventas"></div>
  </div>
</div>
      <!-- TAB: BALANCE -->
<div id="tab-balance" class="tab-content">
  <div class="top-bar">
    <h2>üíµ Balance Financiero</h2>
    <p>An√°lisis completo de la salud financiera del negocio</p>
  </div>
  
  <!-- Grid Principal de M√©tricas -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px;">
    
    <!-- Card Ingresos -->
    <div style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 20px; padding: 32px; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25); position: relative; overflow: hidden;">
      <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">üí∞</div>
      <div style="position: relative; z-index: 1;">
        <div style="color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Ingresos Totales</div>
        <div id="balance-ingresos" style="color: white; font-size: 48px; font-weight: 800; line-height: 1; margin-bottom: 8px;">-</div>
        <div style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Este mes</div>
      </div>
    </div>

    <!-- Card Costos -->
    <div style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); border-radius: 20px; padding: 32px; box-shadow: 0 8px 24px rgba(239, 68, 68, 0.25); position: relative; overflow: hidden;">
      <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">üìâ</div>
      <div style="position: relative; z-index: 1;">
        <div style="color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Costos Totales</div>
        <div id="balance-costos" style="color: white; font-size: 48px; font-weight: 800; line-height: 1; margin-bottom: 8px;">-</div>
        <div style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Este mes</div>
      </div>
    </div>

    <!-- Card Ganancia -->
    <div style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 20px; padding: 32px; box-shadow: 0 8px 24px rgba(59, 130, 246, 0.25); position: relative; overflow: hidden;">
      <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">üíµ</div>
      <div style="position: relative; z-index: 1;">
        <div style="color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Ganancia Neta</div>
        <div id="balance-ganancia" style="color: white; font-size: 48px; font-weight: 800; line-height: 1; margin-bottom: 8px;">-</div>
        <div style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Este mes</div>
      </div>
    </div>

    <!-- Card Margen -->
    <div style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); border-radius: 20px; padding: 32px; box-shadow: 0 8px 24px rgba(139, 92, 246, 0.25); position: relative; overflow: hidden;">
      <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">üìä</div>
      <div style="position: relative; z-index: 1;">
        <div style="color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Margen Bruto</div>
        <div id="balance-margen" style="color: white; font-size: 48px; font-weight: 800; line-height: 1; margin-bottom: 8px;">-</div>
        <div style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Porcentaje</div>
      </div>
    </div>
      </div>

      <!-- Card Compras -->
      <div style="background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); border-radius: 20px; padding: 32px; box-shadow: 0 8px 24px rgba(99, 102, 241, 0.25); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">üõí</div>
        <div style="position: relative; z-index: 1;">
          <div style="color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Compras Totales</div>
          <div id="balance-compras" style="color: white; font-size: 48px; font-weight: 800; line-height: 1; margin-bottom: 8px;">--‚Ç¨</div>
          <div style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Este mes</div>
        </div>
      </div>

      </div>

  <!-- Grid Secundario -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
    
    <!-- Card Inventario -->
    <div style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); border: 2px solid #F59E0B;">
      <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px;">üì¶</div>
        <div>
          <div style="color: #64748B; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Valor Inventario</div>
          <div id="balance-inventario" style="color: #F59E0B; font-size: 36px; font-weight: 800; line-height: 1;">-</div>
        </div>
      </div>
      <div style="height: 4px; background: linear-gradient(90deg, #F59E0B 0%, #FDE68A 100%); border-radius: 2px;"></div>
    </div>

    <!-- Card Plato M√°s Vendido -->
    <div style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); border: 2px solid #FF6B35;">
      <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #FFF7ED, #FFEDD5); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px;">üèÜ</div>
        <div style="flex: 1;">
          <div style="color: #64748B; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Plato M√°s Vendido</div>
          <div id="balance-plato-vendido" style="color: #1E293B; font-size: 18px; font-weight: 700; line-height: 1.3;">-</div>
        </div>
      </div>
      <div style="height: 4px; background: linear-gradient(90deg, #FF6B35 0%, #FFEDD5 100%); border-radius: 2px;"></div>
    </div>

  </div>

</div>
  
  <!-- Modales (simplificados) -->
  <div id="modal-producir" class="modal">
    <div class="modal-content">
      <h3>Producir platos</h3>
      <p style="margin-bottom: 20px;">¬øCu√°ntas unidades de <strong id="modal-plato-nombre"></strong>?</p>
      <div class="form-group">
        <label>Cantidad</label>
        <input type="number" id="modal-cantidad" min="1" value="1" style="width:100%;padding:10px;" oninput="window.actualizarDetalleDescuento()">
      </div>
      <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 6px;">
        <strong>‚ö†Ô∏è Descuento de stock:</strong>
        <div id="modal-descuento-detalle" style="margin-top: 10px;"></div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="window.cerrarModalProducir()">Cancelar</button>
        <button class="btn btn-success" onclick="window.confirmarProduccion()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="modal-ver-proveedor" class="modal">
    <div class="modal-content">
      <h3 id="modal-proveedor-titulo"></h3>
      <div id="modal-proveedor-contenido"></div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="window.cerrarModalVerProveedor()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal ver detalles pedido -->
  <div id="modal-ver-pedido" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <h3>Detalles del Pedido</h3>
      <div id="modal-ver-pedido-contenido"></div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="window.cerrarModalVerPedido()">Cerrar</button>
        <button class="btn btn-primary" onclick="window.descargarPedidoPDF()" id="btn-descargar-pdf">
          üìÑ Descargar PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Modal recibir pedido -->
  <div id="modal-recibir-pedido" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <h3>Recibir Pedido</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Verifica las cantidades y precios recibidos. Puedes ajustar los valores si hay diferencias.
      </p>
      
      <div style="background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong>Proveedor:</strong> <span id="modal-rec-proveedor"></span><br>
        <strong>Fecha pedido:</strong> <span id="modal-rec-fecha"></span><br>
        <strong>Total original:</strong> <span id="modal-rec-total-original"></span>
      </div>

      <div style="margin-bottom: 20px;">
        <h4 style="margin-bottom: 10px;">Ingredientes del pedido:</h4>
        <table style="font-size: 13px;">
          <thead>
            <tr>
              <th>Ingrediente</th>
              <th>Pedido</th>
              <th>Recibido</th>
              <th>Precio Ped.</th>
              <th>Precio Real</th>
              <th>Subtotal</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="modal-rec-items"></tbody>
        </table>
      </div>

      <div style="background: #f0fdf4; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
          <div>
            <strong style="color: #666;">Total Original:</strong><br>
            <span style="font-size: 20px; font-weight: bold; color: #333;" id="modal-rec-resumen-original">0.00 ‚Ç¨</span>
          </div>
          <div>
            <strong style="color: #666;">Total Recibido:</strong><br>
            <span style="font-size: 20px; font-weight: bold; color: #059669;" id="modal-rec-resumen-recibido">0.00 ‚Ç¨</span>
          </div>
          <div>
            <strong style="color: #666;">Varianza:</strong><br>
            <span style="font-size: 20px; font-weight: bold;" id="modal-rec-resumen-varianza">0.00 ‚Ç¨</span>
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="window.cerrarModalRecibirPedido()">Cancelar</button>
        <button class="btn btn-success" onclick="window.confirmarRecepcionPedido()">Confirmar Recepci√≥n</button>
      </div>
    </div>
  </div>
  <script>
    // C√≥digo JavaScript completo (por brevedad, incluyo versi√≥n funcional comprimida)
    // El c√≥digo completo est√° disponible en el archivo descargable
    
    (function() {
      window.ingredientes = [];
      window.recetas = [];
      window.proveedores = [];
      window.pedidos = [];
      let editandoIngredienteId = null;
      let editandoRecetaId = null;
      let editandoProveedorId = null;
      let recetaProduciendo = null;
      let chartRentabilidad = null;
      let chartIngredientes = null;

      // === UTILIDADES ===
      function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
        
        toast.innerHTML = `
          <div class="toast-icon">${icons[type]}</div>
          <div class="toast-message">${message}</div>
        `;
        
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'slideIn 0.3s ease reverse';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
      
      function showLoading() {
        document.getElementById('loading-overlay').classList.add('active');
      }
      
      function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
      }
      // === EXPORT A EXCEL ===
      function exportarAExcel(datos, nombreArchivo, columnas) {
        // Preparar datos para Excel
        const datosExcel = datos.map(item => {
          const fila = {};
          columnas.forEach(col => {
            fila[col.header] = col.key ? item[col.key] : col.value(item);
          });
          return fila;
        });
        
        // Crear libro y hoja
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(datosExcel);
        
        // Ajustar ancho de columnas
        ws['!cols'] = columnas.map(() => ({ wch: 20 }));
        
        XLSX.utils.book_append_sheet(wb, ws, "Datos");
        
        // Descargar
        XLSX.writeFile(wb, `${nombreArchivo}_${new Date().toISOString().split('T')[0]}.xlsx`);
        
        showToast('Excel descargado correctamente', 'success');
      }
      function exportarIngredientes() {
        const columnas = [
          { header: 'Nombre', key: 'nombre' },
          { header: 'Categor√≠a', key: 'categoria' },
          { header: 'Proveedor', value: (ing) => {
            const prov = window.proveedores.find(p => p.id === ing.proveedor_id);
            return prov ? prov.nombre : 'Sin proveedor';
          }},
          { header: 'Precio (‚Ç¨)', value: (ing) => parseFloat(ing.precio || 0).toFixed(2) },
          { header: 'Unidad', key: 'unidad' },
          { header: 'Stock Actual', value: (ing) => parseFloat(ing.stockActual || 0).toFixed(2) },
          { header: 'Stock M√≠nimo', value: (ing) => parseFloat(ing.stockMinimo || 0).toFixed(2) }
        ];
        
        exportarAExcel(window.ingredientes, 'Ingredientes_CostOS', columnas);
      }
      function exportarRecetas() {
        const columnas = [
          { header: 'Nombre', key: 'nombre' },
          { header: 'Categor√≠a', key: 'categoria' },
          { header: 'Precio Venta (‚Ç¨)', value: (rec) => parseFloat(rec.precio_venta || 0).toFixed(2) },
          { header: 'Coste (‚Ç¨)', value: (rec) => {
            return rec.ingredientes.reduce((sum, item) => {
              const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
              return sum + (ing ? ing.precio * item.cantidad : 0);
            }, 0).toFixed(2);
          }},
          { header: 'Margen (%)', value: (rec) => {
            const coste = rec.ingredientes.reduce((sum, item) => {
              const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
              return sum + (ing ? ing.precio * item.cantidad : 0);
            }, 0);
            const margen = rec.precio_venta > 0 ? ((parseFloat(rec.precio_venta) - coste) / parseFloat(rec.precio_venta) * 100) : 0;
            return margen.toFixed(1) + '%';
          }},
          { header: 'Ingredientes', value: (rec) => rec.ingredientes.length }
        ];
        
        exportarAExcel(window.recetas, 'Recetas_CostOS', columnas);
      }
      function exportarVentas() {
        const columnas = [
          { header: 'Fecha', key: 'fecha' },
          { header: 'Receta', value: (venta) => {
            const rec = window.recetas.find(r => r.id === venta.receta_id);
            return rec ? rec.nombre : 'Desconocida';
          }},
          { header: 'Cantidad', key: 'cantidad' },
          { header: 'Total (‚Ç¨)', value: (venta) => parseFloat(venta.total).toFixed(2) }
        ];
        
        api.getSales().then(ventas => exportarAExcel(ventas, 'Ventas_CostOS', columnas));
      }
      // Exponer funciones globalmente
      window.exportarIngredientes = exportarIngredientes;
      window.exportarRecetas = exportarRecetas;
      window.exportarVentas = exportarVentas;
      // === ACTUALIZAR KPIs ===
      window.actualizarKPIs = function() {
        // 1. INGRESOS TOTALES (suma de ventas)
        api.getSales().then(ventas => {
          const ingresos = ventas.reduce((sum, v) => sum + parseFloat(v.total), 0);
          document.getElementById('kpi-ingresos').textContent = ingresos.toFixed(0) + '‚Ç¨';
        }).catch(() => {
          document.getElementById('kpi-ingresos').textContent = '0‚Ç¨';
        });

        // 2. PEDIDOS ACTIVOS
        const pedidosActivos = window.pedidos.filter(p => p.estado === 'pendiente').length;
        document.getElementById('kpi-pedidos').textContent = pedidosActivos;

        // 3. STOCK BAJO
        const stockBajo = window.ingredientes.filter(ing => {
          const stockActual = parseFloat(ing.stock_actual) || 0;
          const stockMinimo = parseFloat(ing.stock_minimo) || 0;
          return stockMinimo > 0 && stockActual <= stockMinimo;
        }).length;
        document.getElementById('kpi-stock').textContent = stockBajo;
        document.getElementById('kpi-stock-msg').textContent =
          stockBajo > 0 ? 'Requieren atenci√≥n' : 'Todo OK';

        // 4. MARGEN PROMEDIO
        if (window.recetas.length > 0) {
          let totalMargen = 0;
          window.recetas.forEach(rec => {
            const coste = rec.ingredientes.reduce((sum, item) => {
              const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
              return sum + (ing ? parseFloat(ing.precio) * item.cantidad : 0);
            }, 0);
            const precioVenta = parseFloat(rec.precio_venta) || 0;
            const margen = precioVenta > 0 ? ((precioVenta - coste) / precioVenta) * 100 : 0;
            totalMargen += margen;
          });
          const margenPromedio = (totalMargen / window.recetas.length).toFixed(0);
          document.getElementById('kpi-margen').textContent = margenPromedio + '%';
        } else {
          document.getElementById('kpi-margen').textContent = '0%';
        }
      };
      
      // === GR√ÅFICO INGRESOS VS GASTOS ===
      async function renderRevenueChart() {
        const ctx = document.getElementById('revenueChart');
        if (!ctx || typeof Chart === 'undefined') return;

        // Obtener datos reales de los √∫ltimos 7 d√≠as
        const labels = [];
        const ingresos = [];
        const costos = [];
        
        for (let i = 6; i >= 0; i--) {
          const fecha = new Date();
          fecha.setDate(fecha.getDate() - i);
          const fechaStr = fecha.toISOString().split('T')[0];
          const diaSemana = fecha.toLocaleDateString('es-ES', { weekday: 'short' });
          labels.push(diaSemana.charAt(0).toUpperCase() + diaSemana.slice(1));
          
          // Filtrar ventas de ese d√≠a
          try {
            const ventas = await api.getSales();
            const ventasDia = ventas.filter(v => v.fecha.split('T')[0] === fechaStr);
            const ingresoDia = ventasDia.reduce((sum, v) => sum + parseFloat(v.total), 0);
            ingresos.push(ingresoDia);
            
            // Calcular costos de ese d√≠a (basado en ingredientes de recetas vendidas)
            let costoDia = 0;
            for (const venta of ventasDia) {
              const receta = window.recetas.find(r => r.id === venta.receta_id);
              if (receta && receta.ingredientes) {
                for (const item of receta.ingredientes) {
                  const ing = window.ingredientes.find(i => i.id === item.ingredienteId);
                  if (ing) {
                    costoDia += parseFloat(ing.precio) * item.cantidad * venta.cantidad;
                  }
                }
              }
            }
            costos.push(costoDia);
          } catch (e) {
            ingresos.push(0);
            costos.push(0);
          }
        }

        // Destruir gr√°fico anterior si existe
        if (window.revenueChartInstance) {
          window.revenueChartInstance.destroy();
        }

        window.revenueChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Ingresos',
              data: ingresos,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              tension: 0.4,
              borderWidth: 3
            }, {
              label: 'Costos',
              data: costos,
              borderColor: '#EF4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              fill: true,
              tension: 0.4,
              borderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'top',
                labels: { usePointStyle: true, padding: 20, font: { size: 14, weight: '600' } }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0, 0, 0, 0.05)' },
                ticks: { callback: value => value + '‚Ç¨', font: { size: 12 } }
              },
              x: { grid: { display: false }, ticks: { font: { size: 12 } } }
            }
          }
        });
      }
      // === VENTAS ===
window.renderizarVentas = async function() {
  const select = document.getElementById('venta-receta');
  select.innerHTML = '<option value="">Selecciona un plato...</option>';
  window.recetas.forEach(r => {
    select.innerHTML += `<option value="${r.id}">${r.nombre} - ${r.precio_venta}‚Ç¨</option>`;
  });
  
  // Obtener rango de fechas
  const fechaDesde = document.getElementById('ventas-fecha-desde')?.value;
  const fechaHasta = document.getElementById('ventas-fecha-hasta')?.value;
  
  try {
    const ventas = await api.getSales();
    
    // Filtrar por fechas si hay filtros
    let ventasFiltradas = ventas;
    if (fechaDesde) {
      ventasFiltradas = ventasFiltradas.filter(v => v.fecha >= fechaDesde);
    }
    if (fechaHasta) {
      ventasFiltradas = ventasFiltradas.filter(v => v.fecha <= fechaHasta + 'T23:59:59');
    }
    
    // Agrupar por d√≠a
    const ventasPorDia = {};
    ventasFiltradas.forEach(v => {
      const dia = v.fecha.split('T')[0];
      if (!ventasPorDia[dia]) ventasPorDia[dia] = [];
      ventasPorDia[dia].push(v);
    });
    
    let html = '<table><thead><tr><th>Fecha</th><th>Hora</th><th>Plato</th><th>Cantidad</th><th>Total</th><th>Acciones</th></tr></thead><tbody>';
    let totalGeneral = 0;
    
    Object.keys(ventasPorDia).sort().reverse().forEach(dia => {
      // Header de fecha
      html += `<tr style="background:#F8FAFC;"><td colspan="5" style="padding:12px 16px;font-weight:700;color:#1E293B;border-top:2px solid #E2E8F0;">${new Date(dia).toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</td></tr>`;
      
      // Ventas de ese d√≠a
      ventasPorDia[dia].forEach(v => {
        const hora = new Date(v.fecha).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
        const fecha = new Date(v.fecha).toLocaleDateString('es-ES');
        html += `<tr><td style="padding:8px 16px 8px 32px;color:#64748B;">${fecha}</td><td style="padding:8px 16px;color:#64748B;">${hora}</td><td style="padding:8px 16px;color:#1E293B;">${v.receta_nombre}</td><td style="padding:8px 16px;text-align:center;color:#64748B;">${v.cantidad}</td><td style="padding:8px 16px;text-align:right;"><strong style="color:#1E293B;">${parseFloat(v.total).toFixed(2)}‚Ç¨</strong></td><td style="padding:8px 16px;text-align:center;"><button class="icon-btn delete" onclick="window.eliminarVenta(${v.id})" title="Eliminar">üóëÔ∏è</button></td></tr>`;
        totalGeneral += parseFloat(v.total);
      });
    });
    
    html += `<tr style="background:#10b981;color:white;font-weight:700;font-size:16px;"><td colspan="4">TOTAL</td><td>${totalGeneral.toFixed(2)}‚Ç¨</td></tr>`;
    html += '</tbody></table>';
    
    document.getElementById('tabla-ventas').innerHTML = html;
  } catch (error) {
    document.getElementById('tabla-ventas').innerHTML = '<p style="color:#ef4444;">Error cargando ventas</p>';
  }
};
      window.eliminarVenta = async function(id) {
  if (!confirm('¬øEliminar esta venta? El stock NO se restaurar√° autom√°ticamente.')) return;
  
  try {
    await api.deleteSale(id);
    await cargarDatos();
    renderizarVentas();
    renderizarIngredientes();
      renderizarInventario();
      window.actualizarKPIs();
      window.actualizarDashboardExpandido();
      showToast('Venta eliminada', 'success');
  } catch (error) {
    console.error('Error:', error);
    showToast('Error eliminando venta', 'error');
  }
};
// === BALANCE ===
window.renderizarBalance = async function() {
  try {
    // Obtener balance del mes actual
        const resBalance = await fetch(API_BASE + '/balance/mes', {
            headers: getAuthHeaders()
        });
        const balance = await resBalance.json();
    
    // Actualizar m√©tricas
    document.getElementById('balance-ingresos').textContent = balance.ingresos.toFixed(2) + '‚Ç¨';
    document.getElementById('balance-costos').textContent = balance.costos.toFixed(2) + '‚Ç¨';
    document.getElementById('balance-ganancia').textContent = balance.ganancia.toFixed(2) + '‚Ç¨';
    document.getElementById('balance-margen').textContent = balance.margen.toFixed(1) + '%';
    document.getElementById('balance-inventario').textContent = balance.valor_inventario.toFixed(2) + '‚Ç¨';

      // Calcular compras del mes
      const ahora = new Date();
      const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1).toISOString().split('T')[0];
      const pedidosRecibidos = window.pedidos.filter(p => 
        p.estado === 'recibido' && 
        p.fecha_recepcion && 
        p.fecha_recepcion.split('T')[0] >= inicioMes
      );
      const comprasMes = pedidosRecibidos.reduce((sum, p) => sum + parseFloat(p.total || 0), 0);
      document.getElementById('balance-compras').textContent = comprasMes.toFixed(2) + '‚Ç¨';
    
    if (balance.plato_mas_vendido) {
      document.getElementById('balance-plato-vendido').textContent = 
        `${balance.plato_mas_vendido.nombre} (${balance.plato_mas_vendido.total_vendido} unidades)`;
    } else {
      document.getElementById('balance-plato-vendido').textContent = 'Sin ventas este mes';
    }
    
  } catch (error) {
    console.error('Error renderizando balance:', error);
    document.getElementById('balance-ingresos').textContent = 'Error';
    document.getElementById('balance-costos').textContent = 'Error';
    document.getElementById('balance-ganancia').textContent = 'Error';
    document.getElementById('balance-margen').textContent = 'Error';
  }
};

    // ========== AUTENTICACI√ìN ==========
    const API_AUTH_URL = 'https://lacaleta-api.mindloop.cloud/api/auth';
    
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (token) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        return true;
      }
      return false;
    }
    
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      
      try {
        const res = await fetch(API_AUTH_URL + '/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          errorEl.textContent = data.error || 'Error al iniciar sesi√≥n';
          return;
        }
        
        localStorage.setItem('token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));
        
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        
        init();
      } catch (err) {
        errorEl.textContent = 'Error de conexi√≥n';
      }
    });
    
    window.logout = function() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      location.reload();
    };

    async function init() {
      // Mostrar nombre del restaurante
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.restaurante) {
        document.getElementById('user-restaurant').textContent = 'üçΩÔ∏è ' + user.restaurante;
      }
      
      await cargarDatos();
        renderizarIngredientes();
        renderizarRecetas();
        renderizarProveedores();
        renderizarPedidos();
        renderizarInventario();
        renderizarVentas();
        renderizarBalance();
        actualizarKPIs();
      window.actualizarDashboardExpandido();
        document.getElementById('form-venta').addEventListener('submit', async (e) => {
      e.preventDefault();
      const recetaId = document.getElementById('venta-receta').value;
      const cantidad = parseInt(document.getElementById('venta-cantidad').value);

      // Validaciones
      if (!recetaId) {
        showToast('Selecciona un plato', 'error');
        return;
      }
      if (!cantidad || cantidad <= 0) {
        showToast('La cantidad debe ser mayor que 0', 'error');
        return;
      }

      try {
        await api.createSale({ recetaId, cantidad });
        await cargarDatos();
        renderizarVentas();
        renderizarInventario();
        renderizarIngredientes();
        window.actualizarKPIs();
        e.target.reset();
        showToast('Venta registrada correctamente', 'success');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

        // Configurar fecha de hoy por defecto
        const hoy = new Date().toISOString().split('T')[0];
        if(document.getElementById('ped-fecha')) {
          document.getElementById('ped-fecha').value = hoy;
        }
      }
     // API helper para balance
    const API_BASE = 'https://lacaleta-api.mindloop.cloud/api';
    
    function getAuthHeaders() {
        const token = localStorage.getItem('token');
        return {
            'Content-Type': 'application/json',
            'Authorization': token ? 'Bearer ' + token : ''
        };
    }
    
    window.api = {
        async getIngredientes() {
            const res = await fetch(API_BASE + '/ingredients', {
                headers: getAuthHeaders()
            });
            return await res.json();
        },
        
        async createIngrediente(ingrediente) {
            const res = await fetch(API_BASE + '/ingredients', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(ingrediente)
            });
            if (!res.ok) throw new Error('Error creando ingrediente');
            return await res.json();
        },
        
       async updateIngrediente(id, ingrediente) {
            const res = await fetch(API_BASE + `/ingredients/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(ingrediente)
            });
            if (!res.ok) throw new Error('Error actualizando ingrediente');
            return await res.json();
        },
        
        async deleteIngrediente(id) {
            const res = await fetch(API_BASE + `/ingredients/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error('Error eliminando ingrediente');
            return await res.json();
        },
      // Inventario completo con precio medio y stock real
    async getInventarioCompleto() {
        const res = await fetch(API_BASE + '/inventory/complete', {
            headers: getAuthHeaders()
        });
        return await res.json();
    },

    // Actualizar stock real de un ingrediente
    async updateStockReal(id, stockReal) {
        const res = await fetch(API_BASE + '/inventory/' + id + '/stock-real', {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify({ stock_real: stockReal })
        });
        if (!res.ok) throw new Error('Error actualizando stock real');
        return await res.json();
    },
        
        async getRecetas() {
            const res = await fetch(API_BASE + '/recipes', {
                headers: getAuthHeaders()
            });
            return await res.json();
        },
        
       async createReceta(receta) {
            const res = await fetch(API_BASE + '/recipes', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(receta)
            });
            if (!res.ok) throw new Error('Error creando receta');
            return await res.json();
        },
        
        async updateReceta(id, receta) {
            const res = await fetch(API_BASE + `/recipes/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(receta)
            });
            if (!res.ok) throw new Error('Error actualizando receta');
            return await res.json();
        },
        
        async deleteReceta(id) {
            const res = await fetch(API_BASE + `/recipes/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error('Error eliminando receta');
            return await res.json();
        },
        
        async getProveedores() {
            const res = await fetch(API_BASE + '/suppliers', {
                headers: getAuthHeaders()
            });
            return await res.json();
        },
        
        async createProveedor(proveedor) {
            const res = await fetch(API_BASE + '/suppliers', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(proveedor)
            });
            if (!res.ok) throw new Error('Error creando proveedor');
            return await res.json();
        },
        
        async updateProveedor(id, proveedor) {
            const res = await fetch(API_BASE + `/suppliers/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(proveedor)
            });
            if (!res.ok) throw new Error('Error actualizando proveedor');
            return await res.json();
        },
        
        async deleteProveedor(id) {
            const res = await fetch(API_BASE + `/suppliers/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error('Error eliminando proveedor');
            return await res.json();
        },
        
       async getPedidos() {
            const res = await fetch(API_BASE + '/orders', {
                headers: getAuthHeaders()
            });
            return await res.json();
        },
        
        async createPedido(pedido) {
            const res = await fetch(API_BASE + '/orders', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(pedido)
            });
            if (!res.ok) throw new Error('Error creando pedido');
            return await res.json();
        },
        
        async updatePedido(id, pedido) {
            const res = await fetch(API_BASE + `/orders/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(pedido)
            });
            if (!res.ok) throw new Error('Error actualizando pedido');
            return await res.json();
        },
        
        async deletePedido(id) {
            const res = await fetch(API_BASE + `/orders/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error('Error eliminando pedido');
            return await res.json();
        },
        
        async getSales(fecha = null) {
            const url = fecha
                ? API_BASE + `/sales?fecha=${fecha}`
                : API_BASE + '/sales';
            const res = await fetch(url, {
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error('Error al cargar ventas');
            return await res.json();
        },
        
        async createSale(saleData) {
            const res = await fetch(API_BASE + '/sales', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(saleData)
            });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.error || 'Error al registrar venta');
            }
            return await res.json();
        },
        
        async deleteSale(id) {
            const res = await fetch(API_BASE + `/sales/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error('Error al eliminar venta');
            return await res.json();
        },
      };

      async function cargarDatos() {
  try {
    window.ingredientes = await api.getInventarioCompleto();
    window.recetas = await api.getRecetas();
    window.proveedores = await api.getProveedores();
    window.pedidos = await api.getPedidos();
  } catch (error) {
    console.error('Error cargando datos:', error);
    showToast('Error conectando con la API', 'error');
  }
}
      window.cambiarTab = function(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        document.getElementById('tab-btn-' + tab).classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');

        if (tab === 'analisis') window.renderizarAnalisis();
        if (tab === 'pedidos') renderizarPedidos();
        if (tab === 'inventario') window.renderizarInventario();
        if (tab === 'ventas') window.renderizarVentas();
        if (tab === 'balance') window.renderizarBalance();
      };

      // ========== INGREDIENTES (c√≥digo completo pero resumido visualmente) ==========
      window.mostrarFormularioIngrediente = function() {
        actualizarSelectProveedores();
        document.getElementById('formulario-ingrediente').style.display = 'block';
        document.getElementById('ing-nombre').focus();
      };

      window.cerrarFormularioIngrediente = function() {
        document.getElementById('formulario-ingrediente').style.display = 'none';
        document.querySelector('#formulario-ingrediente form').reset();
        editandoIngredienteId = null;
        document.getElementById('form-title-ingrediente').textContent = 'Nuevo Ingrediente';
        document.getElementById('btn-text-ingrediente').textContent = 'A√±adir';
      };

      function actualizarSelectProveedores() {
        const select = document.getElementById('ing-proveedor-select');
        select.innerHTML = '<option value="">Sin proveedor</option>';
        proveedores.forEach(prov => {
          select.innerHTML += `<option value="${prov.id}">${prov.nombre}</option>`;
        });
      }

      window.guardarIngrediente = async function(event) {
        event.preventDefault();
        
        const ingrediente = {
          nombre: document.getElementById('ing-nombre').value,
          proveedorId: document.getElementById('ing-proveedor-select').value || null,
          precio: parseFloat(document.getElementById('ing-precio').value) || 0,
          unidad: document.getElementById('ing-unidad').value,
          stockActual: parseFloat(document.getElementById('ing-stockActual').value) || 0,
          stockMinimo: parseFloat(document.getElementById('ing-stockMinimo').value) || 0
        };

    // Validaciones
    if (!ingrediente.nombre || ingrediente.nombre.trim() === '') {
      showToast('El nombre es obligatorio', 'error');
      return;
    }
    if (ingrediente.precio < 0) {
      showToast('El precio no puede ser negativo', 'error');
      return;
    }
    if (ingrediente.stockActual < 0) {
      showToast('El stock no puede ser negativo', 'error');
      return;
    }
    if (ingrediente.stockMinimo < 0) {
      showToast('El stock m√≠nimo no puede ser negativo', 'error');
      return;
    }

  showLoading();

  try {
          if (editandoIngredienteId !== null) {
            await api.updateIngrediente(editandoIngredienteId, ingrediente);
          } else {
            await api.createIngrediente(ingrediente);
          }
          await cargarDatos();
          renderizarIngredientes();
      renderizarInventario();
      window.actualizarKPIs();
      window.actualizarDashboardExpandido();
    hideLoading();
    showToast(editandoIngredienteId ? 'Ingrediente actualizado' : 'Ingrediente creado', 'success');
      window.cerrarFormularioIngrediente();
        } catch (error) {
    hideLoading();
    console.error('Error:', error);
    showToast('Error guardando ingrediente: ' + error.message, 'error');
  }
};
      window.editarIngrediente = function(id) {
        const ing = ingredientes.find(i => i.id === id);
        if (!ing) return;
        
        actualizarSelectProveedores();
        document.getElementById('ing-nombre').value = ing.nombre;
        document.getElementById('ing-proveedor-select').value = ing.proveedorId || '';
        document.getElementById('ing-precio').value = ing.precio || '';
        document.getElementById('ing-unidad').value = ing.unidad;
        document.getElementById('ing-stockActual').value = ing.stockActual || '';
        document.getElementById('ing-stockMinimo').value = ing.stockMinimo || '';
        
        editandoIngredienteId = id;
        document.getElementById('form-title-ingrediente').textContent = 'Editar Ingrediente';
        document.getElementById('btn-text-ingrediente').textContent = 'Guardar';
        window.mostrarFormularioIngrediente();
      };

      window.eliminarIngrediente = async function(id) {
        if (confirm('¬øEliminar?')) {
          showLoading();
          try {
            await api.deleteIngrediente(id);
            await cargarDatos();
          renderizarIngredientes();
          renderizarInventario();
        window.actualizarKPIs();
        window.actualizarDashboardExpandido();
          hideLoading();
          showToast('Ingrediente eliminado', 'success');
          } catch (error) {
            hideLoading();
            console.error('Error:', error);
            showToast('Error eliminando ingrediente: ' + error.message, 'error');
          }
        }
      };

      function getNombreProveedor(proveedorId) {
        if (!proveedorId) return '-';
        const prov = proveedores.find(p => p.id == proveedorId);
        return prov ? prov.nombre : '-';
      }

      window.renderizarIngredientes = function() {
      const busqueda = document.getElementById('busqueda-ingredientes').value.toLowerCase();
      const filtrados = ingredientes.filter(ing => {
        return ing.nombre.toLowerCase().includes(busqueda);
      });

      const container = document.getElementById('tabla-ingredientes');

      if (filtrados.length === 0) {
        container.innerHTML = 
          '<div class="empty-state">' +
            '<div class="icon">üì¶</div>' +
            '<h3>' + (busqueda ? 'No encontrados' : 'A√∫n no hay ingredientes') + '</h3>' +
            '<p>' + (busqueda ? 'Otra b√∫squeda' : 'A√±ade tu primer ingrediente') + '</p>' +
          '</div>';
        document.getElementById('resumen-ingredientes').style.display = 'none';
      } else {
        let html = '<table><thead><tr>';
        html += '<th>Estado</th><th>Ingrediente</th><th>Stock Virtual</th><th>Stock Real</th><th>Diferencia</th><th>Stock M√≠n.</th><th>Precio Medio</th><th>Valor Stock</th><th>Acciones</th>';
        html += '</tr></thead><tbody>';

        filtrados.forEach(ing => {
          const stockVirtual = parseFloat(ing.stock_virtual || ing.stock_actual) || 0;
          const stockReal = ing.stock_real !== null && ing.stock_real !== undefined ? parseFloat(ing.stock_real) : null;
          const stockMinimo = parseFloat(ing.stock_minimo) || 0;
          const diferencia = stockReal !== null ? (stockVirtual - stockReal).toFixed(2) : '-';
          const precioMedio = parseFloat(ing.precio_medio || ing.precio) || 0;
          const valorStock = (stockVirtual * precioMedio).toFixed(2);
          const stockBajo = stockMinimo > 0 && stockVirtual <= stockMinimo;

          html += '<tr>';
          
          if (stockVirtual > 0) {
            html += '<td><span class="stock-badge ' + (stockBajo ? 'stock-low' : 'stock-ok') + '">' + stockVirtual.toFixed(2) + ' ' + ing.unidad + '</span>';
            if (stockBajo && ing.stock_minimo) html += ' ‚ö†Ô∏è';
            html += '</td>';
          } else {
            html += '<td>--</td>';
          }
          
          html += '<td><strong>' + ing.nombre + '</strong></td>';
          html += '<td>' + stockVirtual.toFixed(2) + ' ' + ing.unidad + '</td>';
          
          const stockRealValue = stockReal !== null ? stockReal : '';
          html += '<td><input type="number" step="0.01" value="' + stockRealValue + '" placeholder="--" class="stock-real-input" data-id="' + ing.id + '"></td>';
          
          if (diferencia !== '-') {
            const difNum = parseFloat(diferencia);
            const difClass = Math.abs(difNum) < 0.5 ? 'dif-ok' : (difNum > 0 ? 'dif-positiva' : 'dif-negativa');
            html += '<td class="' + difClass + '">' + (difNum > 0 ? '+' : '') + diferencia + '</td>';
          } else {
            html += '<td>-</td>';
          }
          
          html += '<td>' + stockMinimo.toFixed(2) + ' ' + ing.unidad + '</td>';
          html += '<td>' + precioMedio.toFixed(2) + '‚Ç¨/' + ing.unidad + '</td>';
          html += '<td><strong>' + valorStock + '‚Ç¨</strong></td>';
          
          html += '<td><div class="actions">';
          html += '<button class="icon-btn edit" onclick="window.editarIngrediente(' + ing.id + ')">‚úèÔ∏è</button>';
          html += '<button class="icon-btn delete" onclick="window.eliminarIngrediente(' + ing.id + ')">üóëÔ∏è</button>';
          html += '</div></td>';
          html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
        
        document.querySelectorAll('.stock-real-input').forEach(input => {
          input.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            const stockReal = parseFloat(e.target.value) || null;
            try {
              showLoading();
              await api.updateStockReal(id, stockReal);
              await cargarDatos();
              renderizarIngredientes();
              hideLoading();
              showToast('Stock real actualizado', 'success');
            } catch (error) {
              hideLoading();
              showToast('Error: ' + error.message, 'error');
            }
          });
        });

        document.getElementById('resumen-ingredientes').innerHTML = 
          '<div>Total: <strong>' + ingredientes.length + '</strong></div>' +
          '<div>Mostrando: <strong>' + filtrados.length + '</strong></div>';
        document.getElementById('resumen-ingredientes').style.display = 'flex';
      }
    };

      // ========== RECETAS (resumido) ==========
      window.mostrarFormularioReceta = function() {
        if (ingredientes.length === 0) {
          showToast('Primero a√±ade ingredientes', 'warning');
          window.cambiarTab('ingredientes');
          window.mostrarFormularioIngrediente();
          return;
        }
        document.getElementById('formulario-receta').style.display = 'block';
        window.agregarIngredienteReceta();
        document.getElementById('rec-nombre').focus();
      };

      window.cerrarFormularioReceta = function() {
        document.getElementById('formulario-receta').style.display = 'none';
        document.querySelector('#formulario-receta form').reset();
        document.getElementById('lista-ingredientes-receta').innerHTML = '';
        document.getElementById('coste-calculado-form').style.display = 'none';
        editandoRecetaId = null;
        // Limpiar campos del formulario
        document.getElementById('rec-nombre').value = '';
        document.getElementById('rec-categoria').value = 'entrante';
        document.getElementById('rec-precio_venta').value = '';
        document.getElementById('rec-porciones').value = '1';
        document.getElementById('lista-ingredientes-receta').innerHTML = '';
        document.getElementById('form-title-receta').textContent = 'Nueva Receta';
        document.getElementById('btn-text-receta').textContent = 'Guardar';
      };

      window.agregarIngredienteReceta = function() {
        const container = document.getElementById('lista-ingredientes-receta');
        const div = document.createElement('div');
        div.className = 'ingrediente-item';
        
        let opciones = '<option value="">Seleccionar...</option>';
        ingredientes.forEach(ing => {
          opciones += `<option value="${ing.id}">${ing.nombre} (${ing.unidad})</option>`;
        });
        
        div.innerHTML = `
          <select onchange="window.calcularCosteReceta()">${opciones}</select>
          <input type="number" placeholder="Cantidad" step="0.01" min="0" oninput="window.calcularCosteReceta()">
          <span style="font-size: 12px; color: #666;"></span>
          <button type="button" onclick="this.parentElement.remove(); window.calcularCosteReceta()">√ó</button>
        `;
        
        container.appendChild(div);
      };

      window.calcularCosteReceta = function() {
        const items = document.querySelectorAll('#lista-ingredientes-receta .ingrediente-item');
        let costeTotal = 0;
        let hayDatos = false;

        items.forEach(item => {
          const select = item.querySelector('select');
          const input = item.querySelector('input');
          const span = item.querySelector('span');
          
          if (select.value && input.value) {
            hayDatos = true;
            const ing = ingredientes.find(i => i.id == select.value);
            const cantidad = parseFloat(input.value);
            const coste = (ing.precio * cantidad).toFixed(2);
            costeTotal += parseFloat(coste);
            span.textContent = `${coste} ‚Ç¨`;
          } else {
            span.textContent = '';
          }
        });

        const precio_venta = parseFloat(document.getElementById('rec-precio_venta').value) || 0;
        const margen = precio_venta - costeTotal;
        const margenPct = precio_venta > 0 ? ((margen / precio_venta) * 100).toFixed(1) : 0;

        if (hayDatos) {
          document.getElementById('coste-calculado-form').style.display = 'block';
          document.getElementById('coste-calculado-form').innerHTML = `
            <h4>üí∞ C√°lculo</h4>
            <div class="coste-row"><span>Coste:</span><strong>${costeTotal.toFixed(2)} ‚Ç¨</strong></div>
            <div class="coste-row"><span>Precio:</span><strong>${precio_venta.toFixed(2)} ‚Ç¨</strong></div>
            <div class="coste-row"><span>Margen:</span><strong>${margen.toFixed(2)} ‚Ç¨ (${margenPct}%)</strong></div>
          `;
        } else {
          document.getElementById('coste-calculado-form').style.display = 'none';
        }
      };

      window.guardarReceta = async function(event) {
        event.preventDefault();
        
        const items = document.querySelectorAll('#lista-ingredientes-receta .ingrediente-item');
        const ingredientesReceta = [];
        
        items.forEach(item => {
          const select = item.querySelector('select');
          const input = item.querySelector('input');
          if (select.value && input.value) {
            ingredientesReceta.push({
              ingredienteId: parseInt(select.value),
              cantidad: parseFloat(input.value)
            });
          }
        });

        if (ingredientesReceta.length === 0) {
          showToast('A√±ade ingredientes a la receta', 'warning');
          return;
        }

        const receta = {
          nombre: document.getElementById('rec-nombre').value,
          categoria: document.getElementById('rec-categoria').value,
          precio_venta: parseFloat(document.getElementById('rec-precio_venta').value) || 0,
          porciones: parseInt(document.getElementById('rec-porciones').value) || 1,
          ingredientes: ingredientesReceta
        };
        
        showLoading();

        try {
          if (editandoRecetaId !== null) {
            await api.updateReceta(editandoRecetaId, receta);
          } else {
            await api.createReceta(receta);
          }
          await cargarDatos();
          renderizarRecetas();
          hideLoading();
          showToast(editandoRecetaId ? 'Receta actualizada' : 'Receta creada', 'success');
          window.cerrarFormularioReceta();
        } catch (error) {
          hideLoading();
          console.error('Error:', error);
          showToast('Error guardando receta: ' + error.message, 'error');
        }
      };

      window.editarReceta = function(id) {
        const rec = recetas.find(r => r.id === id);
        if (!rec) return;
        
        document.getElementById('rec-nombre').value = rec.nombre;
        document.getElementById('rec-categoria').value = rec.categoria;
        document.getElementById('rec-precio_venta').value = rec.precio_venta;
        document.getElementById('rec-porciones').value = rec.porciones;
        
        document.getElementById('lista-ingredientes-receta').innerHTML = '';
        rec.ingredientes.forEach(item => {
          window.agregarIngredienteReceta();
          const lastItem = document.querySelector('#lista-ingredientes-receta .ingrediente-item:last-child');
          lastItem.querySelector('select').value = item.ingredienteId;
          lastItem.querySelector('input').value = item.cantidad;
        });
        
        window.calcularCosteReceta();
        editandoRecetaId = id;
        document.getElementById('form-title-receta').textContent = 'Editar';
        document.getElementById('btn-text-receta').textContent = 'Guardar';
        window.mostrarFormularioReceta();
      };

      window.eliminarReceta = async function(id) {
        if (confirm('¬øEliminar?')) {
          showLoading();
          try {
            await api.deleteReceta(id);
            await cargarDatos();
            renderizarRecetas();
            hideLoading();
            showToast('Receta eliminada', 'success');
          } catch (error) {
            hideLoading();
            console.error('Error:', error);
            showToast('Error eliminando receta: ' + error.message, 'error');

          }
        }
      };

      function calcularCosteRecetaCompleto(receta) {
        let total = 0;
        receta.ingredientes.forEach(item => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (ing) total += ing.precio * item.cantidad;
        });
        return total;
      }

      window.renderizarRecetas = function() {
        const busqueda = document.getElementById('busqueda-recetas').value.toLowerCase();
        const filtradas = recetas.filter(r => r.nombre.toLowerCase().includes(busqueda));

        const container = document.getElementById('tabla-recetas');
        
        if (filtradas.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üë®‚Äçüç≥</div>
              <h3>${busqueda ? 'No encontradas' : 'A√∫n no hay recetas'}</h3>
            </div>
          `;
          document.getElementById('resumen-recetas').style.display = 'none';
        } else {
          let html = '<table><thead><tr>';
          html += '<th>Plato</th><th>Categor√≠a</th><th>Coste</th><th>Precio</th><th>Margen</th><th>Acciones</th>';
          html += '</tr></thead><tbody>';

          filtradas.forEach(rec => {
            const coste = calcularCosteRecetaCompleto(rec);
            const margen = rec.precio_venta - coste;
            const pct = rec.precio_venta > 0 ? ((margen/rec.precio_venta)*100).toFixed(0) : 0;
            
            html += '<tr>';
            html += `<td><strong>${rec.nombre}</strong></td>`;
            html += `<td><span class="badge badge-success">${rec.categoria}</span></td>`;
            html += `<td>${coste.toFixed(2)} ‚Ç¨</td>`;
            html += `<td>${rec.precio_venta ? parseFloat(rec.precio_venta).toFixed(2) : '0.00'} ‚Ç¨</td>`;
            html += `<td><span class="badge ${margen>0?'badge-success':'badge-warning'}">${margen.toFixed(2)} ‚Ç¨ (${pct}%)</span></td>`;
            html += `<td><div class="actions">`;
            html += `<button class="icon-btn produce" onclick="window.abrirModalProducir(${rec.id})">‚¨áÔ∏è</button>`;
            html += `<button class="icon-btn edit" onclick="window.editarReceta(${rec.id})">‚úèÔ∏è</button>`;
            html += `<button class="icon-btn delete" onclick="window.eliminarReceta(${rec.id})">üóëÔ∏è</button>`;
            html += '</div></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          container.innerHTML = html;

          document.getElementById('resumen-recetas').innerHTML = `
            <div>Total: <strong>${recetas.length}</strong></div>
            <div>Mostrando: <strong>${filtradas.length}</strong></div>
          `;
          document.getElementById('resumen-recetas').style.display = 'flex';
        }
      };

      // ========== PRODUCCI√ìN ==========
      window.abrirModalProducir = function(id) {
        recetaProduciendo = id;
        const rec = recetas.find(r => r.id === id);
        document.getElementById('modal-plato-nombre').textContent = rec.nombre;
        document.getElementById('modal-cantidad').value = 1;
        window.actualizarDetalleDescuento();
        document.getElementById('modal-producir').classList.add('active');
      };

      window.cerrarModalProducir = function() {
        document.getElementById('modal-producir').classList.remove('active');
        recetaProduciendo = null;
      };

      window.actualizarDetalleDescuento = function() {
        if (recetaProduciendo === null) return;
        const cant = parseInt(document.getElementById('modal-cantidad').value) || 1;
        const rec = recetas.find(r => r.id === recetaProduciendo);
        let html = '<ul style="margin:0;padding-left:20px;">';
        rec.ingredientes.forEach(item => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (ing) html += `<li>${ing.nombre}: -${item.cantidad*cant} ${ing.unidad}</li>`;
        });
        html += '</ul>';
        document.getElementById('modal-descuento-detalle').innerHTML = html;
      };

      window.confirmarProduccion = async function() {
        if (recetaProduciendo === null) return;
        const cant = parseInt(document.getElementById('modal-cantidad').value) || 1;
        const rec = recetas.find(r => r.id === recetaProduciendo);
        
        let falta = false;
        let msg = 'Stock insuficiente:\n';
        rec.ingredientes.forEach(item => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (ing) {
            const necesario = item.cantidad * cant;
            if (ing.stockActual < necesario) {
              falta = true;
              msg += `- ${ing.nombre}: necesitas ${necesario}, tienes ${ing.stockActual}\n`;
            }
          }
        });
        
        if (falta) {
          alert(msg);
          return;
        }

        showLoading();
        
        try {
          for (const item of rec.ingredientes) {
            const ing = ingredientes.find(i => i.id === item.ingredienteId);
            if (ing) {
              const nuevoStock = Math.max(0, ing.stockActual - (item.cantidad * cant));
              await api.updateIngrediente(ing.id, {
                ...ing,
                stockActual: nuevoStock
              });
            }
          }
          
          await cargarDatos();
          renderizarIngredientes();
          hideLoading();
          window.cerrarModalProducir();
          showToast(`Producidas ${cant} unidades de ${rec.nombre}`, 'success');
        } catch (error) {
          hideLoading();
          console.error('Error:', error);
         showToast('Error actualizando stock: ' + error.message, 'error');
        }
      };

      // ========== PROVEEDORES (resumido) ==========
      window.mostrarFormularioProveedor = function() {
        document.getElementById('formulario-proveedor').style.display = 'block';
        cargarIngredientesProveedor();
        document.getElementById('prov-nombre').focus();
      };

      window.cerrarFormularioProveedor = function() {
        document.getElementById('formulario-proveedor').style.display = 'none';
        document.querySelector('#formulario-proveedor form').reset();
        editandoProveedorId = null;
        document.getElementById('form-title-proveedor').textContent = 'Nuevo Proveedor';
        document.getElementById('btn-text-proveedor').textContent = 'A√±adir';
      };

      function cargarIngredientesProveedor(seleccionados = []) {
        const container = document.getElementById('lista-ingredientes-proveedor');
        if (ingredientes.length === 0) {
          container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">Primero a√±ade ingredientes</p>';
          return;
        }

        const busqueda = document.getElementById('buscar-ingredientes-proveedor').value.toLowerCase();
        const filtrados = ingredientes.filter(ing => ing.nombre.toLowerCase().includes(busqueda));

        let html = '';
        filtrados.forEach(ing => {
          const checked = seleccionados.includes(ing.id) ? 'checked' : '';
          html += `
            <div class="ingrediente-checkbox">
              <input type="checkbox" id="check-ing-${ing.id}" value="${ing.id}" ${checked}>
              <label for="check-ing-${ing.id}">${ing.nombre}</label>
            </div>
          `;
        });

        container.innerHTML = html || '<p style="color:#999;padding:10px;">Sin resultados</p>';
      }

      window.filtrarIngredientesProveedor = function() {
        const checks = document.querySelectorAll('#lista-ingredientes-proveedor input[type="checkbox"]:checked');
        const seleccionados = Array.from(checks).map(c => parseInt(c.value));
        cargarIngredientesProveedor(seleccionados);
      };

      window.guardarProveedor = async function(event) {
        event.preventDefault();

        const checks = document.querySelectorAll('#lista-ingredientes-proveedor input[type="checkbox"]:checked');
        const ingredientesIds = Array.from(checks).map(c => parseInt(c.value));

        const proveedor = {
          nombre: document.getElementById('prov-nombre').value,
          contacto: document.getElementById('prov-contacto').value,
          telefono: document.getElementById('prov-telefono').value,
          email: document.getElementById('prov-email').value,
          direccion: document.getElementById('prov-direccion').value,
          notas: document.getElementById('prov-notas').value,
          ingredientes: ingredientesIds
        };

        showLoading();

        try {
          if (editandoProveedorId !== null) {
            await api.updateProveedor(editandoProveedorId, proveedor);
          } else {
            await api.createProveedor(proveedor);
          }
          await cargarDatos();
          renderizarProveedores();
          hideLoading();
          showToast(editandoProveedorId ? 'Proveedor actualizado' : 'Proveedor creado', 'success');
          window.cerrarFormularioProveedor();
        } catch (error) {
          hideLoading();
          console.error('Error:', error);
         showToast('Error guardando proveedor: ' + error.message, 'error');
        }
      };

      window.editarProveedor = function(id) {
        const prov = proveedores.find(p => p.id === id);
        if (!prov) return;
        
        document.getElementById('prov-nombre').value = prov.nombre;
        document.getElementById('prov-contacto').value = prov.contacto || '';
        document.getElementById('prov-telefono').value = prov.telefono || '';
        document.getElementById('prov-email').value = prov.email || '';
        document.getElementById('prov-direccion').value = prov.direccion || '';
        document.getElementById('prov-notas').value = prov.notas || '';
        
        cargarIngredientesProveedor(prov.ingredientes || []);
        
        editandoProveedorId = id;
        document.getElementById('form-title-proveedor').textContent = 'Editar';
        document.getElementById('btn-text-proveedor').textContent = 'Guardar';
        window.mostrarFormularioProveedor();
      };

      window.eliminarProveedor = async function(id) {
        if (confirm('¬øEliminar?')) {
          showLoading();
          try {
            await api.deleteProveedor(id);
            await cargarDatos();
            renderizarProveedores();
            renderizarIngredientes();
            hideLoading();
            showToast('Proveedor eliminado', 'success');
         } catch (error) {
      hideLoading();
      console.error('Error:', error);
      showToast('Error eliminando proveedor: ' + error.message, 'error');
          }
        }
      };

      window.verProveedorDetalles = function(id) {
        const prov = proveedores.find(p => p.id === id);
        if (!prov) return;
        
        document.getElementById('modal-proveedor-titulo').textContent = prov.nombre;
        
        let html = '<div style="margin-bottom:20px;">';
        if (prov.contacto) html += `<p><strong>Contacto:</strong> ${prov.contacto}</p>`;
        if (prov.telefono) html += `<p><strong>Tel√©fono:</strong> ${prov.telefono}</p>`;
        if (prov.email) html += `<p><strong>Email:</strong> ${prov.email}</p>`;
        if (prov.direccion) html += `<p><strong>Direcci√≥n:</strong> ${prov.direccion}</p>`;
        if (prov.notas) html += `<p><strong>Notas:</strong> ${prov.notas}</p>`;
        html += '</div>';

        html += '<h4 style="margin-top:20px;margin-bottom:10px;">Ingredientes:</h4>';
        if (prov.ingredientes && prov.ingredientes.length > 0) {
          html += '<div class="ingredientes-list">';
          prov.ingredientes.forEach(ingId => {
            const ing = ingredientes.find(i => i.id === ingId);
            if (ing) html += `<span class="badge">${ing.nombre}</span>`;
          });
          html += '</div>';
        } else {
          html += '<p style="color:#999;">Sin ingredientes</p>';
        }

        document.getElementById('modal-proveedor-contenido').innerHTML = html;
        document.getElementById('modal-ver-proveedor').classList.add('active');
      };

      window.cerrarModalVerProveedor = function() {
        document.getElementById('modal-ver-proveedor').classList.remove('active');
      };

      window.renderizarProveedores = function() {
        const busqueda = document.getElementById('busqueda-proveedores').value.toLowerCase();
        const filtrados = proveedores.filter(p => p.nombre.toLowerCase().includes(busqueda));

        const container = document.getElementById('tabla-proveedores');
        
        if (filtrados.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üöö</div>
              <h3>${busqueda ? 'No encontrados' : 'A√∫n no hay proveedores'}</h3>
            </div>
          `;
          document.getElementById('resumen-proveedores').style.display = 'none';
        } else {
          let html = '<table><thead><tr>';
          html += '<th>Proveedor</th><th>Contacto</th><th>Tel√©fono</th><th>Ingredientes</th><th>Acciones</th>';
          html += '</tr></thead><tbody>';

          filtrados.forEach(prov => {
            const numIng = prov.ingredientes ? prov.ingredientes.length : 0;
            
            html += '<tr>';
            html += `<td><strong>${prov.nombre}</strong></td>`;
            html += `<td>${prov.contacto || '-'}</td>`;
            html += `<td>${prov.telefono || '-'}</td>`;
            html += `<td><span class="badge badge-info">${numIng}</span></td>`;
            html += `<td><div class="actions">`;
            html += `<button class="icon-btn view" onclick="window.verProveedorDetalles(${prov.id})">üëÅÔ∏è</button>`;
            html += `<button class="icon-btn edit" onclick="window.editarProveedor(${prov.id})">‚úèÔ∏è</button>`;
            html += `<button class="icon-btn delete" onclick="window.eliminarProveedor(${prov.id})">üóëÔ∏è</button>`;
            html += '</div></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          container.innerHTML = html;

          document.getElementById('resumen-proveedores').innerHTML = `
            <div>Total: <strong>${proveedores.length}</strong></div>
            <div>Mostrando: <strong>${filtrados.length}</strong></div>
          `;
          document.getElementById('resumen-proveedores').style.display = 'flex';
        }
      };

      // ========== PEDIDOS ==========
      window.mostrarFormularioPedido = function() {
        if (proveedores.length === 0) {
         showToast('Primero a√±ade proveedores', 'warning');
          window.cambiarTab('proveedores');
          return;
        }
        
        // Cargar select de proveedores
        const select = document.getElementById('ped-proveedor');
        select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
        proveedores.forEach(prov => {
          select.innerHTML += `<option value="${prov.id}">${prov.nombre}</option>`;
        });
        
        document.getElementById('formulario-pedido').style.display = 'block';
        document.getElementById('ped-proveedor').focus();
      };

      window.cerrarFormularioPedido = function() {
        document.getElementById('formulario-pedido').style.display = 'none';
        document.querySelector('#formulario-pedido form').reset();
        document.getElementById('container-ingredientes-pedido').style.display = 'none';
        document.getElementById('lista-ingredientes-pedido').innerHTML = '';
        document.getElementById('total-pedido-form').style.display = 'none';
      };

      window.cargarIngredientesPedido = function() {
        const proveedorId = parseInt(document.getElementById('ped-proveedor').value);
        if (!proveedorId) {
          document.getElementById('container-ingredientes-pedido').style.display = 'none';
          return;
        }

        const proveedor = proveedores.find(p => p.id === proveedorId);
        if (!proveedor || !proveedor.ingredientes || proveedor.ingredientes.length === 0) {
          document.getElementById('container-ingredientes-pedido').style.display = 'none';
          showToast('Este proveedor no tiene ingredientes asignados', 'warning');
          return;
        }

        document.getElementById('container-ingredientes-pedido').style.display = 'block';
        document.getElementById('lista-ingredientes-pedido').innerHTML = '';
        window.agregarIngredientePedido();
      };

      window.agregarIngredientePedido = function() {
        const proveedorId = parseInt(document.getElementById('ped-proveedor').value);
        if (!proveedorId) return;

        const proveedor = proveedores.find(p => p.id === proveedorId);
        const ingredientesProveedor = ingredientes.filter(ing => 
          proveedor.ingredientes.includes(ing.id)
        );

        const container = document.getElementById('lista-ingredientes-pedido');
        const div = document.createElement('div');
        div.className = 'ingrediente-item';
        
        let opciones = '<option value="">Seleccionar...</option>';
        ingredientesProveedor.forEach(ing => {
          opciones += `<option value="${ing.id}">${ing.nombre} (${parseFloat(ing.precio || 0).toFixed(2)}‚Ç¨/${ing.unidad})</option>`;
        });
        
        div.innerHTML = `
          <select onchange="window.calcularTotalPedido()">${opciones}</select>
          <input type="number" placeholder="Cantidad" step="0.01" min="0" oninput="window.calcularTotalPedido()">
          <span style="font-size: 12px; color: #666;"></span>
          <button type="button" onclick="this.parentElement.remove(); window.calcularTotalPedido()">√ó</button>
        `;
        
        container.appendChild(div);
      };

      window.calcularTotalPedido = function() {
        const items = document.querySelectorAll('#lista-ingredientes-pedido .ingrediente-item');
        let total = 0;
        let hayDatos = false;

        items.forEach(item => {
          const select = item.querySelector('select');
          const input = item.querySelector('input');
          const span = item.querySelector('span');
          
          if (select.value && input.value) {
            hayDatos = true;
            const ing = ingredientes.find(i => i.id == select.value);
            const cantidad = parseFloat(input.value);
            const subtotal = ing.precio * cantidad;
            total += subtotal;
            span.textContent = `${subtotal.toFixed(2)} ‚Ç¨`;
          } else {
            span.textContent = '';
          }
        });

        if (hayDatos) {
          document.getElementById('total-pedido-form').style.display = 'block';
          document.getElementById('total-pedido-value').textContent = total.toFixed(2) + ' ‚Ç¨';
        } else {
          document.getElementById('total-pedido-form').style.display = 'none';
        }
      };

      window.guardarPedido = async function(event) {
        event.preventDefault();

        const proveedorId = parseInt(document.getElementById('ped-proveedor').value);
        const fecha = document.getElementById('ped-fecha').value;

        const items = document.querySelectorAll('#lista-ingredientes-pedido .ingrediente-item');
        const ingredientesPedido = [];
        let total = 0;

        items.forEach(item => {
          const select = item.querySelector('select');
          const input = item.querySelector('input');
          if (select.value && input.value) {
            const ing = ingredientes.find(i => i.id == select.value);
            const cantidad = parseFloat(input.value);
            const subtotal = ing.precio * cantidad;
            total += subtotal;
            
            ingredientesPedido.push({
              ingredienteId: ing.id,
              cantidad: cantidad,
              precioUnitario: ing.precio,
              subtotal: subtotal
            });
          }
        });

        if (ingredientesPedido.length === 0) {
          showToast('A√±ade ingredientes al pedido', 'warning');
          return;
        }

    // Validaciones adicionales
    if (!proveedorId) {
      showToast('Selecciona un proveedor', 'error');
      return;
    }
    if (!fecha) {
      showToast('Selecciona una fecha', 'error');
      return;
    }
    
    // Validar cantidades positivas
    const cantidadInvalida = ingredientesPedido.find(i => i.cantidad <= 0);
    if (cantidadInvalida) {
      showToast('Las cantidades deben ser mayores que 0', 'error');
      return;
    }

    const pedido = {
          proveedorId: proveedorId,
          fecha: fecha,
          ingredientes: ingredientesPedido,
          total: total,
          estado: 'pendiente'
        };
        
        showLoading();

        try {
          await api.createPedido(pedido);
          renderizarPedidos();
          window.cerrarFormularioPedido();
          hideLoading();
          showToast('Pedido creado correctamente', 'success');
        } catch (error) {
          hideLoading();
          console.error('Error:', error);
          showToast('Error creando pedido: ' + error.message, 'error');
        }
      };

      let pedidoRecibiendoId = null;

      window.marcarPedidoRecibido = function(id) {
        pedidoRecibiendoId = id;
        const pedido = pedidos.find(p => p.id === id);
        const prov = proveedores.find(p => p.id === pedido.proveedorId);

        // Llenar informaci√≥n del pedido
        document.getElementById('modal-rec-proveedor').textContent = prov ? prov.nombre : 'Desconocido';
        document.getElementById('modal-rec-fecha').textContent = new Date(pedido.fecha).toLocaleDateString('es-ES');
        document.getElementById('modal-rec-total-original').textContent = parseFloat(pedido.total || 0).toFixed(2) + ' ‚Ç¨';

        // Crear copia de items para edici√≥n
        if (!pedido.itemsRecepcion) {
          pedido.itemsRecepcion = pedido.ingredientes.map(item => ({
            ...item,
            cantidadRecibida: item.cantidad,
            precioReal: item.precioUnitario,
            estado: 'consolidado'
          }));
        }

        renderItemsRecepcion();
        document.getElementById('modal-recibir-pedido').classList.add('active');
      };

      function renderItemsRecepcion() {
        const pedido = pedidos.find(p => p.id === pedidoRecibiendoId);
        const tbody = document.getElementById('modal-rec-items');
        
        let html = '';
        let totalOriginal = 0;
        let totalRecibido = 0;

        pedido.itemsRecepcion.forEach((item, idx) => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (!ing) return;

          const subtotalOriginal = item.cantidad * item.precioUnitario;
          const subtotalRecibido = item.cantidadRecibida * item.precioReal;
          totalOriginal += subtotalOriginal;
          
          if (item.estado !== 'no-entregado') {
            totalRecibido += subtotalRecibido;
          }

          const varianzaCant = item.cantidadRecibida - item.cantidad;
          const varianzaPrecio = item.precioReal - item.precioUnitario;

          html += '<tr>';
          html += `<td><strong>${ing.nombre}</strong></td>`;
          html += `<td>${item.cantidad} ${ing.unidad}</td>`;
          html += `<td>`;
          if (item.estado === 'no-entregado') {
            html += '<span style="color:#999;">No entregado</span>';
          } else {
            html += `<input type="number" value="${item.cantidadRecibida}" step="0.01" min="0" 
              style="width:80px;padding:5px;border:1px solid #ddd;border-radius:4px;"
              onchange="window.actualizarItemRecepcion(${idx}, 'cantidad', this.value)"> ${ing.unidad}`;
            if (Math.abs(varianzaCant) > 0.01) {
              html += `<br><small style="color:${varianzaCant > 0 ? '#10b981' : '#ef4444'};">${varianzaCant > 0 ? '+' : ''}${varianzaCant.toFixed(2)}</small>`;
            }
          }
          html += `</td>`;
          html += `<td>${parseFloat(item.precioUnitario || 0).toFixed(2)} ‚Ç¨</td>`;
          html += `<td>`;
          if (item.estado === 'no-entregado') {
            html += '<span style="color:#999;">-</span>';
          } else {
            html += `<input type="number" value="${item.precioReal}" step="0.01" min="0" 
              style="width:80px;padding:5px;border:1px solid #ddd;border-radius:4px;"
              onchange="window.actualizarItemRecepcion(${idx}, 'precio', this.value)"> ‚Ç¨`;
            if (Math.abs(varianzaPrecio) > 0.01) {
              html += `<br><small style="color:${varianzaPrecio > 0 ? '#ef4444' : '#10b981'};">${varianzaPrecio > 0 ? '+' : ''}${varianzaPrecio.toFixed(2)} ‚Ç¨</small>`;
            }
          }
          html += `</td>`;
          html += `<td><strong>${item.estado === 'no-entregado' ? '0.00' : subtotalRecibido.toFixed(2)} ‚Ç¨</strong></td>`;
          html += `<td>`;
          html += `<select onchange="window.cambiarEstadoItem(${idx}, this.value)" style="padding:5px;border:1px solid #ddd;border-radius:4px;">`;
          html += `<option value="consolidado" ${item.estado === 'consolidado' ? 'selected' : ''}>‚úÖ OK</option>`;
          html += `<option value="varianza" ${item.estado === 'varianza' ? 'selected' : ''}>‚ö†Ô∏è Varianza</option>`;
          html += `<option value="no-entregado" ${item.estado === 'no-entregado' ? 'selected' : ''}>‚ùå No entregado</option>`;
          html += `</select>`;
          html += `</td>`;
          html += '</tr>';
        });

        tbody.innerHTML = html;

        // Actualizar resumen
        const varianza = totalRecibido - totalOriginal;
        document.getElementById('modal-rec-resumen-original').textContent = totalOriginal.toFixed(2) + ' ‚Ç¨';
        document.getElementById('modal-rec-resumen-recibido').textContent = totalRecibido.toFixed(2) + ' ‚Ç¨';
        
        const varianzaEl = document.getElementById('modal-rec-resumen-varianza');
        varianzaEl.textContent = (varianza >= 0 ? '+' : '') + varianza.toFixed(2) + ' ‚Ç¨';
        varianzaEl.style.color = varianza > 0 ? '#ef4444' : varianza < 0 ? '#10b981' : '#666';
      }

      window.actualizarItemRecepcion = function(idx, tipo, valor) {
        const pedido = pedidos.find(p => p.id === pedidoRecibiendoId);
        const item = pedido.itemsRecepcion[idx];
        
        if (tipo === 'cantidad') {
          item.cantidadRecibida = parseFloat(valor) || 0;
          if (Math.abs(item.cantidadRecibida - item.cantidad) > 0.01) {
            item.estado = 'varianza';
          } else if (item.estado === 'varianza') {
            item.estado = 'consolidado';
          }
        } else if (tipo === 'precio') {
          item.precioReal = parseFloat(valor) || 0;
          if (Math.abs(item.precioReal - item.precioUnitario) > 0.01) {
            item.estado = 'varianza';
          } else if (item.estado === 'varianza') {
            item.estado = 'consolidado';
          }
        }
        
        renderItemsRecepcion();
      };

      window.cambiarEstadoItem = function(idx, estado) {
        const pedido = pedidos.find(p => p.id === pedidoRecibiendoId);
        pedido.itemsRecepcion[idx].estado = estado;
        renderItemsRecepcion();
      };

      window.cerrarModalRecibirPedido = function() {
        document.getElementById('modal-recibir-pedido').classList.remove('active');
        pedidoRecibiendoId = null;
      };

      window.confirmarRecepcionPedido = async function() {
        if (!confirm('¬øConfirmar recepci√≥n del pedido? Esto actualizar√° el stock con las cantidades recibidas.')) return;

        const pedido = pedidos.find(p => p.id === pedidoRecibiendoId);
        
        // Actualizar stock con cantidades reales recibidas
        let totalRecibido = 0;

        showLoading();
        
        try {
          const items = pedido.itemsRecepcion || pedido.ingredientes;
        for (const item of items) {
            if (item.estado !== 'no-entregado') {
              const ing = ingredientes.find(i => i.id === item.ingredienteId);
              if (ing) {
                await api.updateIngrediente(ing.id, {
                  ...ing,
                  stock_actual: parseFloat(ing.stock_actual || 0) + parseFloat(item.cantidadRecibida || item.cantidad || 0)
                });
              }
              totalRecibido += item.cantidadRecibida * item.precioReal;
            }
          }

          // Actualizar pedido
          await api.updatePedido(pedidoRecibiendoId, {
            ...pedido,
            estado: 'recibido',
            totalRecibido: totalRecibido,
            ingredientes: pedido.itemsRecepcion
          });

          await cargarDatos();
          renderizarPedidos();
          renderizarIngredientes();
          renderizarInventario();
      window.actualizarKPIs();
      window.actualizarDashboardExpandido();
      window.cerrarModalRecibirPedido();
          hideLoading();
          showToast('Pedido recibido y stock actualizado correctamente', 'success');
        } catch (error) {
          hideLoading();
          console.error('Error:', error);
         showToast('Error confirmando recepci√≥n: ' + error.message, 'error');
        }
      };

      window.eliminarPedido = async function(id) {
        if (confirm('¬øEliminar este pedido?')) {
           showLoading();
          
          try {
            await api.deletePedido(id);
            await cargarDatos();
            renderizarPedidos();
            hideLoading();
            showToast('Pedido eliminado', 'success');
          } catch (error) {
            hideLoading();
            console.error('Error:', error);
           showToast('Error eliminando pedido: ' + error.message, 'error');
          }
        }
      };

      let pedidoViendoId = null;

     window.verDetallesPedido = function(pedidoId) {
        const pedido = pedidos.find(p => p.id === pedidoId);
        if (!pedido) {
          showToast('Pedido no encontrado', 'error');
          return;
        }

        const prov = proveedores.find(p => p.id === pedido.proveedor_id);
        
        let html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div>
              <strong style="color:#666;">Proveedor:</strong><br>
              ${prov ? prov.nombre : 'Desconocido'}
            </div>
            <div>
              <strong style="color:#666;">Fecha:</strong><br>
              ${new Date(pedido.fecha).toLocaleDateString('es-ES')}
            </div>
          </div>
          
          <div style="margin-bottom: 30px;">
            <strong style="color:#666;">Estado:</strong><br>
            <span class="badge ${pedido.estado === 'recibido' ? 'badge-received' : 'badge-pending'}">
              ${pedido.estado === 'recibido' ? 'Recibido' : 'Pendiente'}
            </span>
          </div>
          
          <h4 style="margin: 30px 0 15px 0; color: #1E293B;">Ingredientes del pedido:</h4>
          
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="background: #F8FAFC; border-bottom: 2px solid #E2E8F0;">
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #64748B;">Ingrediente</th>
                <th style="padding: 12px; text-align: center; font-weight: 600; color: #64748B;">Cantidad</th>
                <th style="padding: 12px; text-align: right; font-weight: 600; color: #64748B;">Precio Unit.</th>
                <th style="padding: 12px; text-align: right; font-weight: 600; color: #64748B;">Subtotal</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        let total = 0;
        
        if (pedido.ingredientes && pedido.ingredientes.length > 0) {
          pedido.ingredientes.forEach(item => {
            const ing = ingredientes.find(i => i.id === item.ingredienteId);
            const nombreIng = ing ? ing.nombre : 'Ingrediente eliminado (ID: ' + item.ingredienteId + ')';
            const unidadIng = ing ? ing.unidad : 'ud';
            
            const cantidad = item.cantidad || 0;
            const precio = item.precioReal || item.precioUnitario || ing.precio || 0;
            const subtotal = cantidad * precio;
            total += subtotal;
            
            html += `
              <tr style="border-bottom: 1px solid #F1F5F9;">
                <td style="padding: 12px;">
                 <strong style="color: ${ing ? '#1E293B' : '#EF4444'}">${nombreIng}</strong>
                </td>
                <td style="padding: 12px; text-align: center; color: #64748B;">
                  ${cantidad.toFixed(2)} ${unidadIng}
                </td>
                <td style="padding: 12px; text-align: right; color: #64748B;">
                 ${parseFloat(precio || 0).toFixed(2)} ‚Ç¨
                </td>
                <td style="padding: 12px; text-align: right;">
                  <strong style="color: #1E293B;">${subtotal.toFixed(2)} ‚Ç¨</strong>
                </td>
              </tr>
            `;
          });
        } else {
          html += `
            <tr>
              <td colspan="4" style="padding: 40px; text-align: center; color: #94A3B8;">
                No hay ingredientes en este pedido
              </td>
            </tr>
          `;
        }
        
        html += `
            </tbody>
          </table>
          
          <div style="margin-top: 30px; padding: 20px; background: #F0FDF4; border: 2px solid #10B981; border-radius: 12px; text-align: right;">
            <strong style="color: #666; font-size: 16px;">Total del Pedido:</strong><br>
            <span style="font-size: 32px; font-weight: bold; color: #059669;">${total.toFixed(2)} ‚Ç¨</span>
          </div>
        `;
        
        document.getElementById('modal-ver-pedido-contenido').innerHTML = html;
        document.getElementById('modal-ver-pedido').classList.add('active');
        pedidoViendoId = pedidoId;
      };

      window.cerrarModalVerPedido = function() {
        document.getElementById('modal-ver-pedido').classList.remove('active');
        pedidoViendoId = null;
      };

      window.descargarPedidoPDF = function() {
        if (pedidoViendoId === null) return;
        
        const pedido = pedidos.find(p => p.id === pedidoViendoId);
        const prov = proveedores.find(p => p.id === pedido.proveedorId);

        // Crear HTML para imprimir
        let htmlPrint = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pedido - La Caleta 102</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #c35a3f; padding-bottom: 20px; }
    .header h1 { color: #c35a3f; margin: 0; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; background: #f8f8f8; padding: 20px; border-radius: 5px; }
    .info-item { margin-bottom: 10px; }
    .info-item strong { display: block; color: #666; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th { background: #f8f8f8; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-size: 12px; color: #666; }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    .total-box { background: #f0fdf4; border: 2px solid #10b981; padding: 20px; border-radius: 5px; text-align: right; }
    .total-box strong { font-size: 24px; color: #059669; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .badge-received { background: #d1fae5; color: #059669; }
    .badge-pending { background: #fef3c7; color: #d97706; }
    .varianza { font-size: 11px; }
    .varianza.pos { color: #10b981; }
    .varianza.neg { color: #ef4444; }
    @media print {
      body { padding: 20px; }
      button { display: none; }
    }
    /* === RESPONSIVE MOBILE === */
@media (max-width: 768px) {
  /* Container */
  .container { padding: 12px; }
  
  /* Header */
  .header {
    padding: 8px 32px;
    flex-direction: column;
    text-align: center;
    gap: 12px;
  }
  
  .header h1 { font-size: 32px; }
  .header p { font-size: 14px; }
  
  /* KPI Dashboard */
  .kpi-dashboard {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    padding: 0 12px;
    margin: 16px 0;
  }
  
  .kpi-card {
    padding: 16px;
  }
  
  .kpi-icon { font-size: 24px; margin-bottom: 8px; }
  .kpi-label { font-size: 11px; }
  .kpi-value { font-size: 28px; }
  .kpi-trend { font-size: 12px; }
  
  /* Tabs */
  .tabs {
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    padding: 12px 12px 0;
    gap: 8px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  
  .tabs::-webkit-scrollbar { display: none; }
  
  .tab {
    padding: 10px 16px;
    font-size: 13px;
    display: inline-block;
  }
  
  /* Main Card */
  .main-card {
    padding: 16px;
    border-radius: 16px 16px 0 0;
  }
  
  /* Top Bar */
  .top-bar {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 20px;
  }
  
  .top-bar h2 { font-size: 22px; }
  .top-bar p { font-size: 13px; }
  
  /* Buttons */
  .btn {
    width: 100%;
    justify-content: center;
    padding: 14px 20px;
    font-size: 14px;
  }
  
  .btn-small {
    width: auto;
    padding: 10px 16px;
  }
  
  /* Search Box */
  .search-box {
    max-width: 100%;
    margin: 16px 0;
  }
  
  /* Form Grid */
  .form-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .form-card {
    padding: 16px;
  }
  
  /* Tables */
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }
  
  table thead th {
    padding: 12px 16px;
    font-size: 10px;
  }
  
  table tbody td {
    padding: 12px 16px;
    font-size: 13px;
  }
  
  /* Actions */
  .actions {
    gap: 6px;
  }
  
  .icon-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  /* Stats Grid */
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  /* Charts Grid */
  .charts-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  /* Balance Cards */
  [id^="tab-balance"] > div[style*="grid"] {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }
  
  /* Balance Cards Gradient */
  [id="tab-balance"] > div:nth-child(2) > div {
    padding: 24px !important;
  }
  
  [id="tab-balance"] > div:nth-child(2) > div > div:first-child {
    font-size: 100px !important;
  }
  
  [id="tab-balance"] > div:nth-child(2) > div [id^="balance-"] {
    font-size: 36px !important;
  }
  
  /* Modals */
  .modal-content {
    width: 95%;
    padding: 20px;
    max-height: 90vh;
  }
  
  /* Ingrediente Item */
  .ingrediente-item {
    grid-template-columns: 1fr;
    gap: 8px;
  }
  
  .ingrediente-item select,
  .ingrediente-item input {
    width: 100%;
  }
  
  /* Toast Container */
  .toast-container {
    top: 60px;
    right: 12px;
    left: 12px;
    max-width: none;
  }
  
  .toast {
    padding: 12px 16px;
  }
  
  /* Summary */
  .summary {
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
  }
}

@media (max-width: 480px) {
  /* Extra peque√±o */
  .kpi-dashboard {
    grid-template-columns: 1fr;
  }
  
  .header h1 { font-size: 28px; }
  
  .kpi-value { font-size: 32px; }
}
  </style>
</head>
<body>
  <div class="header">
    <h1>La Caleta 102</h1>
    <p>Pedido a Proveedor</p>
  </div>

  <div class="info-grid">
    <div class="info-item">
      <strong>Proveedor</strong>
      ${prov ? prov.nombre : 'Desconocido'}
    </div>
    <div class="info-item">
      <strong>Fecha del Pedido</strong>
      ${new Date(pedido.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}
    </div>
    <div class="info-item">
      <strong>Estado</strong>
      <span class="badge ${pedido.estado === 'recibido' ? 'badge-received' : 'badge-pending'}">
        ${pedido.estado === 'recibido' ? 'Recibido' : 'Pendiente'}
      </span>
    </div>
    ${pedido.estado === 'recibido' && pedido.fechaRecepcion ? `
    <div class="info-item">
      <strong>Fecha de Recepci√≥n</strong>
      ${new Date(pedido.fechaRecepcion).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}
    </div>
    ` : ''}
  </div>

  <h3>Detalle del Pedido</h3>
  <table>
    <thead>
      <tr>
        <th>Ingrediente</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Subtotal</th>
        ${pedido.estado === 'recibido' ? '<th>Estado</th>' : ''}
      </tr>
    </thead>
    <tbody>`;

        const items = pedido.ingredientes;
        let totalFinal = 0;

        items.forEach(item => {
          const ing = ingredientes.find(i => i.id === item.ingredienteId);
          if (!ing) return;

          const esRecibido = pedido.estado === 'recibido' && item.cantidadRecibida !== undefined;
          const cantidad = esRecibido ? item.cantidadRecibida : item.cantidad;
          const precio = esRecibido && item.precioReal ? item.precioReal : item.precioUnitario;
          const subtotal = cantidad * precio;

          if (item.estado !== 'no-entregado') {
            totalFinal += subtotal;
          }

          htmlPrint += '<tr>';
          htmlPrint += `<td>${ing.nombre}</td>`;
          htmlPrint += `<td>${cantidad} ${ing.unidad}`;
          
          if (esRecibido && item.cantidad && Math.abs(cantidad - item.cantidad) > 0.01) {
            const diff = cantidad - item.cantidad;
            htmlPrint += `<br><span class="varianza ${diff > 0 ? 'pos' : 'neg'}">(${diff > 0 ? '+' : ''}${diff.toFixed(2)})</span>`;
          }
          
          htmlPrint += `</td>`;
          htmlPrint += `<td>${parseFloat(precio || 0).toFixed(2)} ‚Ç¨/${ing.unidad}`;
          
          if (esRecibido && item.precioUnitario && Math.abs(precio - item.precioUnitario) > 0.01) {
            const diff = precio - item.precioUnitario;
            htmlPrint += `<br><span class="varianza ${diff > 0 ? 'neg' : 'pos'}">(${diff > 0 ? '+' : ''}${diff.toFixed(2)} ‚Ç¨)</span>`;
          }
          
          htmlPrint += `</td>`;
          htmlPrint += `<td>${item.estado === 'no-entregado' ? '0.00' : subtotal.toFixed(2)} ‚Ç¨</td>`;
          
          if (esRecibido) {
            let estadoText = '';
            if (item.estado === 'consolidado') estadoText = '‚úÖ OK';
            else if (item.estado === 'varianza') estadoText = '‚ö†Ô∏è Varianza';
            else if (item.estado === 'no-entregado') estadoText = '‚ùå No entregado';
            htmlPrint += `<td>${estadoText}</td>`;
          }
          
          htmlPrint += '</tr>';
        });

        htmlPrint += '</tbody></table>';

        if (pedido.estado === 'recibido' && pedido.totalRecibido !== undefined) {
          const varianza = pedido.totalRecibido - pedido.total;
          htmlPrint += `
  <div class="total-box">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
      <div>
        <strong style="color:#666;font-size:14px;">Total Original</strong><br>
        <span style="font-size:20px;">${pedido.total.toFixed(2)} ‚Ç¨</span>
      </div>
      <div>
        <strong style="color:#059669;font-size:14px;">Total Recibido</strong><br>
        <strong>${pedido.totalRecibido.toFixed(2)} ‚Ç¨</strong>
      </div>
      <div>
        <strong style="color:#666;font-size:14px;">Varianza</strong><br>
        <span style="font-size:20px;color:${varianza >= 0 ? '#ef4444' : '#10b981'};">${varianza >= 0 ? '+' : ''}${varianza.toFixed(2)} ‚Ç¨</span>
      </div>
    </div>
  </div>`;
        } else {
          htmlPrint += `
  <div class="total-box">
   <strong>Total del Pedido: ${parseFloat(pedido.total).toFixed(2)} ‚Ç¨</strong>
  </div>`;
        }

        htmlPrint += `
  <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 11px; color: #999; text-align: center;">
    Generado el ${new Date().toLocaleDateString('es-ES')} - La Caleta 102 Dashboard
  </div>
</body>
</html>`;

        // Abrir en nueva ventana para imprimir/guardar PDF
        const ventana = window.open('', '_blank');
        ventana.document.write(htmlPrint);
        ventana.document.close();
        
        // Esperar a que se cargue y abrir di√°logo de impresi√≥n
        setTimeout(() => {
          ventana.print();
        }, 250);
      };

      window.renderizarPedidos = function() {
        const busqueda = document.getElementById('busqueda-pedidos').value.toLowerCase();
        const filtrados = pedidos.filter(ped => {
          const prov = proveedores.find(p => p.id === ped.proveedorId);
          const nombreProv = prov ? prov.nombre.toLowerCase() : '';
          return nombreProv.includes(busqueda) || ped.estado.includes(busqueda);
        });

        const container = document.getElementById('tabla-pedidos');

        if (filtrados.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìã</div>
              <h3>${busqueda ? 'No encontrados' : 'A√∫n no hay pedidos'}</h3>
              <p>${busqueda ? 'Otra b√∫squeda' : 'Crea tu primer pedido'}</p>
            </div>
          `;
          document.getElementById('resumen-pedidos').style.display = 'none';
        } else {
          let html = '<table><thead><tr>';
          html += '<th>Fecha</th><th>Proveedor</th><th>Items</th><th>Total</th><th>Estado</th><th>Acciones</th>';
          html += '</tr></thead><tbody>';

          filtrados.forEach(ped => {
            const prov = proveedores.find(p => p.id === (ped.proveedor_id || ped.proveedorId));
            const nombreProv = prov ? prov.nombre : 'Desconocido';
            
            html += '<tr>';
            html += `<td>${new Date(ped.fecha).toLocaleDateString('es-ES')}</td>`;
            html += `<td><strong>${nombreProv}</strong></td>`;
            html += `<td>${ped.ingredientes.length} ingredientes</td>`;
            html += `<td><strong>${parseFloat(ped.total).toFixed(2)} ‚Ç¨</strong></td>`;
            html += `<td><span class="badge ${ped.estado === 'recibido' ? 'badge-received' : 'badge-pending'}">${ped.estado === 'recibido' ? 'Recibido' : 'Pendiente'}</span></td>`;
            html += `<td><div class="actions">`;
            html += `<button class="icon-btn view" onclick="window.verDetallesPedido(${ped.id})" title="Ver detalles">üëÅÔ∏è</button>`;
            if (ped.estado === 'pendiente') {
              html += `<button class="icon-btn receive" onclick="window.marcarPedidoRecibido(${ped.id})" title="Recibir pedido">üì•</button>`;
            }
            html += `<button class="icon-btn delete" onclick="window.eliminarPedido(${ped.id})" title="Eliminar">üóëÔ∏è</button>`;
            html += '</div></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          container.innerHTML = html;

          const totalPendientes = pedidos.filter(p => p.estado === 'pendiente').length;
          const totalRecibidos = pedidos.filter(p => p.estado === 'recibido').length;

          document.getElementById('resumen-pedidos').innerHTML = `
            <div>Total: <strong>${pedidos.length}</strong></div>
            <div>Pendientes: <strong>${totalPendientes}</strong></div>
            <div>Recibidos: <strong>${totalRecibidos}</strong></div>
          `;
          document.getElementById('resumen-pedidos').style.display = 'flex';
        }
      }

      // ========== AN√ÅLISIS (resumido) ==========
      window.renderizarAnalisis = function() {
        if (recetas.length === 0 || ingredientes.length === 0) {
          document.getElementById('analisis-vacio').style.display = 'block';
          document.getElementById('analisis-contenido').style.display = 'none';
          return;
        }

        document.getElementById('analisis-vacio').style.display = 'none';
        document.getElementById('analisis-contenido').style.display = 'block';

        let totalMargen = 0;
        let totalCoste = 0;
        const datosRecetas = recetas.map(rec => {
          const coste = calcularCosteRecetaCompleto(rec);
          const margen = rec.precio_venta - coste;
          const margenPct = rec.precio_venta > 0 ? (margen / rec.precio_venta) * 100 : 0;
          totalMargen += margenPct;
          totalCoste += coste;
          return { ...rec, coste, margen, margenPct };
        });

        const margenPromedio = (totalMargen / recetas.length).toFixed(1);
        const costePromedio = (totalCoste / recetas.length).toFixed(2);

        document.getElementById('stat-total-recetas').textContent = recetas.length;
        document.getElementById('stat-margen-promedio').textContent = margenPromedio + '%';
        document.getElementById('stat-coste-promedio').textContent = costePromedio + ' ‚Ç¨';
        document.getElementById('stat-total-ingredientes').textContent = ingredientes.length;
        
        renderRevenueChart();
        renderChartRentabilidad(datosRecetas);
        renderChartIngredientes();
        renderTablaRentabilidad(datosRecetas);
      };

      function renderChartRentabilidad(datos) {
        const ctx = document.getElementById('chart-rentabilidad');
        if (!ctx) return;

        const ordenados = [...datos].sort((a, b) => b.margenPct - a.margenPct).slice(0, 10);

        if (chartRentabilidad) chartRentabilidad.destroy();

        chartRentabilidad = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ordenados.map(r => r.nombre),
            datasets: [{
              label: 'Margen (%)',
              data: ordenados.map(r => r.margenPct.toFixed(1)),
              backgroundColor: ordenados.map(r => r.margenPct > 50 ? '#10b981' : r.margenPct > 30 ? '#f59e0b' : '#ef4444')
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
      }

      function renderChartIngredientes() {
        const ctx = document.getElementById('chart-ingredientes');
        if (!ctx) return;

        const ordenados = [...ingredientes]
          .filter(ing => ing.precio > 0)
          .sort((a, b) => b.precio - a.precio)
          .slice(0, 10);

        if (chartIngredientes) chartIngredientes.destroy();

        chartIngredientes = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ordenados.map(i => i.nombre),
            datasets: [{
              data: ordenados.map(i => i.precio),
              backgroundColor: [
                '#c35a3f', '#d47157', '#10b981', '#3b82f6', '#f59e0b',
                '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  font: {
                    size: 11
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.label + ': ' + context.parsed.toFixed(2) + ' ‚Ç¨';
                  }
                }
              }
            }
          }
        });
      }

      function renderTablaRentabilidad(datos) {
        const ordenados = [...datos].sort((a, b) => b.margenPct - a.margenPct);
        
        let html = '<table><thead><tr>';
        html += '<th>#</th><th>Plato</th><th>Coste</th><th>Precio</th><th>Margen ‚Ç¨</th><th>Margen %</th>';
        html += '</tr></thead><tbody>';

        ordenados.forEach((rec, idx) => {
          html += '<tr>';
          html += `<td><strong>#${idx + 1}</strong></td>`;
          html += `<td>${rec.nombre}</td>`;
          html += `<td>${parseFloat(rec.coste || 0).toFixed(2)} ‚Ç¨</td>`;
          html += `<td>${parseFloat(rec.precio_venta || 0).toFixed(2)} ‚Ç¨</td>`;
          html += `<td>${parseFloat(rec.margen || 0).toFixed(2)} ‚Ç¨</td>`;
          html += `<td><span class="badge ${rec.margenPct > 50 ? 'badge-success' : rec.margenPct > 30 ? 'badge-warning' : 'badge-warning'}">${parseFloat(rec.margenPct || 0).toFixed(1)}%</span></td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        document.getElementById('tabla-rentabilidad').innerHTML = html;
      }

      // ========== INVENTARIO ==========
      window.renderizarInventario = function() {
        const busqueda = document.getElementById('busqueda-inventario').value.toLowerCase();
        const filtrados = ingredientes.filter(ing => 
          ing.nombre.toLowerCase().includes(busqueda)
        );

        const container = document.getElementById('tabla-inventario');
        
        // Calcular alertas
        let stockBajo = 0;
        let stockCritico = 0;
        
        window.ingredientes.forEach(ing => {
          const stockActual = parseFloat(ing.stock_actual) || 0;
          const stockMinimo = parseFloat(ing.stock_minimo) || 0;
          // Solo contar si tiene m√≠nimo configurado
          if (stockMinimo > 0 && stockActual <= stockMinimo) {
            if (stockActual <= 0) {
              stockCritico++;
            } else {
              stockBajo++;
            }
          }
        });
        
        // Actualizar badge
        const totalAlertas = stockBajo + stockCritico;
        const badge = document.getElementById('badge-inventario');
        if (totalAlertas > 0) {
          badge.textContent = totalAlertas;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
        
        // Actualizar resumen
        const resumen = document.getElementById('resumen-inventario');
        if (stockBajo > 0 || stockCritico > 0) {
          resumen.innerHTML = `
            <div style="color: #f59e0b;">‚ö†Ô∏è Stock bajo: <strong>${stockBajo}</strong></div>
            <div style="color: #ef4444;">üî¥ Stock cr√≠tico: <strong>${stockCritico}</strong></div>
          `;
          resumen.style.display = 'flex';
        } else {
          resumen.style.display = 'none';
        }

        if (filtrados.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üì¶</div>
              <h3>No hay ingredientes</h3>
              <p>A√±ade ingredientes para gestionar el inventario</p>
            </div>
          `;
          return;
        }

        let html = '<table><thead><tr>';
        html += '<th>Estado</th><th>Ingrediente</th><th>Stock Actual</th><th>Stock M√≠nimo</th><th>Unidad</th><th>Acciones</th>';
        html += '</tr></thead><tbody>';

        filtrados.forEach(ing => {
          let estadoClass = 'stock-ok';
          let estadoIcon = 'üü¢';
          
          const stockActual = parseFloat(ing.stock_actual) || 0;
      const stockMinimo = parseFloat(ing.stock_minimo) || 0;
      
      if (stockMinimo > 0 && stockActual <= 0) {
        estadoClass = 'stock-critico';
        estadoIcon = 'üî¥';
      } else if (stockMinimo > 0 && stockActual <= stockMinimo) {
        estadoClass = 'stock-bajo';
        estadoIcon = 'üü°';
      }
          
          html += '<tr>';
          html += `<td><span class="stock-indicator ${estadoClass}"></span>${estadoIcon}</td>`;
          html += `<td><strong>${ing.nombre}</strong></td>`;
          html += `<td><span class="stock-value">${parseFloat(ing.stock_actual || 0).toFixed(2)}</span></td>`;
          html += `<td>${ing.stock_minimo}</td>`;
          html += `<td>${ing.unidad}</td>`;
          html += '</tr>';
        });

        container.innerHTML = html;
      };


      // Event listener para b√∫squeda de inventario
      document.getElementById('busqueda-inventario').addEventListener('input', window.renderizarInventario);

    // Dashboard expandido - actualizar datos
    window.actualizarDashboardExpandido = async function() {
      try {
        const ventas = await api.getSales();
        const hoy = new Date().toISOString().split('T')[0];
        const ventasHoy = ventas.filter(v => v.fecha.split('T')[0] === hoy);
        
        document.getElementById('ventas-hoy').textContent = ventasHoy.length;
        const ingresosHoy = ventasHoy.reduce((sum, v) => sum + parseFloat(v.total), 0);
        document.getElementById('ingresos-hoy').textContent = ingresosHoy.toFixed(2) + '‚Ç¨';
        
        const platosHoy = {};
        ventasHoy.forEach(v => {
          platosHoy[v.receta_nombre] = (platosHoy[v.receta_nombre] || 0) + v.cantidad;
        });
        const platoEstrella = Object.entries(platosHoy).sort((a,b) => b[1] - a[1])[0];
        document.getElementById('plato-estrella-hoy').textContent = platoEstrella ? platoEstrella[0] + ' (' + platoEstrella[1] + ')' : 'Sin ventas';
        
        const alertas = window.ingredientes.filter(ing => {
          const stockActual = parseFloat(ing.stock_actual) || 0;
          const stockMinimo = parseFloat(ing.stock_minimo) || 0;
          return stockMinimo > 0 && stockActual <= stockMinimo;
        });
        
        const listaAlertas = document.getElementById('alertas-stock-lista');
        if (alertas.length === 0) {
          listaAlertas.innerHTML = '<p style="color: #10B981; margin: 0;">‚úÖ Todo el stock OK</p>';
        } else {
          listaAlertas.innerHTML = alertas.map(ing => 
            '<div style="padding: 8px; margin-bottom: 6px; background: #FEF2F2; border-radius: 6px; border-left: 3px solid #EF4444;"><strong>' + ing.nombre + '</strong>: ' + parseFloat(ing.stock_actual).toFixed(1) + ' ' + ing.unidad + '</div>'
          ).join('');
        }
      } catch (e) {
        console.error('Error dashboard:', e);
      }
    };

    // Verificar autenticaci√≥n al cargar
    if (checkAuth()) {
      init();
    }
    })();
    
  </script>
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>
  
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
  </div>
</body>
</html>
